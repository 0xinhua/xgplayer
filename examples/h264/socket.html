<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>测试软解</title>
  <!--  <link rel="stylesheet" href="../../packages/xgplayer/dist/xgplayer.css">-->
  <style>
    #__vconsole .vc-switch {
      top: 0!important;
      right: 0!important;
    }
  </style>
  <meta  name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
</head>
<body>
<section>
  <div id="player"></div>
  <input type="text" id="wsUrl" placeholder="输入socket地址" style="width: 300px">
  <button id="btn" onclick="start()">点我开始</button>
</section>
<script src="./vconsole.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xgplayer@2.6.9/browser/index.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xgplayer-raw264@2.3.29/dist/index.js"></script>

<!--<script src="../../packages/xgplayer-mobilevideo/dist/index.js"></script>-->
<!--<script src="../../packages/xgplayer-raw264/dist/index.js"></script>-->
<!--<script src="./index_2.js"></script>-->
<script>
  var player;
  function start() {
    player = new H264Player({
      ignores: ['replay', 'time', 'fullscreen', 'volume', 'play', 'progress', 'loading'],
      id: 'player',
      width: 300,
      height: 500,
      isLive: true,
      autoplay: true,
      videoInit: false,
      stretch: true,
      fps: 30, // 可以设定帧率
      url: [],
      videoConfig: {
        noAudio: true,
      }
    })

    function Loader (ws) {
      this.currentBuffer = null;
      this.curBodyLen = 0;
      this.ws = ws;
    }

    Loader.getBodyLen = function getBodyLen (u8a) {
      return  u8a[0] * 256 * 256 * 256  +  u8a[1] * 256 * 256 + u8a[2] * 256 + u8a[3];
    };

    Loader.getPts = function getPts (u8a) {
      return  u8a[0] * 256 * 256 * 256  +  u8a[1] * 256 * 256 + u8a[2] * 256 + u8a[3];
    };

    Loader.prototype.tryRead = function tryRead (data) {
      var pts = Loader.getPts(data.slice(0, 8));
      if (pts === -2) {
        this.ws.send('start')
      }
      if (!this.currentBuffer) {
        this.curBodyLen = Loader.getBodyLen(data.slice(8, 12));
        this.currentBuffer = new Uint8Array(data.slice(12));
      } else {
        var prevBuffer = this.currentBuffer
        this.currentBuffer = new Uint8Array(this.currentBuffer.byteLength + data.byteLength)
        this.currentBuffer.set(prevBuffer, 0)
        this.currentBuffer.set(data, prevBuffer.byteLength)
      }

      if (this.curBodyLen === this.currentBuffer.byteLength) {
        player.pushBuffer(this.currentBuffer)
        this.curBodyLen = 0;
        this.currentBuffer = null
      } else if (this.curBodyLen < this.currentBuffer.byteLength) {
        var resolved = this.currentBuffer.slice(0, this.curBodyLen);
        var newBuffer = this.currentBuffer.slice(this.curBodyLen);
        this.curBodyLen = Loader.getBodyLen(newBuffer.slice(8, 12))
        this.currentBuffer = new Uint8Array(newBuffer.slice(12));
        player.pushBuffer(resolved)
      }
    }
    const input = document.querySelector('#wsUrl');
    var ws = new WebSocket(input.value) // 替换websocket地址
    var loader = new Loader(ws);
    ws.binaryType = 'arraybuffer'
    ws.addEventListener('message', function (event) {
      if (event.data === 'support_video') {
        ws.send("start")
        return;
      }
      loader.tryRead(new Uint8Array(event.data))
    });

  }


</script>
<script>
  // init vConsole
  var vConsole = new VConsole();
  console.log('Hello world');
</script>
</body>
</html>
