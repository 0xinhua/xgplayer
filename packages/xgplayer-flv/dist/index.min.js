!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("xgplayer")):"function"==typeof define&&define.amd?define(["xgplayer"],t):(e=e||self,e.FlvPlayer=t(e.Player))}(this,function(e){"use strict";function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(){}function n(){n.init.call(this)}function r(e){return void 0===e._maxListeners?n.defaultMaxListeners:e._maxListeners}function a(e,t,i){if(t)e.call(i);else for(var n=e.length,r=v(e,n),a=0;a<n;++a)r[a].call(i)}function s(e,t,i,n){if(t)e.call(i,n);else for(var r=e.length,a=v(e,r),s=0;s<r;++s)a[s].call(i,n)}function o(e,t,i,n,r){if(t)e.call(i,n,r);else for(var a=e.length,s=v(e,a),o=0;o<a;++o)s[o].call(i,n,r)}function u(e,t,i,n,r,a){if(t)e.call(i,n,r,a);else for(var s=e.length,o=v(e,s),u=0;u<s;++u)o[u].call(i,n,r,a)}function l(e,t,i,n){if(t)e.apply(i,n);else for(var r=e.length,a=v(e,r),s=0;s<r;++s)a[s].apply(i,n)}function h(e,t,n,a){var s,o,u;if("function"!=typeof n)throw new TypeError('"listener" argument must be a function');if(o=e._events,o?(o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),u=o[t]):(o=e._events=new i,e._eventsCount=0),u){if("function"==typeof u?u=o[t]=a?[n,u]:[u,n]:a?u.unshift(n):u.push(n),!u.warned&&(s=r(e))&&s>0&&u.length>s){u.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+u.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=u.length,f(l)}}else u=o[t]=n,++e._eventsCount;return e}function f(e){"function"==typeof console.warn?console.warn(e):console.log(e)}function d(e,t,i){function n(){e.removeListener(t,n),r||(r=!0,i.apply(e,arguments))}var r=!1;return n.listener=i,n}function c(e){var t=this._events;if(t){var i=t[e];if("function"==typeof i)return 1;if(i)return i.length}return 0}function p(e,t){for(var i=t,n=i+1,r=e.length;n<r;i+=1,n+=1)e[i]=e[n];e.pop()}function v(e,t){for(var i=new Array(t);t--;)i[t]=e[t];return i}function y(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}function m(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Be(t))&&"function"!=typeof t?e:t}function g(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Be(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function k(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function E(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function b(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function A(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function S(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function w(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function T(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function D(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function R(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function O(e,t){return t={exports:{}},e(t,t.exports),t.exports}function L(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function x(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function U(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function C(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function B(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function M(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Be(t))&&"function"!=typeof t?e:t}function I(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Be(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function P(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function F(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function N(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function j(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function V(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function G(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function z(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function X(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function H(){}function W(){W.init.call(this)}function q(e){return void 0===e._maxListeners?W.defaultMaxListeners:e._maxListeners}function K(e,t,i){if(t)e.call(i);else for(var n=e.length,r=re(e,n),a=0;a<n;++a)r[a].call(i)}function Y(e,t,i,n){if(t)e.call(i,n);else for(var r=e.length,a=re(e,r),s=0;s<r;++s)a[s].call(i,n)}function J(e,t,i,n,r){if(t)e.call(i,n,r);else for(var a=e.length,s=re(e,a),o=0;o<a;++o)s[o].call(i,n,r)}function Z(e,t,i,n,r,a){if(t)e.call(i,n,r,a);else for(var s=e.length,o=re(e,s),u=0;u<s;++u)o[u].call(i,n,r,a)}function Q(e,t,i,n){if(t)e.apply(i,n);else for(var r=e.length,a=re(e,r),s=0;s<r;++s)a[s].apply(i,n)}function $(e,t,i,n){var r,a,s;if("function"!=typeof i)throw new TypeError('"listener" argument must be a function');if(a=e._events,a?(a.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),a=e._events),s=a[t]):(a=e._events=new H,e._eventsCount=0),s){if("function"==typeof s?s=a[t]=n?[i,s]:[s,i]:n?s.unshift(i):s.push(i),!s.warned&&(r=q(e))&&r>0&&s.length>r){s.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=e,o.type=t,o.count=s.length,ee(o)}}else s=a[t]=i,++e._eventsCount;return e}function ee(e){"function"==typeof console.warn?console.warn(e):console.log(e)}function te(e,t,i){function n(){e.removeListener(t,n),r||(r=!0,i.apply(e,arguments))}var r=!1;return n.listener=i,n}function ie(e){var t=this._events;if(t){var i=t[e];if("function"==typeof i)return 1;if(i)return i.length}return 0}function ne(e,t){for(var i=t,n=i+1,r=e.length;n<r;i+=1,n+=1)e[i]=e[n];e.pop()}function re(e,t){for(var i=new Array(t);t--;)i[t]=e[t];return i}function ae(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}function se(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Vi(t))&&"function"!=typeof t?e:t}function oe(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Vi(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function ue(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function le(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function he(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function fe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function de(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ce(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function pe(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ve(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ye(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function me(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function ge(e,t){return t={exports:{}},e(t,t.exports),t.exports}function _e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ke(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ee(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Vi(t))&&"function"!=typeof t?e:t}function be(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Vi(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function Ae(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Se(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function we(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Te(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function De(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}e=e&&e.hasOwnProperty("default")?e.default:e;var Re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Oe=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},Le=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),xe=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Ue=function(e){for(var t in e)if(e.hasOwnProperty(t)&&null===e[t])return!1;return!0},Ce=function(){function e(){t(this,e),this.mimeType=null,this.duration=null,this.hasVideo=null,this.video={codec:null,width:null,height:null,profile:null,level:null,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},chromaFormat:null,parRatio:{width:1,height:1}},this.hasAudio=null,this.audio={codec:null,sampleRate:null,sampleRateIndex:null,channelCount:null}}return xe(e,[{key:"isComplete",value:function(){return e.isBaseInfoReady(this)&&e.isVideoReady(this)&&e.isAudioReady(this)}}],[{key:"isBaseInfoReady",value:function(e){return Ue(e)}},{key:"isVideoReady",value:function(e){return!e.hasVideo||Ue(e.video)}},{key:"isAudioReady",value:function(e){return!e.hasAudio||Ue(e.video)}}]),e}();i.prototype=Object.create(null),n.EventEmitter=n,n.usingDomains=!1,n.prototype.domain=void 0,n.prototype._events=void 0,n.prototype._maxListeners=void 0,n.defaultMaxListeners=10,n.init=function(){this.domain=null,n.usingDomains&&(void 0).active&&(void 0).Domain,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new i,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},n.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},n.prototype.getMaxListeners=function(){return r(this)},n.prototype.emit=function(e){var t,i,n,r,h,f,d,c="error"===e;if(f=this._events)c=c&&null==f.error;else if(!c)return!1;if(d=this.domain,c){if(t=arguments[1],!d){if(t instanceof Error)throw t;var p=new Error('Uncaught, unspecified "error" event. ('+t+")");throw p.context=t,p}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=d,t.domainThrown=!1,d.emit("error",t),!1}if(!(i=f[e]))return!1;var v="function"==typeof i;switch(n=arguments.length){case 1:a(i,v,this);break;case 2:s(i,v,this,arguments[1]);break;case 3:o(i,v,this,arguments[1],arguments[2]);break;case 4:u(i,v,this,arguments[1],arguments[2],arguments[3]);break;default:for(r=new Array(n-1),h=1;h<n;h++)r[h-1]=arguments[h];l(i,v,this,r)}return!0},n.prototype.addListener=function(e,t){return h(this,e,t,!1)},n.prototype.on=n.prototype.addListener,n.prototype.prependListener=function(e,t){return h(this,e,t,!0)},n.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,d(this,e,t)),this},n.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,d(this,e,t)),this},n.prototype.removeListener=function(e,t){var n,r,a,s,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(n=r[e]))return this;if(n===t||n.listener&&n.listener===t)0==--this._eventsCount?this._events=new i:(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(a=-1,s=n.length;s-- >0;)if(n[s]===t||n[s].listener&&n[s].listener===t){o=n[s].listener,a=s;break}if(a<0)return this;if(1===n.length){if(n[0]=void 0,0==--this._eventsCount)return this._events=new i,this;delete r[e]}else p(n,a);r.removeListener&&this.emit("removeListener",e,o||t)}return this},n.prototype.removeAllListeners=function(e){var t,n;if(!(n=this._events))return this;if(!n.removeListener)return 0===arguments.length?(this._events=new i,this._eventsCount=0):n[e]&&(0==--this._eventsCount?this._events=new i:delete n[e]),this;if(0===arguments.length){for(var r,a=Object.keys(n),s=0;s<a.length;++s)"removeListener"!==(r=a[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new i,this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},n.prototype.listeners=function(e){var t,i=this._events;return i&&(t=i[e])?"function"==typeof t?[t.listener||t]:y(t):[]},n.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):c.call(e,t)},n.prototype.listenerCount=c,n.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var Be="function"==typeof Symbol&&"symbol"==Re(Symbol.iterator)?function(e){return void 0===e?"undefined":Re(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":Re(e)},Me=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},Ie=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Pe=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in r)return r.value;var s=r.get;return void 0!==s?s.call(n):void 0},Fe=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Re(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},Ne=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":Re(t))&&"function"!=typeof t?e:t},je=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in r)return r.value;var s=r.get;return void 0!==s?s.call(n):void 0},Ve=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Ge=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];_(this,e),this._emitter=new n,this._instanceMap={},this._clsMap={},this._inited=!1,this.mediaInfo=new Ce,this.allowedEvents=t,this._hooks={},this._emitCounter={}}return Ve(e,[{key:"getInstance",value:function(e){return this._instanceMap[e]||null}},{key:"initInstance",value:function(e){if(this._clsMap[e]){for(var t=arguments.length,i=Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];var r=new(Function.prototype.bind.apply(this._clsMap[e],[null].concat(i)));return this._instanceMap[e]=r,r.init&&r.init(),r}throw new Error(e+"未在context中注册")}},{key:"init",value:function(e){if(!this._inited){for(var t in this._clsMap)this._clsMap.hasOwnProperty(t)&&!this._instanceMap[t]&&this.initInstance(t,e);this._inited=!0}}},{key:"registry",value:function(e,t){var i=this,n=this._emitter,r=this._isMessageNameValid.bind(this),a=this,s=function(t){function i(t,n,r){_(this,i);var s=m(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,n,r));return s.listeners={},s.onceListeners={},s.TAG=e,s._context=a,s}return g(i,t),Ve(i,[{key:"on",value:function(t,i){return r(t),this.listeners[t]?this.listeners[t].push(i):this.listeners[t]=[i],n.on(t+"__TO__"+e,i),n.on(t,i)}},{key:"before",value:function(e,t){r(e),a._hooks[e]?a._hooks[e].push(t):a._hooks[e]=[t]}},{key:"once",value:function(t,i){return r(t),this.onceListeners[t]?this.onceListeners[t].push(i):this.onceListeners[t]=[i],n.once(t+"__TO__"+e,i),n.once(t,i)}},{key:"emit",value:function(e){r(e),a._emitCounter[e]?(a._emitCounter[e]+=1,a._emitCounter[e]%1e3==0&&window.console&&(window.console.warn("invoke: ",e),window.localStorage.setItem("xgplayer_invoke_"+e,a._emitCounter[e]))):a._emitCounter[e]=1;var t=a._hooks?a._hooks[e]:null;if(t)for(var i=0,s=t.length;i<s;i++)(0,t[i])();for(var o=arguments.length,u=Array(o>1?o-1:0),l=1;l<o;l++)u[l-1]=arguments[l];return n.emit.apply(n,[e].concat(u))}},{key:"emitTo",value:function(e,t){r(t);for(var i=arguments.length,a=Array(i>2?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];return n.emit.apply(n,[t+"__TO__"+e].concat(a))}},{key:"off",value:function(e,t){return r(e),n.off(e,t)}},{key:"removeListeners",value:function(){var t=Object.prototype.hasOwnProperty.bind(this.listeners);for(var i in this.listeners)if(t(i))for(var r=this.listeners[i]||[],a=0;a<r.length;a++){var s=r[a];n.off(i,s),n.off(i+"__TO__"+e,s)}for(var o in this.onceListeners)if(t(o))for(var u=this.onceListeners[o]||[],l=0;l<u.length;l++){var h=u[l];n.off(o,h),n.off(o+"__TO__"+e,h)}}},{key:"destroy",value:function(){if(this.removeListeners(),this.listeners={},delete a._instanceMap[e],je(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this))return je(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this)}}]),i}(t);return this._clsMap[e]=s,function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];return i.initInstance.apply(i,[e].concat(n))}}},{key:"destroyInstances",value:function(){var e=this;Object.keys(this._instanceMap).forEach(function(t){e._instanceMap[t].destroy&&e._instanceMap[t].destroy()})}},{key:"destroy",value:function(){this._emitter=null,this.allowedEvents=[],this._clsMap=null,this._context=null,this._hooks=null,this._emitCounter={},this.destroyInstances()}},{key:"_isMessageNameValid",value:function(e){if(!this.allowedEvents.indexOf(e)<0)throw new Error("unregistered message name: "+e)}}]),e}(),ze={LADER_START:"LOADER_START",LOADER_DATALOADED:"LOADER_DATALOADED",LOADER_COMPLETE:"LOADER_COMPLETE",LOADER_ERROR:"LOADER_ERROR"},Xe={DEMUX_START:"DEMUX_START",DEMUX_COMPLETE:"DEMUX_COMPLETE",DEMUX_ERROR:"DEMUX_ERROR",METADATA_PARSED:"METADATA_PARSED",VIDEO_METADATA_CHANGE:"VIDEO_METADATA_CHANGE",AUDIO_METADATA_CHANGE:"AUDIO_METADATA_CHANGE",MEDIA_INFO:"MEDIA_INFO"},He={REMUX_METADATA:"REMUX_METADATA",REMUX_MEDIA:"REMUX_MEDIA",MEDIA_SEGMENT:"MEDIA_SEGMENT",REMUX_ERROR:"REMUX_ERROR",INIT_SEGMENT:"INIT_SEGMENT",DETECT_CHANGE_STREAM:"DETECT_CHANGE_STREAM",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT"},We={SOURCE_UPDATE_END:"SOURCE_UPDATE_END"},qe={RETRY_TIME_EXCEEDED:"RETRY_TIME_EXCEEDED"},Ke={START_DECRYPT:"START_DECRYPT",DECRYPTED:"DECRYPTED"},Ye=Object.assign({},ze,Xe,He,We,qe),Je=[],Ze=[];for(var Qe in Ye)Ye.hasOwnProperty(Qe)&&Je.push(Ye[Qe]);for(var $e in Ye)Ye.hasOwnProperty($e)&&Ze.push(Ye[$e]);var et={ALLEVENTS:Ye,HLS_EVENTS:qe,REMUX_EVENTS:He,DEMUX_EVENTS:Xe,MSE_EVENTS:We,LOADER_EVENTS:ze,FlvAllowedEvents:Je,HlsAllowedEvents:Ze,CRYTO_EVENTS:Ke},tt=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),it={get device(){var e=it.os;return e.isPc?"pc":e.isTablet?"tablet":"mobile"},get browser(){var e=navigator.userAgent.toLowerCase(),t={ie:/rv:([\d.]+)\) like gecko/,firfox:/firefox\/([\d.]+)/,chrome:/chrome\/([\d.]+)/,opera:/opera.([\d.]+)/,safari:/version\/([\d.]+).*safari/};return[].concat(Object.keys(t).filter(function(i){return t[i].test(e)}))[0]},get os(){var e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,n=/(?:Android)/.test(e),r=/(?:Firefox)/.test(e),a=/(?:iPad|PlayBook)/.test(e)||n&&!/(?:Mobile)/.test(e)||r&&/(?:Tablet)/.test(e),s=/(?:iPhone)/.test(e)&&!a;return{isTablet:a,isPhone:s,isAndroid:n,isPc:!s&&!n&&!i,isSymbian:i,isWindowsPhone:t,isFireFox:r}},get isLe(){return tt}},nt=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),rt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),at=function(){function e(){k(this,e)}return rt(e,null,[{key:"decode",value:function(t){for(var i=[],n=t,r=0,a=t.length;r<a;)if(n[r]<128)i.push(String.fromCharCode(n[r])),++r;else{if(n[r]<192);else if(n[r]<224){if(e._checkContinuation(n,r,1)){var s=(31&n[r])<<6|63&n[r+1];if(s>=128){i.push(String.fromCharCode(65535&s)),r+=2;continue}}}else if(n[r]<240){if(e._checkContinuation(n,r,2)){var o=(15&n[r])<<12|(63&n[r+1])<<6|63&n[r+2];if(o>=2048&&55296!=(63488&o)){i.push(String.fromCharCode(65535&o)),r+=3;continue}}}else if(n[r]<248&&e._checkContinuation(n,r,3)){var u=(7&n[r])<<18|(63&n[r+1])<<12|(63&n[r+2])<<6|63&n[r+3];if(u>65536&&u<1114112){u-=65536,i.push(String.fromCharCode(u>>>10|55296)),i.push(String.fromCharCode(1023&u|56320)),r+=4;continue}}i.push(String.fromCharCode(65533)),++r}return i.join("")}},{key:"_checkContinuation",value:function(e,t,i){var n=e;if(t+i<n.length){for(;i--;)if(128!=(192&n[++t]))return!1;return!0}return!1}}]),e}(),st=function(){function e(e,t){var i=[],n=!0,r=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(i.push(s.value),!t||i.length!==t);n=!0);}catch(e){r=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw a}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),ot=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ut=(function(){function e(t){var i=this;E(this,e);var n=e.getDefaultInf();if(!t||"[object Object]"!==Object.prototype.toString.call(t))return n;var r=Object.assign({},n,t);Object.entries(r).forEach(function(e){var t=st(e,2),n=t[0],r=t[1];i[n]=r})}ot(e,null,[{key:"getDefaultInf",value:function(){return{dts:null,pts:null,duration:null,position:null,isRAP:!1,originDts:null}}}])}(),function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}()),lt=(function(){function e(){b(this,e),this.startDts=-1,this.endDts=-1,this.startPts=-1,this.endPts=-1,this.originStartDts=-1,this.originEndDts=-1,this.randomAccessPoints=[],this.firstSample=null,this.lastSample=null}ut(e,[{key:"addRAP",value:function(e){e.isRAP=!0,this.randomAccessPoints.push(e)}}])}(),function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}()),ht=function(){function e(t){A(this,e),this._type=t,this._list=[],this._lastAppendLocation=-1}return lt(e,[{key:"isEmpty",value:function(){return 0===this._list.length}},{key:"clear",value:function(){this._list=[],this._lastAppendLocation=-1}},{key:"_searchNearestSegmentBefore",value:function(e){var t=this._list;if(0===t.length)return-2;var i=t.length-1,n=0,r=0,a=i,s=0;if(e<t[0].originDts)return s=-1;for(;r<=a;){if((n=r+Math.floor((a-r)/2))===i||e>t[n].lastSample.originDts&&e<t[n+1].originDts){s=n;break}t[n].originDts<e?r=n+1:a=n-1}return s}},{key:"_searchNearestSegmentAfter",value:function(e){return this._searchNearestSegmentBefore(e)+1}},{key:"append",value:function(e){var t=this._list,i=this._lastAppendLocation,n=0;-1!==i&&i<t.length&&e.originStartDts>=t[i].lastSample.originDts&&(i===t.length-1||i<t.length-1&&e.originStartDts<t[i+1].originStartDts)?n=i+1:t.length>0&&(n=this._searchNearestSegmentBefore(e.originStartDts)+1),this._lastAppendLocation=n,this._list.splice(n,0,e)}},{key:"getLastSegmentBefore",value:function(e){var t=this._searchNearestSegmentBefore(e);return t>=0?this._list[t]:null}},{key:"getLastSampleBefore",value:function(e){var t=this.getLastSegmentBefore(e);return null!==t?t.lastSample:null}},{key:"getLastRAPBefore",value:function(e){for(var t=this._searchNearestSegmentBefore(e),i=this._list[t].randomAccessPoints;0===i.length&&t>0;)t--,i=this._list[t].randomAccessPoints;return i.length>0?i[i.length-1]:null}},{key:"type",get:function(){return this._type}},{key:"length",get:function(){return this._list.length}}]),e}(),ft=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),dt=function(){function e(t){S(this,e);var i={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2",config:[41,401,136,0],duration:0,id:2,refSampleDuration:21,sampleRateIndex:3,timescale:1e3,type:"audio"};return t?Object.assign({},i,t):i}return ft(e,[{key:"destroy",value:function(){this.init=null}}]),e}(),ct=function(){function e(t){S(this,e);var i={avcc:null,sps:new Uint8Array(0),pps:new Uint8Array(0),chromaFormat:420,codec:"avc1.640020",codecHeight:720,codecWidth:1280,duration:0,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},id:1,level:"3.2",presentHeight:720,presentWidth:1280,profile:"High",refSampleDuration:40,parRatio:{height:1,width:1},timescale:1e3,type:"video"};return t?Object.assign({},i,t):i}return ft(e,[{key:"destroy",value:function(){this.init=null,this.sps=null,this.pps=null}}]),e}(),pt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),vt=function(){function e(t){w(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return pt(e,null,[{key:"getDefault",value:function(){return{dts:null,pts:null,data:new Uint8Array}}}]),e}(),yt=function(){function e(t){w(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return pt(e,null,[{key:"getDefault",value:function(){return{dts:null,pts:null,isKeyframe:!1,originDts:null,data:new Uint8Array}}}]),e}(),mt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),gt=function(){function e(t){T(this,e),this.configs=Object.assign({},t),this.container=this.configs.container,this.mediaSource=null,this.sourceBuffers={},this.preloadTime=this.configs.preloadTime||1,this.onSourceOpen=this.onSourceOpen.bind(this),this.onTimeUpdate=this.onTimeUpdate.bind(this),this.onUpdateEnd=this.onUpdateEnd.bind(this),this.onWaiting=this.onWaiting.bind(this)}return mt(e,[{key:"init",value:function(){this.mediaSource=new self.MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this.container.src=URL.createObjectURL(this.mediaSource),this.url=this.container.src,this.container.addEventListener("timeupdate",this.onTimeUpdate),this.container.addEventListener("waiting",this.onWaiting)}},{key:"onTimeUpdate",value:function(){this.emit("TIME_UPDATE",this.container)}},{key:"onWaiting",value:function(){this.emit("WAITING",this.container)}},{key:"onSourceOpen",value:function(){this.addSourceBuffers()}},{key:"onUpdateEnd",value:function(){this.emit("SOURCE_UPDATE_END"),this.doAppend()}},{key:"addSourceBuffers",value:function(){if("open"===this.mediaSource.readyState){var e=this._context.getInstance("PRE_SOURCE_BUFFER"),t=this._context.getInstance("TRACKS"),i=void 0;e=e.sources;for(var n=!1,r=0,a=Object.keys(e).length;r<a;r++){var s=Object.keys(e)[r];if("audio"===s?i=t.audioTrack:"video"===s&&(i=t.videoTrack),i){var o="audio"===s?21:40;i.meta&&i.meta.refSampleDuration&&(o=i.meta.refSampleDuration),e[s].data.length>=this.preloadTime/o&&(n=!0)}}if(n){if(Object.keys(this.sourceBuffers).length>0)return;for(var u=0,l=Object.keys(e).length;u<l;u++){var h=Object.keys(e)[u],f=e[h],d="video"===h?"video/mp4;codecs="+f.mimetype:"audio/mp4;codecs="+f.mimetype,c=this.mediaSource.addSourceBuffer(d);this.sourceBuffers[h]=c,c.addEventListener("updateend",this.onUpdateEnd),this.doAppend()}}}}},{key:"doAppend",value:function(){var e=this._context.getInstance("PRE_SOURCE_BUFFER");if(e)for(var t=0;t<Object.keys(this.sourceBuffers).length;t++){var i=Object.keys(this.sourceBuffers)[t],n=this.sourceBuffers[i];if(!n.updating){var r=e.sources[i];if(r&&!r.inited)n.appendBuffer(r.init.buffer.buffer),r.inited=!0;else if(r){var a=r.data.shift();a&&n.appendBuffer(a.buffer.buffer)}}}}},{key:"endOfStream",value:function(){var e=this.mediaSource,t=e.readyState,i=e.activeSourceBuffers;if("open"===t&&0===i.length)try{this.mediaSource.endOfStream()}catch(e){}}},{key:"remove",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;i<Object.keys(this.sourceBuffers).length;i++){var n=this.sourceBuffers[Object.keys(this.sourceBuffers)[i]];n.updating||n.remove(t,e)}}},{key:"removeBuffers",value:function(){for(var t=this,i=[],n=0;n<Object.keys(this.sourceBuffers).length;n++)!function(n){var r=t.sourceBuffers[Object.keys(t.sourceBuffers)[n]];r.removeEventListener("updateend",t.onUpdateEnd);var a=void 0;a=r.updating?new Promise(function(t){var i=function i(){var n=3,a=function i(){r.updating?n>0?(setTimeout(i,200),n--):t():(e.clearBuffer(r),r.addEventListener("updateend",function(){t()}))};setTimeout(a,200),r.removeEventListener("updateend",i)};r.addEventListener("updateend",i)}):new Promise(function(t){e.clearBuffer(r),r.addEventListener("updateend",function(){t()})}),i.push(a)}(n);return Promise.all(i)}},{key:"destroy",value:function(){var e=this;return this.removeBuffers().then(function(){for(var t=0;t<Object.keys(e.sourceBuffers).length;t++){var i=e.sourceBuffers[Object.keys(e.sourceBuffers)[t]];e.mediaSource.removeSourceBuffer(i),delete e.sourceBuffers[Object.keys(e.sourceBuffers)[t]]}e.container.removeEventListener("timeupdate",e.onTimeUpdate),e.container.removeEventListener("waiting",e.onWaiting),e.mediaSource.removeEventListener("sourceopen",e.onSourceOpen),e.endOfStream(),window.URL.revokeObjectURL(e.url),e.url=null,e.configs={},e.container=null,e.mediaSource=null,e.sourceBuffers={},e.preloadTime=1})}}],[{key:"clearBuffer",value:function(e){for(var t=e.buffered,i=.1,n=0,r=t.length;n<r;n++)i=t.end(n);try{e.remove(0,i)}catch(e){}}}]),e}(),_t=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),kt=function(){function e(t){if(D(this,e),!(t instanceof ArrayBuffer))throw new Error("data is invalid");this.buffer=t,this.dataview=new DataView(t),this.dataview.position=0}return _t(e,[{key:"back",value:function(e){this.position-=e}},{key:"skip",value:function(t){for(var i=Math.floor(t/4),n=t%4,r=0;r<i;r++)e.readByte(this.dataview,4);n>0&&e.readByte(this.dataview,n)}},{key:"readUint8",value:function(){return e.readByte(this.dataview,1)}},{key:"readUint16",value:function(){return e.readByte(this.dataview,2)}},{key:"readUint24",value:function(){return e.readByte(this.dataview,3)}},{key:"readUint32",value:function(){return e.readByte(this.dataview,4)}},{key:"readUint64",value:function(){return e.readByte(this.dataview,8)}},{key:"readInt8",value:function(){return e.readByte(this.dataview,1,!0)}},{key:"readInt16",value:function(){return e.readByte(this.dataview,2,!0)}},{key:"readInt32",value:function(){return e.readByte(this.dataview,4,!0)}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}},{key:"length",get:function(){return this.buffer.byteLength}},{key:"position",set:function(e){this.dataview.position=e},get:function(){return this.dataview.position}}],[{key:"readByte",value:function(e,t,i){var n=void 0;switch(t){case 1:n=i?e.getInt8(e.position):e.getUint8(e.position);break;case 2:n=i?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(i)throw new Error("not supported for readByte 3");n=e.getUint8(e.position)<<16,n|=e.getUint8(e.position+1)<<8,n|=e.getUint8(e.position+2);break;case 4:n=i?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(i)throw new Error("not supported for readBody 8");n=e.getUint32(e.position)<<32,n|=e.getUint32(e.position+4);break;default:n=""}return e.position+=t,n}}]),e}(),Et=O(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){for(var t=0,i=arguments.length,n=Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];var a=!0,s=!1,o=void 0;try{for(var u,l=n[Symbol.iterator]();!(a=(u=l.next()).done);a=!0)t+=u.value.length}catch(e){s=!0,o=e}finally{try{!a&&l.return&&l.return()}finally{if(s)throw o}}var h=new e(t),f=0,d=!0,c=!1,p=void 0;try{for(var v,y=n[Symbol.iterator]();!(d=(v=y.next()).done);d=!0){var m=v.value;h.set(m,f),f+=m.length}}catch(e){c=!0,p=e}finally{try{!d&&y.return&&y.return()}finally{if(c)throw p}}return h}});R(Et);var bt=R(O(function(e){var t=function(e){return e&&e.__esModule?e:{default:e}}(Et);e.exports=t.default})),At=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),St=function(){function e(t){L(this,e),this.buffer=t||new Uint8Array(0)}return At(e,[{key:"write",value:function(){for(var e=this,t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];i.forEach(function(t){e.buffer=bt(Uint8Array,e.buffer,t)})}}],[{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,255&e])}},{key:"readAsInt",value:function(e){function t(e){return e.toString(16).padStart(2,"0")}var i="";return e.forEach(function(e){i+=t(e)}),parseInt(i,16)}}]),e}(),wt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Tt=et.CRYTO_EVENTS,Dt=(function(){function e(t){x(this,e),this.inputBuffer=t.inputbuffer,this.outputBuffer=t.outputbuffer,this.key=t.key,this.iv=t.iv,this.method=t.method,this.crypto=window.crypto||window.msCrypto}wt(e,[{key:"init",value:function(){this.on(Tt.START_DECRYPT,this.decript.bind(this))}},{key:"decript",value:function(){var e=this;this.aeskey?this.decriptData():this.crypto.subtle.importKey("raw",this.key.buffer,{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(t){e.aeskey=t,e.decriptData()})}},{key:"decriptData",value:function(){var e=this,t=this._context.getInstance(this.inputBuffer),i=this._context.getInstance(this.outputBuffer),n=t.shift();n&&this.crypto.subtle.decrypt({name:"AES-CBC",iv:this.iv.buffer},this.aeskey,n).then(function(t){i.push(new Uint8Array(t)),e.emit(Tt.DECRYPTED),e.decriptData(n)})}}])}(),Ge),Rt=et,Ot=it,Lt=nt,xt=at,Ut=ht,Ct=dt,Bt=ct,Mt=vt,It=yt,Pt=gt,Ft=kt,Nt=St,jt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Vt=function(){function e(){U(this,e)}return jt(e,null,[{key:"size",value:function(e){return Nt.writeUint32(e)}},{key:"initBox",value:function(t,i){for(var n=new Nt,r=arguments.length,a=Array(r>2?r-2:0),s=2;s<r;s++)a[s-2]=arguments[s];return n.write.apply(n,[e.size(t),e.type(i)].concat(a)),n.buffer}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,255&t])}},{key:"ftyp",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]))}},{key:"moov",value:function(t){var i=t.type,n=t.meta,r=8,a=e.mvhd(n.duration,n.timescale),s=void 0;s="video"===i?e.videoTrak(n):e.audioTrak(n);var o=e.mvex(n.duration,n.timescale||1e3,n.id);return[a,s,o].forEach(function(e){r+=e.byteLength}),e.initBox(r,"moov",a,s,o)}},{key:"mvhd",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,n=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.initBox(8+n.length,"mvhd",new Uint8Array(n))}},{key:"videoTrak",value:function(t){var i=8,n=e.tkhd({id:1,duration:t.duration,timescale:t.timescale||1e3,width:t.presentWidth,height:t.presentHeight,type:"video"}),r=e.mdia({type:"video",timescale:t.timescale||1e3,duration:t.duration,avcc:t.avcc,parRatio:t.parRatio,width:t.presentWidth,height:t.presentHeight});return[n,r].forEach(function(e){i+=e.byteLength}),e.initBox(i,"trak",n,r)}},{key:"audioTrak",value:function(t){var i=8,n=e.tkhd({id:2,duration:t.duration,timescale:t.timescale||1e3,width:0,height:0,type:"audio"}),r=e.mdia({type:"audio",timescale:t.timescale||1e3,duration:t.duration,channelCount:t.channelCount,samplerate:t.sampleRate,config:t.config});return[n,r].forEach(function(e){i+=e.byteLength}),e.initBox(i,"trak",n,r)}},{key:"tkhd",value:function(t){var i=t.id,n=t.duration,r=t.width,a=t.height,s=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,0,0,0,0,n>>>24&255,n>>>16&255,n>>>8&255,255&n,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>>8&255,255&r,0,0,a>>>8&255,255&a,0,0]);return e.initBox(8+s.byteLength,"tkhd",s)}},{key:"edts",value:function(t){var i=new Nt,n=t.duration,r=t.mediaTime;return i.write(e.size(36),e.type("edts")),i.write(e.size(28),e.type("elst")),i.write(new Uint8Array([0,0,0,1,n>>24&255,n>>16&255,n>>8&255,255&n,r>>24&255,r>>16&255,r>>8&255,255&r,0,0,0,1])),i.buffer}},{key:"mdia",value:function(t){var i=8,n=e.mdhd(t.timescale,t.duration),r=e.hdlr(t.type),a=e.minf(t);return[n,r,a].forEach(function(e){i+=e.byteLength}),e.initBox(i,"mdia",n,r,a)}},{key:"mdhd",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,i=arguments[1],n=new Uint8Array([0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,i>>>24&255,i>>>16&255,i>>>8&255,255&i,85,196,0,0]);return e.initBox(12+n.byteLength,"mdhd",e.extension(0,0),n)}},{key:"hdlr",value:function(t){var i=[0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0];return"audio"===t&&(i.splice.apply(i,[8,4].concat([115,111,117,110])),i.splice.apply(i,[24,13].concat([83,111,117,110,100,72,97,110,100,108,101,114,0]))),e.initBox(8+i.length,"hdlr",new Uint8Array(i))}},{key:"minf",value:function(t){var i=8,n="video"===t.type?e.vmhd():e.smhd(),r=e.dinf(),a=e.stbl(t);return[n,r,a].forEach(function(e){i+=e.byteLength}),e.initBox(i,"minf",n,r,a)}},{key:"vmhd",value:function(){return e.initBox(20,"vmhd",new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))}},{key:"smhd",value:function(){return e.initBox(16,"smhd",new Uint8Array([0,0,0,0,0,0,0,0]))}},{key:"dinf",value:function(){var t=new Nt,i=[0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1];return t.write(e.size(36),e.type("dinf"),e.size(28),e.type("dref"),new Uint8Array(i)),t.buffer}},{key:"stbl",value:function(t){var i=8,n=e.stsd(t),r=e.stts(),a=e.stsc(),s=e.stsz(),o=e.stco();return[n,r,a,s,o].forEach(function(e){i+=e.byteLength}),e.initBox(i,"stbl",n,r,a,s,o)}},{key:"stsd",value:function(t){var i=void 0;return i="audio"===t.type?e.mp4a(t):e.avc1(t),e.initBox(16+i.byteLength,"stsd",e.extension(0,0),new Uint8Array([0,0,0,1]),i)}},{key:"mp4a",value:function(t){var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,t.samplerate>>8&255,255&t.samplerate,0,0]),n=e.esds(t.config);return e.initBox(8+i.byteLength+n.byteLength,"mp4a",i,n)}},{key:"esds",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[43,146,8,0],i=t.length,n=new Nt,r=new Uint8Array([0,0,0,0,3,23+i,0,1,0,4,15+i,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([i]).concat(t).concat([6,1,2]));return n.write(e.size(8+r.byteLength),e.type("esds"),r),n.buffer}},{key:"avc1",value:function(t){var i=new Nt,n=t.width,r=t.height,a=t.parRatio.height,s=t.parRatio.width,o=t.avcc,u=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,n>>8&255,255&n,r>>8&255,255&r,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l=new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]),h=new Uint8Array([a>>24,a>>16&255,a>>8&255,255&a,s>>24,s>>16&255,s>>8&255,255&s]);return i.write(e.size(40+u.byteLength+o.byteLength+l.byteLength),e.type("avc1"),u,e.size(8+o.byteLength),e.type("avcC"),o,e.size(20),e.type("btrt"),l,e.size(16),e.type("pasp"),h),i.buffer}},{key:"stts",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stts",t)}},{key:"stsc",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stsc",t)}},{key:"stco",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stco",t)}},{key:"stsz",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);return e.initBox(20,"stsz",t)}},{key:"mvex",value:function(t){var i=arguments[2],n=new Nt,r=Nt.writeUint32(t);return n.write(e.size(56),e.type("mvex"),e.size(16),e.type("mehd"),e.extension(0,0),r,e.trex(i)),n.buffer}},{key:"trex",value:function(t){var i=new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return e.initBox(8+i.byteLength,"trex",i)}},{key:"moof",value:function(t){var i=8,n=e.mfhd(),r=e.traf(t);return[n,r].forEach(function(e){i+=e.byteLength}),e.initBox(i,"moof",n,r)}},{key:"mfhd",value:function(){var t=Nt.writeUint32(e.sequence);return e.sequence+=1,e.initBox(16,"mfhd",e.extension(0,0),t)}},{key:"traf",value:function(t){var i=8,n=e.tfhd(t.id),r=e.tfdt(t.time),a=e.sdtp(t),s=e.trun(t,a.byteLength);return[n,r,s,a].forEach(function(e){i+=e.byteLength}),e.initBox(i,"traf",n,r,s,a)}},{key:"tfhd",value:function(t){var i=Nt.writeUint32(t);return e.initBox(16,"tfhd",e.extension(0,0),i)}},{key:"tfdt",value:function(t){return e.initBox(16,"tfdt",e.extension(0,0),Nt.writeUint32(t))}},{key:"trun",value:function(t,i){var n=new Nt,r=Nt.writeUint32(t.samples.length),a=Nt.writeUint32(92+16*t.samples.length+i);return n.write(e.size(20+16*t.samples.length),e.type("trun"),new Uint8Array([0,0,15,1]),r,a),t.samples.forEach(function(e){var t=e.flags;n.write(new Uint8Array([e.duration>>>24&255,e.duration>>>16&255,e.duration>>>8&255,255&e.duration,e.size>>>24&255,e.size>>>16&255,e.size>>>8&255,255&e.size,t.isLeading<<2|t.dependsOn,t.isDependedOn<<6|t.hasRedundancy<<4|t.isNonSync,0,0,e.cts>>>24&255,e.cts>>>16&255,e.cts>>>8&255,255&e.cts]))}),n.buffer}},{key:"sdtp",value:function(t){var i=new Nt;return i.write(e.size(12+t.samples.length),e.type("sdtp"),e.extension(0,0)),t.samples.forEach(function(e){var t=e.flags,n=t.isLeading<<6|t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;i.write(new Uint8Array([n]))}),i.buffer}},{key:"mdat",value:function(t){var i=new Nt,n=8;t.samples.forEach(function(e){n+=e.size}),i.write(e.size(n),e.type("mdat"));var r=new Uint8Array(n),a=0;return r.set(i.buffer,a),a+=8,t.samples.forEach(function(e){e.buffer.forEach(function(e){r.set(e,a),a+=e.byteLength})}),r}}]),e}();Vt.type=function(e){return new Uint8Array([e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)])},Vt.sequence=1;var Gt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),zt=Rt.REMUX_EVENTS,Xt=function(){function e(){C(this,e),this._dtsBase=0,this._isDtsBaseInited=!1,this._audioNextDts=null,this._videoNextDts=null,this._videoSegmentList=new Ut("video"),this._audioSegmentList=new Ut("audio");var t=Ot.browser;this._fillSilenceFrame="ie"===t,this.isFirstVideo=!0,this.isFirstAudio=!0,this.videoAllDuration=0,this.audioAllDuration=0}return Gt(e,[{key:"init",value:function(){this.on(zt.REMUX_MEDIA,this.remux.bind(this)),this.on(zt.REMUX_METADATA,this.onMetaDataReady.bind(this)),this.on(zt.DETECT_CHANGE_STREAM,this.resetDtsBase.bind(this))}},{key:"destroy",value:function(){this._dtsBase=-1,this._dtsBaseInited=!1,this._videoNextDts=null,this._audioNextDts=null,this._videoSegmentList.clear(),this._audioSegmentList.clear(),this._videoSegmentList=null,this._audioSegmentList=null}},{key:"remux",value:function(){var e=this._context.getInstance("TRACKS"),t=e.audioTrack,i=e.videoTrack;!this._isDtsBaseInited&&this.calcDtsBase(t,i),this._remuxVideo(i),this._remuxAudio(t)}},{key:"resetDtsBase",value:function(){this._dtsBase=0,this._dtsBaseInited=!1}},{key:"seek",value:function(){this._videoNextDts=null,this._audioNextDts=null,this._videoSegmentList.clear(),this._audioSegmentList.clear()}},{key:"onMetaDataReady",value:function(e){var t=void 0;t="audio"===e?this._context.getInstance("TRACKS").audioTrack:this._context.getInstance("TRACKS").videoTrack;var i=this._context.getInstance("PRE_SOURCE_BUFFER"),n=i.getSource(e);n||(n=i.createSource(e)),n.mimetype=t.meta.codec,n.init=this.remuxInitSegment(e,t.meta),this.emit(zt.INIT_SEGMENT,e)}},{key:"remuxInitSegment",value:function(e,t){var i=new Nt,n=Vt.ftyp(),r=Vt.moov({type:e,meta:t});return i.write(n,r),i}},{key:"calcDtsBase",value:function(e,t){if(!e&&t.samples.length)return t.samples[0].dts;if(e.samples.length||t.samples.length){var i=1/0,n=1/0;e.samples&&e.samples.length&&(i=e.samples[0].dts),t.samples&&t.samples.length&&(n=t.samples[0].dts),this._dtsBase=Math.min(i,n),this._isDtsBaseInited=!0}}},{key:"_remuxVideo",value:function(e){var t=e||{};if(e.samples&&e.samples.length){for(var i=t.samples,n=-1,r=null,a=[],s={samples:[]},o=1e4;i.length&&o-- >0;){var u=i.shift(),l=u.isKeyframe,h=u.options;if(!this.isFirstAudio&&h&&h.meta){r=this.remuxInitSegment("video",h.meta),h.meta=null,i.unshift(u),h.isContinue||this.resetDtsBase();break}var f=u.dts-this._dtsBase;-1===n&&(n=f);var d=void 0,c=void 0;void 0!==u.pts&&(d=(c=u.pts-this._dtsBase)-f),void 0!==u.cts&&(c=u.cts+f,d=u.cts);var p={buffer:[],size:0};s.samples.push(p),p.buffer.push(u.data),p.size+=u.data.byteLength;var v=0;v=u.duration?u.duration:i.length>=1?i[0].dts-this._dtsBase-f:a.length>=1?a[a.length-1].duration:this.videoMeta.refSampleDuration,this.videoAllDuration+=v,a.push({dts:f,cts:d,pts:c,data:u.data,size:u.data.byteLength,isKeyframe:l,duration:v,flags:{isLeading:0,dependsOn:l?2:1,isDependedOn:l?1:0,hasRedundancy:0,isNonSync:l?0:1},originDts:f,type:"video"}),l&&this.emit(zt.RANDOM_ACCESS_POINT,c)}var y=new Nt;if(a.length){var m=Vt.moof({id:t.meta.id,time:n,samples:a}),g=Vt.mdat(s);y.write(m,g),this.writeToSource("video",y)}if(r&&(this.writeToSource("video",r),i.length))return t.samples=i,this._remuxVideo(t);this.isFirstVideo=!1,this.emit(zt.MEDIA_SEGMENT,"video");var _=a[a.length-1];this._videoNextDts=_.dts+_.duration,t.samples=[],t.length=0}}},{key:"_remuxAudio",value:function(e){var t=(e||{}).samples,i=-1,n=[],r=null,a={samples:[]};if(t&&t.length){for(var s=1e4,o=!1;t.length&&s-- >0;){var u=t.shift(),l=u.data,h=u.options;if(!this.isFirstAudio&&h&&h.meta){r=this.remuxInitSegment("audio",h.meta),h.meta=null,t.unshift(u),h.isContinue||this.resetDtsBase();break}var f=u.dts-this._dtsBase,d=f;o||(i=f,o=!0);var c=0;c=u.duration?u.duration:this.audioMeta.refSampleDurationFixed?this.audioMeta.refSampleDurationFixed:t.length>=1?t[0].dts-this._dtsBase-f:n.length>=1?n[n.length-1].duration:this.audioMeta.refSampleDuration,this.audioAllDuration+=c;var p={dts:f,pts:f,cts:0,size:l.byteLength,duration:u.duration?u.duration:c,flags:{isLeading:0,dependsOn:2,isDependedOn:1,hasRedundancy:0,isNonSync:0},isKeyframe:!0,originDts:d,type:"audio"},v={buffer:[],size:0};v.buffer.push(l),v.size+=l.byteLength,a.samples.push(v),n.push(p)}var y=new Nt;if(n.length){var m=Vt.moof({id:e.meta.id,time:i,samples:n}),g=Vt.mdat(a);y.write(m,g),this.writeToSource("audio",y)}if(r&&(this.writeToSource("audio",r),t.length))return e.samples=t,this._remuxAudio(e);this.isFirstAudio=!1,this.emit(zt.MEDIA_SEGMENT,"audio",y);var _=n[n.length-1];this._videoNextDts=_.dts+_.duration,e.samples=[],e.length=0}}},{key:"writeToSource",value:function(e,t){var i=this._context.getInstance("PRE_SOURCE_BUFFER"),n=i.getSource(e);n||(n=i.createSource(e)),n.data.push(t)}},{key:"initSilentAudio",value:function(t,i){var n=e.getSilentFrame(this._audioMeta.channelCount);return{dts:t,pts:t,cts:0,duration:i,unit:n,size:n.byteLength,originDts:t,type:"video"}}},{key:"videoMeta",get:function(){return this._context.getInstance("TRACKS").videoTrack.meta}},{key:"audioMeta",get:function(){return this._context.getInstance("TRACKS").audioTrack.meta}}],[{key:"getSilentFrame",value:function(e){return 1===e?new Uint8Array([0,200,0,128,35,128]):2===e?new Uint8Array([33,0,73,144,2,25,0,35,128]):3===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]):4===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]):5===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]):6===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]):null}}]),e}(),Ht=Rt.LOADER_EVENTS,Wt=function(){function e(t){Oe(this,e),this.configs=Object.assign({},t),this.url=null,this.status=0,this.error=null,this._reader=null,this._canceled=!1,this._destroyed=!1,this.readtype=this.configs.readtype,this.buffer=this.configs.buffer||"LOADER_BUFFER",this._loaderTaskNo=0}return Le(e,[{key:"init",value:function(){this.on(Ht.LADER_START,this.load.bind(this))}},{key:"load",value:function(e,t){var i=this;this.url=e,this._canceled=!1;var n=this.getParams(t);return i.loading=!0,fetch(this.url,n).then(function(e){if(e.ok)return i.status=e.status,i._onFetchResponse(e);i.loading=!1,i.emit(Ht.LOADER_ERROR,i.TAG,new Error("invalid response."))}).catch(function(e){throw i.loading=!1,i.emit(Ht.LOADER_ERROR,i.TAG,e),new Error(e.message)})}},{key:"_onFetchResponse",value:function(e){var t=this,i=this._context.getInstance(this.buffer),n=++this._loaderTaskNo;if(!0===e.ok)switch(this.readtype){case 2:e.json().then(function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(e),t.emit(Ht.LOADER_COMPLETE,i)):t.emit(Ht.LOADER_COMPLETE,e))});break;case 1:e.text().then(function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(e),t.emit(Ht.LOADER_COMPLETE,i)):t.emit(Ht.LOADER_COMPLETE,e))});break;case 3:e.arrayBuffer().then(function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(new Uint8Array(e)),t.emit(Ht.LOADER_COMPLETE,i)):t.emit(Ht.LOADER_COMPLETE,e))});break;case 0:default:return this._onReader(e.body.getReader(),n)}}},{key:"_onReader",value:function(e,t){var i=this._context.getInstance(this.buffer);if(!i&&this._reader||this._destroyed)try{this._reader.cancel()}catch(e){}if(this._reader=e,!1!==this.loading){var n=this;this._reader&&this._reader.read().then(function(r){if(!n._canceled&&!n._destroyed)return r.done?(n.loading=!1,n.status=0,void n.emit(Ht.LOADER_COMPLETE,i)):(i.push(r.value),n.emit(Ht.LOADER_DATALOADED,i),n._onReader(e,t));if(n._reader)try{n._reader.cancel()}catch(e){}}).catch(function(e){n.loading=!1,n.emit(Ht.LOADER_ERROR,n.TAG,e)})}}},{key:"getParams",value:function(e){var t=Object.assign({},e),i=new Headers,n={method:"GET",headers:i,mode:"cors",cache:"default"};if("object"===Re(this.configs.headers)){var r=this.configs.headers;for(var a in r)r.hasOwnProperty(a)&&i.append(a,r[a])}if("object"===Re(t.headers)){var s=t.headers;for(var o in s)s.hasOwnProperty(o)&&i.append(o,s[o])}return!1===t.cors&&(n.mode="same-origin"),t.withCredentials&&(n.credentials="include"),n}},{key:"cancel",value:function(){if(this._reader){try{this._reader.cancel()}catch(e){}this._reader=null,this.loading=!1}this._canceled=!0}},{key:"destroy",value:function(){this._destroyed=!0,this.cancel()}}],[{key:"type",get:function(){return"loader"}}]),e}(),qt=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Kt=(function(){function e(){B(this,e)}qt(e,null,[{key:"parse",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n={duration:0};if(t&&t.split){var r=t.split(/\r|\n/),a=(r=r.filter(function(e){return e})).shift();if(!a.match("#EXTM3U"))throw new Error('Invalid m3u8 file: not "#EXTM3U"');a=r.shift();for(var s=!1;a;){var o=a.match(/#(.[A-Z|-]*):(.*)/),u=a.match(/#(.[A-Z|-]*)/);if(u&&o&&o.length>2)switch(o[1]){case"EXT-X-VERSION":n.version=parseInt(o[2]);break;case"EXT-X-MEDIA-SEQUENCE":n.sequence=parseInt(o[2]);break;case"EXT-X-TARGETDURATION":n.targetduration=parseFloat(o[2]);break;case"EXTINF":e.parseFrag(o,r,n,i,s),s=!1;break;case"EXT-X-KEY":e.parseDecrypt(o[2],n)}if(u&&u.length>1)switch(u[1]){case"EXT-X-DISCONTINUITY":s=!0}a=r.shift()}return n}}},{key:"parseFrag",value:function(e,t,i,n,r){i.frags||(i.frags=[]);var a={start:i.duration,duration:1e3*parseFloat(e[2])};i.duration+=a.duration;var s=t.shift();s.match(/#(.*):(.*)/)&&(s=t.shift()),s.length>0&&"/"===s.charAt(0)&&n.match(/.*\/\/.*\.\w+/g)&&(n=n.match(/.*\/\/.*\.\w+/g)[0]),s.match(/.*:\/\/.*/)?a.url=s:a.url=n+s,a.discontinue=r,i.frags.push(a)}},{key:"parseURL",value:function(e){var t="",i=e.match(/(.*\/).*\.m3u8/);if(i&&i.length>0)for(var n=0;n<i.length;n++)i[n].match(/.*\/$/g)&&i[n].length>t.length&&(t=i[n]);return t}},{key:"parseDecrypt",value:function(e,t){t.encrypt={};var i=e.split(",");for(var n in i){var r=i[n];if(r.match(/METHOD=(.*)/)&&(t.encrypt.method=r.match(/METHOD=(.*)/)[1]),r.match(/URI="(.*)"/)&&(t.encrypt.uri=r.match(/URI="(.*)"/)[1]),r.match(/IV=0x(.*)/)){var a=r.match(/IV=0x(.*)/)[1],s=Math.ceil(a.length/2);t.encrypt.ivb=new Uint8Array(s);for(var o=s-1;o>=0;o--){var u=parseInt(a.substr(2*o,2),16);t.encrypt.ivb[o]=u}t.encrypt.iv=a}}}}])}(),function(){function e(t){Oe(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}return Le(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(i.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),t=e-t,t>0&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e=void 0;for(e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}}]),e}()),Yt=function(){function e(){Oe(this,e)}return Le(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,n=new Uint8Array(i),r=0,a=0;a<i;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(n[r]=t[a],r++);return new Uint8Array(n.buffer,0,r)}},{key:"parseSPS",value:function(t){var i=e._ebsp2rbsp(t),n=new Kt(i);n.readByte();var r=n.readByte();n.readByte();var a=n.readByte();n.readUEG();var s=e.getProfileString(r),o=e.getLevelString(a),u=1,l=420,h=[0,420,422,444],f=8;if((100===r||110===r||122===r||244===r||44===r||83===r||86===r||118===r||128===r||138===r||144===r)&&(3===(u=n.readUEG())&&n.readBits(1),u<=3&&(l=h[u]),f=n.readUEG()+8,n.readUEG(),n.readBits(1),n.readBool()))for(var d=3!==u?8:12,c=0;c<d;c++)n.readBool()&&(c<6?e._skipScalingList(n,16):e._skipScalingList(n,64));n.readUEG();var p=n.readUEG();if(0===p)n.readUEG();else if(1===p){n.readBits(1),n.readSEG(),n.readSEG();for(var v=n.readUEG(),y=0;y<v;y++)n.readSEG()}n.readUEG(),n.readBits(1);var m=n.readUEG(),g=n.readUEG(),_=n.readBits(1);0===_&&n.readBits(1),n.readBits(1);var k=0,E=0,b=0,A=0;n.readBool()&&(k=n.readUEG(),E=n.readUEG(),b=n.readUEG(),A=n.readUEG());var S=1,w=1,T=0,D=!0,R=0,O=0;if(n.readBool()){if(n.readBool()){var L=n.readByte(),x=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],U=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];L>0&&L<16?(S=x[L-1],w=U[L-1]):255===L&&(S=n.readByte()<<8|n.readByte(),w=n.readByte()<<8|n.readByte())}if(n.readBool()&&n.readBool(),n.readBool()&&(n.readBits(4),n.readBool()&&n.readBits(24)),n.readBool()&&(n.readUEG(),n.readUEG()),n.readBool()){var C=n.readBits(32),B=n.readBits(32);D=n.readBool(),T=(R=B)/(O=2*C)}}var M=1;1===S&&1===w||(M=S/w);var I=0,P=0;0===u?(I=1,P=2-_):(I=3===u?1:2,P=(1===u?2:1)*(2-_));var F=16*(m+1),N=16*(g+1)*(2-_);F-=(k+E)*I,N-=(b+A)*P;var j=Math.ceil(F*M);return n.destroy(),n=null,{profile_string:s,level_string:o,bit_depth:f,chroma_format:l,chroma_format_string:e.getChromaFormatString(l),frame_rate:{fixed:D,fps:T,fps_den:O,fps_num:R},par_ratio:{width:S,height:w},codec_size:{width:F,height:N},present_size:{width:j,height:N}}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,n=8,r=0;r<t;r++)0!==n&&(n=(i+e.readSEG()+256)%256),i=0===n?i:n}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};e&&e.codec_size&&(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t.parRatio={width:e.par_ratio.width,height:e.par_ratio.height},t.frameRate=e.frame_rate;var i=t.frameRate.fps_den,n=t.frameRate.fps_num;t.refSampleDuration=Math.floor(t.timescale*(i/n))}}]),e}(),Jt=function(){function e(){Oe(this,e)}return Le(e,null,[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var i=t.dataview,n=t.position;return 1===i.getInt32(n)||0===i.getInt16(n)&&1===i.getInt8(n+2)?e.getAnnexbNals(t):e.getAvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var i=[],n=e.getHeaderPositionAnnexB(t),r=n.pos,a=r;r<t.length-4;){var s=t.buffer.slice(r,r+n.headerLength);n.pos===t.position&&t.skip(n.headerLength),a=(n=e.getHeaderPositionAnnexB(t)).pos;var o={header:s,body:new Uint8Array(t.buffer.slice(r+s.byteLength,a))};e.analyseNal(o),i.push(o),t.skip(a-t.position),r=a}return i}},{key:"getAvccNals",value:function(t){for(var i=[];t.position<t.length-4;){var n=t.dataview.getInt32();if(!(t.length-t.position>=n))break;var r=t.buffer.slice(t.position,t.position+4);t.skip(4);var a=t.buffer.slice(t.position,t.position+n);t.skip(n);var s={header:r,body:a};e.analyseNal(s),i.push(s)}return i}},{key:"analyseNal",value:function(e){switch(31&e.body[0]){case 1:e.ndr=!0;break;case 5:e.idr=!0;break;case 6:break;case 7:e.sps=Yt.parseSPS(e.body);break;case 8:e.pps=!0}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0;3!==i&&4!==i&&t<e.length-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===e.length-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)&&(i=4):(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?i=3:t=e.length)),{pos:t,headerLength:i}}},{key:"getAvcc",value:function(e,t){var i=new Uint8Array(e.byteLength+t.byteLength+11);i[0]=1,i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=255,i[5]=225;var n=6;return i.set(new Uint8Array([e.byteLength>>>8&255,255&e.byteLength]),n),n+=2,i.set(e,n),n+=e.byteLength,i[n]=1,n++,i.set(new Uint8Array([t.byteLength>>>8&255,255&t.byteLength]),n),n+=2,i.set(t,n),i}}]),e}(),Zt=function(){function e(){Oe(this,e)}return Le(e,null,[{key:"getSilentFrame",value:function(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}]),e}(),Qt=Rt.REMUX_EVENTS,$t=Rt.LOADER_EVENTS,ei=function(){function e(){Oe(this,e),this.nextAudioDts=0,this.nextVideoDts=0,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.allAudioSamplesCount=0,this.allVideoSamplesCount=0,this._firstAudioSample=null,this._firstVideoSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this.videoLastSample=null,this.audioLastSample=null,this._videoLargeGap=0,this._audioLargeGap=0}return Le(e,[{key:"init",value:function(){var e=this;this.before(Qt.REMUX_MEDIA,this.doFix.bind(this)),this.on($t.LOADER_COMPLETE,function(){e.videoLastSample&&e.videoTrack.samples.unshift(e.videoLastSample)})}},{key:"reset",value:function(){this.nextAudioDts=null,this.nextVideoDts=null,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.videoLastSample=null,this.audioLastSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[]}},{key:"doFix",value:function(){var t=this.getFirstSample(),i=t.isFirstAudioSamples,n=t.isFirstVideoSamples;this.recordSamplesCount(),this._firstVideoSample&&this.fixRefSampleDuration(this.videoTrack.meta,this.videoTrack.samples),this._firstAudioSample&&this.fixRefSampleDuration(this.audioTrack.meta,this.audioTrack.samples);var r=e.detactChangeStream(this.videoTrack.samples),a=r.changed,s=r.changedIdx;a&&!i?this.fixChangeStreamVideo(s):this.doFixVideo(n);var o=e.detactChangeStream(this.audioTrack.samples),u=o.changed,l=o.changedIdx;u?this.fixChangeStreamAudio(l):this.doFixAudio(i),this.removeInvalidSamples()}},{key:"doFixVideo",value:function(t,i){for(var n=this.videoTrack,r=n.samples,a=n.meta,s=0,o=r.length;s<o;s++){var u=r[s];u.originDts=u.dts}if((!a.frameRate||!1!==a.frameRate.fixed)&&r&&r.length&&this._firstVideoSample){var l=r[0];if(this._videoLargeGap>0&&e.doFixLargeGap(r,this._videoLargeGap),l.dts!==this._firstVideoSample.dts&&i&&(i&&(this.nextVideoDts=i),this._videoLargeGap=this.nextVideoDts-l.dts,e.doFixLargeGap(r,this._videoLargeGap)),t&&this._firstAudioSample){var h=this._firstVideoSample.originDts,f=h-(this._firstAudioSample.originDts||this._firstAudioSample.dts);if(f>2*a.refSampleDuration&&f<10*a.refSampleDuration){for(var d=Math.floor(f/a.refSampleDuration),c=0;c<d;c++){var p=Object.assign({},l);p.dts=h-(c+1)*a.refSampleDuration,p.pts=p.dts+p.cts,r.unshift(p),this.filledVideoSamples.push({dts:p.dts,size:p.data.byteLength})}this._firstVideoSample=this.filledVideoSamples[0]||this._firstVideoSample}else f<-2*a.refSampleDuration&&(this._videoLargeGap=-1*f,e.doFixLargeGap(r,-1*f))}var v=r.pop();if(r.length&&(r[r.length-1].duration=v.dts-r[r.length-1].dts),this.videoLastSample){var y=this.videoLastSample;y.duration=l.dts-y.dts,r.unshift(this.videoLastSample)}this.videoLastSample=v,this.videoTrack.samples=r}}},{key:"doFixAudio",value:function(t,i){var n=this.audioTrack,r=n.samples,a=n.meta;if(r&&r.length){for(var s=0,o=r.length;s<o;s++){var u=r[s];u.originDts=u.dts}var l=r.length,h=Zt.getSilentFrame(a.codec,a.channelCount),f=this._firstAudioSample,d=r[0];if(this._audioLargeGap>0&&e.doFixLargeGap(r,this._audioLargeGap),d.dts!==this._firstAudioSample.dts&&(i||e.detectLargeGap(this.nextAudioDts,d))&&(i&&(this.nextAudioDts=i),this._audioLargeGap=this.nextAudioDts-d.dts,e.doFixLargeGap(r,this._audioLargeGap)),this._firstVideoSample&&t){var c=this._firstVideoSample.originDts||this._firstVideoSample.dts,p=f.dts-c;if(p>a.refSampleDuration&&p<10*a.refSampleDuration){for(var v=Math.floor((f.dts-c)/a.refSampleDuration),y=0;y<v;y++){var m={data:h,datasize:h.byteLength,dts:f.dts-(y+1)*a.refSampleDuration,filtered:0};r.unshift(m),this.filledAudioSamples.push({dts:m.dts,size:m.data.byteLength})}this._firstAudioSample=this.filledAudioSamples[0]||this._firstAudioSample}else p<-1*a.refSampleDuration&&(this._audioLargeGap=-1*p,e.doFixLargeGap(r,-1*p))}var g=void 0,_=r[0].dts;if(this.nextAudioDts){g=_-this.nextAudioDts;var k=Math.abs(g);if(k>a.refSampleDuration&&1===l&&1===this.lastAudioSamplesLen&&(a.refSampleDurationFixed=void 0),g>2*a.refSampleDuration&&g<10*a.refSampleDuration)if(1===l&&1===this.lastAudioSamplesLen)a.refSampleDurationFixed=void 0!==a.refSampleDurationFixed?a.refSampleDurationFixed+g:a.refSampleDuration+g;else for(var E=Math.floor(g/a.refSampleDuration),b=0;b<E;b++){var A=_-(b+1)*a.refSampleDuration,S=Object.assign({},r[0],{dts:A>this.nextAudioDts?A:this.nextAudioDts});this.filledAudioSamples.push({dts:S.dts,size:S.data.byteLength}),this.audioTrack.samples.unshift(S)}else k<=a.refSampleDuration&&k>0?(r[0].dts=this.nextAudioDts,r[0].pts=this.nextAudioDts):g<0&&e.doFixLargeGap(r,-1*g)}var w=r[r.length-1].originDts,T=r[r.length-1].dts,D=r.length>=2?w-r[r.length-2].originDts:a.refSampleDuration;this.lastAudioSamplesLen=l,this.nextAudioDts=a.refSampleDurationFixed?T+a.refSampleDurationFixed:T+D,this.lastAudioDts=T,r[r.length-1].duration=D;for(var R=0,O=r.length;R<O;R++){var L=r[R],x=r[R+1];if(!x)break;var U=x.dts-L.dts;r[R].duration=U}this.audioTrack.samples=e.sortAudioSamples(r)}}},{key:"fixChangeStreamVideo",value:function(e){var t=this.videoTrack,i=t.samples,n=t.meta,r=0===e?this.getStreamChangeStart(i[0]):i[e-1].dts,a=i[e].dts;if(Math.abs(r-a)<=2*n.refSampleDuration)return i[e].options?i[e].options.isContinue=!0:i[e].options={isContinue:!0},this.doFixVideo(!1);var s=i.slice(0,e),o=i.slice(e),u=i[0],l=o[0].dts-u.dts,h=u.options&&u.options.start+l?u.options.start:null;this.videoTrack.samples=i.slice(0,e),this.doFixVideo(!1),this.videoTrack.samples=i.slice(e),this.doFixVideo(!1,h),this.videoTrack.samples=s.concat(o)}},{key:"fixChangeStreamAudio",value:function(e){var t=this.audioTrack,i=t.samples,n=t.meta,r=0===e?this.getStreamChangeStart(i[0]):i[e-1].dts,a=i[e].dts;if(Math.abs(r-a)<=2*n.refSampleDuration)return i[e].options?i[e].options.isContinue=!0:i[e].options={isContinue:!0},this.doFixAudio(!1);var s=i.slice(0,e),o=i.slice(e),u=i[0],l=o[0].dts-u.dts,h=u.options&&u.options.start+l?u.options.start:null;this.audioTrack.samples=s,this.doFixAudio(!1),this.audioTrack.samples=o,this.doFixAudio(!1,h),this.audioTrack.samples=s.concat(o)}},{key:"getFirstSample",value:function(){var t=this.videoTrack.samples,i=this.audioTrack.samples,n=!1,r=!1;return!this._firstVideoSample&&t.length&&(this._firstVideoSample=e.findFirstVideoSample(t),this.removeInvalidSamples(),n=!0),!this._firstAudioSample&&i.length&&(this._firstAudioSample=e.findFirstAudioSample(i),this.removeInvalidSamples(),r=!0),{isFirstVideoSamples:n,isFirstAudioSamples:r}}},{key:"fixRefSampleDuration",value:function(e,t){var i="video"===e.type,n=i?this.allVideoSamplesCount:this.allAudioSamplesCount,r=i?this._firstVideoSample.dts:this._firstAudioSample.dts,a=i?this.filledVideoSamples.length:this.filledAudioSamples.length;if(!e.refSampleDuration||e.refSampleDuration<=0||Number.isNaN(e.refSampleDuration)){if(t.length>=1){var s=t[t.length-1].dts;e.refSampleDuration=Math.floor((s-r)/(n+a-1))}}else if(e.refSampleDuration&&t.length>=5){var o=(t[t.length-1].dts-t[0].dts)/(t.length-1);e.refSampleDuration=Math.floor(Math.abs(e.refSampleDuration-o)<=5?e.refSampleDuration:o)}}},{key:"recordSamplesCount",value:function(){var e=this.audioTrack,t=this.videoTrack;this.allAudioSamplesCount+=e.samples.length,this.allVideoSamplesCount+=t.samples.length}},{key:"removeInvalidSamples",value:function(){var e=this._firstVideoSample,t=this._firstAudioSample;t&&(this.audioTrack.samples=this.audioTrack.samples.filter(function(e,i){return e===t||e.dts>t.dts})),e&&(this.videoTrack.samples=this.videoTrack.samples.filter(function(t,i){return t===e||t.dts>e.dts}))}},{key:"getStreamChangeStart",value:function(e){return e.options&&e.options.start?e.options.start-this.dtsBase:1/0}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"audioTrack",get:function(){return this.tracks&&this.tracks.audioTrack?this.tracks.audioTrack:{samples:[],meta:{}}}},{key:"videoTrack",get:function(){return this.tracks&&this.tracks.videoTrack?this.tracks.videoTrack:{samples:[],meta:{}}}},{key:"dtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e?e._dtsBase:0}}],[{key:"sortAudioSamples",value:function(e){return 1===e.length?e:e.sort(function(e,t){return e.dts-t.dts})}},{key:"findFirstAudioSample",value:function(t){return t&&0!==t.length?e.sortAudioSamples(t)[0]:null}},{key:"findFirstVideoSample",value:function(e){if(!e.length)return null;for(var t=e.sort(function(e,t){return e.dts-t.dts}),i=0,n=t.length;i<n;i++)if(t[i].isKeyframe)return t[i]}},{key:"detectLargeGap",value:function(e,t){if(null!==e){var i=t.dts||0,n=e-i>=1e3||i-e>=1e3,r=t.options&&t.options.discontinue;return n||r}}},{key:"doFixLargeGap",value:function(e,t){for(var i=0,n=e.length;i<n;i++){var r=e[i];r.dts+=t,r.pts&&(r.pts+=t)}}},{key:"detactChangeStream",value:function(e){for(var t=!1,i=-1,n=0,r=e.length;n<r;n++)if(e[n].options&&e[n].options.meta){t=!0,i=n;break}return{changed:t,changedIdx:i}}}]),e}(),ti=Jt,ii=Yt,ni=ei,ri=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ai=function(){function e(){P(this,e),this.id=-1,this.sequenceNumber=0,this.samples=[],this.droppedSamples=[],this.length=0}return ri(e,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0}},{key:"distroy",value:function(){this.reset(),this.id=-1}}]),e}(),si=function(e){function t(){P(this,t);var e=M(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="AudioTrack",e.type="audio",e}return I(t,e),t}(ai),oi=function(e){function t(){P(this,t);var e=M(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="VideoTrack",e.type="video",e.dropped=0,e}return I(t,e),ri(t,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0,this.dropped=0}}]),t}(ai),ui=function(){function e(){P(this,e),this.audioTrack=null,this.videoTrack=null}return ri(e,[{key:"destroy",value:function(){this.audioTrack=null,this.videoTrack=null}}]),e}(),li=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),hi=function(){function e(t){F(this,e),this.length=t||0,this.historyLen=t||0,this.array=[],this.offset=0}return li(e,[{key:"push",value:function(e){this.array.push(e),this.length+=e.byteLength,this.historyLen+=e.byteLength}},{key:"shift",value:function(e){if(this.array.length<1)return new Uint8Array(0);if(void 0===e)return this._shiftBuffer();if(this.offset+e===this.array[0].length){var t=this.array[0].slice(this.offset,this.offset+e);return this.offset=0,this.array.shift(),this.length-=e,t}if(this.offset+e<this.array[0].length){var i=this.array[0].slice(this.offset,this.offset+e);return this.offset+=e,this.length-=e,i}for(var n=new Uint8Array(e),r=0;this.array.length>0&&e>0;){if(this.offset+e<this.array[0].length){var a=this.array[0].slice(this.offset,this.offset+e);n.set(a,r),this.offset+=e,this.length-=e,e=0;break}var s=this.array[0].length-this.offset;n.set(this.array[0].slice(this.offset,this.array[0].length),r),this.array.shift(),this.offset=0,r+=s,this.length-=s,e-=s}return n}},{key:"clear",value:function(){this.array=[],this.length=0,this.offset=0}},{key:"destroy",value:function(){this.clear(),this.historyLen=0}},{key:"_shiftBuffer",value:function(){return this.length-=this.array[0].length,this.offset=0,this.array.shift()}},{key:"toInt",value:function(e,t){for(var i=0,n=this.offset+e;n<this.offset+t+e;)n<this.array[0].length?i=256*i+this.array[0][n]:this.array[1]&&(i=256*i+this.array[1][n-this.array[0].length]),n++;return i}}]),e}(),fi=(function(){function e(){F(this,e),this.video=[],this.audio=[]}li(e,[{key:"destroy",value:function(){this.video=[],this.audio=[]}}])}(),function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}()),di=function e(){N(this,e),this.mimetype="",this.init=null,this.data=[]},ci=ui,pi=si,vi=oi,yi=hi,mi=function(){function e(){N(this,e),this.sources={}}return fi(e,[{key:"getSource",value:function(e){return this.sources[e]}},{key:"createSource",value:function(e){return this.sources[e]=new di,this.sources[e]}},{key:"clear",value:function(){this.sources={}}},{key:"destroy",value:function(){this.sources={}}}]),e}(),gi="function"==typeof Symbol&&"symbol"===Be(Symbol.iterator)?function(e){return void 0===e?"undefined":Be(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":Be(e)},_i=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ki=Rt.DEMUX_EVENTS,Ei={1:["video","MPEG-1"],2:["video","MPEG-2"],27:["video","AVC.H264"],234:["video","VC-1"],3:["audio","MPEG-1"],4:["audio","MPEG-2"],15:["audio","MPEG-2.AAC"],17:["audio","MPEG-4.AAC"],128:["audio","LPCM"],129:["audio","AC3"],6:["audio","AC3"],130:["audio","DTS"],131:["audio","Dolby TrueHD"],132:["audio","AC3-Plus"],133:["audio","DTS-HD"],134:["audio","DTS-MA"],161:["audio","AC3-Plus-SEC"],162:["audio","DTS-HD-SEC"]},bi=(function(){function e(t){j(this,e),this.configs=Object.assign({},t),this.demuxing=!1,this.pat=[],this.pmt=[],this._hasVideoMeta=!1,this._hasAudioMeta=!1}_i(e,[{key:"init",value:function(){this.on(ki.DEMUX_START,this.demux.bind(this))}},{key:"demux",value:function(t){if(!this.demuxing){for(var i=this.inputBuffer,n={pat:[],pmt:[]},r={};i.length>=188;){for(i.length>=1&&71!==i.array[0][i.offset]&&this.emit(ki.DEMUX_ERROR,this.TAG,new Error("Untrust sync code: "+i.array[0][i.offset]+", try to recover;"),!1);i.length>=1&&71!==i.array[0][i.offset];)i.shift(1);var a=i.shift(188),s=new Ft(a.buffer),o={};e.read(s,o,n),o.pes?(r[o.header.pid]||(r[o.header.pid]=[]),r[o.header.pid].push(o.pes),o.pes.ES.buffer=[o.pes.ES.buffer]):r[o.header.pid]&&r[o.header.pid][r[o.header.pid].length-1].ES.buffer.push(o.payload.stream)}for(var u=t,l=t,h=0;h<Object.keys(r).length;h++)for(var f=r[Object.keys(r)[h]],d=0;d<f.length;d++)f[d].id=Object.keys(r)[h],f[d].ES.buffer=e.Merge(f[d].ES.buffer),"audio"===f[d].type?(this.pushAudioSample(f[d],u),u={}):"video"===f[d].type&&(this.pushVideoSample(f[d],l),l={});this._hasAudioMeta&&this.emit(ki.DEMUX_COMPLETE,"audio"),this._hasVideoMeta&&this.emit(ki.DEMUX_COMPLETE,"video")}}},{key:"pushAudioSample",value:function(t,i){var n=void 0;this._tracks.audioTrack?n=this._tracks.audioTrack:(this._tracks.audioTrack=new pi,n=this._tracks.audioTrack);var r=new Ct({audioSampleRate:t.ES.frequence,sampleRate:t.ES.frequence,channelCount:t.ES.channel,codec:"mp4a.40."+t.ES.audioObjectType,config:t.ES.audioConfig,id:2,sampleRateIndex:t.ES.frequencyIndex});r.refSampleDuration=Math.floor(1024/r.audioSampleRate*r.timescale);var a=e.compaireMeta(n.meta,r,!0);this._hasAudioMeta&&a||(n.meta=r,this._hasAudioMeta=!0,this.emit(ki.METADATA_PARSED,"audio"));var s=new Uint8Array(t.ES.buffer.buffer.slice(t.ES.buffer.position,t.ES.buffer.length)),o=parseInt(t.pts/90),u=parseInt(t.pts/90),l=new Mt({dts:o,pts:u,data:s,options:i});n.samples.push(l)}},{key:"pushVideoSample",value:function(t,i){var n=ti.getNalunits(t.ES.buffer),r=void 0,a=new Bt;this._tracks.videoTrack?r=this._tracks.videoTrack:(this._tracks.videoTrack=new vi,r=this._tracks.videoTrack);for(var s=0,o=!1,u=!1,l=0;l<n.length;l++){var h=n[l];if(h.sps){o=h,r.sps=h.body,a.chromaFormat=o.sps.chroma_format,a.codec="avc1.";for(var f=1;f<4;f++){var d=o.body[f].toString(16);d.length<2&&(d="0"+d),a.codec+=d}a.codecHeight=o.sps.codec_size.height,a.codecWidth=o.sps.codec_size.width,a.frameRate=o.sps.frame_rate,a.id=1,a.level=o.sps.level_string,a.presentHeight=o.sps.present_size.height,a.presentWidth=o.sps.present_size.width,a.profile=o.sps.profile_string,a.refSampleDuration=Math.floor(a.timescale*(o.sps.frame_rate.fps_den/o.sps.frame_rate.fps_num)),a.sarRatio=o.sps.sar_ratio?o.sps.sar_ratio:o.sps.par_ratio}else h.pps?(r.pps=h.body,u=h):s+=4+h.body.byteLength}if(o&&u){a.avcc=ti.getAvcc(o.body,u.body);var c=e.compaireMeta(r.meta,a,!0);this._hasVideoMeta&&c||(i?i.meta=Object.assign({},a):i={meta:Object.assign({},a)},r.meta=a,this._hasVideoMeta=!0,this.emit(ki.METADATA_PARSED,"video"))}for(var p=new Uint8Array(s),v=0,y=!1,m=0;m<n.length;m++){var g=n[m],_=g.body.byteLength;g.idr&&(y=!0),g.pps||g.sps||(p.set(new Uint8Array([_>>>24&255,_>>>16&255,_>>>8&255,255&_]),v),v+=4,p.set(g.body,v),v+=_)}var k=new It({dts:parseInt(t.dts/90),pts:parseInt(t.pts/90),cts:(t.pts-t.dts)/90,originDts:t.dts,isKeyframe:y,data:p,options:i});r.samples.push(k)}},{key:"destory",value:function(){this.off(ki.DEMUX_START,this.demux),this.configs={},this.demuxing=!1,this.pat=[],this.pmt=[],this._hasVideoMeta=!1,this._hasAudioMeta=!1}},{key:"inputBuffer",get:function(){return this._context.getInstance(this.configs.inputbuffer)}},{key:"_tracks",get:function(){return this._context.getInstance("TRACKS")}}],[{key:"compaireArray",value:function(e,t,i){var n=0,r=0;if("Uint8Array"===i?(n=e.byteLength,r=t.byteLength):"Array"===i&&(n=e.length,r=t.length),n!==r)return!1;for(var a=0;a<n;a++)if(e[a]!==t[a])return!1;return!0}},{key:"compaireMeta",value:function(t,i,n){if(!t||!i)return!1;for(var r=0,a=Object.keys(t).length;r<a;r++){var s=t[Object.keys(t)[r]],o=i[Object.keys(t)[r]];if("object"!==(void 0===s?"undefined":gi(s))){if(n&&"duration"!==Object.keys(t)[r]&&"refSampleDuration"!==Object.keys(t)[r]&&"refSampleDurationFixed"!==Object.keys(t)[r]&&s!==o)return!1}else if(void 0!==s.byteLength){if(void 0===o.byteLength)return!1;if(!e.compaireArray(s,o,"Uint8Array"))return!1}else if(void 0!==s.length){if(void 0===o.length)return!1;if(!e.compaireArray(s,o,"Array"))return!1}else if(!e.compaireMeta(s,o))return!1}return!0}},{key:"Merge",value:function(e){for(var t=void 0,i=0,n=0,r=0;r<e.length;r++)i+=e[r].length-e[r].position;t=new Uint8Array(i);for(var a=0;a<e.length;a++){var s=e[a];t.set(new Uint8Array(s.buffer,s.position),n),n+=s.length-s.position}return new Ft(t.buffer)}},{key:"read",value:function(t,i,n){e.readHeader(t,i),e.readPayload(t,i,n),"MEDIA"!==i.header.packet||1!==i.header.payload||i.unknownPIDs||(i.pes=e.PES(i))}},{key:"readPayload",value:function(t,i,n){var r=i.header.pid;switch(r){case 0:e.PAT(t,i,n);break;case 1:e.CAT(t,i,n);break;case 2:e.TSDT(t,i,n);break;case 8191:break;default:if(n.pat.some(function(e){return e.pid===r}))e.PMT(t,i,n);else{var a=n.pmt?n.pmt.filter(function(e){return e.pid===r}):[];a.length>0?e.Media(t,i,Ei[a[0].streamType][0]):i.unknownPIDs=!0}}}},{key:"readHeader",value:function(e,t){var i={};i.sync=e.readUint8();var n=e.readUint16();i.error=n>>>15,i.payload=n>>>14&1,i.priority=n>>>13&1,i.pid=8191&n,n=e.readUint8(),i.scrambling=n>>6&3,i.adaptation=n>>4&3,i.continuity=15&n,i.packet=0===i.pid?"PAT":"MEDIA",t.header=i}},{key:"PAT",value:function(e,t,i){var n={},r=e.readUint8();e.skip(r),r=e.readUint8(),n.tabelID=r,r=e.readUint16(),n.error=r>>>7,n.zero=r>>>6&1,n.sectionLength=4095&r,n.streamID=e.readUint16(),n.current=1&e.readUint8(),n.sectionNumber=e.readUint8(),n.lastSectionNumber=e.readUint8();for(var a=(n.sectionLength-9)/4,s=[],o=0;o<a;o++){var u=e.readUint16(),l=8191&e.readUint16();s.push({program:u,pid:l,type:0===u?"network":"mapPID"})}s.length>0&&(i.pat=i.pat.concat(s)),n.list=s,n.program=e.readUint16(),n.pid=8191&e.readUint16(),t.payload=n}},{key:"PMT",value:function(e,t,i){var n={};t.header.packet="PMT";var r=e.readUint8();e.skip(r),r=e.readUint8(),n.tableID=r,r=e.readUint16(),n.sectionLength=4095&r,n.program=e.readUint16(),n.current=1&e.readUint8(),n.order=e.readUint8(),n.lastOrder=e.readUint8(),n.PCR_PID=8191&e.readUint16(),n.programLength=4095&e.readUint16();for(var a=(n.sectionLength-13)/5,s=[],o=0;o<a;o++)s.push({streamType:e.readUint8(),pid:8191&e.readUint16(),es:4095&e.readUint16()});n.list=s,this.pmt||(this.pmt=[]),i.pmt=this.pmt.concat(s.map(function(e){return{pid:e.pid,es:e.es,streamType:e.streamType,program:n.program}})),t.payload=n}},{key:"Media",value:function(e,t,i){var n=t.header,r={};if(n.type=i,3===n.adaptation&&(r.adaptationLength=e.readUint8(),r.adaptationLength>0)){var a=e.readUint8();r.discontinue=a>>>7,r.access=a>>>6&1,r.priority=a>>>5&1,r.PCR=a>>>4&1,r.OPCR=a>>>3&1,r.splicePoint=a>>>2&1,r.transportPrivate=a>>>1&1,r.adaptationField=1&a;var s=e.position;if(1===r.PCR&&(r.programClockBase=e.readUint32()<<1,a=e.readUint16(),r.programClockBase|=a>>>15,r.programClockExtension=511&a),1===r.OPCR&&(r.originProgramClockBase=e.readUint32()<<1,a=e.readUint16(),r.originProgramClockBase+=a>>>15,r.originProgramClockExtension=511&a),1===r.splicePoint&&(r.spliceCountdown=e.readUint8()),1===r.transportPrivate)for(var o=e.readUint8(),u=[],l=0;l<o;l++)u.push(e.readUint8());if(1===r.adaptationField){var h=e.readUint8(),f=e.readUint8(),d=e.position,c=f>>>6&1,p=f>>>5&1;1==f>>>7&&(f=e.readUint16(),r.ltwValid=f>>>15,r.ltwOffset=61439&f),1===c&&(f=e.readUint24(),r.piecewiseRate=4194303&f),1===p&&(f=e.readInt8(),r.spliceType=f>>>4,r.dtsNextAU1=f>>>1&7,r.marker1=1&f,f=e.readUint16(),r.dtsNextAU2=f>>>1,r.marker2=1&f,f=e.readUint16(),r.dtsNextAU3=f),e.skip(h-1-(e.position-d))}var v=r.adaptationLength-1-(e.position-s);e.skip(v)}r.stream=new Ft(e.buffer.slice(e.position)),t.payload=r}},{key:"PES",value:function(t){var i={},n=t.payload.stream;if(1!==n.readUint24())i.ES={},i.ES.buffer=n;else{var r=n.readUint8();r>=224&&r<=239&&(i.type="video"),r>=192&&r<=223&&(i.type="audio");var a=n.readUint16();if(i.packetLength=a,"video"!==i.type&&"audio"!==i.type)throw new Error("format is not supported");var s=n.readUint8();if(2!=s>>>6)throw new Error("error when parse pes header");s=n.readUint8(),i.ptsDTSFlag=s>>>6,i.escrFlag=s>>>5&1,i.esRateFlag=s>>>4&1,i.dsmFlag=s>>>3&1,i.additionalFlag=s>>>2&1,i.crcFlag=s>>>1&1,i.extensionFlag=1&s,i.pesHeaderLength=n.readUint8();var o=i.pesHeaderLength;if(2===i.ptsDTSFlag){var u=[];s=n.readUint8(),u.push(s>>>1&7),s=n.readUint16(),u.push(s>>>1),s=n.readUint16(),u.push(s>>>1),i.pts=u[0]<<30|u[1]<<15|u[2],o-=5,"video"===i.type&&(i.dts=i.pts)}if(3===i.ptsDTSFlag){var l=[];s=n.readUint8(),l.push(s>>>1&7),s=n.readUint16(),l.push(s>>>1),s=n.readUint16(),l.push(s>>>1),i.pts=l[0]<<30|l[1]<<15|l[2];var h=[];s=n.readUint8(),h.push(s>>>1&7),s=n.readUint16(),h.push(s>>>1),s=n.readUint16(),h.push(s>>>1),i.dts=h[0]<<30|h[1]<<15|h[2],o-=10}if(1===i.escrFlag){var f=[],d=[];s=n.readUint8(),f.push(s>>>3&7),f.push(3&s),s=n.readUint16(),f.push(s>>>13),f.push(3&s),s=n.readUint16(),f.push(s>>>13),d.push(3&s),s=n.readUint8(),d.push(s>>>1),i.escr=300*(f[0]<<30|f[1]<<28|f[2]<<15|f[3]<<13|f[4])+(d[0]<<7|d[1]),o-=6}if(1===i.esRateFlag&&(s=n.readUint24(),i.esRate=s>>>1&4194303,o-=3),1===i.dsmFlag)throw new Error("not support DSM_trick_mode");if(1===i.additionalFlag&&(s=n.readUint8(),i.additionalCopyInfo=127&s,o-=1),1===i.crcFlag&&(i.pesCRC=n.readUint16(),o-=2),1===i.extensionFlag)throw new Error("not support extension");o>0&&n.skip(o),i.ES=e.ES(n,i.type)}return i}},{key:"ES",value:function(t,i){var n=void 0,r={};if("video"===i){if(1!==(n=t.readUint32())&&(t.back(4),1!==(n=t.readUint24())))throw new Error("h264 nal header parse failed");t.skip(2),r.buffer=t}else{if("audio"!==i)throw new Error("ES "+i+" is not supported");if((n=t.readUint16())>>>4!=4095)throw new Error("aac ES parse Error");var a=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];r.id=0==(n>>>3&1)?"MPEG-4":"MPEG-2",r.layer=n>>>1&3,r.absent=1&n,n=t.readUint16(),r.audioObjectType=1+(n>>>14&3),r.profile=r.audioObjectType-1,r.frequencyIndex=n>>>10&15,r.frequence=a[r.frequencyIndex],r.channel=n>>>6&7,r.frameLength=(3&n)<<11|t.readUint16()>>>5,e.getAudioConfig(r),t.skip(1),r.buffer=t}return r}},{key:"TSDT",value:function(e,t,i){t.payload={}}},{key:"CAT",value:function(e,t,i){var n={};n.tableID=e.readUint8();var r=e.readUint16();n.sectionIndicator=r>>>7,n.sectionLength=4095&r,e.skip(2),r=e.readUint8(),n.version=r>>>3,n.currentNextIndicator=1&r,n.sectionNumber=e.readUint8(),n.lastSectionNumber=e.readUint8(),this.sectionLength,n.crc32=e.readUint32(),t.payload=n}},{key:"getAudioConfig",value:function(e){var t=navigator.userAgent.toLowerCase(),i=void 0,n=void 0;/firefox/i.test(t)?e.frequencyIndex>=6?(e.audioObjectType=5,i=new Array(4),n=e.frequencyIndex-3):(e.audioObjectType=2,i=new Array(2),n=e.frequencyIndex):-1!==t.indexOf("android")?(e.audioObjectType=2,i=new Array(2),n=e.frequencyIndex):(e.audioObjectType=5,i=new Array(4),e.frequencyIndex>=6?n=e.frequencyIndex-3:(1===e.channel&&(e.audioObjectType=2,i=new Array(2)),n=e.frequencyIndex)),i[0]=e.audioObjectType<<3,i[0]|=(14&e.frequencyIndex)>>1,i[1]=(1&e.frequencyIndex)<<7,i[1]|=e.channel<<3,5===e.audioObjectType&&(i[1]|=(14&n)>>1,i[2]=(1&n)<<7,i[2]|=8,i[3]=0),e.audioConfig=i}}])}(),function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}()),Ai=(function(){function e(t){V(this,e),this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0,this.fragLength=0,this._lastget=void 0,this._audoclear=t.autoclear||!1}bi(e,[{key:"push",value:function(e,t,i){this._ts[e]||(this._ts[e]={duration:t,downloaded:!1,downloading:!1,start:this.duration,discontinue:!!i},this._list[this.duration]=e,this.duration+=t,this.fragLength+=1)}},{key:"deleteFrag",value:function(e){this._ts[e]&&(this._ts[e].start>this._lastget.time&&(this._lastget={duration:this._ts[e].duration,time:this._ts[e].start,downloaded:!1,downloading:!1,url:e}),delete this._list[this._ts[e].start],delete this._ts[e],this.fragLength-=1)}},{key:"pushM3U8",value:function(e,t){if(!e)throw new Error("No m3u8 data received.");if(this.version=e.version,this.targetduration=e.targetduration,e.encrypt&&!this.encrypt&&(this.encrypt=e.encrypt),!(e.sequence>this.sequence))throw new Error("Old m3u8 file received, "+e.sequence);this.sequence=e.sequence;for(var i=[],n=0;n<e.frags.length;n++){var r=e.frags[n];this._ts[r.url]||(i.push(r.url),this.push(r.url,r.duration,r.discontinue))}if(i.length<1)throw new Error("Can not read ts file list.");if(t)for(var a=this.getTsList(),s=0;s<a.length;s++)i.indexOf(a[s])<0&&this.deleteFrag(a[s])}},{key:"getTsList",value:function(){return Object.keys(this._ts)}},{key:"downloaded",value:function(e,t){var i=this._ts[e];i&&(i.downloaded=t)}},{key:"downloading",value:function(e,t){var i=this._ts[e];i&&(i.downloading=t)}},{key:"getTsByName",value:function(e){return this._ts[e]}},{key:"getTs",value:function(e){var t=Object.keys(this._list),i=void 0;if(void 0===e&&(e=this._lastget?this._lastget.time+this._lastget.duration:0),!(t.length<1||e>=this.duration)){t.sort(function(e,t){return parseFloat(e)-parseFloat(t)});for(var n=0;n<t.length&&e>=parseInt(t[n]);n++){var r=this._list[t[n]];i={url:r,downloaded:this._ts[r].downloaded,downloading:this._ts[r].downloading,time:parseInt(t[n]),duration:parseInt(this._ts[r].duration)},this.autoclear&&(delete this._ts[this._lastget.url],delete this._list[this._lastget.time]),this._lastget=i}return i}}},{key:"clear",value:function(){this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0}},{key:"clearDownloaded",value:function(){for(var e=0,t=Object.keys(this._ts).length;e<t;e++){var i=this._ts[Object.keys(this._ts)[e]];i.downloaded=!1,i.downloading=!1}}},{key:"destroy",value:function(){this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0,this.fragLength=0,this._lastget=void 0,this._audoclear=!1}},{key:"list",get:function(){return this._list}},{key:"baseURL",set:function(e){this.baseURL!==e&&(this.clear(),this._baseURL=e)},get:function(){return this._baseURL}}])}(),function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}()),Si={NUMBER:0,BOOLEAN:1,STRING:2,OBJECT:3,MIX_ARRAY:8,OBJECT_END:9,STRICT_ARRAY:10,DATE:11,LONE_STRING:12},wi=function(){function e(){G(this,e),this.offset=0,this.readOffset=this.offset}return Ai(e,[{key:"resolve",value:function(e,t){if(t<3)throw new Error("not enough data for metainfo");var i={},n=this.parseValue(e),r=this.parseValue(e,t-n.bodySize);return i[n.data]=r.data,this.resetStatus(),i}},{key:"resetStatus",value:function(){this.offset=0,this.readOffset=this.offset}},{key:"parseString",value:function(e){var t=new DataView(e,this.readOffset).getUint16(0,!Lt),i="";i=t>0?xt.decode(new Uint8Array(e,this.readOffset+2,t)):"";var n=t+2;return this.readOffset+=n,{data:i,bodySize:t+2}}},{key:"parseDate",value:function(e,t){var i=new DataView(e,this.readOffset,t),n=i.getFloat64(0,!Lt);return n+=60*i.getInt16(8,!Lt)*1e3,this.readOffset+=10,{data:new Date(n),bodySize:10}}},{key:"parseObject",value:function(e,t){var i=this.parseString(e,t),n=this.parseValue(e,t-i.bodySize);return{data:{name:i.data,value:n.data},bodySize:i.bodySize+n.bodySize,isObjEnd:n.isObjEnd}}},{key:"parseLongString",value:function(e){var t=new DataView(e,this.readOffset).getUint32(0,!Lt),i="";return i=t>0?xt.decode(new Uint8Array(e,this.readOffset+2,t)):"",this.readOffset+=t+4,{data:i,bodySize:t+4}}},{key:"parseValue",value:function(e,t){var i=new ArrayBuffer;i=e instanceof ArrayBuffer?e:e.buffer;var n=Si.NUMBER,r=Si.BOOLEAN,a=Si.STRING,s=Si.OBJECT,o=Si.MIX_ARRAY,u=Si.OBJECT_END,l=Si.STRICT_ARRAY,h=Si.DATE,f=Si.LONE_STRING,d=new DataView(i,this.readOffset,t),c=!1,p=d.getUint8(0),v=1;this.readOffset+=1;var y=null;switch(p){case n:y=d.getFloat64(1,!Lt),this.readOffset+=8,v+=8;break;case r:y=!!d.getUint8(1),this.readOffset+=1,v+=1;break;case a:var m=this.parseString(i);y=m.data,v+=m.bodySize;break;case s:y={};var g=0;for(16777215&d.getUint32(t-4,!Lt)&&(g=3);v<t-4;){var _=this.parseObject(i,t-v-g);if(_.isObjectEnd)break;y[_.data.name]=_.data.value,v+=_.bodySize}v<=t-3&&9==(16777215&d.getUint32(v-1,!Lt))&&(this.readOffset+=3,v+=3);break;case o:y={},v+=4,this.readOffset+=4;var k=0;for(9==(16777215&d.getUint32(t-4,!Lt))&&(k=3);v<t-8;){var E=this.parseObject(i,t-v-k);if(E.isObjectEnd)break;y[E.data.name]=E.data.value,v+=E.bodySize}v<=t-3&&9==(16777215&d.getUint32(v-1,!Lt))&&(v+=3,this.readOffset+=3);break;case u:y=null,c=!0;break;case l:y=[];var b=d.getUint32(1,!Lt);v+=4,this.readOffset+=4;for(var A=0;A<b;A++){var S=this.parseValue(i,t-v);y.push(S.data),v+=S.bodySize}break;case h:var w=this.parseDate(i,t-1);y=w.data,v+=w.bodySize;break;case f:var T=this.parseLongString(i,t-1);y=T.data,v+=T.bodySize;break;default:v=t}return{data:y,bodySize:v,isObjEnd:c}}}]),e}(),Ti=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Di=Rt.DEMUX_EVENTS,Ri=function(){function e(){z(this,e),this._firstFragmentLoaded=!1,this._trackNum=0,this._hasScript=!1}return Ti(e,[{key:"init",value:function(){this.on(Di.DEMUX_START,this.doParseFlv.bind(this))}},{key:"doParseFlv",value:function(){if(this._firstFragmentLoaded){if(this.loaderBuffer.length<11)return;var e=void 0,t=1e4;do{e=this._parseFlvTag()}while(e&&t-- >0);this.emit(Di.DEMUX_COMPLETE)}else{if(this.loaderBuffer.length<13)return;var i=this.loaderBuffer.shift(13);this.parseFlvHeader(i),this.doParseFlv()}}},{key:"parseFlvHeader",value:function(t){if(e.isFlvFile(t)){this._firstFragmentLoaded=!0;var i=e.getPlayType(t[4]);i.hasVideo&&this.initVideoTrack(),i.hasAudio&&this.initAudioTrack()}else this.emit(Di.DEMUX_ERROR,new Error("invalid flv file")),this.doParseFlv();this.doParseFlv()}},{key:"initVideoTrack",value:function(){this._trackNum++;var e=new vi;e.meta=new Bt,e.id=e.meta.id=this._trackNum,this.tracks.videoTrack=e}},{key:"initAudioTrack",value:function(){this._trackNum++;var e=new pi;e.meta=new Ct,e.id=e.meta.id=this._trackNum,this.tracks.audioTrack=e}},{key:"_parseFlvTag",value:function(){if(this.loaderBuffer.length<11)return null;var e=this._parseFlvTagHeader();return e&&this._processChunk(e),e}},{key:"_parseFlvTagHeader",value:function(){var e=0,t={},i=this.loaderBuffer.toInt(e,1);if(e+=1,t.filtered=(32&i)>>>5,t.tagType=31&i,t.datasize=this.loaderBuffer.toInt(e,3),e+=3,8!==t.tagType&&9!==t.tagType&&11!==t.tagType&&18!==t.tagType||0!==this.loaderBuffer.toInt(8,3))return this.loaderBuffer&&this.loaderBuffer.length>0&&this.loaderBuffer.shift(1),this.emit(Di.DEMUX_ERROR,this.TAG,new Error("tagType "+t.tagType),!1),null;if(this.loaderBuffer.length<t.datasize+15)return null;this.loaderBuffer.shift(4);var n=this.loaderBuffer.toInt(0,3);this.loaderBuffer.shift(3);var r=this.loaderBuffer.shift(1)[0];return r>0&&(n+=16777216*r),t.dts=n,this.loaderBuffer.shift(3),t}},{key:"_processChunk",value:function(e){switch(e.tagType){case 18:this._parseScriptData(e);break;case 8:this._parseAACData(e);break;case 9:this._parseHevcData(e);break;case 11:this.loaderBuffer.shift(3);break;default:this.loaderBuffer.shift(1)}}},{key:"_parseScriptData",value:function(e){var t=this.tracks.audioTrack,i=this.tracks.videoTrack,n=this.loaderBuffer.shift(e.datasize),r=(new wi).resolve(n,n.length),a=this._context.onMetaData=r?r.onMetaData:void 0;if(this._context.mediaInfo.duration=a.duration,this._context.mediaInfo.hasVideo=a.hasVideo,this._context.mediaInfo.hsaAudio=a.hasAudio,this._datasizeValidator(e.datasize)&&(this.emit(Di.MEDIA_INFO),this._hasScript=!0),t&&!t.hasSpecificConfig){var s=t.meta;switch(a.audiosamplerate&&(s.sampleRate=a.audiosamplerate),a.audiochannels&&(s.channelCount=a.audiochannels),a.audiosamplerate){case 44100:s.sampleRateIndex=4;break;case 22050:s.sampleRateIndex=7;break;case 11025:s.sampleRateIndex=10}}if(i&&!i.hasSpecificConfig){var o=i.meta;if("number"==typeof a.framerate){var u=Math.floor(1e3*a.framerate);if(u>0){var l=u/1e3;o.frameRate||(o.frameRate={}),o.frameRate.fixed=!0,o.frameRate.fps=l,o.frameRate.fps_num=u,o.frameRate.fps_den=1e3}}}}},{key:"_aacSequenceHeaderParser",value:function(e){var t={};t.hasSpecificConfig=!0,t.objectType=e[1]>>>3,t.sampleRateIndex=(7&e[1])<<1|e[2]>>>7,t.audiosamplerate=this._switchAudioSampleRate(t.sampleRateIndex),t.channelCount=(120&e[2])>>>3,t.frameLength=(4&e[2])>>>2,t.dependsOnCoreCoder=(2&e[2])>>>1,t.extensionFlagIndex=1&e[2],t.codec="mp4a.40."+t.objectType;var i=window.navigator.userAgent.toLowerCase(),n=void 0,r=void 0,a=t.sampleRateIndex;return-1!==i.indexOf("firefox")?t.sampleRateIndex>=6?(t.objectType=5,r=new Array(4),n=a-3):(t.objectType=2,r=new Array(2),n=a):-1!==i.indexOf("android")?(t.objectType=2,r=new Array(2),n=a):(t.objectType=5,n=t.sampleRateIndex,r=new Array(4),t.sampleRateIndex>=6?n=t.sampleRateIndex-3:1===t.channelCount&&(t.objectType=2,r=new Array(2),n=t.sampleRateIndex)),r[0]=t.objectType<<3,r[0]|=(15&t.sampleRateIndex)>>>1,r[1]=(15&t.sampleRateIndex)<<7,r[1]|=(15&t.channelCount)<<3,5===t.objectType&&(r[1]|=(15&n)>>>1,r[2]=(1&n)<<7,r[2]|=8,r[3]=0),t.config=r,t}},{key:"_parseAACData",value:function(e){var t=this.tracks.audioTrack;if(t){var i=t.meta;i||(t.meta=new Ct,i=t.meta);var n=this.loaderBuffer.shift(1)[0];e.data=this.loaderBuffer.shift(e.datasize-1);var r=(240&n)>>>4;t.format=r,10!==r&&this.emit(Di.DEMUX_ERROR,new Error("invalid audio format: "+r)),10!==r||this._hasAudioSequence||(i.sampleRate=this._switchAudioSamplingFrequency(n),i.sampleRateIndex=(12&n)>>>2,i.frameLenth=(2&n)>>>1,i.channelCount=1&n,i.refSampleDuration=Math.floor(1024/i.audioSampleRate*i.timescale));var a=i.audioSampleRate,s=i.sampleRateIndex,o=i.refSampleDuration;delete e.tagType;var u=this._datasizeValidator(e.datasize);if(0===e.data[0]){var l=this._aacSequenceHeaderParser(e.data);a=l.audiosamplerate||i.audioSampleRate,s=l.sampleRateIndex||i.sampleRateIndex,o=Math.floor(1024/a*i.timescale),i.channelCount=l.channelCount,i.sampleRate=a,i.sampleRateIndex=s,i.refSampleDuration=o,i.duration=this._context.mediaInfo.duration*i.timescale,i.config=l.config;var h=this._context.mediaInfo.audio;h.codec=l.codec,h.channelCount=l.channelCount,h.sampleRate=a,h.sampleRateIndex=l.audioSampleRateIndex,this._hasScript&&!this._hasAudioSequence?this.emit(Di.METADATA_PARSED,"audio"):this._hasScript&&this._hasAudioSequence&&this.emit(Di.AUDIO_METADATA_CHANGE),this._hasAudioSequence=!0,this._metaChange=!0}else this._metaChange&&(e.options={meta:t.meta},this._metaChange=!1),e.data=e.data.slice(1,e.data.length),t.samples.push(e);u||this.emit(Di.DEMUX_ERROR,this.TAG,new Error("TAG length error at "+e.datasize),!1)}}},{key:"_parseHevcData",value:function(e){var t=this.loaderBuffer.shift(1)[0];e.frameType=(240&t)>>>4,e.isKeyframe=1===e.frameType;var i=15&t;if(this.tracks.videoTrack.codecID=i,e.avcPacketType=this.loaderBuffer.shift(1)[0],e.cts=this.loaderBuffer.toInt(0,3),this.loaderBuffer.shift(3),12===i){var n=this.loaderBuffer.shift(e.datasize-5);if(e.data=n,0!==Number.parseInt(e.avcPacketType)){this._datasizeValidator(e.datasize)||this.emit(Di.DEMUX_ERROR,this.TAG,new Error("invalid video tag datasize: "+e.datasize),!1);var r={},a=0;for(r.cts=e.cts,r.dts=e.dts;e.data.length>a;){var s=e.data.slice(Number.parseInt(a),4+a);r.size=s[3],r.size+=256*s[2],r.size+=256*s[1]*256,r.size+=256*s[0]*256*256,a+=4,r.data=e.data.slice(Number.parseInt(a),r.size+a),a+=r.size,this.tracks.videoTrack.samples.push(r),this.emit(Di.METADATA_PARSED,"video")}}else 0===Number.parseInt(e.avcPacketType)&&(this._datasizeValidator(e.datasize)?this.emit(Di.METADATA_PARSED,"video"):this.emit(Di.DEMUX_ERROR,this.TAG,new Error("invalid video tag datasize: "+e.datasize),!1))}else if(7===i){var o=this.loaderBuffer.shift(e.datasize-5);if(0===o[4]&&0===o[5]&&0===o[6]&&1===o[7]){for(var u=0,l=0;l<4;l++)u=256*u+o[l];u-=4,(o=o.slice(4,o.length))[3]=u%256,u=(u-o[3])/256,o[2]=u%256,u=(u-o[2])/256,o[1]=u%256,o[0]=(u-o[1])/256}if(e.data=o,0===e.avcPacketType)this._avcSequenceHeaderParser(e.data),this._datasizeValidator(e.datasize)&&(this._hasScript&&!this._hasVideoSequence?this.emit(Di.METADATA_PARSED,"video"):this._hasScript&&this._hasVideoSequence&&this.emit(Di.VIDEO_METADATA_CHANGE),this._hasVideoSequence=!0),this._metaChange=!0;else{if(!this._datasizeValidator(e.datasize))return void this.emit(Di.DEMUX_ERROR,this.TAG,new Error("invalid video tag datasize: "+e.datasize),!1);this._metaChange&&(e.options={meta:Object.assign({},this.tracks.videoTrack.meta)},this._metaChange=!1),this.tracks.videoTrack.samples.push(e)}}else this.emit(Di.DEMUX_ERROR,this.TAG,new Error("video codeid is "+i),!1),e.data=this.loaderBuffer.shift(e.datasize-1),this._datasizeValidator(e.datasize)||this.emit(Di.DEMUX_ERROR,this.TAG,new Error("invalid video tag datasize: "+e.datasize),!1),this.tracks.videoTrack.samples.push(e),this.emit(Di.DEMUX_COMPLETE);delete e.tagType}},{key:"_avcSequenceHeaderParser",value:function(e){var t=this.tracks.videoTrack;if(t){var i=0;t.meta||(t.meta=new Bt);var n=t.meta;n.configurationVersion=e[0],n.avcProfileIndication=e[1],n.profileCompatibility=e[2],n.avcLevelIndication=e[3]/10,n.nalUnitLength=1+(3&e[4]);var r=31&e[5];i=6;for(var a={},s=0;s<r;s++){var o=255*e[i]+e[i+1];i+=2;for(var u=new Uint8Array(o),l=0;l<o;l++)u[l]=e[i+l];for(var h="avc1.",f=1;f<4;f++){var d=u[f].toString(16);d.length<2&&(d="0"+d),h+=d}n.codec=h,i+=o,this.tracks.videoTrack.meta.sps=u,a=ii.parseSPS(u)}var c=e[i];i++;for(var p=0;p<c;p++){var v=255*e[i]+e[i+1];i+=2;for(var y=new Uint8Array(v),m=0;m<v;m++)y[m]=e[i+m];i+=v,this.tracks.videoTrack.meta.pps=y}Object.assign(n,ii.toVideoMeta(a));var g=this._context.mediaInfo.video;g.codec=n.codec,g.profile=n.profile,g.level=n.level,g.chromaFormat=n.chromaFormat,g.frameRate=n.frameRate,g.parRatio=n.parRatio,g.width=g.width===n.presentWidth?g.width:n.presentWidth,g.height=g.height===n.presentHeight?g.width:n.presentHeight,n.duration=this._context.mediaInfo.duration*n.timescale,n.avcc=new Uint8Array(e.length),n.avcc.set(e),t.meta=n}}},{key:"_switchAudioSampleRate",value:function(e){return[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][e]}},{key:"_switchAudioSamplingFrequency",value:function(e){return[5500,11025,22050,44100,48e3][(12&e)>>>2]}},{key:"_switchAudioChannel",value:function(e){return[1,2][1&e]}},{key:"_datasizeValidator",value:function(e){var t=this.loaderBuffer.toInt(0,4);return this.loaderBuffer.shift(4),t===e+11}},{key:"loaderBuffer",get:function(){var e=this._context.getInstance("LOADER_BUFFER");if(e)return e;this.emit(Di.DEMUX_ERROR,new Error("找不到 loaderBuffer 实例"))}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"logger",get:function(){return this._context.getInstance("LOGGER")}}],[{key:"isFlvFile",value:function(e){return!(70!==e[0]||76!==e[1]||86!==e[2]||1!==e[3])}},{key:"getPlayType",value:function(e){var t={hasVideo:!1,hasAudio:!1};return!0&e&&(t.hasVideo=!0),!0&e&&(t.hasAudio=!0),t}}]),e}(),Oi=Rt.REMUX_EVENTS,Li=Rt.DEMUX_EVENTS,xi=Rt.LOADER_EVENTS,Ui=Rt.MSE_EVENTS,Ci="FLVController",Bi=function(){function e(){Me(this,e)}return Ie(e,[{key:"warn",value:function(){}}]),e}(),Mi=function(){function t(e){Me(this,t),this.TAG=Ci,this._player=e,this.state={initSegmentArrived:!1,randomAccessPoints:[]},this.bufferClearTimer=null}return Ie(t,[{key:"init",value:function(){this._context.registry("FETCH_LOADER",Wt),this._context.registry("LOADER_BUFFER",yi),this._context.registry("FLV_DEMUXER",Ri),this._context.registry("TRACKS",ci),this._context.registry("MP4_REMUXER",Xt.Mp4Remuxer),this._context.registry("PRE_SOURCE_BUFFER",mi),!1!==this._player.config.compatibility&&this._context.registry("COMPATIBILITY",ni),this._context.registry("LOGGER",Bi),this.mse=this._context.registry("MSE",Pt)({container:this._player.video}),this._handleTimeUpdate=this._handleTimeUpdate.bind(this),this.initListeners()}},{key:"initListeners",value:function(){this.on(xi.LOADER_DATALOADED,this._handleLoaderDataLoaded.bind(this)),this.on(xi.LOADER_ERROR,this._handleNetworkError.bind(this)),this.on(Li.MEDIA_INFO,this._handleMediaInfo.bind(this)),this.on(Li.METADATA_PARSED,this._handleMetadataParsed.bind(this)),this.on(Li.DEMUX_COMPLETE,this._handleDemuxComplete.bind(this)),this.on(Li.DEMUX_ERROR,this._handleDemuxError.bind(this)),this.on(Oi.INIT_SEGMENT,this._handleAppendInitSegment.bind(this)),this.on(Oi.MEDIA_SEGMENT,this._handleMediaSegment.bind(this)),this.on(Oi.RANDOM_ACCESS_POINT,this._handleAddRAP.bind(this)),this.on(Ui.SOURCE_UPDATE_END,this._handleSourceUpdateEnd.bind(this)),this._player.on("timeupdate",this._handleTimeUpdate)}},{key:"_handleMediaInfo",value:function(){this._context.mediaInfo||this.emit(Li.DEMUX_ERROR,new Error("failed to get mediainfo"))}},{key:"_handleLoaderDataLoaded",value:function(){this.emitTo("FLV_DEMUXER",Li.DEMUX_START)}},{key:"_handleMetadataParsed",value:function(e){this.emit(Oi.REMUX_METADATA,e)}},{key:"_handleDemuxComplete",value:function(){this.emit(Oi.REMUX_MEDIA)}},{key:"_handleAppendInitSegment",value:function(){this.state.initSegmentArrived=!0,this.mse.addSourceBuffers()}},{key:"_handleMediaSegment",value:function(){this.mse.addSourceBuffers(),this.mse.doAppend()}},{key:"_handleSourceUpdateEnd",value:function(){var e=this._player.currentTime,t=this._player.video,i=this._player.config.preloadTime||5,n=t.buffered.length;if(0!==n){var r=t.buffered.end(n-1);r-e>2*i&&(this._player.currentTime=r-i),this.mse.doAppend()}}},{key:"_handleTimeUpdate",value:function(){var e=this,t=this._player.currentTime,i=this._player.video,n=i.buffered;if(n&&n.length){var r=[0,0],a=i.currentTime;if(n)for(var s=0,o=n.length;s<o&&(r[0]=n.start(s),r[1]=n.end(s),!(r[0]<=a&&a<=r[1]));s++);var u=r[0],l=r[1];if(a>l||a<u)return void(i.currentTime=u);if(t-u>10||n.length>1){if(this.bufferClearTimer||!this.state.randomAccessPoints.length)return;for(var h=1/0,f=0;f<this.state.randomAccessPoints.length;f++){var d=Math.ceil(this.state.randomAccessPoints[f]/1e3);if(d>t-10)break;h=d}this.mse.remove(Math.max(Math.min(h,t-10,l-10),.1),0),this.bufferClearTimer=setTimeout(function(){e.bufferClearTimer=null},5e3)}}}},{key:"_handleNetworkError",value:function(t,i){this._player.emit("error",new e.Errors("network",this._player.config.url)),this._onError(xi.LOADER_ERROR,t,i,!0)}},{key:"_handleDemuxError",value:function(t,i,n){void 0===n&&(n=!1),this._player.emit("error",new e.Errors("parse",this._player.config.url)),this._onError(Li.DEMUX_ERROR,t,i,n)}},{key:"_handleAddRAP",value:function(e){this.state.randomAccessPoints&&this.state.randomAccessPoints.push(e)}},{key:"_onError",value:function(e,t,i,n){var r={errorType:e,errorDetails:"["+t+"]: "+i.message,errorFatal:n||!1};this._player.emit("FLV_ERROR",r)}},{key:"seek",value:function(){this.state.initSegmentArrived||this.loadData()}},{key:"loadData",value:function(){this.emit(xi.LADER_START,this._player.config.url)}},{key:"pause",value:function(){var e=this._context.getInstance("FETCH_LOADER");e&&e.cancel()}},{key:"destroy",value:function(){this._player.off("timeupdate",this._handleTimeUpdate),this._player=null,this.mse=null,this.state.randomAccessPoints=[]}}]),t}(),Ii=Rt.FlvAllowedEvents,Pi=function(t){function i(e){Me(this,i);var t=Ne(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,e));return t.context=new Dt(Ii),t.initEvents(),t.loaderCompleteTimer=null,t}return Fe(i,t),Ie(i,[{key:"start",value:function(){this.initFlv(),this.context.init(),Pe(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"start",this).call(this,this.flv.mse.url)}},{key:"initFlvEvents",value:function(t){var i=this,n=this;t.once(Rt.REMUX_EVENTS.INIT_SEGMENT,function(){if(e.util.addClass(n.root,"xgplayer-is-live"),!e.util.findDom(i.root,"xg-live")){var t=e.util.createDom("xg-live","正在直播",{},"xgplayer-live");n.controls.appendChild(t)}}),t.once(Rt.LOADER_EVENTS.LOADER_COMPLETE,function(){n.paused?n.emit("ended"):i.loaderCompleteTimer=setInterval(function(){var e=n.getBufferedRange()[1];Math.abs(n.currentTime-e)<.5&&(n.emit("ended"),window.clearInterval(i.loaderCompleteTimer))},200)})}},{key:"initEvents",value:function(){var e=this;this.on("timeupdate",function(){e.loadData()}),this.on("seeking",function(){var t=e.currentTime,i=e.getBufferedRange();(t>i[1]||t<i[0])&&e.flv.seek(e.currentTime)})}},{key:"initFlv",value:function(){var e=this.context.registry("FLV_CONTROLLER",Mi)(this);this.initFlvEvents(e),this.flv=e}},{key:"play",value:function(){var e=this;return this._hasStart?this._destroy().then(function(){e.context=new Dt(Ii);var t=e.context.registry("FLV_CONTROLLER",Mi)(e);return e.initFlvEvents(t),e.flv=t,e.context.init(),Pe(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"start",e).call(e,t.mse.url),Pe(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"play",e).call(e)}):Pe(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"play",this).call(this)}},{key:"pause",value:function(){Pe(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"pause",this).call(this),this.flv&&this.flv.pause()}},{key:"loadData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.currentTime;this.flv&&this.flv.seek(e)}},{key:"destroy",value:function(){var e=this;this._destroy().then(function(){Pe(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",e).call(e)})}},{key:"_destroy",value:function(){var e=this;return this.flv.mse.destroy().then(function(){e.context.destroy(),e.flv=null,e.context=null,e.loaderCompleteTimer&&window.clearInterval(e.loaderCompleteTimer)})}},{key:"src",get:function(){return this.currentSrc},set:function(e){var t=this;this.player.config.url=e,this.paused?this.start(e):(this.pause(),this.once("pause",function(){t.start(e)}),this.once("canplay",function(){t.play()})),this.once("canplay",function(){t.currentTime=0})}}]),i}(e),Fi=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Ni=function(e){for(var t in e)if(e.hasOwnProperty(t)&&null===e[t])return!1;return!0},ji=function(){function e(){X(this,e),this.mimeType=null,this.duration=null,this.hasVideo=null,this.video={codec:null,width:null,height:null,profile:null,level:null,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},chromaFormat:null,parRatio:{width:1,height:1}},this.hasAudio=null,this.audio={codec:null,sampleRate:null,sampleRateIndex:null,channelCount:null}}return Fi(e,[{key:"isComplete",value:function(){return e.isBaseInfoReady(this)&&e.isVideoReady(this)&&e.isAudioReady(this)}}],[{key:"isBaseInfoReady",value:function(e){return Ni(e)}},{key:"isVideoReady",value:function(e){return!e.hasVideo||Ni(e.video)}},{key:"isAudioReady",value:function(e){return!e.hasAudio||Ni(e.video)}}]),e}();H.prototype=Object.create(null),W.EventEmitter=W,W.usingDomains=!1,W.prototype.domain=void 0,W.prototype._events=void 0,W.prototype._maxListeners=void 0,W.defaultMaxListeners=10,W.init=function(){this.domain=null,W.usingDomains&&(void 0).active&&(void 0).Domain,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new H,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},W.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},W.prototype.getMaxListeners=function(){return q(this)},W.prototype.emit=function(e){var t,i,n,r,a,s,o,u="error"===e;if(s=this._events)u=u&&null==s.error;else if(!u)return!1;if(o=this.domain,u){if(t=arguments[1],!o){if(t instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=o,t.domainThrown=!1,o.emit("error",t),!1}if(!(i=s[e]))return!1;var h="function"==typeof i;switch(n=arguments.length){case 1:K(i,h,this);break;case 2:Y(i,h,this,arguments[1]);break;case 3:J(i,h,this,arguments[1],arguments[2]);break;case 4:Z(i,h,this,arguments[1],arguments[2],arguments[3]);break;default:for(r=new Array(n-1),a=1;a<n;a++)r[a-1]=arguments[a];Q(i,h,this,r)}return!0},W.prototype.addListener=function(e,t){return $(this,e,t,!1)},W.prototype.on=W.prototype.addListener,W.prototype.prependListener=function(e,t){return $(this,e,t,!0)},W.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,te(this,e,t)),this},W.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,te(this,e,t)),this},W.prototype.removeListener=function(e,t){var i,n,r,a,s;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(n=this._events))return this;if(!(i=n[e]))return this;if(i===t||i.listener&&i.listener===t)0==--this._eventsCount?this._events=new H:(delete n[e],n.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(r=-1,a=i.length;a-- >0;)if(i[a]===t||i[a].listener&&i[a].listener===t){s=i[a].listener,r=a;break}if(r<0)return this;if(1===i.length){if(i[0]=void 0,0==--this._eventsCount)return this._events=new H,this;delete n[e]}else ne(i,r);n.removeListener&&this.emit("removeListener",e,s||t)}return this},W.prototype.removeAllListeners=function(e){var t,i;if(!(i=this._events))return this;if(!i.removeListener)return 0===arguments.length?(this._events=new H,this._eventsCount=0):i[e]&&(0==--this._eventsCount?this._events=new H:delete i[e]),this;if(0===arguments.length){for(var n,r=Object.keys(i),a=0;a<r.length;++a)"removeListener"!==(n=r[a])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=new H,this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},W.prototype.listeners=function(e){var t,i=this._events;return i&&(t=i[e])?"function"==typeof t?[t.listener||t]:ae(t):[]},W.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):ie.call(e,t)},W.prototype.listenerCount=ie,W.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var Vi="function"==typeof Symbol&&"symbol"==Re(Symbol.iterator)?function(e){return void 0===e?"undefined":Re(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":Re(e)},Gi=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},zi=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Xi=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in r)return r.value;var s=r.get;return void 0!==s?s.call(n):void 0},Hi=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Re(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},Wi=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=(void 0===t?"undefined":Re(t))&&"function"!=typeof t?e:t},qi=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in r)return r.value;var s=r.get;return void 0!==s?s.call(n):void 0},Ki=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Yi=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];ue(this,e),this._emitter=new W,this._instanceMap={},this._clsMap={},this._inited=!1,this.mediaInfo=new ji,this.allowedEvents=t,this._hooks={},this._emitCounter={}}return Ki(e,[{key:"getInstance",value:function(e){return this._instanceMap[e]||null}},{key:"initInstance",value:function(e){if(this._clsMap[e]){for(var t=arguments.length,i=Array(t>1?t-1:0),n=1;n<t;n++)i[n-1]=arguments[n];var r=new(Function.prototype.bind.apply(this._clsMap[e],[null].concat(i)));return this._instanceMap[e]=r,r.init&&r.init(),r}throw new Error(e+"未在context中注册")}},{key:"init",value:function(e){if(!this._inited){for(var t in this._clsMap)this._clsMap.hasOwnProperty(t)&&!this._instanceMap[t]&&this.initInstance(t,e);this._inited=!0}}},{key:"registry",value:function(e,t){var i=this,n=this._emitter,r=this._isMessageNameValid.bind(this),a=this,s=function(t){function i(t,n,r){ue(this,i);var s=se(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,n,r));return s.listeners={},s.onceListeners={},s.TAG=e,s._context=a,s}return oe(i,t),Ki(i,[{key:"on",value:function(t,i){return r(t),this.listeners[t]?this.listeners[t].push(i):this.listeners[t]=[i],n.on(t+"__TO__"+e,i),n.on(t,i)}},{key:"before",value:function(e,t){r(e),a._hooks[e]?a._hooks[e].push(t):a._hooks[e]=[t]}},{key:"once",value:function(t,i){return r(t),this.onceListeners[t]?this.onceListeners[t].push(i):this.onceListeners[t]=[i],n.once(t+"__TO__"+e,i),n.once(t,i)}},{key:"emit",value:function(e){r(e),a._emitCounter[e]?(a._emitCounter[e]+=1,a._emitCounter[e]%1e3==0&&window.console&&(window.console.warn("invoke: ",e),window.localStorage.setItem("xgplayer_invoke_"+e,a._emitCounter[e]))):a._emitCounter[e]=1;var t=a._hooks?a._hooks[e]:null;if(t)for(var i=0,s=t.length;i<s;i++)(0,t[i])();for(var o=arguments.length,u=Array(o>1?o-1:0),l=1;l<o;l++)u[l-1]=arguments[l];return n.emit.apply(n,[e].concat(u))}},{key:"emitTo",value:function(e,t){r(t);for(var i=arguments.length,a=Array(i>2?i-2:0),s=2;s<i;s++)a[s-2]=arguments[s];return n.emit.apply(n,[t+"__TO__"+e].concat(a))}},{key:"off",value:function(e,t){return r(e),n.off(e,t)}},{key:"removeListeners",value:function(){var t=Object.prototype.hasOwnProperty.bind(this.listeners);for(var i in this.listeners)if(t(i))for(var r=this.listeners[i]||[],a=0;a<r.length;a++){var s=r[a];n.off(i,s),n.off(i+"__TO__"+e,s)}for(var o in this.onceListeners)if(t(o))for(var u=this.onceListeners[o]||[],l=0;l<u.length;l++){var h=u[l];n.off(o,h),n.off(o+"__TO__"+e,h)}}},{key:"destroy",value:function(){if(this.removeListeners(),this.listeners={},delete a._instanceMap[e],qi(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this))return qi(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this)}}]),i}(t);return this._clsMap[e]=s,function(){for(var t=arguments.length,n=Array(t),r=0;r<t;r++)n[r]=arguments[r];return i.initInstance.apply(i,[e].concat(n))}}},{key:"destroyInstances",value:function(){var e=this;Object.keys(this._instanceMap).forEach(function(t){e._instanceMap[t].destroy&&e._instanceMap[t].destroy()})}},{key:"destroy",value:function(){this._emitter=null,this.allowedEvents=[],this._clsMap=null,this._context=null,this._hooks=null,this._emitCounter={},this.destroyInstances()}},{key:"_isMessageNameValid",value:function(e){if(!this.allowedEvents.indexOf(e)<0)throw new Error("unregistered message name: "+e)}}]),e}(),Ji={LADER_START:"LOADER_START",LOADER_DATALOADED:"LOADER_DATALOADED",LOADER_COMPLETE:"LOADER_COMPLETE",LOADER_ERROR:"LOADER_ERROR"},Zi={DEMUX_START:"DEMUX_START",DEMUX_COMPLETE:"DEMUX_COMPLETE",DEMUX_ERROR:"DEMUX_ERROR",METADATA_PARSED:"METADATA_PARSED",VIDEO_METADATA_CHANGE:"VIDEO_METADATA_CHANGE",AUDIO_METADATA_CHANGE:"AUDIO_METADATA_CHANGE",MEDIA_INFO:"MEDIA_INFO"},Qi={REMUX_METADATA:"REMUX_METADATA",REMUX_MEDIA:"REMUX_MEDIA",MEDIA_SEGMENT:"MEDIA_SEGMENT",REMUX_ERROR:"REMUX_ERROR",INIT_SEGMENT:"INIT_SEGMENT",DETECT_CHANGE_STREAM:"DETECT_CHANGE_STREAM",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT"},$i={SOURCE_UPDATE_END:"SOURCE_UPDATE_END"},en={RETRY_TIME_EXCEEDED:"RETRY_TIME_EXCEEDED"},tn={START_DECRYPT:"START_DECRYPT",DECRYPTED:"DECRYPTED"},nn=Object.assign({},Ji,Zi,Qi,$i,en),rn=[],an=[];for(var sn in nn)nn.hasOwnProperty(sn)&&rn.push(nn[sn]);for(var on in nn)nn.hasOwnProperty(on)&&an.push(nn[on]);var un={ALLEVENTS:nn,HLS_EVENTS:en,REMUX_EVENTS:Qi,DEMUX_EVENTS:Zi,MSE_EVENTS:$i,LOADER_EVENTS:Ji,FlvAllowedEvents:rn,HlsAllowedEvents:an,CRYTO_EVENTS:tn},ln=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),hn={get device(){var e=hn.os;return e.isPc?"pc":e.isTablet?"tablet":"mobile"},get browser(){var e=navigator.userAgent.toLowerCase(),t={ie:/rv:([\d.]+)\) like gecko/,firfox:/firefox\/([\d.]+)/,chrome:/chrome\/([\d.]+)/,opera:/opera.([\d.]+)/,safari:/version\/([\d.]+).*safari/};return[].concat(Object.keys(t).filter(function(i){return t[i].test(e)}))[0]},get os(){var e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,n=/(?:Android)/.test(e),r=/(?:Firefox)/.test(e),a=/(?:iPad|PlayBook)/.test(e)||n&&!/(?:Mobile)/.test(e)||r&&/(?:Tablet)/.test(e),s=/(?:iPhone)/.test(e)&&!a;return{isTablet:a,isPhone:s,isAndroid:n,isPc:!s&&!n&&!i,isSymbian:i,isWindowsPhone:t,isFireFox:r}},get isLe(){return ln}},fn=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),dn=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),cn=function(){function e(){le(this,e)}return dn(e,null,[{key:"decode",value:function(t){for(var i=[],n=t,r=0,a=t.length;r<a;)if(n[r]<128)i.push(String.fromCharCode(n[r])),++r;else{if(n[r]<192);else if(n[r]<224){if(e._checkContinuation(n,r,1)){var s=(31&n[r])<<6|63&n[r+1];if(s>=128){i.push(String.fromCharCode(65535&s)),r+=2;continue}}}else if(n[r]<240){if(e._checkContinuation(n,r,2)){var o=(15&n[r])<<12|(63&n[r+1])<<6|63&n[r+2];if(o>=2048&&55296!=(63488&o)){i.push(String.fromCharCode(65535&o)),r+=3;continue}}}else if(n[r]<248&&e._checkContinuation(n,r,3)){var u=(7&n[r])<<18|(63&n[r+1])<<12|(63&n[r+2])<<6|63&n[r+3];if(u>65536&&u<1114112){u-=65536,i.push(String.fromCharCode(u>>>10|55296)),i.push(String.fromCharCode(1023&u|56320)),r+=4;continue}}i.push(String.fromCharCode(65533)),++r}return i.join("")}},{key:"_checkContinuation",value:function(e,t,i){var n=e;if(t+i<n.length){for(;i--;)if(128!=(192&n[++t]))return!1;return!0}return!1}}]),e}(),pn=function(){function e(e,t){var i=[],n=!0,r=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done)&&(i.push(s.value),!t||i.length!==t);n=!0);}catch(e){r=!0,a=e}finally{try{!n&&o.return&&o.return()}finally{if(r)throw a}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),vn=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),yn=(function(){function e(t){var i=this;he(this,e);var n=e.getDefaultInf();if(!t||"[object Object]"!==Object.prototype.toString.call(t))return n;var r=Object.assign({},n,t);Object.entries(r).forEach(function(e){var t=pn(e,2),n=t[0],r=t[1];i[n]=r})}vn(e,null,[{key:"getDefaultInf",value:function(){return{dts:null,pts:null,duration:null,position:null,isRAP:!1,originDts:null}}}])}(),function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}()),mn=(function(){function e(){fe(this,e),this.startDts=-1,this.endDts=-1,this.startPts=-1,this.endPts=-1,this.originStartDts=-1,this.originEndDts=-1,this.randomAccessPoints=[],this.firstSample=null,this.lastSample=null}yn(e,[{key:"addRAP",value:function(e){e.isRAP=!0,this.randomAccessPoints.push(e)}}])}(),function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}()),gn=function(){function e(t){de(this,e),this._type=t,this._list=[],this._lastAppendLocation=-1}return mn(e,[{key:"isEmpty",value:function(){return 0===this._list.length}},{key:"clear",value:function(){this._list=[],this._lastAppendLocation=-1}},{key:"_searchNearestSegmentBefore",value:function(e){var t=this._list;if(0===t.length)return-2;var i=t.length-1,n=0,r=0,a=i,s=0;if(e<t[0].originDts)return s=-1;for(;r<=a;){if((n=r+Math.floor((a-r)/2))===i||e>t[n].lastSample.originDts&&e<t[n+1].originDts){s=n;break}t[n].originDts<e?r=n+1:a=n-1}return s}},{key:"_searchNearestSegmentAfter",value:function(e){return this._searchNearestSegmentBefore(e)+1}},{key:"append",value:function(e){var t=this._list,i=this._lastAppendLocation,n=0;-1!==i&&i<t.length&&e.originStartDts>=t[i].lastSample.originDts&&(i===t.length-1||i<t.length-1&&e.originStartDts<t[i+1].originStartDts)?n=i+1:t.length>0&&(n=this._searchNearestSegmentBefore(e.originStartDts)+1),this._lastAppendLocation=n,this._list.splice(n,0,e)}},{key:"getLastSegmentBefore",value:function(e){var t=this._searchNearestSegmentBefore(e);return t>=0?this._list[t]:null}},{key:"getLastSampleBefore",value:function(e){var t=this.getLastSegmentBefore(e);return null!==t?t.lastSample:null}},{key:"getLastRAPBefore",value:function(e){for(var t=this._searchNearestSegmentBefore(e),i=this._list[t].randomAccessPoints;0===i.length&&t>0;)t--,i=this._list[t].randomAccessPoints;return i.length>0?i[i.length-1]:null}},{key:"type",get:function(){return this._type}},{key:"length",get:function(){return this._list.length}}]),e}(),_n=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),kn=function(){function e(t){ce(this,e);var i={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2",config:[41,401,136,0],duration:0,id:2,refSampleDuration:21,sampleRateIndex:3,timescale:1e3,type:"audio"};return t?Object.assign({},i,t):i}return _n(e,[{key:"destroy",value:function(){this.init=null}}]),e}(),En=function(){function e(t){ce(this,e);var i={avcc:null,sps:new Uint8Array(0),pps:new Uint8Array(0),chromaFormat:420,codec:"avc1.640020",codecHeight:720,codecWidth:1280,duration:0,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},id:1,level:"3.2",presentHeight:720,presentWidth:1280,profile:"High",refSampleDuration:40,parRatio:{height:1,width:1},timescale:1e3,type:"video"};return t?Object.assign({},i,t):i}return _n(e,[{key:"destroy",value:function(){this.init=null,this.sps=null,this.pps=null}}]),e}(),bn=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),An=(function(){function e(t){pe(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}bn(e,null,[{key:"getDefault",value:function(){return{dts:null,pts:null,data:new Uint8Array}}}])}(),function(){function e(t){pe(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}bn(e,null,[{key:"getDefault",value:function(){return{dts:null,pts:null,isKeyframe:!1,originDts:null,data:new Uint8Array}}}])}(),function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}()),Sn=function(){function e(t){ve(this,e),this.configs=Object.assign({},t),this.container=this.configs.container,this.mediaSource=null,this.sourceBuffers={},this.preloadTime=this.configs.preloadTime||1,this.onSourceOpen=this.onSourceOpen.bind(this),this.onTimeUpdate=this.onTimeUpdate.bind(this),this.onUpdateEnd=this.onUpdateEnd.bind(this),this.onWaiting=this.onWaiting.bind(this)}return An(e,[{key:"init",value:function(){this.mediaSource=new self.MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this.container.src=URL.createObjectURL(this.mediaSource),this.url=this.container.src,this.container.addEventListener("timeupdate",this.onTimeUpdate),this.container.addEventListener("waiting",this.onWaiting)}},{key:"onTimeUpdate",value:function(){this.emit("TIME_UPDATE",this.container)}},{key:"onWaiting",value:function(){this.emit("WAITING",this.container)}},{key:"onSourceOpen",value:function(){this.addSourceBuffers()}},{key:"onUpdateEnd",value:function(){this.emit("SOURCE_UPDATE_END"),this.doAppend()}},{key:"addSourceBuffers",value:function(){if("open"===this.mediaSource.readyState){var e=this._context.getInstance("PRE_SOURCE_BUFFER"),t=this._context.getInstance("TRACKS"),i=void 0;e=e.sources;for(var n=!1,r=0,a=Object.keys(e).length;r<a;r++){var s=Object.keys(e)[r];if("audio"===s?i=t.audioTrack:"video"===s&&(i=t.videoTrack),i){var o="audio"===s?21:40;i.meta&&i.meta.refSampleDuration&&(o=i.meta.refSampleDuration),e[s].data.length>=this.preloadTime/o&&(n=!0)}}if(n){if(Object.keys(this.sourceBuffers).length>0)return;for(var u=0,l=Object.keys(e).length;u<l;u++){var h=Object.keys(e)[u],f=e[h],d="video"===h?"video/mp4;codecs="+f.mimetype:"audio/mp4;codecs="+f.mimetype,c=this.mediaSource.addSourceBuffer(d);this.sourceBuffers[h]=c,c.addEventListener("updateend",this.onUpdateEnd),this.doAppend()}}}}},{key:"doAppend",value:function(){var e=this._context.getInstance("PRE_SOURCE_BUFFER");if(e)for(var t=0;t<Object.keys(this.sourceBuffers).length;t++){var i=Object.keys(this.sourceBuffers)[t],n=this.sourceBuffers[i];if(!n.updating){var r=e.sources[i];if(r&&!r.inited)n.appendBuffer(r.init.buffer.buffer),r.inited=!0;else if(r){var a=r.data.shift();a&&n.appendBuffer(a.buffer.buffer)}}}}},{key:"endOfStream",value:function(){var e=this.mediaSource,t=e.readyState,i=e.activeSourceBuffers;if("open"===t&&0===i.length)try{this.mediaSource.endOfStream()}catch(e){}}},{key:"remove",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;i<Object.keys(this.sourceBuffers).length;i++){var n=this.sourceBuffers[Object.keys(this.sourceBuffers)[i]];n.updating||n.remove(t,e)}}},{key:"removeBuffers",value:function(){for(var t=this,i=[],n=0;n<Object.keys(this.sourceBuffers).length;n++)!function(n){var r=t.sourceBuffers[Object.keys(t.sourceBuffers)[n]];r.removeEventListener("updateend",t.onUpdateEnd);var a=void 0;a=r.updating?new Promise(function(t){var i=function i(){var n=3,a=function i(){r.updating?n>0?(setTimeout(i,200),n--):t():(e.clearBuffer(r),r.addEventListener("updateend",function(){t()}))};setTimeout(a,200),r.removeEventListener("updateend",i)};r.addEventListener("updateend",i)}):new Promise(function(t){e.clearBuffer(r),r.addEventListener("updateend",function(){t()})}),i.push(a)}(n);return Promise.all(i)}},{key:"destroy",value:function(){var e=this;return this.removeBuffers().then(function(){for(var t=0;t<Object.keys(e.sourceBuffers).length;t++){var i=e.sourceBuffers[Object.keys(e.sourceBuffers)[t]];e.mediaSource.removeSourceBuffer(i),delete e.sourceBuffers[Object.keys(e.sourceBuffers)[t]]}e.container.removeEventListener("timeupdate",e.onTimeUpdate),e.container.removeEventListener("waiting",e.onWaiting),e.mediaSource.removeEventListener("sourceopen",e.onSourceOpen),e.endOfStream(),window.URL.revokeObjectURL(e.url),e.url=null,e.configs={},e.container=null,e.mediaSource=null,e.sourceBuffers={},e.preloadTime=1})}}],[{key:"clearBuffer",value:function(e){for(var t=e.buffered,i=.1,n=0,r=t.length;n<r;n++)i=t.end(n);try{e.remove(0,i)}catch(e){}}}]),e}(),wn=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Tn=(function(){function e(t){if(ye(this,e),!(t instanceof ArrayBuffer))throw new Error("data is invalid");this.buffer=t,this.dataview=new DataView(t),this.dataview.position=0}wn(e,[{key:"back",value:function(e){this.position-=e}},{key:"skip",value:function(t){for(var i=Math.floor(t/4),n=t%4,r=0;r<i;r++)e.readByte(this.dataview,4);n>0&&e.readByte(this.dataview,n)}},{key:"readUint8",value:function(){return e.readByte(this.dataview,1)}},{key:"readUint16",value:function(){return e.readByte(this.dataview,2)}},{key:"readUint24",value:function(){return e.readByte(this.dataview,3)}},{key:"readUint32",value:function(){return e.readByte(this.dataview,4)}},{key:"readUint64",value:function(){return e.readByte(this.dataview,8)}},{key:"readInt8",value:function(){return e.readByte(this.dataview,1,!0)}},{key:"readInt16",value:function(){return e.readByte(this.dataview,2,!0)}},{key:"readInt32",value:function(){return e.readByte(this.dataview,4,!0)}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}},{key:"length",get:function(){return this.buffer.byteLength}},{key:"position",set:function(e){this.dataview.position=e},get:function(){return this.dataview.position}}],[{key:"readByte",value:function(e,t,i){var n=void 0;switch(t){case 1:n=i?e.getInt8(e.position):e.getUint8(e.position);break;case 2:n=i?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(i)throw new Error("not supported for readByte 3");n=e.getUint8(e.position)<<16,n|=e.getUint8(e.position+1)<<8,n|=e.getUint8(e.position+2);break;case 4:n=i?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(i)throw new Error("not supported for readBody 8");n=e.getUint32(e.position)<<32,n|=e.getUint32(e.position+4);break;default:n=""}return e.position+=t,n}}])}(),ge(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){for(var t=0,i=arguments.length,n=Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];var a=!0,s=!1,o=void 0;try{for(var u,l=n[Symbol.iterator]();!(a=(u=l.next()).done);a=!0)t+=u.value.length}catch(e){s=!0,o=e}finally{try{!a&&l.return&&l.return()}finally{if(s)throw o}}var h=new e(t),f=0,d=!0,c=!1,p=void 0;try{for(var v,y=n[Symbol.iterator]();!(d=(v=y.next()).done);d=!0){var m=v.value;h.set(m,f),f+=m.length}}catch(e){c=!0,p=e}finally{try{!d&&y.return&&y.return()}finally{if(c)throw p}}return h}}));me(Tn);var Dn=me(ge(function(e){var t=function(e){return e&&e.__esModule?e:{default:e}}(Tn);e.exports=t.default})),Rn=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),On=function(){function e(t){_e(this,e),this.buffer=t||new Uint8Array(0)}return Rn(e,[{key:"write",value:function(){for(var e=this,t=arguments.length,i=Array(t),n=0;n<t;n++)i[n]=arguments[n];i.forEach(function(t){e.buffer=Dn(Uint8Array,e.buffer,t)})}}],[{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,255&e])}},{key:"readAsInt",value:function(e){function t(e){return e.toString(16).padStart(2,"0")}var i="";return e.forEach(function(e){i+=t(e)}),parseInt(i,16)}}]),e}(),Ln=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),xn=un.CRYTO_EVENTS,Un=(function(){function e(t){ke(this,e),this.inputBuffer=t.inputbuffer,this.outputBuffer=t.outputbuffer,this.key=t.key,this.iv=t.iv,this.method=t.method,this.crypto=window.crypto||window.msCrypto}Ln(e,[{key:"init",value:function(){this.on(xn.START_DECRYPT,this.decript.bind(this))}},{key:"decript",value:function(){var e=this;this.aeskey?this.decriptData():this.crypto.subtle.importKey("raw",this.key.buffer,{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(t){e.aeskey=t,e.decriptData()})}},{key:"decriptData",value:function(){var e=this,t=this._context.getInstance(this.inputBuffer),i=this._context.getInstance(this.outputBuffer),n=t.shift();n&&this.crypto.subtle.decrypt({name:"AES-CBC",iv:this.iv.buffer},this.aeskey,n).then(function(t){i.push(new Uint8Array(t)),e.emit(xn.DECRYPTED),e.decriptData(n)})}}])}(),Yi),Cn=un,Bn=hn,Mn=fn,In=cn,Pn=gn,Fn=kn,Nn=En,jn=Sn,Vn=On,Gn=function(){function e(t){Oe(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}return Le(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(i.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),t=e-t,t>0&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e=void 0;for(e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}}]),e}(),zn=function(){function e(){Oe(this,e)}return Le(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,n=new Uint8Array(i),r=0,a=0;a<i;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(n[r]=t[a],r++);return new Uint8Array(n.buffer,0,r)}},{key:"parseSPS",value:function(t){var i=e._ebsp2rbsp(t),n=new Gn(i);n.readByte();var r=n.readByte();n.readByte();var a=n.readByte();n.readUEG();var s=e.getProfileString(r),o=e.getLevelString(a),u=1,l=420,h=[0,420,422,444],f=8;if((100===r||110===r||122===r||244===r||44===r||83===r||86===r||118===r||128===r||138===r||144===r)&&(3===(u=n.readUEG())&&n.readBits(1),u<=3&&(l=h[u]),f=n.readUEG()+8,n.readUEG(),n.readBits(1),n.readBool()))for(var d=3!==u?8:12,c=0;c<d;c++)n.readBool()&&(c<6?e._skipScalingList(n,16):e._skipScalingList(n,64));n.readUEG();var p=n.readUEG();if(0===p)n.readUEG();else if(1===p){n.readBits(1),n.readSEG(),n.readSEG();for(var v=n.readUEG(),y=0;y<v;y++)n.readSEG()}n.readUEG(),n.readBits(1);var m=n.readUEG(),g=n.readUEG(),_=n.readBits(1);0===_&&n.readBits(1),n.readBits(1);var k=0,E=0,b=0,A=0;n.readBool()&&(k=n.readUEG(),E=n.readUEG(),b=n.readUEG(),A=n.readUEG());var S=1,w=1,T=0,D=!0,R=0,O=0;if(n.readBool()){if(n.readBool()){var L=n.readByte(),x=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],U=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];L>0&&L<16?(S=x[L-1],w=U[L-1]):255===L&&(S=n.readByte()<<8|n.readByte(),w=n.readByte()<<8|n.readByte())}if(n.readBool()&&n.readBool(),n.readBool()&&(n.readBits(4),n.readBool()&&n.readBits(24)),n.readBool()&&(n.readUEG(),n.readUEG()),n.readBool()){var C=n.readBits(32),B=n.readBits(32);D=n.readBool(),T=(R=B)/(O=2*C)}}var M=1;1===S&&1===w||(M=S/w);var I=0,P=0;0===u?(I=1,P=2-_):(I=3===u?1:2,P=(1===u?2:1)*(2-_));var F=16*(m+1),N=16*(g+1)*(2-_);F-=(k+E)*I,N-=(b+A)*P;var j=Math.ceil(F*M);return n.destroy(),n=null,{profile_string:s,level_string:o,bit_depth:f,chroma_format:l,chroma_format_string:e.getChromaFormatString(l),frame_rate:{fixed:D,fps:T,fps_den:O,fps_num:R},par_ratio:{width:S,height:w},codec_size:{width:F,height:N},present_size:{width:j,height:N}}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,n=8,r=0;r<t;r++)0!==n&&(n=(i+e.readSEG()+256)%256),i=0===n?i:n}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};e&&e.codec_size&&(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t.parRatio={width:e.par_ratio.width,height:e.par_ratio.height},t.frameRate=e.frame_rate;var i=t.frameRate.fps_den,n=t.frameRate.fps_num;t.refSampleDuration=Math.floor(t.timescale*(i/n))}}]),e}(),Xn=(function(){function e(){Oe(this,e)}Le(e,null,[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var i=t.dataview,n=t.position;return 1===i.getInt32(n)||0===i.getInt16(n)&&1===i.getInt8(n+2)?e.getAnnexbNals(t):e.getAvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var i=[],n=e.getHeaderPositionAnnexB(t),r=n.pos,a=r;r<t.length-4;){var s=t.buffer.slice(r,r+n.headerLength);n.pos===t.position&&t.skip(n.headerLength),a=(n=e.getHeaderPositionAnnexB(t)).pos;var o={header:s,body:new Uint8Array(t.buffer.slice(r+s.byteLength,a))};e.analyseNal(o),i.push(o),t.skip(a-t.position),r=a}return i}},{key:"getAvccNals",value:function(t){for(var i=[];t.position<t.length-4;){var n=t.dataview.getInt32();if(!(t.length-t.position>=n))break;var r=t.buffer.slice(t.position,t.position+4);t.skip(4);var a=t.buffer.slice(t.position,t.position+n);t.skip(n);var s={header:r,body:a};e.analyseNal(s),i.push(s)}return i}},{key:"analyseNal",value:function(e){switch(31&e.body[0]){case 1:e.ndr=!0;break;case 5:e.idr=!0;break;case 6:break;case 7:e.sps=zn.parseSPS(e.body);break;case 8:e.pps=!0}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0;3!==i&&4!==i&&t<e.length-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===e.length-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)&&(i=4):(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?i=3:t=e.length)),{pos:t,headerLength:i}}},{key:"getAvcc",value:function(e,t){var i=new Uint8Array(e.byteLength+t.byteLength+11);i[0]=1,i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=255,i[5]=225;var n=6;return i.set(new Uint8Array([e.byteLength>>>8&255,255&e.byteLength]),n),n+=2,i.set(e,n),n+=e.byteLength,i[n]=1,n++,i.set(new Uint8Array([t.byteLength>>>8&255,255&t.byteLength]),n),n+=2,i.set(t,n),i}}])}(),function(){function e(){Oe(this,e)}return Le(e,null,[{key:"getSilentFrame",value:function(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}]),e}()),Hn=Cn.REMUX_EVENTS,Wn=Cn.LOADER_EVENTS,qn=function(){function e(){Oe(this,e),this.nextAudioDts=0,this.nextVideoDts=0,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.allAudioSamplesCount=0,this.allVideoSamplesCount=0,this._firstAudioSample=null,this._firstVideoSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this.videoLastSample=null,this.audioLastSample=null,this._videoLargeGap=0,this._audioLargeGap=0}return Le(e,[{key:"init",value:function(){var e=this;this.before(Hn.REMUX_MEDIA,this.doFix.bind(this)),this.on(Wn.LOADER_COMPLETE,function(){e.videoLastSample&&e.videoTrack.samples.unshift(e.videoLastSample)})}},{key:"reset",value:function(){this.nextAudioDts=null,this.nextVideoDts=null,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.videoLastSample=null,this.audioLastSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[]}},{key:"doFix",value:function(){var t=this.getFirstSample(),i=t.isFirstAudioSamples,n=t.isFirstVideoSamples;this.recordSamplesCount(),this._firstVideoSample&&this.fixRefSampleDuration(this.videoTrack.meta,this.videoTrack.samples),this._firstAudioSample&&this.fixRefSampleDuration(this.audioTrack.meta,this.audioTrack.samples);var r=e.detactChangeStream(this.videoTrack.samples),a=r.changed,s=r.changedIdx;a&&!i?this.fixChangeStreamVideo(s):this.doFixVideo(n);var o=e.detactChangeStream(this.audioTrack.samples),u=o.changed,l=o.changedIdx;u?this.fixChangeStreamAudio(l):this.doFixAudio(i),this.removeInvalidSamples()}},{key:"doFixVideo",value:function(t,i){for(var n=this.videoTrack,r=n.samples,a=n.meta,s=0,o=r.length;s<o;s++){var u=r[s];u.originDts=u.dts}if((!a.frameRate||!1!==a.frameRate.fixed)&&r&&r.length&&this._firstVideoSample){var l=r[0];if(this._videoLargeGap>0&&e.doFixLargeGap(r,this._videoLargeGap),l.dts!==this._firstVideoSample.dts&&i&&(i&&(this.nextVideoDts=i),this._videoLargeGap=this.nextVideoDts-l.dts,e.doFixLargeGap(r,this._videoLargeGap)),t&&this._firstAudioSample){var h=this._firstVideoSample.originDts,f=h-(this._firstAudioSample.originDts||this._firstAudioSample.dts);if(f>2*a.refSampleDuration&&f<10*a.refSampleDuration){for(var d=Math.floor(f/a.refSampleDuration),c=0;c<d;c++){var p=Object.assign({},l);p.dts=h-(c+1)*a.refSampleDuration,p.pts=p.dts+p.cts,r.unshift(p),this.filledVideoSamples.push({dts:p.dts,size:p.data.byteLength})}this._firstVideoSample=this.filledVideoSamples[0]||this._firstVideoSample}else f<-2*a.refSampleDuration&&(this._videoLargeGap=-1*f,e.doFixLargeGap(r,-1*f))}var v=r.pop();if(r.length&&(r[r.length-1].duration=v.dts-r[r.length-1].dts),this.videoLastSample){var y=this.videoLastSample;y.duration=l.dts-y.dts,r.unshift(this.videoLastSample)}this.videoLastSample=v,this.videoTrack.samples=r}}},{key:"doFixAudio",value:function(t,i){var n=this.audioTrack,r=n.samples,a=n.meta;if(r&&r.length){for(var s=0,o=r.length;s<o;s++){var u=r[s];u.originDts=u.dts}var l=r.length,h=Xn.getSilentFrame(a.codec,a.channelCount),f=this._firstAudioSample,d=r[0];if(this._audioLargeGap>0&&e.doFixLargeGap(r,this._audioLargeGap),d.dts!==this._firstAudioSample.dts&&(i||e.detectLargeGap(this.nextAudioDts,d))&&(i&&(this.nextAudioDts=i),this._audioLargeGap=this.nextAudioDts-d.dts,e.doFixLargeGap(r,this._audioLargeGap)),this._firstVideoSample&&t){var c=this._firstVideoSample.originDts||this._firstVideoSample.dts,p=f.dts-c;if(p>a.refSampleDuration&&p<10*a.refSampleDuration){for(var v=Math.floor((f.dts-c)/a.refSampleDuration),y=0;y<v;y++){var m={data:h,datasize:h.byteLength,dts:f.dts-(y+1)*a.refSampleDuration,filtered:0};r.unshift(m),this.filledAudioSamples.push({dts:m.dts,size:m.data.byteLength})}this._firstAudioSample=this.filledAudioSamples[0]||this._firstAudioSample}else p<-1*a.refSampleDuration&&(this._audioLargeGap=-1*p,e.doFixLargeGap(r,-1*p))}var g=void 0,_=r[0].dts;if(this.nextAudioDts){g=_-this.nextAudioDts;var k=Math.abs(g);if(k>a.refSampleDuration&&1===l&&1===this.lastAudioSamplesLen&&(a.refSampleDurationFixed=void 0),g>2*a.refSampleDuration&&g<10*a.refSampleDuration)if(1===l&&1===this.lastAudioSamplesLen)a.refSampleDurationFixed=void 0!==a.refSampleDurationFixed?a.refSampleDurationFixed+g:a.refSampleDuration+g;else for(var E=Math.floor(g/a.refSampleDuration),b=0;b<E;b++){var A=_-(b+1)*a.refSampleDuration,S=Object.assign({},r[0],{dts:A>this.nextAudioDts?A:this.nextAudioDts});this.filledAudioSamples.push({dts:S.dts,size:S.data.byteLength}),this.audioTrack.samples.unshift(S)}else k<=a.refSampleDuration&&k>0?(r[0].dts=this.nextAudioDts,r[0].pts=this.nextAudioDts):g<0&&e.doFixLargeGap(r,-1*g)}var w=r[r.length-1].originDts,T=r[r.length-1].dts,D=r.length>=2?w-r[r.length-2].originDts:a.refSampleDuration;this.lastAudioSamplesLen=l,this.nextAudioDts=a.refSampleDurationFixed?T+a.refSampleDurationFixed:T+D,this.lastAudioDts=T,r[r.length-1].duration=D;for(var R=0,O=r.length;R<O;R++){var L=r[R],x=r[R+1];if(!x)break;var U=x.dts-L.dts;r[R].duration=U}this.audioTrack.samples=e.sortAudioSamples(r)}}},{key:"fixChangeStreamVideo",value:function(e){var t=this.videoTrack,i=t.samples,n=t.meta,r=0===e?this.getStreamChangeStart(i[0]):i[e-1].dts,a=i[e].dts;if(Math.abs(r-a)<=2*n.refSampleDuration)return i[e].options?i[e].options.isContinue=!0:i[e].options={isContinue:!0},this.doFixVideo(!1);var s=i.slice(0,e),o=i.slice(e),u=i[0],l=o[0].dts-u.dts,h=u.options&&u.options.start+l?u.options.start:null;this.videoTrack.samples=i.slice(0,e),this.doFixVideo(!1),this.videoTrack.samples=i.slice(e),this.doFixVideo(!1,h),this.videoTrack.samples=s.concat(o)}},{key:"fixChangeStreamAudio",value:function(e){var t=this.audioTrack,i=t.samples,n=t.meta,r=0===e?this.getStreamChangeStart(i[0]):i[e-1].dts,a=i[e].dts;if(Math.abs(r-a)<=2*n.refSampleDuration)return i[e].options?i[e].options.isContinue=!0:i[e].options={isContinue:!0},this.doFixAudio(!1);var s=i.slice(0,e),o=i.slice(e),u=i[0],l=o[0].dts-u.dts,h=u.options&&u.options.start+l?u.options.start:null;this.audioTrack.samples=s,this.doFixAudio(!1),this.audioTrack.samples=o,this.doFixAudio(!1,h),this.audioTrack.samples=s.concat(o)}},{key:"getFirstSample",value:function(){var t=this.videoTrack.samples,i=this.audioTrack.samples,n=!1,r=!1;return!this._firstVideoSample&&t.length&&(this._firstVideoSample=e.findFirstVideoSample(t),this.removeInvalidSamples(),n=!0),!this._firstAudioSample&&i.length&&(this._firstAudioSample=e.findFirstAudioSample(i),this.removeInvalidSamples(),r=!0),{isFirstVideoSamples:n,isFirstAudioSamples:r}}},{key:"fixRefSampleDuration",value:function(e,t){var i="video"===e.type,n=i?this.allVideoSamplesCount:this.allAudioSamplesCount,r=i?this._firstVideoSample.dts:this._firstAudioSample.dts,a=i?this.filledVideoSamples.length:this.filledAudioSamples.length;if(!e.refSampleDuration||e.refSampleDuration<=0||Number.isNaN(e.refSampleDuration)){if(t.length>=1){var s=t[t.length-1].dts;e.refSampleDuration=Math.floor((s-r)/(n+a-1))}}else if(e.refSampleDuration&&t.length>=5){var o=(t[t.length-1].dts-t[0].dts)/(t.length-1);e.refSampleDuration=Math.floor(Math.abs(e.refSampleDuration-o)<=5?e.refSampleDuration:o)}}},{key:"recordSamplesCount",value:function(){var e=this.audioTrack,t=this.videoTrack;this.allAudioSamplesCount+=e.samples.length,this.allVideoSamplesCount+=t.samples.length}},{key:"removeInvalidSamples",value:function(){var e=this._firstVideoSample,t=this._firstAudioSample;t&&(this.audioTrack.samples=this.audioTrack.samples.filter(function(e,i){return e===t||e.dts>t.dts})),e&&(this.videoTrack.samples=this.videoTrack.samples.filter(function(t,i){return t===e||t.dts>e.dts}))}},{key:"getStreamChangeStart",value:function(e){return e.options&&e.options.start?e.options.start-this.dtsBase:1/0}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"audioTrack",get:function(){return this.tracks&&this.tracks.audioTrack?this.tracks.audioTrack:{samples:[],meta:{}}}},{key:"videoTrack",get:function(){return this.tracks&&this.tracks.videoTrack?this.tracks.videoTrack:{samples:[],meta:{}}}},{key:"dtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e?e._dtsBase:0}}],[{key:"sortAudioSamples",value:function(e){return 1===e.length?e:e.sort(function(e,t){return e.dts-t.dts})}},{key:"findFirstAudioSample",value:function(t){return t&&0!==t.length?e.sortAudioSamples(t)[0]:null}},{key:"findFirstVideoSample",value:function(e){if(!e.length)return null;for(var t=e.sort(function(e,t){return e.dts-t.dts}),i=0,n=t.length;i<n;i++)if(t[i].isKeyframe)return t[i]}},{key:"detectLargeGap",value:function(e,t){if(null!==e){var i=t.dts||0,n=e-i>=1e3||i-e>=1e3,r=t.options&&t.options.discontinue;return n||r}}},{key:"doFixLargeGap",value:function(e,t){for(var i=0,n=e.length;i<n;i++){var r=e[i];r.dts+=t,r.pts&&(r.pts+=t)}}},{key:"detactChangeStream",value:function(e){for(var t=!1,i=-1,n=0,r=e.length;n<r;n++)if(e[n].options&&e[n].options.meta){t=!0,i=n;break}return{changed:t,changedIdx:i}}}]),e}(),Kn=zn,Yn=qn,Jn=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Zn=function(){function e(){Ae(this,e),this.id=-1,this.sequenceNumber=0,this.samples=[],this.droppedSamples=[],this.length=0}return Jn(e,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0}},{key:"distroy",value:function(){this.reset(),this.id=-1}}]),e}(),Qn=function(e){function t(){Ae(this,t);var e=Ee(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="AudioTrack",e.type="audio",e}return be(t,e),t}(Zn),$n=function(e){function t(){Ae(this,t);var e=Ee(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="VideoTrack",e.type="video",e.dropped=0,e}return be(t,e),Jn(t,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0,this.dropped=0}}]),t}(Zn),er=function(){function e(){Ae(this,e),this.audioTrack=null,this.videoTrack=null}return Jn(e,[{key:"destroy",value:function(){this.audioTrack=null,this.videoTrack=null}}]),e}(),tr=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ir=function(){function e(t){Se(this,e),this.length=t||0,this.historyLen=t||0,this.array=[],this.offset=0}return tr(e,[{key:"push",value:function(e){this.array.push(e),this.length+=e.byteLength,this.historyLen+=e.byteLength}},{key:"shift",value:function(e){if(this.array.length<1)return new Uint8Array(0);if(void 0===e)return this._shiftBuffer();if(this.offset+e===this.array[0].length){var t=this.array[0].slice(this.offset,this.offset+e);return this.offset=0,this.array.shift(),this.length-=e,t}if(this.offset+e<this.array[0].length){var i=this.array[0].slice(this.offset,this.offset+e);return this.offset+=e,this.length-=e,i}for(var n=new Uint8Array(e),r=0;this.array.length>0&&e>0;){if(this.offset+e<this.array[0].length){var a=this.array[0].slice(this.offset,this.offset+e);n.set(a,r),this.offset+=e,this.length-=e,e=0;break}var s=this.array[0].length-this.offset;n.set(this.array[0].slice(this.offset,this.array[0].length),r),this.array.shift(),this.offset=0,r+=s,this.length-=s,e-=s}return n}},{key:"clear",value:function(){this.array=[],this.length=0,this.offset=0}},{key:"destroy",value:function(){this.clear(),this.historyLen=0}},{key:"_shiftBuffer",value:function(){return this.length-=this.array[0].length,this.offset=0,this.array.shift()}},{key:"toInt",value:function(e,t){for(var i=0,n=this.offset+e;n<this.offset+t+e;)n<this.array[0].length?i=256*i+this.array[0][n]:this.array[1]&&(i=256*i+this.array[1][n-this.array[0].length]),n++;return i}}]),e}(),nr=(function(){function e(){Se(this,e),this.video=[],this.audio=[]}tr(e,[{key:"destroy",value:function(){this.video=[],this.audio=[]}}])}(),function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}()),rr=function e(){we(this,e),this.mimetype="",this.init=null,this.data=[]},ar=er,sr=Qn,or=$n,ur=ir,lr=function(){function e(){we(this,e),this.sources={}}return nr(e,[{key:"getSource",value:function(e){return this.sources[e]}},{key:"createSource",value:function(e){return this.sources[e]=new rr,this.sources[e]}},{key:"clear",value:function(){this.sources={}}},{key:"destroy",value:function(){this.sources={}}}]),e}(),hr={NUMBER:0,BOOLEAN:1,STRING:2,OBJECT:3,MIX_ARRAY:8,OBJECT_END:9,STRICT_ARRAY:10,DATE:11,LONE_STRING:12},fr=function(){function e(){Gi(this,e),this.offset=0,this.readOffset=this.offset}return zi(e,[{key:"resolve",value:function(e,t){if(t<3)throw new Error("not enough data for metainfo");var i={},n=this.parseValue(e),r=this.parseValue(e,t-n.bodySize);return i[n.data]=r.data,this.resetStatus(),i}},{key:"resetStatus",value:function(){this.offset=0,this.readOffset=this.offset}},{key:"parseString",value:function(e){var t=new DataView(e,this.readOffset).getUint16(0,!Mn),i="";i=t>0?In.decode(new Uint8Array(e,this.readOffset+2,t)):"";var n=t+2;return this.readOffset+=n,{data:i,bodySize:t+2}}},{key:"parseDate",value:function(e,t){var i=new DataView(e,this.readOffset,t),n=i.getFloat64(0,!Mn);return n+=60*i.getInt16(8,!Mn)*1e3,this.readOffset+=10,{data:new Date(n),bodySize:10}}},{key:"parseObject",value:function(e,t){var i=this.parseString(e,t),n=this.parseValue(e,t-i.bodySize);return{data:{name:i.data,value:n.data},bodySize:i.bodySize+n.bodySize,isObjEnd:n.isObjEnd}}},{key:"parseLongString",value:function(e){var t=new DataView(e,this.readOffset).getUint32(0,!Mn),i="";return i=t>0?In.decode(new Uint8Array(e,this.readOffset+2,t)):"",this.readOffset+=t+4,{data:i,bodySize:t+4}}},{key:"parseValue",value:function(e,t){var i=new ArrayBuffer;i=e instanceof ArrayBuffer?e:e.buffer;var n=hr.NUMBER,r=hr.BOOLEAN,a=hr.STRING,s=hr.OBJECT,o=hr.MIX_ARRAY,u=hr.OBJECT_END,l=hr.STRICT_ARRAY,h=hr.DATE,f=hr.LONE_STRING,d=new DataView(i,this.readOffset,t),c=!1,p=d.getUint8(0),v=1;this.readOffset+=1;var y=null;switch(p){case n:y=d.getFloat64(1,!Mn),this.readOffset+=8,v+=8;break;case r:y=!!d.getUint8(1),this.readOffset+=1,v+=1;break;case a:var m=this.parseString(i);y=m.data,v+=m.bodySize;break;case s:y={};var g=0;for(16777215&d.getUint32(t-4,!Mn)&&(g=3);v<t-4;){var _=this.parseObject(i,t-v-g);if(_.isObjectEnd)break;y[_.data.name]=_.data.value,v+=_.bodySize}v<=t-3&&9==(16777215&d.getUint32(v-1,!Mn))&&(this.readOffset+=3,v+=3);break;case o:y={},v+=4,this.readOffset+=4;var k=0;for(9==(16777215&d.getUint32(t-4,!Mn))&&(k=3);v<t-8;){var E=this.parseObject(i,t-v-k);if(E.isObjectEnd)break;y[E.data.name]=E.data.value,v+=E.bodySize}v<=t-3&&9==(16777215&d.getUint32(v-1,!Mn))&&(v+=3,this.readOffset+=3);break;case u:y=null,c=!0;break;case l:y=[];var b=d.getUint32(1,!Mn);v+=4,this.readOffset+=4;for(var A=0;A<b;A++){var S=this.parseValue(i,t-v);y.push(S.data),v+=S.bodySize}break;case h:var w=this.parseDate(i,t-1);y=w.data,v+=w.bodySize;break;case f:var T=this.parseLongString(i,t-1);y=T.data,v+=T.bodySize;break;default:v=t}return{data:y,bodySize:v,isObjEnd:c}}}]),e}(),dr=Cn.DEMUX_EVENTS,cr=function(){function e(){Gi(this,e),this._firstFragmentLoaded=!1,this._trackNum=0,this._hasScript=!1}return zi(e,[{key:"init",value:function(){this.on(dr.DEMUX_START,this.doParseFlv.bind(this))}},{key:"doParseFlv",value:function(){if(this._firstFragmentLoaded){if(this.loaderBuffer.length<11)return;var e=void 0,t=1e4;do{e=this._parseFlvTag()}while(e&&t-- >0);this.emit(dr.DEMUX_COMPLETE)}else{if(this.loaderBuffer.length<13)return;var i=this.loaderBuffer.shift(13);this.parseFlvHeader(i),this.doParseFlv()}}},{key:"parseFlvHeader",value:function(t){if(e.isFlvFile(t)){this._firstFragmentLoaded=!0;var i=e.getPlayType(t[4]);i.hasVideo&&this.initVideoTrack(),i.hasAudio&&this.initAudioTrack()}else this.emit(dr.DEMUX_ERROR,new Error("invalid flv file")),this.doParseFlv();this.doParseFlv()}},{key:"initVideoTrack",value:function(){this._trackNum++;var e=new or;e.meta=new Nn,e.id=e.meta.id=this._trackNum,this.tracks.videoTrack=e}},{key:"initAudioTrack",value:function(){this._trackNum++;var e=new sr;e.meta=new Fn,e.id=e.meta.id=this._trackNum,this.tracks.audioTrack=e}},{key:"_parseFlvTag",value:function(){if(this.loaderBuffer.length<11)return null;var e=this._parseFlvTagHeader();return e&&this._processChunk(e),e}},{key:"_parseFlvTagHeader",value:function(){var e=0,t={},i=this.loaderBuffer.toInt(e,1);if(e+=1,t.filtered=(32&i)>>>5,t.tagType=31&i,t.datasize=this.loaderBuffer.toInt(e,3),e+=3,8!==t.tagType&&9!==t.tagType&&11!==t.tagType&&18!==t.tagType||0!==this.loaderBuffer.toInt(8,3))return this.loaderBuffer&&this.loaderBuffer.length>0&&this.loaderBuffer.shift(1),this.emit(dr.DEMUX_ERROR,this.TAG,new Error("tagType "+t.tagType),!1),null;if(this.loaderBuffer.length<t.datasize+15)return null;this.loaderBuffer.shift(4);var n=this.loaderBuffer.toInt(0,3);this.loaderBuffer.shift(3);var r=this.loaderBuffer.shift(1)[0];return r>0&&(n+=16777216*r),t.dts=n,this.loaderBuffer.shift(3),t}},{key:"_processChunk",value:function(e){switch(e.tagType){case 18:this._parseScriptData(e);break;case 8:this._parseAACData(e);break;case 9:this._parseHevcData(e);break;case 11:this.loaderBuffer.shift(3);break;default:this.loaderBuffer.shift(1)}}},{key:"_parseScriptData",value:function(e){var t=this.tracks.audioTrack,i=this.tracks.videoTrack,n=this.loaderBuffer.shift(e.datasize),r=(new fr).resolve(n,n.length),a=this._context.onMetaData=r?r.onMetaData:void 0;if(this._context.mediaInfo.duration=a.duration,this._context.mediaInfo.hasVideo=a.hasVideo,this._context.mediaInfo.hsaAudio=a.hasAudio,this._datasizeValidator(e.datasize)&&(this.emit(dr.MEDIA_INFO),this._hasScript=!0),t&&!t.hasSpecificConfig){var s=t.meta;switch(a.audiosamplerate&&(s.sampleRate=a.audiosamplerate),a.audiochannels&&(s.channelCount=a.audiochannels),a.audiosamplerate){case 44100:s.sampleRateIndex=4;break;case 22050:s.sampleRateIndex=7;break;case 11025:s.sampleRateIndex=10}}if(i&&!i.hasSpecificConfig){var o=i.meta;if("number"==typeof a.framerate){var u=Math.floor(1e3*a.framerate);if(u>0){var l=u/1e3;o.frameRate||(o.frameRate={}),o.frameRate.fixed=!0,o.frameRate.fps=l,o.frameRate.fps_num=u,o.frameRate.fps_den=1e3}}}}},{key:"_aacSequenceHeaderParser",value:function(e){var t={};t.hasSpecificConfig=!0,t.objectType=e[1]>>>3,t.sampleRateIndex=(7&e[1])<<1|e[2]>>>7,t.audiosamplerate=this._switchAudioSampleRate(t.sampleRateIndex),t.channelCount=(120&e[2])>>>3,t.frameLength=(4&e[2])>>>2,t.dependsOnCoreCoder=(2&e[2])>>>1,t.extensionFlagIndex=1&e[2],t.codec="mp4a.40."+t.objectType;var i=window.navigator.userAgent.toLowerCase(),n=void 0,r=void 0,a=t.sampleRateIndex;return-1!==i.indexOf("firefox")?t.sampleRateIndex>=6?(t.objectType=5,r=new Array(4),n=a-3):(t.objectType=2,r=new Array(2),n=a):-1!==i.indexOf("android")?(t.objectType=2,r=new Array(2),n=a):(t.objectType=5,n=t.sampleRateIndex,r=new Array(4),t.sampleRateIndex>=6?n=t.sampleRateIndex-3:1===t.channelCount&&(t.objectType=2,r=new Array(2),n=t.sampleRateIndex)),r[0]=t.objectType<<3,r[0]|=(15&t.sampleRateIndex)>>>1,r[1]=(15&t.sampleRateIndex)<<7,r[1]|=(15&t.channelCount)<<3,5===t.objectType&&(r[1]|=(15&n)>>>1,r[2]=(1&n)<<7,r[2]|=8,r[3]=0),t.config=r,t}},{key:"_parseAACData",value:function(e){var t=this.tracks.audioTrack;if(t){var i=t.meta;i||(t.meta=new Fn,i=t.meta);var n=this.loaderBuffer.shift(1)[0];e.data=this.loaderBuffer.shift(e.datasize-1);var r=(240&n)>>>4;t.format=r,10!==r&&this.emit(dr.DEMUX_ERROR,new Error("invalid audio format: "+r)),10!==r||this._hasAudioSequence||(i.sampleRate=this._switchAudioSamplingFrequency(n),i.sampleRateIndex=(12&n)>>>2,i.frameLenth=(2&n)>>>1,i.channelCount=1&n,i.refSampleDuration=Math.floor(1024/i.audioSampleRate*i.timescale));var a=i.audioSampleRate,s=i.sampleRateIndex,o=i.refSampleDuration;delete e.tagType;var u=this._datasizeValidator(e.datasize);if(0===e.data[0]){var l=this._aacSequenceHeaderParser(e.data);a=l.audiosamplerate||i.audioSampleRate,s=l.sampleRateIndex||i.sampleRateIndex,o=Math.floor(1024/a*i.timescale),i.channelCount=l.channelCount,i.sampleRate=a,i.sampleRateIndex=s,i.refSampleDuration=o,i.duration=this._context.mediaInfo.duration*i.timescale,i.config=l.config;var h=this._context.mediaInfo.audio;h.codec=l.codec,h.channelCount=l.channelCount,h.sampleRate=a,h.sampleRateIndex=l.audioSampleRateIndex,this._hasScript&&!this._hasAudioSequence?this.emit(dr.METADATA_PARSED,"audio"):this._hasScript&&this._hasAudioSequence&&this.emit(dr.AUDIO_METADATA_CHANGE),this._hasAudioSequence=!0,this._metaChange=!0}else this._metaChange&&(e.options={meta:t.meta},this._metaChange=!1),e.data=e.data.slice(1,e.data.length),t.samples.push(e);u||this.emit(dr.DEMUX_ERROR,this.TAG,new Error("TAG length error at "+e.datasize),!1)}}},{key:"_parseHevcData",value:function(e){var t=this.loaderBuffer.shift(1)[0];e.frameType=(240&t)>>>4,e.isKeyframe=1===e.frameType;var i=15&t;if(this.tracks.videoTrack.codecID=i,e.avcPacketType=this.loaderBuffer.shift(1)[0],e.cts=this.loaderBuffer.toInt(0,3),this.loaderBuffer.shift(3),12===i){var n=this.loaderBuffer.shift(e.datasize-5);if(e.data=n,0!==Number.parseInt(e.avcPacketType)){this._datasizeValidator(e.datasize)||this.emit(dr.DEMUX_ERROR,this.TAG,new Error("invalid video tag datasize: "+e.datasize),!1);var r={},a=0;for(r.cts=e.cts,r.dts=e.dts;e.data.length>a;){var s=e.data.slice(Number.parseInt(a),4+a);r.size=s[3],r.size+=256*s[2],r.size+=256*s[1]*256,r.size+=256*s[0]*256*256,a+=4,r.data=e.data.slice(Number.parseInt(a),r.size+a),a+=r.size,this.tracks.videoTrack.samples.push(r),this.emit(dr.METADATA_PARSED,"video")}}else 0===Number.parseInt(e.avcPacketType)&&(this._datasizeValidator(e.datasize)?this.emit(dr.METADATA_PARSED,"video"):this.emit(dr.DEMUX_ERROR,this.TAG,new Error("invalid video tag datasize: "+e.datasize),!1))}else if(7===i){var o=this.loaderBuffer.shift(e.datasize-5);if(0===o[4]&&0===o[5]&&0===o[6]&&1===o[7]){for(var u=0,l=0;l<4;l++)u=256*u+o[l];u-=4,(o=o.slice(4,o.length))[3]=u%256,u=(u-o[3])/256,o[2]=u%256,u=(u-o[2])/256,o[1]=u%256,o[0]=(u-o[1])/256}if(e.data=o,0===e.avcPacketType)this._avcSequenceHeaderParser(e.data),this._datasizeValidator(e.datasize)&&(this._hasScript&&!this._hasVideoSequence?this.emit(dr.METADATA_PARSED,"video"):this._hasScript&&this._hasVideoSequence&&this.emit(dr.VIDEO_METADATA_CHANGE),this._hasVideoSequence=!0),this._metaChange=!0;else{if(!this._datasizeValidator(e.datasize))return void this.emit(dr.DEMUX_ERROR,this.TAG,new Error("invalid video tag datasize: "+e.datasize),!1);this._metaChange&&(e.options={meta:Object.assign({},this.tracks.videoTrack.meta)},this._metaChange=!1),this.tracks.videoTrack.samples.push(e)}}else this.emit(dr.DEMUX_ERROR,this.TAG,new Error("video codeid is "+i),!1),e.data=this.loaderBuffer.shift(e.datasize-1),this._datasizeValidator(e.datasize)||this.emit(dr.DEMUX_ERROR,this.TAG,new Error("invalid video tag datasize: "+e.datasize),!1),this.tracks.videoTrack.samples.push(e),this.emit(dr.DEMUX_COMPLETE);delete e.tagType}},{key:"_avcSequenceHeaderParser",value:function(e){var t=this.tracks.videoTrack;if(t){var i=0;t.meta||(t.meta=new Nn);var n=t.meta;n.configurationVersion=e[0],n.avcProfileIndication=e[1],n.profileCompatibility=e[2],n.avcLevelIndication=e[3]/10,n.nalUnitLength=1+(3&e[4]);var r=31&e[5];i=6;for(var a={},s=0;s<r;s++){var o=255*e[i]+e[i+1];i+=2;for(var u=new Uint8Array(o),l=0;l<o;l++)u[l]=e[i+l];for(var h="avc1.",f=1;f<4;f++){var d=u[f].toString(16);d.length<2&&(d="0"+d),h+=d}n.codec=h,i+=o,this.tracks.videoTrack.meta.sps=u,a=Kn.parseSPS(u)}var c=e[i];i++;for(var p=0;p<c;p++){var v=255*e[i]+e[i+1];i+=2;for(var y=new Uint8Array(v),m=0;m<v;m++)y[m]=e[i+m];i+=v,this.tracks.videoTrack.meta.pps=y}Object.assign(n,Kn.toVideoMeta(a));var g=this._context.mediaInfo.video;g.codec=n.codec,g.profile=n.profile,g.level=n.level,g.chromaFormat=n.chromaFormat,g.frameRate=n.frameRate,g.parRatio=n.parRatio,g.width=g.width===n.presentWidth?g.width:n.presentWidth,g.height=g.height===n.presentHeight?g.width:n.presentHeight,n.duration=this._context.mediaInfo.duration*n.timescale,n.avcc=new Uint8Array(e.length),n.avcc.set(e),t.meta=n}}},{key:"_switchAudioSampleRate",value:function(e){return[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][e]}},{key:"_switchAudioSamplingFrequency",value:function(e){return[5500,11025,22050,44100,48e3][(12&e)>>>2]}},{key:"_switchAudioChannel",value:function(e){return[1,2][1&e]}},{key:"_datasizeValidator",value:function(e){var t=this.loaderBuffer.toInt(0,4);return this.loaderBuffer.shift(4),t===e+11}},{key:"loaderBuffer",get:function(){var e=this._context.getInstance("LOADER_BUFFER");if(e)return e;this.emit(dr.DEMUX_ERROR,new Error("找不到 loaderBuffer 实例"))}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"logger",get:function(){return this._context.getInstance("LOGGER")}}],[{key:"isFlvFile",value:function(e){return!(70!==e[0]||76!==e[1]||86!==e[2]||1!==e[3])}},{key:"getPlayType",value:function(e){var t={hasVideo:!1,hasAudio:!1};return!0&e&&(t.hasVideo=!0),!0&e&&(t.hasAudio=!0),t}}]),e}(),pr=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),vr=function(){function e(){Te(this,e)}return pr(e,null,[{key:"size",value:function(e){return Vn.writeUint32(e)}},{key:"initBox",value:function(t,i){for(var n=new Vn,r=arguments.length,a=Array(r>2?r-2:0),s=2;s<r;s++)a[s-2]=arguments[s];return n.write.apply(n,[e.size(t),e.type(i)].concat(a)),n.buffer}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,255&t])}},{key:"ftyp",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]))}},{key:"moov",value:function(t){var i=t.type,n=t.meta,r=8,a=e.mvhd(n.duration,n.timescale),s=void 0;s="video"===i?e.videoTrak(n):e.audioTrak(n);var o=e.mvex(n.duration,n.timescale||1e3,n.id);return[a,s,o].forEach(function(e){r+=e.byteLength}),e.initBox(r,"moov",a,s,o)}},{key:"mvhd",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,n=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.initBox(8+n.length,"mvhd",new Uint8Array(n))}},{key:"videoTrak",value:function(t){var i=8,n=e.tkhd({id:1,duration:t.duration,timescale:t.timescale||1e3,width:t.presentWidth,height:t.presentHeight,type:"video"}),r=e.mdia({type:"video",timescale:t.timescale||1e3,duration:t.duration,avcc:t.avcc,parRatio:t.parRatio,width:t.presentWidth,height:t.presentHeight});return[n,r].forEach(function(e){i+=e.byteLength}),e.initBox(i,"trak",n,r)}},{key:"audioTrak",value:function(t){var i=8,n=e.tkhd({id:2,duration:t.duration,timescale:t.timescale||1e3,width:0,height:0,type:"audio"}),r=e.mdia({type:"audio",timescale:t.timescale||1e3,duration:t.duration,channelCount:t.channelCount,samplerate:t.sampleRate,config:t.config});return[n,r].forEach(function(e){i+=e.byteLength}),e.initBox(i,"trak",n,r)}},{key:"tkhd",value:function(t){var i=t.id,n=t.duration,r=t.width,a=t.height,s=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,0,0,0,0,n>>>24&255,n>>>16&255,n>>>8&255,255&n,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>>8&255,255&r,0,0,a>>>8&255,255&a,0,0]);return e.initBox(8+s.byteLength,"tkhd",s)}},{key:"edts",value:function(t){var i=new Vn,n=t.duration,r=t.mediaTime;return i.write(e.size(36),e.type("edts")),i.write(e.size(28),e.type("elst")),i.write(new Uint8Array([0,0,0,1,n>>24&255,n>>16&255,n>>8&255,255&n,r>>24&255,r>>16&255,r>>8&255,255&r,0,0,0,1])),i.buffer}},{key:"mdia",value:function(t){var i=8,n=e.mdhd(t.timescale,t.duration),r=e.hdlr(t.type),a=e.minf(t);return[n,r,a].forEach(function(e){i+=e.byteLength}),e.initBox(i,"mdia",n,r,a)}},{key:"mdhd",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,i=arguments[1],n=new Uint8Array([0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,i>>>24&255,i>>>16&255,i>>>8&255,255&i,85,196,0,0]);return e.initBox(12+n.byteLength,"mdhd",e.extension(0,0),n)}},{key:"hdlr",value:function(t){var i=[0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0];return"audio"===t&&(i.splice.apply(i,[8,4].concat([115,111,117,110])),i.splice.apply(i,[24,13].concat([83,111,117,110,100,72,97,110,100,108,101,114,0]))),e.initBox(8+i.length,"hdlr",new Uint8Array(i))}},{key:"minf",value:function(t){var i=8,n="video"===t.type?e.vmhd():e.smhd(),r=e.dinf(),a=e.stbl(t);return[n,r,a].forEach(function(e){i+=e.byteLength}),e.initBox(i,"minf",n,r,a)}},{key:"vmhd",value:function(){return e.initBox(20,"vmhd",new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))}},{key:"smhd",value:function(){return e.initBox(16,"smhd",new Uint8Array([0,0,0,0,0,0,0,0]))}},{key:"dinf",value:function(){var t=new Vn,i=[0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1];return t.write(e.size(36),e.type("dinf"),e.size(28),e.type("dref"),new Uint8Array(i)),t.buffer}},{key:"stbl",value:function(t){var i=8,n=e.stsd(t),r=e.stts(),a=e.stsc(),s=e.stsz(),o=e.stco();return[n,r,a,s,o].forEach(function(e){i+=e.byteLength}),e.initBox(i,"stbl",n,r,a,s,o)}},{key:"stsd",value:function(t){var i=void 0;return i="audio"===t.type?e.mp4a(t):e.avc1(t),e.initBox(16+i.byteLength,"stsd",e.extension(0,0),new Uint8Array([0,0,0,1]),i)}},{key:"mp4a",value:function(t){var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,t.samplerate>>8&255,255&t.samplerate,0,0]),n=e.esds(t.config);return e.initBox(8+i.byteLength+n.byteLength,"mp4a",i,n)}},{key:"esds",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[43,146,8,0],i=t.length,n=new Vn,r=new Uint8Array([0,0,0,0,3,23+i,0,1,0,4,15+i,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([i]).concat(t).concat([6,1,2]));return n.write(e.size(8+r.byteLength),e.type("esds"),r),n.buffer}},{key:"avc1",value:function(t){var i=new Vn,n=t.width,r=t.height,a=t.parRatio.height,s=t.parRatio.width,o=t.avcc,u=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,n>>8&255,255&n,r>>8&255,255&r,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l=new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]),h=new Uint8Array([a>>24,a>>16&255,a>>8&255,255&a,s>>24,s>>16&255,s>>8&255,255&s]);return i.write(e.size(40+u.byteLength+o.byteLength+l.byteLength),e.type("avc1"),u,e.size(8+o.byteLength),e.type("avcC"),o,e.size(20),e.type("btrt"),l,e.size(16),e.type("pasp"),h),i.buffer}},{key:"stts",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stts",t)}},{key:"stsc",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stsc",t)}},{key:"stco",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stco",t)}},{key:"stsz",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);return e.initBox(20,"stsz",t)}},{key:"mvex",value:function(t){var i=arguments[2],n=new Vn,r=Vn.writeUint32(t);return n.write(e.size(56),e.type("mvex"),e.size(16),e.type("mehd"),e.extension(0,0),r,e.trex(i)),n.buffer}},{key:"trex",value:function(t){var i=new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return e.initBox(8+i.byteLength,"trex",i)}},{key:"moof",value:function(t){var i=8,n=e.mfhd(),r=e.traf(t);return[n,r].forEach(function(e){i+=e.byteLength}),e.initBox(i,"moof",n,r)}},{key:"mfhd",value:function(){var t=Vn.writeUint32(e.sequence);return e.sequence+=1,e.initBox(16,"mfhd",e.extension(0,0),t)}},{key:"traf",value:function(t){var i=8,n=e.tfhd(t.id),r=e.tfdt(t.time),a=e.sdtp(t),s=e.trun(t,a.byteLength);return[n,r,s,a].forEach(function(e){i+=e.byteLength}),e.initBox(i,"traf",n,r,s,a)}},{key:"tfhd",value:function(t){var i=Vn.writeUint32(t);return e.initBox(16,"tfhd",e.extension(0,0),i)}},{key:"tfdt",value:function(t){return e.initBox(16,"tfdt",e.extension(0,0),Vn.writeUint32(t))}},{key:"trun",value:function(t,i){var n=new Vn,r=Vn.writeUint32(t.samples.length),a=Vn.writeUint32(92+16*t.samples.length+i);return n.write(e.size(20+16*t.samples.length),e.type("trun"),new Uint8Array([0,0,15,1]),r,a),t.samples.forEach(function(e){var t=e.flags;n.write(new Uint8Array([e.duration>>>24&255,e.duration>>>16&255,e.duration>>>8&255,255&e.duration,e.size>>>24&255,e.size>>>16&255,e.size>>>8&255,255&e.size,t.isLeading<<2|t.dependsOn,t.isDependedOn<<6|t.hasRedundancy<<4|t.isNonSync,0,0,e.cts>>>24&255,e.cts>>>16&255,e.cts>>>8&255,255&e.cts]))}),n.buffer}},{key:"sdtp",value:function(t){var i=new Vn;return i.write(e.size(12+t.samples.length),e.type("sdtp"),e.extension(0,0)),t.samples.forEach(function(e){var t=e.flags,n=t.isLeading<<6|t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;i.write(new Uint8Array([n]))}),i.buffer}},{key:"mdat",value:function(t){var i=new Vn,n=8;t.samples.forEach(function(e){n+=e.size}),i.write(e.size(n),e.type("mdat"));var r=new Uint8Array(n),a=0;return r.set(i.buffer,a),a+=8,t.samples.forEach(function(e){e.buffer.forEach(function(e){r.set(e,a),a+=e.byteLength})}),r}}]),e}();vr.type=function(e){return new Uint8Array([e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)])},vr.sequence=1;var yr=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),mr=Cn.REMUX_EVENTS,gr=function(){function e(){De(this,e),this._dtsBase=0,this._isDtsBaseInited=!1,this._audioNextDts=null,this._videoNextDts=null,this._videoSegmentList=new Pn("video"),this._audioSegmentList=new Pn("audio");var t=Bn.browser;this._fillSilenceFrame="ie"===t,this.isFirstVideo=!0,this.isFirstAudio=!0,this.videoAllDuration=0,this.audioAllDuration=0}return yr(e,[{key:"init",value:function(){this.on(mr.REMUX_MEDIA,this.remux.bind(this)),this.on(mr.REMUX_METADATA,this.onMetaDataReady.bind(this)),this.on(mr.DETECT_CHANGE_STREAM,this.resetDtsBase.bind(this))}},{key:"destroy",value:function(){this._dtsBase=-1,this._dtsBaseInited=!1,this._videoNextDts=null,this._audioNextDts=null,this._videoSegmentList.clear(),this._audioSegmentList.clear(),this._videoSegmentList=null,this._audioSegmentList=null}},{key:"remux",value:function(){var e=this._context.getInstance("TRACKS"),t=e.audioTrack,i=e.videoTrack;!this._isDtsBaseInited&&this.calcDtsBase(t,i),this._remuxVideo(i),this._remuxAudio(t)}},{key:"resetDtsBase",value:function(){this._dtsBase=0,this._dtsBaseInited=!1}},{key:"seek",value:function(){this._videoNextDts=null,this._audioNextDts=null,this._videoSegmentList.clear(),this._audioSegmentList.clear()}},{key:"onMetaDataReady",value:function(e){var t=void 0;t="audio"===e?this._context.getInstance("TRACKS").audioTrack:this._context.getInstance("TRACKS").videoTrack;var i=this._context.getInstance("PRE_SOURCE_BUFFER"),n=i.getSource(e);n||(n=i.createSource(e)),n.mimetype=t.meta.codec,n.init=this.remuxInitSegment(e,t.meta),this.emit(mr.INIT_SEGMENT,e)}},{key:"remuxInitSegment",value:function(e,t){var i=new Vn,n=vr.ftyp(),r=vr.moov({type:e,meta:t});return i.write(n,r),i}},{key:"calcDtsBase",value:function(e,t){if(!e&&t.samples.length)return t.samples[0].dts;if(e.samples.length||t.samples.length){var i=1/0,n=1/0;e.samples&&e.samples.length&&(i=e.samples[0].dts),t.samples&&t.samples.length&&(n=t.samples[0].dts),this._dtsBase=Math.min(i,n),this._isDtsBaseInited=!0}}},{key:"_remuxVideo",value:function(e){var t=e||{};if(e.samples&&e.samples.length){for(var i=t.samples,n=-1,r=null,a=[],s={samples:[]},o=1e4;i.length&&o-- >0;){var u=i.shift(),l=u.isKeyframe,h=u.options;if(!this.isFirstAudio&&h&&h.meta){r=this.remuxInitSegment("video",h.meta),h.meta=null,i.unshift(u),h.isContinue||this.resetDtsBase();break}var f=u.dts-this._dtsBase;-1===n&&(n=f);var d=void 0,c=void 0;void 0!==u.pts&&(d=(c=u.pts-this._dtsBase)-f),void 0!==u.cts&&(c=u.cts+f,d=u.cts);var p={buffer:[],size:0};s.samples.push(p),p.buffer.push(u.data),p.size+=u.data.byteLength;var v=0;v=u.duration?u.duration:i.length>=1?i[0].dts-this._dtsBase-f:a.length>=1?a[a.length-1].duration:this.videoMeta.refSampleDuration,this.videoAllDuration+=v,a.push({dts:f,cts:d,pts:c,data:u.data,size:u.data.byteLength,isKeyframe:l,duration:v,flags:{isLeading:0,dependsOn:l?2:1,isDependedOn:l?1:0,hasRedundancy:0,isNonSync:l?0:1},originDts:f,type:"video"}),l&&this.emit(mr.RANDOM_ACCESS_POINT,c)}var y=new Vn;if(a.length){var m=vr.moof({id:t.meta.id,time:n,samples:a}),g=vr.mdat(s);y.write(m,g),this.writeToSource("video",y)}if(r&&(this.writeToSource("video",r),i.length))return t.samples=i,this._remuxVideo(t);this.isFirstVideo=!1,this.emit(mr.MEDIA_SEGMENT,"video");var _=a[a.length-1];this._videoNextDts=_.dts+_.duration,t.samples=[],t.length=0}}},{key:"_remuxAudio",value:function(e){var t=(e||{}).samples,i=-1,n=[],r=null,a={samples:[]};if(t&&t.length){for(var s=1e4,o=!1;t.length&&s-- >0;){var u=t.shift(),l=u.data,h=u.options;if(!this.isFirstAudio&&h&&h.meta){r=this.remuxInitSegment("audio",h.meta),h.meta=null,t.unshift(u),h.isContinue||this.resetDtsBase();break}var f=u.dts-this._dtsBase,d=f;o||(i=f,o=!0);var c=0;c=u.duration?u.duration:this.audioMeta.refSampleDurationFixed?this.audioMeta.refSampleDurationFixed:t.length>=1?t[0].dts-this._dtsBase-f:n.length>=1?n[n.length-1].duration:this.audioMeta.refSampleDuration,this.audioAllDuration+=c;var p={dts:f,pts:f,cts:0,size:l.byteLength,duration:u.duration?u.duration:c,flags:{isLeading:0,dependsOn:2,isDependedOn:1,hasRedundancy:0,isNonSync:0},isKeyframe:!0,originDts:d,type:"audio"},v={buffer:[],size:0};v.buffer.push(l),v.size+=l.byteLength,a.samples.push(v),n.push(p)}var y=new Vn;if(n.length){var m=vr.moof({id:e.meta.id,time:i,samples:n}),g=vr.mdat(a);y.write(m,g),this.writeToSource("audio",y)}if(r&&(this.writeToSource("audio",r),t.length))return e.samples=t,this._remuxAudio(e);this.isFirstAudio=!1,this.emit(mr.MEDIA_SEGMENT,"audio",y);var _=n[n.length-1];this._videoNextDts=_.dts+_.duration,e.samples=[],e.length=0}}},{key:"writeToSource",value:function(e,t){var i=this._context.getInstance("PRE_SOURCE_BUFFER"),n=i.getSource(e);n||(n=i.createSource(e)),n.data.push(t)}},{key:"initSilentAudio",value:function(t,i){var n=e.getSilentFrame(this._audioMeta.channelCount);return{dts:t,pts:t,cts:0,duration:i,unit:n,size:n.byteLength,originDts:t,type:"video"}}},{key:"videoMeta",get:function(){return this._context.getInstance("TRACKS").videoTrack.meta}},{key:"audioMeta",get:function(){return this._context.getInstance("TRACKS").audioTrack.meta}}],[{key:"getSilentFrame",value:function(e){return 1===e?new Uint8Array([0,200,0,128,35,128]):2===e?new Uint8Array([33,0,73,144,2,25,0,35,128]):3===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]):4===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]):5===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]):6===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]):null}}]),e}(),_r=Cn.LOADER_EVENTS,kr=function(){function e(t){Oe(this,e),this.configs=Object.assign({},t),this.url=null,this.status=0,this.error=null,this._reader=null,this._canceled=!1,this._destroyed=!1,this.readtype=this.configs.readtype,this.buffer=this.configs.buffer||"LOADER_BUFFER",this._loaderTaskNo=0}return Le(e,[{key:"init",value:function(){this.on(_r.LADER_START,this.load.bind(this))}},{key:"load",value:function(e,t){var i=this;this.url=e,this._canceled=!1;var n=this.getParams(t);return i.loading=!0,fetch(this.url,n).then(function(e){if(e.ok)return i.status=e.status,i._onFetchResponse(e);i.loading=!1,i.emit(_r.LOADER_ERROR,i.TAG,new Error("invalid response."))}).catch(function(e){throw i.loading=!1,i.emit(_r.LOADER_ERROR,i.TAG,e),new Error(e.message)})}},{key:"_onFetchResponse",value:function(e){var t=this,i=this._context.getInstance(this.buffer),n=++this._loaderTaskNo;if(!0===e.ok)switch(this.readtype){case 2:e.json().then(function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(e),t.emit(_r.LOADER_COMPLETE,i)):t.emit(_r.LOADER_COMPLETE,e))});break;case 1:e.text().then(function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(e),t.emit(_r.LOADER_COMPLETE,i)):t.emit(_r.LOADER_COMPLETE,e))});break;case 3:e.arrayBuffer().then(function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(new Uint8Array(e)),t.emit(_r.LOADER_COMPLETE,i)):t.emit(_r.LOADER_COMPLETE,e))});break;case 0:default:return this._onReader(e.body.getReader(),n)}}},{key:"_onReader",value:function(e,t){var i=this._context.getInstance(this.buffer);if(!i&&this._reader||this._destroyed)try{this._reader.cancel()}catch(e){}if(this._reader=e,!1!==this.loading){var n=this;this._reader&&this._reader.read().then(function(r){if(!n._canceled&&!n._destroyed)return r.done?(n.loading=!1,n.status=0,void n.emit(_r.LOADER_COMPLETE,i)):(i.push(r.value),n.emit(_r.LOADER_DATALOADED,i),n._onReader(e,t));if(n._reader)try{n._reader.cancel()}catch(e){}}).catch(function(e){n.loading=!1,n.emit(_r.LOADER_ERROR,n.TAG,e)})}}},{key:"getParams",value:function(e){var t=Object.assign({},e),i=new Headers,n={method:"GET",headers:i,mode:"cors",cache:"default"};if("object"===Re(this.configs.headers)){var r=this.configs.headers;for(var a in r)r.hasOwnProperty(a)&&i.append(a,r[a])}if("object"===Re(t.headers)){var s=t.headers;for(var o in s)s.hasOwnProperty(o)&&i.append(o,s[o])}return!1===t.cors&&(n.mode="same-origin"),t.withCredentials&&(n.credentials="include"),n}},{key:"cancel",value:function(){if(this._reader){try{this._reader.cancel()}catch(e){}this._reader=null,this.loading=!1}this._canceled=!0}},{key:"destroy",value:function(){this._destroyed=!0,this.cancel()}}],[{key:"type",get:function(){return"loader"}}]),e}(),Er=Cn.REMUX_EVENTS,br=Cn.DEMUX_EVENTS,Ar=Cn.LOADER_EVENTS,Sr="FLVController",wr=function(){function e(){Gi(this,e)}return zi(e,[{key:"warn",value:function(){}}]),e}(),Tr=function(){function t(e){Gi(this,t),this.TAG=Sr,this._player=e,this.state={initSegmentArrived:!1,range:{start:0,end:""},rangeSupport:!0}}return zi(t,[{key:"init",value:function(){var e=this;this._context.registry("FETCH_LOADER",kr),this._context.registry("LOADER_BUFFER",ur),this._context.registry("FLV_DEMUXER",cr),this._context.registry("TRACKS",ar),this._context.registry("MP4_REMUXER",gr.Mp4Remuxer),this._context.registry("PRE_SOURCE_BUFFER",lr),this._context.registry("COMPATIBILITY",Yn),this._context.registry("LOGGER",wr),this.mse=this._context.registry("MSE",jn)({container:this._player.video}),this.initListeners(),setTimeout(function(){e.loadMeta()},0)}},{key:"initListeners",value:function(){this.on(Ar.LOADER_DATALOADED,this._handleLoaderDataLoaded.bind(this)),this.on(Ar.LOADER_ERROR,this._handleNetworkError.bind(this)),this.on(br.MEDIA_INFO,this._handleMediaInfo.bind(this)),this.on(br.METADATA_PARSED,this._handleMetadataParsed.bind(this)),this.on(br.DEMUX_COMPLETE,this._handleDemuxComplete.bind(this)),this.on(br.DEMUX_ERROR,this._handleDemuxError.bind(this)),this.on(Er.INIT_SEGMENT,this._handleAppendInitSegment.bind(this)),this.on(Er.MEDIA_SEGMENT,this._handleMediaSegment.bind(this))}},{key:"_handleMediaInfo",value:function(){var e=this;this._context.onMetaData||this.emit(br.DEMUX_ERROR,new Error("failed to get mediainfo"));var t=this._context.getInstance("LOADER_BUFFER"),i=this._context.getInstance("FETCH_LOADER");this.isSeekable&&(i.cancel(),this.state.range={start:0,end:t.historyLen-1},setTimeout(function(){e.loadNext(0)}))}},{key:"_handleLoaderDataLoaded",value:function(){this.emitTo("FLV_DEMUXER",br.DEMUX_START)}},{key:"_handleMetadataParsed",value:function(e){this.emit(Er.REMUX_METADATA,e)}},{key:"_handleDemuxComplete",value:function(){this.emit(Er.REMUX_MEDIA)}},{key:"_handleAppendInitSegment",value:function(){this.state.initSegmentArrived=!0,this.mse.addSourceBuffers()}},{key:"_handleMediaSegment",value:function(){this.mse.addSourceBuffers(),this.mse.doAppend()}},{key:"_handleNetworkError",value:function(t,i){this._player.emit("error",new e.Errors("network",this._player.config.url)),this._onError(Ar.LOADER_ERROR,t,i,!0)}},{key:"_handleDemuxError",value:function(t,i,n){void 0===n&&(n=!1),this._player.emit("error",new e.Errors("parse",this._player.config.url)),this._onError(Ar.LOADER_ERROR,t,i,n)}},{key:"_onError",value:function(e,t,i,n){var r={errorType:e,errorDetails:"["+t+"]: "+i.message,errorFatal:n||!1};this._player.emit("FLV_ERROR",r)}},{key:"seek",value:function(e){if(!this._context.onMetaData)return void this.loadMeta();if(this.isSeekable){this._context.getInstance("LOADER_BUFFER").clear();var t=this._player.config.preloadTime,i=void 0===t?15:t,n=this.getSeekRange(e,i);this.state.range=n,this.compat&&this.compat.reset(),this.loadData()}}},{key:"loadNext",value:function(e){this._context.onMetaData&&(this.loader.loading||this.getNextRange(e)&&this.loadData())}},{key:"loadData",value:function(){var e=this.state.range,t=e.start,i=e.end;this.emit(Ar.LADER_START,this._player.config.url,{headers:{method:"get",Range:"bytes="+t+"-"+i}})}},{key:"loadMeta",value:function(){var e=this;this.loader.load(this._player.config.url,{headers:{Range:"bytes=0-"}}).catch(function(){e.state.rangeSupport=!1,e.loadFallback()})}},{key:"loadFallback",value:function(){var t=this;this.loader.load(this._player.config.url).catch(function(){t._player.emit("error",new e.Errors("network",t._player.config.url))})}},{key:"getSeekRange",value:function(e,i){var n=this._context.onMetaData.keyframes,r=this._context.mediaInfo.duration,a=e,s=e+i,o=t.findFilePosition(a,n);return s>=r||a>=r?{start:o,end:""}:{start:o,end:t.findFilePosition(s,n)}}},{key:"getNextRange",value:function(e){if(""!==this.state.range.end){var t=this.getSeekRange(e,this.config.preloadTime||15).end;if(!(t<=this.state.range.end&&""!==t))return this.state.range={start:this.state.range.end+1,end:t},!0}}},{key:"destroy",value:function(){this._player=null,this.mse=null,this.state={initSegmentArrived:!1,range:{start:0,end:""},rangeSupport:!0}}},{key:"isSeekable",get:function(){return!!this.state.rangeSupport&&(!this._context||!this._context.mediaInfo.isComplete()||null!==this._context.mediaInfo.keyframes&&void 0!==this._context.mediaInfo.keyframes)}},{key:"config",get:function(){return this._player.config}},{key:"loader",get:function(){return this._context.getInstance("FETCH_LOADER")}},{key:"compat",get:function(){return this._context.getInstance("COMPATIBILITY")}}],[{key:"findFilePosition",value:function(e,t){for(var i=0,n=t.times.length;i<n;i++){var r=t.times[i],a=i+1<n?t.times[i+1]:Number.MAX_SAFE_INTEGER;if(r<=e&&e<=a)return t.filepositions[i]}return""}}]),t}(),Dr=Cn.FlvAllowedEvents,Rr=function(e,t){if(!e.config.isLive&&e.duration-e.currentTime<2){var i=e.getBufferedRange();e.currentTime-i[1]<.1&&(e.emit("ended"),t.mse.endOfStream())}},Or=function(e){function t(e){Gi(this,t);var i=Wi(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.context=new Un(Dr),i.initEvents(),i}return Hi(t,e),zi(t,[{key:"start",value:function(){var e=this.context.registry("FLV_CONTROLLER",Tr)(this);this.flv=e,this.context.init(),Xi(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",this).call(this,e.mse.url)}},{key:"initEvents",value:function(){this.on("timeupdate",this.handleTimeUpdate.bind(this)),this.on("seeking",this.handleSeek.bind(this)),this.once("destroy",this._destroy.bind(this))}},{key:"handleTimeUpdate",value:function(){this.loadData(),Rr(this,this.flv)}},{key:"handleSeek",value:function(){var e=this.currentTime,t=this.getBufferedRange();(e>t[1]||e<t[0])&&this.flv.seek(this.currentTime)}},{key:"_destroy",value:function(){this.context.destroy(),this.context=null,this.flv=null}},{key:"loadData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.currentTime,t=this.getBufferedRange();t[1]-e<(this.config.preloadTime||15)-5&&this.flv.loadNext(t[1]+1)}},{key:"src",get:function(){return this.currentSrc},set:function(e){var t=this;this.player.config.url=e,this.paused?this.start(e):(this.pause(),this.once("pause",function(){t.start(e)}),this.once("canplay",function(){t.play()})),this.once("canplay",function(){t.currentTime=0})}}]),t}(e);return function e(t){return Oe(this,e),t.isLive?new Pi(t):new Or(t)}});
//# sourceMappingURL=index.min.js.map
