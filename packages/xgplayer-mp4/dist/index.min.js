!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("xgplayer")):"function"==typeof define&&define.amd?define(["xgplayer"],t):(e=e||self,e.Mp4Player=t(e.Player))}(this,function(e){"use strict";function t(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function i(e,t){return t={exports:{}},e(t,t.exports),t.exports}function r(e){return!!e&&"object"==typeof e}function n(e){var t=Object.prototype.toString.call(e);return"[object RegExp]"===t||"[object Date]"===t||a(e)}function a(e){return e.$$typeof===R}function o(e){return Array.isArray(e)?[]:{}}function s(e,t){return!1!==t.clone&&t.isMergeableObject(e)?f(o(e),e,t):e}function u(e,t,i){return e.concat(t).map(function(e){return s(e,i)})}function d(e,t,i){var r={};return i.isMergeableObject(e)&&Object.keys(e).forEach(function(t){r[t]=s(e[t],i)}),Object.keys(t).forEach(function(n){i.isMergeableObject(t[n])&&e[n]?r[n]=f(e[n],t[n],i):r[n]=s(t[n],i)}),r}function f(e,t,i){(i=i||{}).arrayMerge=i.arrayMerge||u,i.isMergeableObject=i.isMergeableObject||j;var r=Array.isArray(t);return r===Array.isArray(e)?r?i.arrayMerge(e,t,i):d(e,t,i):s(t,i)}e=e&&e.hasOwnProperty("default")?e.default:e;var h=function(e){return void 0!==e&&null!==e},c={object:!0,function:!0,undefined:!0},l=function(e){return!!h(e)&&hasOwnProperty.call(c,typeof e)},m=function(e){if(!l(e))return!1;try{return!!e.constructor&&e.constructor.prototype===e}catch(e){return!1}},v=function(e){if("function"!=typeof e)return!1;if(!hasOwnProperty.call(e,"length"))return!1;try{if("number"!=typeof e.length)return!1;if("function"!=typeof e.call)return!1;if("function"!=typeof e.apply)return!1}catch(e){return!1}return!m(e)},p=/^\s*class[\s{\/}]/,y=Function.prototype.toString,w=function(e){return!!v(e)&&!p.test(y.call(e))},g=function(e){return void 0!==e&&null!==e},b=Object.keys,U=function(e){return b(g(e)?Object(e):e)},k=function(){try{return Object.keys("primitive"),!0}catch(e){return!1}}()?Object.keys:U,x=function(e){if(!g(e))throw new TypeError("Cannot use null or undefined");return e},B=Math.max,_=function(e,t){var i,r,n,a=B(arguments.length,2);for(e=Object(x(e)),n=function(r){try{e[r]=t[r]}catch(e){i||(i=e)}},r=1;r<a;++r)t=arguments[r],k(t).forEach(n);if(void 0!==i)throw i;return e},S=function(){var e,t=Object.assign;return"function"==typeof t&&(e={foo:"raz"},t(e,{bar:"dwa"},{trzy:"trzy"}),e.foo+e.bar+e.trzy==="razdwatrzy")}()?Object.assign:_,T=Array.prototype.forEach,z=Object.create,C=function(e,t){var i;for(i in e)t[i]=e[i]},M=function(e){var t=z(null);return T.call(arguments,function(e){g(e)&&C(Object(e),t)}),t},A="razdwatrzy",E=String.prototype.indexOf,O=function(e){return E.call(this,e,arguments[1])>-1},D=function(){return"function"==typeof A.contains&&(!0===A.contains("dwa")&&!1===A.contains("foo"))}()?String.prototype.contains:O,F=i(function(e){(e.exports=function(e,t){var i,r,n,a,o;return arguments.length<2||"string"!=typeof e?(a=t,t=e,e=null):a=arguments[2],h(e)?(i=D.call(e,"c"),r=D.call(e,"e"),n=D.call(e,"w")):(i=n=!0,r=!1),o={value:t,configurable:i,enumerable:r,writable:n},a?S(M(a),o):o}).gs=function(e,t,i){var r,n,a,o;return"string"!=typeof e?(a=i,i=t,t=e,e=null):a=arguments[3],h(t)?w(t)?h(i)?w(i)||(a=i,i=void 0):i=void 0:(a=t,t=i=void 0):t=void 0,h(e)?(r=D.call(e,"c"),n=D.call(e,"e")):(r=!0,n=!1),o={get:t,set:i,configurable:r,enumerable:n},a?S(M(a),o):o}}),L=function(e){if("function"!=typeof e)throw new TypeError(e+" is not a function");return e},P=i(function(e,t){var i,r,n,a,o,s,u,d=Function.prototype.apply,f=Function.prototype.call,h=Object.create,c=Object.defineProperty,l=Object.defineProperties,m=Object.prototype.hasOwnProperty,v={configurable:!0,enumerable:!1,writable:!0};o={on:i=function(e,t){var i;return L(t),m.call(this,"__ee__")?i=this.__ee__:(i=v.value=h(null),c(this,"__ee__",v),v.value=null),i[e]?"object"==typeof i[e]?i[e].push(t):i[e]=[i[e],t]:i[e]=t,this},once:r=function(e,t){var r,a;return L(t),a=this,i.call(this,e,r=function(){n.call(a,e,r),d.call(t,this,arguments)}),r.__eeOnceListener__=t,this},off:n=function(e,t){var i,r,n,a;if(L(t),!m.call(this,"__ee__"))return this;if(!(i=this.__ee__)[e])return this;if("object"==typeof(r=i[e]))for(a=0;n=r[a];++a)n!==t&&n.__eeOnceListener__!==t||(2===r.length?i[e]=r[a?0:1]:r.splice(a,1));else r!==t&&r.__eeOnceListener__!==t||delete i[e];return this},emit:a=function(e){var t,i,r,n,a;if(m.call(this,"__ee__")&&(n=this.__ee__[e]))if("object"==typeof n){for(i=arguments.length,a=new Array(i-1),t=1;t<i;++t)a[t-1]=arguments[t];for(n=n.slice(),t=0;r=n[t];++t)d.call(r,this,a)}else switch(arguments.length){case 1:f.call(n,this);break;case 2:f.call(n,this,arguments[1]);break;case 3:f.call(n,this,arguments[1],arguments[2]);break;default:for(i=arguments.length,a=new Array(i-1),t=1;t<i;++t)a[t-1]=arguments[t];d.call(n,this,a)}}},s={on:F(i),once:F(r),off:F(n),emit:F(a)},u=l({},s),e.exports=t=function(e){return null==e?h(u):l(Object(e),s)},t.methods=o}),j=(P.methods,function(e){return r(e)&&!n(e)}),R="function"==typeof Symbol&&Symbol.for?Symbol.for("react.element"):60103;f.all=function(e,t){if(!Array.isArray(e))throw new Error("first argument should be an array");return e.reduce(function(e,i){return f(e,i,t)},{})};var I=f,N="1.1.8",K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},q=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},H=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),G=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},X=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},V=function(e){function t(e,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"";q(this,t),r.version=N;var a=X(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,i,r));return a.url=n,a}return G(t,e),t}(e.Errors),W=function(){function e(t){if(q(this,e),!(t instanceof ArrayBuffer))throw new V("parse","",{line:9,handle:"[Stream] constructor",msg:"data is valid"});this.buffer=t,this.dataview=new DataView(t),this.dataview.position=0}return H(e,[{key:"skip",value:function(t){for(var i=Math.floor(t/4),r=t%4,n=0;n<i;n++)e.readByte(this.dataview,4);r>0&&e.readByte(this.dataview,r)}},{key:"readUint8",value:function(){return e.readByte(this.dataview,1)}},{key:"readUint16",value:function(){return e.readByte(this.dataview,2)}},{key:"readUint32",value:function(){return e.readByte(this.dataview,4)}},{key:"readUint64",value:function(){return e.readByte(this.dataview,8)}},{key:"readInt8",value:function(){return e.readByte(this.dataview,1,!0)}},{key:"readInt16",value:function(){return e.readByte(this.dataview,2,!0)}},{key:"readInt32",value:function(){return e.readByte(this.dataview,4,!0)}},{key:"position",set:function(e){this.dataview.position=e},get:function(){return this.dataview.position}}],[{key:"readByte",value:function(e,t,i){var r=void 0;switch(t){case 1:r=i?e.getInt8(e.position):e.getUint8(e.position);break;case 2:r=i?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(i)throw"not supported for readByte 3";r=e.getUint8(e.position)<<16,r|=e.getUint8(e.position+1)<<8,r|=e.getUint8(e.position+2);break;case 4:r=i?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(i)throw new V("parse","",{line:73,handle:"[Stream] readByte",msg:"not supported for readBody 8"});r=e.getUint32(e.position)<<32,r|=e.getUint32(e.position+4);break;default:r=""}return e.position+=t,r}}]),e}(),Y=function(){function e(){q(this,e),this.headSize=8,this.size=0,this.type="",this.subBox=[],this.start=-1}return H(e,[{key:"readHeader",value:function(e){if(this.start=e.position,this.size=e.readUint32(),this.type=String.fromCharCode(e.readUint8(),e.readUint8(),e.readUint8(),e.readUint8()),1===this.size)this.size=e.readUint64();else if(0===this.size&&"mdat"!==this.type)throw new V("parse","",{line:19,handle:"[Box] readHeader",msg:"parse mp4 mdat box failed"});if("uuid"===this.type)for(var t=[],i=0;i<16;i++)t.push(e.readUint8())}},{key:"readBody",value:function(t){var i=this.size-t.position+this.start,r=this.type;this.data=t.buffer.slice(t.position,t.position+i),t.position+=this.data.byteLength;var n=void 0;(n=e.containerBox.find(function(e){return e===r})?e.containerParser:e[r])&&n instanceof Function&&n.call(this)}},{key:"read",value:function(e){this.readHeader(e),this.readBody(e)}}],[{key:"containerParser",value:function(){for(var t=new W(this.data),i=t.buffer.byteLength,r=this;t.position<i;){var n=new e;n.readHeader(t),r.subBox.push(n),n.readBody(t)}delete r.data,t=null}}]),e}();Y.containerBox=["moov","trak","edts","mdia","minf","dinf","stbl","mvex","moof","traf","mfra"],Y.avc1=function(){var e=new W(this.data),t=this;e.skip(6),this.dataReferenceIndex=e.readUint16(),e.skip(16),this.width=e.readUint16(),this.height=e.readUint16(),this.horizresolution=e.readUint32(),this.vertresolution=e.readUint32(),e.skip(4),this.frameCount=e.readUint16(),e.skip(1);for(var i=0;i<31;i++)String.fromCharCode(e.readUint8());for(this.depth=e.readUint16(),e.skip(2);e.position<e.buffer.byteLength;){var r=new Y;r.readHeader(e),t.subBox.push(r),r.readBody(e)}delete this.data,e=null},Y.avcC=function(){var e=new W(this.data);this.configVersion=e.readUint8(),this.profile=e.readUint8(),this.profileCompatibility=e.readUint8(),this.AVCLevelIndication=e.readUint8(),this.lengthSizeMinusOne=1+(3&e.readUint8()),this.numOfSequenceParameterSets=31&e.readUint8();var t=e.readUint16();this.sequenceLength=t;for(var i=[],r=0;r<t;r++)i.push(Number(e.readUint8()).toString(16));this.ppsCount=e.readUint8();var n=e.readUint16();this.ppsLength=n;for(var a=[],o=0;o<n;o++)a.push(Number(e.readUint8()).toString(16));this.pps=a,this.sequence=i;for(var s=[],u=e.dataview.byteLength;e.position<u;)s.push(e.readUint8());this.last=s,delete this.subBox,delete this.data,e=null},Y.btrt=function(){var e=new W(this.data);this.bufferSizeDB=e.readUint32(),this.maxBitrate=e.readUint32(),this.avgBitrate=e.readUint32(),delete this.subBox,delete this.data,e=null},Y.co64=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3),this.count=e.readUint32();var t=[];this.entries=t;for(var i=0,r=this.count;i<r;i++)t.push(e.readUint64());delete this.subBox,delete this.data,e=null},Y.ctts=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3),this.entryCount=e.readUint32();var t=[];this.entry=t;for(var i=0,r=this.entryCount;i<r;i++)t.push({count:e.readUint32(),offset:e.readUint32()});delete this.subBox,delete this.data,e=null},Y.dref=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3);var t=e.readUint32();this.entryCount=t;for(var i=this,r=0;r<t;r++){var n=new Y;i.subBox.push(n),n.read(e)}delete this.data,e=null},Y.elst=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3);var t=[],i=e.readUint32();this.entries=t;for(var r=0;r<i;r++){var n={};t.push(n),1===this.version?(n.segment_duration=e.readUint64(),n.media_time=e.readUint64()):(n.segment_duration=e.readUint32(),n.media_time=e.readInt32()),n.media_rate_integer=e.readInt16(),n.media_rate_fraction=e.readInt16()}delete this.subBox,delete this.data,e=null},Y.esds=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3);var t=Y.MP4ESDescrTag(e);this.subBox.push(t),delete this.data,e=null},Y.ftyp=function(){var e=new W(this.data);this.major_brand=String.fromCharCode(e.readUint8(),e.readUint8(),e.readUint8(),e.readUint8()),this.minor_version=e.readUint32();for(var t=[],i=0,r=Math.floor((e.buffer.byteLength-8)/4);i<r;i++)t.push(String.fromCharCode(e.readUint8(),e.readUint8(),e.readUint8(),e.readUint8()));this.compatible_brands=t,e=null,delete this.subBox,delete this.data},Y.hdlr=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3),e.skip(4),this.handleType=""+String.fromCharCode(e.readUint8())+String.fromCharCode(e.readUint8())+String.fromCharCode(e.readUint8())+String.fromCharCode(e.readUint8()),e.skip(12);for(var t=[];e.position<this.size-8;)t.push(String.fromCharCode(e.readUint8()));this.name=t.join(""),delete this.subBox,delete this.data,e=null},Y.iods=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3);for(var t=[],i=e.buffer.byteLength;e.position<i;)t.push(e.readUint8());this.content=t,delete this.subBox,delete this.data,e=null},Y.mdat=function(){delete this.subBox};var Z=function(){function e(){q(this,e);var t=new Date;t.setFullYear(1904),t.setMonth(0),t.setDate(1),t.setHours(0),t.setMinutes(0),t.setSeconds(0),this.time=t}return H(e,[{key:"setTime",value:function(e){return this.time.setTime(this.time.getTime()+1*e),this.time.toLocaleString()}}]),e}();Y.mdhd=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3),1===this.version?(this.create=e.readUint64(),this.modify=e.readUint64(),this.createTime=(new Z).setTime(1e3*this.create),this.modifyTime=(new Z).setTime(1e3*this.modify),this.timescale=e.readUint32(),this.duration=e.readUint64()):(this.create=e.readUint32(),this.modify=e.readUint32(),this.createTime=(new Z).setTime(1e3*this.create),this.modifyTime=(new Z).setTime(1e3*this.modify),this.timescale=e.readUint32(),this.duration=e.readUint32()),this.language=e.readUint16(),e.readUint16(),delete this.subBox,delete this.data,e=null},Y.mp4a=function(){var e=new W(this.data);e.skip(6),this.dataReferenceIndex=e.readUint16(),e.skip(8),this.channelCount=e.readUint16(),this.sampleSize=e.readUint16(),e.skip(4),this.sampleRate=e.readUint32()>>16;var t=new Y;t.readHeader(e),this.subBox.push(t),t.readBody(e),delete this.data,e=null},Y.MP4DecConfigDescrTag=function(e){var t=new Y,i=void 0;return t.type=e.readUint8(),i=e.readUint8(),128===i?(t.extend=!0,e.skip(2),i=e.readUint8()+5):i+=2,t.size=i,t.typeID=e.readUint8(),t.streamUint=e.readUint8(),t.bufferSize=W.readByte(e.dataview,3),t.maximum=e.readUint32(),t.average=e.readUint32(),t.subBox.push(Y.MP4DecSpecificDescrTag(e)),t},Y.MP4DecSpecificDescrTag=function(e){var t=new Y,i=void 0,r=void 0;t.type=e.readUint8(),128===(i=e.readUint8())?(t.extend=!0,e.skip(2),r=(i=e.readUint8()+5)-5):(r=i,i+=2),t.size=i;for(var n=[],a=0;a<r;a++)n.push(Number(e.readUint8()).toString(16).padStart(2,"0"));return t.EScode=n,delete t.subBox,t},Y.MP4ESDescrTag=function(e){var t=new Y,i=void 0;return t.type=e.readUint8(),i=e.readUint8(),128===i?(t.extend=!0,e.skip(2),i=e.readUint8()+5):i+=2,t.size=i,t.esID=e.readUint16(),t.priority=e.readUint8(),t.subBox.push(Y.MP4DecConfigDescrTag(e)),t.subBox.push(Y.SLConfigDescriptor(e)),t},Y.mvhd=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3),this.create=e.readUint32(),this.modify=e.readUint32(),this.createTime=(new Z).setTime(1e3*this.create),this.modifyTime=(new Z).setTime(1e3*this.modify),this.timeScale=e.readUint32(),this.duration=e.readUint32(),this.rate=e.readUint16()+"."+e.readUint16(),this.volume=e.readUint8()+"."+e.readUint8(),W.readByte(e.dataview,8),W.readByte(e.dataview,2);for(var t=[],i=0;i<9;i++)t.push(e.readUint16()+"."+e.readUint16());this.matrix=t,W.readByte(e.dataview,24),this.nextTrackID=e.readUint32(),delete this.subBox,delete this.data},Y.pasp=function(){var e=new W(this.data);this.content=e.buffer.slice(0,this.size-8),delete this.subBox,delete this.data,e=null},Y.SLConfigDescriptor=function(e){var t=new Y,i=void 0;return t.type=e.readUint8(),i=e.readUint8(),128===i?(t.extend=!0,e.skip(2),i=e.readUint8()+5):i+=2,t.size=i,t.SL=e.readUint8(),delete t.subBox,t},Y.smhd=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3),this.balance=e.readInt8()+"."+e.readInt8(),delete this.subBox,delete this.data,e=null},Y.stco=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3),this.count=e.readUint32();var t=[];this.entries=t;for(var i=0,r=this.count;i<r;i++)t.push(e.readUint32());delete this.subBox,delete this.data,e=null},Y.stsc=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3),this.count=e.readUint32();var t=[];this.entries=t;for(var i=0,r=this.count;i<r;i++)t.push({first_chunk:e.readUint32(),samples_per_chunk:e.readUint32(),sample_desc_index:e.readUint32()});for(var n,a,o=0,s=this.count;o<s-1;o++)n=t[o],a=t[o-1],n.chunk_count=t[o+1].first_chunk-n.first_chunk,n.first_sample=0===o?1:a.first_sample+a.chunk_count*a.samples_per_chunk;if(1===this.count){var u=t[0];u.first_sample=1,u.chunk_count=0}else if(this.count>1){var d=t[this.count-1],f=t[this.count-2];d.first_sample=f.first_sample+f.chunk_count*f.samples_per_chunk,d.chunk_count=0}delete this.subBox,delete this.data,e=null},Y.stsd=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3),this.entryCount=e.readUint32();var t=new Y;t.readHeader(e),this.subBox.push(t),t.readBody(e),delete this.data,e=null},Y.stss=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3),this.count=e.readUint32();var t=[];this.entries=t;for(var i=0,r=this.count;i<r;i++)t.push(e.readUint32());delete this.subBox,delete this.data,e=null},Y.stsz=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3),this.sampleSize=e.readUint32(),this.count=e.readUint32();var t=[];this.entries=t;for(var i=0,r=this.count;i<r;i++)t.push(e.readUint32());delete this.subBox,delete this.data,e=null},Y.stts=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3),this.count=e.readUint32();for(var t=[],i=0,r=this.count;i<r;i++)t.push({sampleCount:e.readUint32(),sampleDuration:e.readUint32()});this.entry=t,delete this.subBox,delete this.data,e=null},Y.tkhd=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=W.readByte(e.dataview,3,0),1===this.version?(this.create=e.readUint64(),this.modify=e.readUint64(),this.createTime=(new Z).setTime(1e3*this.create),this.modifyTime=(new Z).setTime(1e3*this.modify),this.trackID=e.readUint32(),this.reserverd=e.readUint32(),this.duration=e.readUint64()):(this.create=e.readUint32(),this.modify=e.readUint32(),this.createTime=(new Z).setTime(1e3*this.create),this.modifyTime=(new Z).setTime(1e3*this.modify),this.trackID=e.readUint32(),this.reserverd=e.readUint32(),this.duration=e.readUint32()),e.readUint64(),this.layer=e.readInt16(),this.alternate_group=e.readInt16(),this.volume=e.readInt16()>>8,e.readUint16();for(var t=[],i=0;i<9;i++)t.push(e.readUint16()+"."+e.readUint16());this.matrix=t,this.width=e.readUint16()+"."+e.readUint16(),this.height=e.readUint16()+"."+e.readUint16(),delete this.data,delete this.subBox,e=null},Y.udta=function(){delete this.subBox},Y["url "]=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=[e.readUint8(),e.readUint8(),e.readUint8()];for(var t=[],i=e.buffer.byteLength;e.position<i;)t.push(e.readUint8());this.location=t,delete this.subBox,delete this.data,e=null},Y.vmhd=function(){var e=new W(this.data);this.version=e.readUint8(),this.flag=[e.readUint8(),e.readUint8(),e.readUint8()],this.graphicsmode=e.readUint16(),this.opcolor=[e.readUint16(),e.readUint16(),e.readUint16()],delete this.subBox,delete this.data,e=null};var $=i(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){for(var t=0,i=arguments.length,r=Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];var a=!0,o=!1,s=void 0;try{for(var u,d=r[Symbol.iterator]();!(a=(u=d.next()).done);a=!0)t+=u.value.length}catch(e){o=!0,s=e}finally{try{!a&&d.return&&d.return()}finally{if(o)throw s}}var f=new e(t),h=0,c=!0,l=!1,m=void 0;try{for(var v,p=r[Symbol.iterator]();!(c=(v=p.next()).done);c=!0){var y=v.value;f.set(y,h),h+=y.length}}catch(e){l=!0,m=e}finally{try{!c&&p.return&&p.return()}finally{if(l)throw m}}return f}});t($);var J=t(i(function(e){var t=function(e){return e&&e.__esModule?e:{default:e}}($);e.exports=t.default})),Q=function e(t){q(this,e),this.buffer=null,this.boxes=[],this.nextBox=null,this.start=0;var i=this;i.buffer?J(Uint8Array,i.buffer,t):i.buffer=t;var r=t.byteLength;t.position=0;for(var n=new W(t);r-n.position>=8;){var a=new Y;if(a.readHeader(n),a.size-8<=r-n.position)a.readBody(n),i.boxes.push(a);else{if("mdat"!==a.type){i.nextBox=a,n.position-=8;break}a.readBody(n),i.boxes.push(a)}}i.buffer=new Uint8Array(i.buffer.slice(n.position))},ee=function(){function e(){q(this,e),this.buffer=new Uint8Array(0)}return H(e,[{key:"write",value:function(){for(var e=this,t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];i.forEach(function(t){t?e.buffer=J(Uint8Array,e.buffer,t):window.console.error(t)})}}],[{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,255&e])}}]),e}(),te=Math.pow(2,32)-1,ie=function(){function e(){q(this,e)}return H(e,null,[{key:"type",value:function(e){return new Uint8Array([e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)])}},{key:"size",value:function(e){return ee.writeUint32(e)}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,255&t])}},{key:"ftyp",value:function(){var t=new ee;return t.write(e.size(24),e.type("ftyp"),new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49])),t.buffer}},{key:"moov",value:function(t){var i=new ee,r=8,n=e.mvhd(t.duration,t.timeScale),a=e.videoTrak(t),o=e.audioTrak(t),s=e.mvex(t.duration,t.timeScale);return[n,a,o,s].forEach(function(e){r+=e.byteLength}),i.write(e.size(r),e.type("moov"),n,a,o,s),i.buffer}},{key:"mvhd",value:function(t,i){var r=new ee;t*=i;var n=Math.floor(t/(te+1)),a=Math.floor(t%(te+1)),o=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,i>>24&255,i>>16&255,i>>8&255,255&i,n>>24,n>>16&255,n>>8&255,255&n,a>>24,a>>16&255,a>>8&255,255&a,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return r.write(e.size(8+o.length),e.type("mvhd"),new Uint8Array(o)),r.buffer}},{key:"videoTrak",value:function(t){var i=new ee,r=8,n=e.tkhd({id:1,duration:t.videoDuration,timescale:t.videoTimeScale,width:t.width,height:t.height,type:"video"}),a=e.mdia({type:"video",timescale:t.videoTimeScale,duration:t.videoDuration,sps:t.sps,pps:t.pps,pixelRatio:t.pixelRatio,width:t.width,height:t.height});return[n,a].forEach(function(e){r+=e.byteLength}),i.write(e.size(r),e.type("trak"),n,a),i.buffer}},{key:"audioTrak",value:function(t){var i=new ee,r=8,n=e.tkhd({id:2,duration:t.audioDuration,timescale:t.audioTimeScale,width:0,height:0,type:"audio"}),a=e.mdia({type:"audio",timescale:t.audioTimeScale,duration:t.audioDuration,channelCount:t.channelCount,samplerate:t.sampleRate,audioConfig:t.audioConfig});return[n,a].forEach(function(e){r+=e.byteLength}),i.write(e.size(r),e.type("trak"),n,a),i.buffer}},{key:"tkhd",value:function(t){var i=new ee,r=t.id,n=t.duration*t.timeScale,a=t.width,o=t.height,s=t.type,u=Math.floor(n/(te+1)),d=Math.floor(n%(te+1)),f=new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,r>>24&255,r>>16&255,r>>8&255,255&r,0,0,0,0,u>>24,u>>16&255,u>>8&255,255&u,d>>24,d>>16&255,d>>8&255,255&d,0,0,0,0,0,0,0,0,0,0,0,"video"===s?1:0,"audio"===s?1:0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,a>>8&255,255&a,0,0,o>>8&255,255&o,0,0]);return i.write(e.size(8+f.byteLength),e.type("tkhd"),f),i.buffer}},{key:"edts",value:function(t){var i=new ee,r=t.duration,n=t.mediaTime;return i.write(e.size(36),e.type("edts")),i.write(e.size(28),e.type("elst")),i.write(new Uint8Array([0,0,0,1,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n,0,0,0,1])),i.buffer}},{key:"mdia",value:function(t){var i=new ee,r=8,n=e.mdhd(t.timescale),a=e.hdlr(t.type),o=e.minf(t);return[n,a,o].forEach(function(e){r+=e.byteLength}),i.write(e.size(r),e.type("mdia"),n,a,o),i.buffer}},{key:"mdhd",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=new ee;i*=t;var n=Math.floor(i/(te+1)),a=Math.floor(i%(te+1)),o=new Uint8Array([0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,255&t,n>>24,n>>16&255,n>>8&255,255&n,a>>24,a>>16&255,a>>8&255,255&a,85,196,0,0]);return r.write(e.size(12+o.byteLength),e.type("mdhd"),e.extension(1,0),o),r.buffer}},{key:"hdlr",value:function(t){var i=new ee,r=[0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0];return"audio"===t&&(r.splice.apply(r,[8,4].concat([115,111,117,110])),r.splice.apply(r,[24,13].concat([83,111,117,110,100,72,97,110,100,108,101,114,0]))),i.write(e.size(8+r.length),e.type("hdlr"),new Uint8Array(r)),i.buffer}},{key:"minf",value:function(t){var i=new ee,r=8,n="video"===t.type?e.vmhd():e.smhd(),a=e.dinf(),o=e.stbl(t);return[n,a,o].forEach(function(e){r+=e.byteLength}),i.write(e.size(r),e.type("minf"),n,a,o),i.buffer}},{key:"vmhd",value:function(){var t=new ee;return t.write(e.size(20),e.type("vmhd"),new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0])),t.buffer}},{key:"smhd",value:function(){var t=new ee;return t.write(e.size(16),e.type("smhd"),new Uint8Array([0,0,0,0,0,0,0,0])),t.buffer}},{key:"dinf",value:function(){var t=new ee,i=[0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1];return t.write(e.size(36),e.type("dinf"),e.size(28),e.type("dref"),new Uint8Array(i)),t.buffer}},{key:"stbl",value:function(t){var i=new ee,r=8,n=e.stsd(t),a=e.stts(),o=e.stsc(),s=e.stsz(),u=e.stco();return[n,a,o,s,u].forEach(function(e){r+=e.byteLength}),i.write(e.size(r),e.type("stbl"),n,a,o,s,u),i.buffer}},{key:"stsd",value:function(t){var i=new ee,r=void 0;return r="audio"===t.type?e.mp4a(t):e.avc1(t),i.write(e.size(16+r.byteLength),e.type("stsd"),e.extension(0,0),new Uint8Array([0,0,0,1]),r),i.buffer}},{key:"mp4a",value:function(t){var i=new ee,r=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,t.samplerate>>8&255,255&t.samplerate,0,0]),n=e.esds(t.audioConfig);return i.write(e.size(8+r.byteLength+n.byteLength),e.type("mp4a"),r,n),i.buffer}},{key:"esds",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[43,146,8,0],i=t.length,r=new ee,n=new Uint8Array([0,0,0,0,3,23+i,0,1,0,4,15+i,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([i]).concat(t).concat([6,1,2]));return r.write(e.size(8+n.byteLength),e.type("esds"),n),r.buffer}},{key:"avc1",value:function(t){var i=new ee,r=t.sps,n=t.pps,a=t.width,o=t.height,s=t.pixelRatio[0],u=t.pixelRatio[1],d=new Uint8Array([1,r[1],r[2],r[3],255,225].concat([r.length>>>8&255,255&r.length]).concat(r).concat(1).concat([n.length>>>8&255,255&n.length]).concat(n)),f=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,a>>8&255,255&a,o>>8&255,255&o,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),h=new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]),c=new Uint8Array([s>>24,s>>16&255,s>>8&255,255&s,u>>24,u>>16&255,u>>8&255,255&u]);return i.write(e.size(40+f.byteLength+d.byteLength+h.byteLength),e.type("avc1"),f,e.size(8+d.byteLength),e.type("avcC"),d,e.size(20),e.type("btrt"),h,e.size(16),e.type("pasp"),c),i.buffer}},{key:"stts",value:function(){var t=new ee,i=new Uint8Array([0,0,0,0,0,0,0,0]);return t.write(e.size(16),e.type("stts"),i),t.buffer}},{key:"stsc",value:function(){var t=new ee,i=new Uint8Array([0,0,0,0,0,0,0,0]);return t.write(e.size(16),e.type("stsc"),i),t.buffer}},{key:"stco",value:function(){var t=new ee,i=new Uint8Array([0,0,0,0,0,0,0,0]);return t.write(e.size(16),e.type("stco"),i),t.buffer}},{key:"stsz",value:function(){var t=new ee,i=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);return t.write(e.size(20),e.type("stsz"),i),t.buffer}},{key:"mvex",value:function(t,i){var r=new ee,n=ee.writeUint32(t*i);return r.write(e.size(88),e.type("mvex"),e.size(16),e.type("mehd"),e.extension(0,0),n,e.trex(1),e.trex(2)),r.buffer}},{key:"trex",value:function(t){var i=new ee,r=new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return i.write(e.size(8+r.byteLength),e.type("trex"),r),i.buffer}},{key:"moof",value:function(t){var i=new ee,r=8,n=e.mfhd(),a=e.traf(t);return[n,a].forEach(function(e){r+=e.byteLength}),i.write(e.size(r),e.type("moof"),n,a),i.buffer}},{key:"mfhd",value:function(){var t=new ee,i=ee.writeUint32(e.sequence);return e.sequence+=1,t.write(e.size(16),e.type("mfhd"),e.extension(0,0),i),t.buffer}},{key:"traf",value:function(t){var i=new ee,r=8,n=e.tfhd(t.id),a=e.tfdt(t.time),o=e.sdtp(t),s=e.trun(t,o.byteLength);return[n,a,o,s].forEach(function(e){r+=e.byteLength}),i.write(e.size(r),e.type("traf"),n,a,o,s),i.buffer}},{key:"tfhd",value:function(t){var i=new ee,r=ee.writeUint32(t);return i.write(e.size(16),e.type("tfhd"),e.extension(0,0),r),i.buffer}},{key:"tfdt",value:function(t){var i=new ee,r=Math.floor(t/(te+1)),n=Math.floor(t%(te+1));return i.write(e.size(20),e.type("tfdt"),e.extension(1,0),ee.writeUint32(r),ee.writeUint32(n)),i.buffer}},{key:"trun",value:function(t,i){var r=t.id,n=1===r?16:12,a=new ee,o=ee.writeUint32(t.samples.length),s=ee.writeUint32(96+n*t.samples.length+i);return a.write(e.size(20+n*t.samples.length),e.type("trun"),e.extension(0,t.flags),o,s),t.samples.forEach(function(e,t){a.write(ee.writeUint32(e.duration)),a.write(ee.writeUint32(e.size)),1===r?(a.write(ee.writeUint32(e.key?33554432:16842752)),a.write(ee.writeUint32(e.offset))):a.write(ee.writeUint32(16777216))}),a.buffer}},{key:"sdtp",value:function(t){var i=new ee;return i.write(e.size(12+t.samples.length),e.type("sdtp"),e.extension(0,0)),t.samples.forEach(function(e){i.write(new Uint8Array(1===t.id?[e.key?32:16]:[16]))}),i.buffer}},{key:"mdat",value:function(t){var i=new ee,r=8;return t.samples.forEach(function(e){r+=e.size}),i.write(e.size(r),e.type("mdat")),t.samples.forEach(function(e){i.write(e.buffer)}),i.buffer}}]),e}();ie.sequence=1;var re=function(){function e(t,i,r,n){q(this,e),P(this),this.url=t,this.range=i,this.withCredentials=r,this.id=i.join("-"),this.on=!1;var a=new window.XMLHttpRequest;a.target=this,a.responseType="arraybuffer",a.withCredentials=this.withCredentials||!1,a.open("get",t),a.setRequestHeader("Range","bytes="+i[0]+"-"+i[1]),a.onload=function(){200!==a.status&&206!==a.status||n&&n instanceof Function&&n(a.response),a.target.remove()},a.onerror=function(e){a.target.emit("error",new V("network","",{line:25,handle:"[Task] constructor",msg:e.message,url:t})),a.target.remove()},a.onabort=function(){a.target.remove()},this.xhr=a,e.queue.push(this),this.update()}return H(e,[{key:"cancel",value:function(){this.xhr.abort()}},{key:"remove",value:function(){var t=this;e.queue.filter(function(i,r){return i.url===t.url&&i.id===t.id&&(e.queue.splice(r,1),!0)}),this.update()}},{key:"update",value:function(){var t=e.queue,i=t.filter(function(e){return e.on}),r=t.filter(function(e){return!e.on}),n=e.limit-i.length;r.forEach(function(e,t){t<n&&e.run()})}},{key:"run",value:function(){1===this.xhr.readyState?(this.on=!0,this.xhr.send()):this.remove()}}],[{key:"clear",value:function(){e.queue.forEach(function(e){e.on&&e.cancel()}),e.queue.length=0}}]),e}();re.queue=[],re.limit=2,window.Task=re;var ne={};ne.findBox=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];if(e.type!==t){if(e&&e.subBox){var r=e.subBox.filter(function(e){return e.type===t});r.length?r.forEach(function(e){return i.push(e)}):e.subBox.forEach(function(e){return ne.findBox(e,t,i)})}}else i.push(e);return i=[].concat(i),i.length>1?i:i[0]},ne.padStart=function(e,t,i){for(var r=String(i),n=t>>0,a=Math.ceil(n/r.length),o=[],s=String(e);a--;)o.push(r);return o.join("").substring(0,n-s.length)+s},ne.toHex=function(){for(var e=[],t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];return i.forEach(function(t){e.push(ne.padStart(Number(t).toString(16),2,0))}),e},ne.sum=function(){for(var e=0,t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];return i.forEach(function(t){e+=t}),e},ne.stscOffset=function(e,t){var i=void 0,r="",n=e.entries.filter(function(e){return e.first_sample<=t&&t<e.first_sample+e.chunk_count*e.samples_per_chunk})[0];if(n){var a=Math.floor((t-n.first_sample)/n.samples_per_chunk),o=n.first_sample+a*n.samples_per_chunk;return i=n.first_chunk+a,r=[o,t],{chunk_index:i,samples_offset:r}}var s=e.entries.pop();e.entries.push(s);var u=Math.floor((t-s.first_sample)/s.samples_per_chunk);return{chunk_index:s.first_chunk+u,samples_offset:[s.first_sample+s.samples_per_chunk*u,t]}},ne.seekSampleOffset=function(e,t,i,r,n){var a=ne.stscOffset(e,r+1),o=t.entries[a.chunk_index-1]+ne.sum.apply(null,i.entries.slice(a.samples_offset[0]-1,a.samples_offset[1]-1))-n;if(void 0===o)throw"result="+o+",stco.length="+t.entries.length+",sum="+ne.sum.apply(null,i.entries.slice(0,r));if(o<0)throw"result="+o+",stco.length="+t.entries.length+",sum="+ne.sum.apply(null,i.entries.slice(0,r));return o},ne.seekSampleTime=function(e,t,i){var r=void 0,n=void 0,a=0,o=0,s=0;if(e.entry.every(function(e){return n=e.sampleDuration,i<a+e.sampleCount?(r=o+(i-a)*e.sampleDuration,!1):(a+=e.sampleCount,o+=e.sampleCount*n,!0)}),t){var u=0;t.entry.every(function(e){return u+=e.count,!(i<u)||(s=e.offset,!1)})}return r||(r=o+(i-a)*n),{time:r,duration:n,offset:s}},ne.seekOrderSampleByTime=function(e,t,i){var r=0,n=0,a=0,o=void 0;return e.every(function(e,s){return o=e.sampleCount*e.sampleDuration/t,i<=r+o?(n=a+Math.ceil((i-r)*t/e.sampleDuration),r+=Math.ceil((i-r)*t/e.sampleDuration)*e.sampleDuration/t,!1):(r+=o,a+=e.sampleCount,!0)}),{order:n,startTime:r}},ne.seekTrakDuration=function(e,t){var i=0;return ne.findBox(e,"stts").entry.forEach(function(e){i+=e.sampleCount*e.sampleDuration}),Number(i/t).toFixed(4)};var ae=function(){function e(t,i){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Math.pow(25,4);q(this,e),P(this),this.url=t,this.withCredentials=i,this.CHUNK_SIZE=r,this.init(t),this.once("moovReady",this.moovParse.bind(this)),this.cache=new ee,this.bufferCache=new Set,this.timeRage=[],this.canDownload=!0}return H(e,[{key:"getData",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:t+this.CHUNK_SIZE,r=this;return new Promise(function(n,a){new re(e.url,[t,i],e.withCredentials,n).once("error",function(e){r.emit("error",e)})})}},{key:"moovParse",value:function(){var e=this,t=this,i=this.moovBox,r=ne.findBox(i,"mvhd"),n=void 0,a=void 0,o=void 0,s=void 0,u=void 0,d=void 0,f=void 0,h=void 0,c=void 0,l=void 0,m=void 0,v=void 0,p=void 0,y=void 0;ne.findBox(i,"trak").forEach(function(e){var i=ne.findBox(e,"hdlr"),r=ne.findBox(e,"mdhd");if(!i||!r)return void t.emit("error",new V("parse","",{line:72,handle:"[MP4] moovParse",url:t.url}));var w=ne.findBox(e,"stsd").subBox[0];if("vide"===i.handleType){var g=ne.findBox(e,"avcC"),b=ne.findBox(e,"tkhd");n=e,u=r.timescale,g?(o=w.type+"."+ne.toHex(g.profile,g.profileCompatibility,g.AVCLevelIndication).join(""),f=g.sequence&&g.sequence.map(function(e){return Number("0x"+e)}),h=g.pps&&g.pps.map(function(e){return Number("0x"+e)}),c=g.profile):o=""+w.type,b&&(l=b.width,m=b.height)}if("soun"===i.handleType){a=e;var U=ne.findBox(e,"esds"),k=ne.findBox(e,"mp4a"),x=ne.findBox(e,5);d=r.timescale,s=U?w.type+"."+ne.toHex(U.subBox[0].subBox[0].typeID)+"."+U.subBox[0].subBox[0].subBox[0].type:""+w.type,x&&x.EScode&&(y=x.EScode.map(function(e){return Number("0x"+e)})),k&&(v=k.channelCount,p=k.sampleRate)}}),this.videoTrak=I({},n),this.audioTrak=I({},a);var w=this._boxes.find(function(e){return"mdat"===e.type}),g=ne.seekTrakDuration(n,u),b=ne.seekTrakDuration(a,d);this.mdatStart=w.start;var U=this.videoKeyFrames,k=U.length-1;U.forEach(function(t,i){i<k?e.timeRage.push([t.time.time/u,U[i+1].time.time/u]):e.timeRage.push([t.time.time/u,-1])}),this.meta={videoCodec:o,audioCodec:s,createTime:r.createTime,modifyTime:r.modifyTime,duration:r.duration/r.timeScale,timeScale:r.timeScale,videoDuration:g,videoTimeScale:u,audioDuration:b,audioTimeScale:d,endTime:Math.min(g,b),sps:f,pps:h,width:l,height:m,profile:c,pixelRatio:[1,1],channelCount:v,sampleRate:p,audioConfig:y}}},{key:"init",value:function(){var e=this;e.getData().then(function(t){var i=void 0,r=0,n=void 0,a=void 0;try{i=new Q(t)}catch(t){return e.emit("error",t.type?t:new V("parse","",{line:176,handle:"[MP4] init",msg:t.message})),!1}if(e._boxes=a=i.boxes,a.every(function(t){return r+=t.size,"moov"!==t.type||(n=t,e.moovBox=n,e.emit("moovReady",n),!1)}),!n){var o=i.nextBox;o?"moov"===o.type?e.getData(r,r+o.size+28).then(function(t){var i=new Q(t);e._boxes=e._boxes.concat(i.boxes),(n=i.boxes.filter(function(e){return"moov"===e.type})).length?(e.moovBox=n[0],e.emit("moovReady",n)):e.emit("error",new V("parse","",{line:203,handle:"[MP4] init",msg:"not find moov box"}))}):e.emit("error",new V("parse","",{line:207,handle:"[MP4] init",msg:"not find moov box"})):e.getData(r,"").then(function(t){var i=new Q(t);i?(e._boxes=e._boxes.concat(i.boxes),i.boxes.every(function(t){return"moov"!==t.type||(n=t,e.moovBox=n,e.emit("moovReady",n),!1)})):e.emit("error",new V("parse","",{line:225,handle:"[MP4] init",msg:"not find moov box"}))})}}).catch(function(){e.emit("error",new V("network","",{line:231,handle:"[MP4] getData",msg:"getData failed"}))})}},{key:"getSamplesByOrders",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"video",t=arguments[1],i=arguments[2],r="video"===e?this.videoTrak:this.audioTrak,n=ne.findBox(r,"stsc"),a=ne.findBox(r,"stsz"),o=ne.findBox(r,"stts"),s=ne.findBox(r,"stco"),u=ne.findBox(r,"ctts"),d=this.mdatStart,f=[];if(i=void 0!==i?i:a.entries.length,t instanceof Array)t.forEach(function(e,t){f.push({idx:e,size:a.entries[e],time:ne.seekSampleTime(o,u,e),offset:ne.seekSampleOffset(n,s,a,e,d)})});else if(0!==i)for(var h=t;h<i;h++)f.push({idx:h,size:a.entries[h],time:ne.seekSampleTime(o,u,h),offset:ne.seekSampleOffset(n,s,a,h,d)});else f={idx:t,size:a.entries[t],time:ne.seekSampleTime(o,u,t),offset:ne.seekSampleOffset(n,s,a,t,d)};return f}},{key:"packMeta",value:function(){if(this.meta){var e=new ee;return e.write(ie.ftyp()),e.write(ie.moov(this.meta)),this.cache.write(e.buffer),e.buffer}}},{key:"seek",value:function(e){var t=e*this.meta.videoTimeScale,i=void 0,r=this.videoKeyFrames,n=this.audioKeyFrames;return r.every(function(e,n){var a=e.time.time,o=r[n+1]?r[n+1].time.time:Number.MAX_SAFE_INTEGER;return!(a<=t&&t<o)||(i=n,!1)}),n.every(function(e,r){var a=e.startTime,o=n[r+1]?n[r+1].startTime:Number.MAX_SAFE_INTEGER;return!(a<=t&&t<o)||(i=Math.min(r,i),!1)}),this.bufferCache.has(i)?Promise.resolve(null):this.loadFragment(i)}},{key:"loadFragment",value:function(e){var t=void 0,i=void 0,r=this.videoKeyFrames[e],n=this.getSamplesByOrders("audio",this.audioKeyFrames[e].order,0);if(t=Math.min(r.offset,n.offset),e<this.videoKeyFrames.length-1){var a=this.videoKeyFrames[e+1],o=this.getSamplesByOrders("audio",this.audioKeyFrames[e+1].order,0);i=Math.max(a.offset,o.offset)}var s=this;return window.isNaN(t)||void 0!==i&&window.isNaN(i)?(s.emit("error",new V("parse","",{line:366,handle:"[MP4] loadFragment",url:s.url})),!1):this.bufferCache.has(e)?Promise.resolve(null):this.getData(t+s.mdatStart,i?s.mdatStart+i:"").then(function(i){return s.createFragment(new Uint8Array(i),t,e)})}},{key:"addFragment",value:function(e){var t=new ee;return t.write(ie.moof(e)),t.write(ie.mdat(e)),this.cache.write(t.buffer),t.buffer}},{key:"createFragment",value:function(e,t,i){var r=this,n=[];this.bufferCache.add(i);var a=r.videoKeyFrames.map(function(e){return e.idx}),o=r.getSamplesByOrders("video",a[i],a[i+1]),s=o.map(function(i,r){return{size:i.size,duration:i.time.duration,offset:i.time.offset,buffer:new Uint8Array(e.slice(i.offset-t,i.offset-t+i.size)),key:0===r}});n.push(this.addFragment({id:1,time:o[0].time.time,firstFlags:33554432,flags:3841,samples:s}));var u=this.getSamplesByOrders("audio",this.audioKeyFrames[i].order,this.audioKeyFrames[i+1]?this.audioKeyFrames[i+1].order:void 0),d=u.map(function(i,r){return{size:i.size,duration:i.time.duration,offset:i.time.offset,buffer:new Uint8Array(e.slice(i.offset-t,i.offset-t+i.size)),key:0===r}});n.push(this.addFragment({id:2,time:u[0].time.time,firstFlags:0,flags:1793,samples:d}));var f=0;n.every(function(e){return f+=e.byteLength,!0});var h=new Uint8Array(f),c=0;return n.every(function(e){return h.set(e,c),c+=e.byteLength,!0}),Promise.resolve(h)}},{key:"download",value:function(){}},{key:"cut",value:function(e,t){var i=this;this.bufferCache.clear();var r=e*this.meta.videoTimeScale,n=t*this.meta.videoTimeScale,a=void 0,o=void 0,s=this.videoKeyFrames,u=this.audioKeyFrames;return s.every(function(e,t){var i=e.time.time,u=s[t+1]?s[t+1].time.time:Number.MAX_SAFE_INTEGER;return i<=r&&r<u?(a=t,!0):!(i<=n&&n<u)||(o=t,!1)}),u.every(function(e,t){var i=e.startTime,s=u[t+1]?u[t+1].startTime:Number.MAX_SAFE_INTEGER;return i<=r&&r<s?(a=Math.min(t,a),!0):!(i<=n&&n<s)||(o=Math.min(t,o),!1)}),o||(o=s.length),i.loadFragmentForCut(a,o)}},{key:"loadFragmentForCut",value:function(e,t){var i=void 0,r=void 0,n=this.videoKeyFrames[e],a=this.getSamplesByOrders("audio",this.audioKeyFrames[e].order,0);i=Math.min(n.offset,a.offset);var o=this.videoKeyFrames[t],s=this.getSamplesByOrders("audio",this.audioKeyFrames[t].order,0);r=Math.max(o.offset,s.offset);var u=this;return window.isNaN(i)||void 0!==r&&window.isNaN(r)?(u.emit("error",new V("parse","",{line:366,handle:"[MP4] loadFragment",url:u.url})),!1):this.getData(i+u.mdatStart,r?u.mdatStart+r:"").then(function(n){return u.createFragmentForCut(new Uint8Array(n),i,e,r,t)})}},{key:"createFragmentForCut",value:function(e,t,i,r,n){var a=this,o=[],s=a.videoKeyFrames.map(function(e){return e.idx}),u=a.getSamplesByOrders("video",s[i],s[n]).map(function(i,r){return{size:i.size,duration:i.time.duration,offset:i.time.offset,buffer:new Uint8Array(e.slice(i.offset-t,i.offset-t+i.size)),key:0===r}});o.push(this.addFragment({id:1,time:0,firstFlags:33554432,flags:3841,samples:u}));var d=this.getSamplesByOrders("audio",this.audioKeyFrames[i].order,this.audioKeyFrames[n]?this.audioKeyFrames[n].order:void 0).map(function(i,r){return{size:i.size,duration:i.time.duration,offset:i.time.offset,buffer:new Uint8Array(e.slice(i.offset-t,i.offset-t+i.size)),key:0===r}});o.push(this.addFragment({id:2,time:0,firstFlags:0,flags:1793,samples:d}));var f=0;o.every(function(e){return f+=e.byteLength,!0});var h=new Uint8Array(f),c=0;return o.every(function(e){return h.set(e,c),c+=e.byteLength,!0}),Promise.resolve(h)}},{key:"videoKeyFrames",get:function(){if(this._videoFrames)return this._videoFrames;var e=this.videoTrak,t=ne.findBox(e,"stss"),i=this.getSamplesByOrders("video",t.entries.map(function(e){return e-1}));return this._videoFrames=i,i}},{key:"audioKeyFrames",get:function(){if(this._audioFrames)return this._audioFrames;var e=ne.findBox(this.videoTrak,"mdhd").timescale,t=ne.findBox(this.audioTrak,"mdhd").timescale,i=ne.findBox(this.audioTrak,"stts").entry,r=[];return r=this.videoKeyFrames.map(function(r){return ne.seekOrderSampleByTime(i,t,r.time.time/e)}),this._audioFrames=r,this._audioFrames}}]),e}(),oe=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:'video/mp4; codecs="avc1.64001E, mp4a.40.5"';q(this,e);var i=this;P(this),this.codecs=t,this.mediaSource=new window.MediaSource,this.url=window.URL.createObjectURL(this.mediaSource),this.queue=[],this.updating=!1,this.mediaSource.addEventListener("sourceopen",function(){i.sourceBuffer=i.mediaSource.addSourceBuffer(i.codecs),i.sourceBuffer.addEventListener("error",function(e){i.emit("error",new V("mse","",{line:16,handle:"[MSE] constructor sourceopen",msg:e.message}))}),i.sourceBuffer.addEventListener("updateend",function(e){i.emit("updateend");var t=i.queue.shift();t&&i.sourceBuffer&&!i.sourceBuffer.updating&&"open"===i.state&&i.sourceBuffer.appendBuffer(t)}),i.emit("sourceopen")}),this.mediaSource.addEventListener("sourceclose",function(){i.emit("sourceclose")})}return H(e,[{key:"appendBuffer",value:function(e){var t=this.sourceBuffer;return t&&!t.updating&&"open"===this.state?(t.appendBuffer(e),!0):(this.queue.push(e),!1)}},{key:"removeBuffer",value:function(e,t){this.sourceBuffer.remove(e,t)}},{key:"endOfStream",value:function(){"open"===this.state&&this.mediaSource.endOfStream()}},{key:"state",get:function(){return this.mediaSource.readyState}},{key:"duration",get:function(){return this.mediaSource.duration},set:function(e){this.mediaSource.duration=e}}],[{key:"isSupported",value:function(e){return window.MediaSource&&window.MediaSource.isTypeSupported(e)}}]),e}(),se=e.BasePlugin,ue=e.Events,de=function(e,t){if(t.meta.endTime-e.currentTime<2){var i=e.getBufferedRange();e.currentTime-i[1]<.1&&e.mse.endOfStream()}};return function(e){function t(e){q(this,t);var i=X(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.loadData=i.loadData.bind(i),i.destroy=i.destroy.bind(i),i.onTimeUpdate=i.onTimeUpdate.bind(i),i.onSeeking=i.onSeeking.bind(i),i.initEvents(),i}return G(t,e),H(t,null,[{key:"pluginName",get:function(){return"mp4Player"}}]),H(t,[{key:"beforePlayerInit",value:function(){var e=this;return this.initMp4().then(function(){try{se.defineGetterOrSetter(e.player,{__url:{get:function(){return e.mse.url}}})}catch(e){}})}},{key:"initEvents",value:function(){var e=this.player;e.once("canplay",function(){if("safari"===se.Sniffer.browser&&e.buffered.length){var t=e.buffered.start(0);e.currentTime=t+.1}}),e.once(ue.DESTROY,this.destroy),e.on(ue.TIME_UPDATE,this.onTimeUpdate),e.on(ue.SEEKING,this.onSeeking),e.on(ue.WAITING,this.onWaiting)}},{key:"initMp4",value:function(){var e=this,t=this.player,i=new ae(t.config.url,t.config.withCredentials);return new Promise(function(t,r){i.once("moovReady",function(){var r=new oe;r.on("sourceopen",function(){r.appendBuffer(i.packMeta()),r.once("updateend",e.loadData)}),e.mse=r,e.mp4=i,t(i)}),i.on("error",r)})}},{key:"cut",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments[1],i=this.player,r=new ee,n=new ae(i.config.url,i.config.withCredentials);return new Promise(function(i,a){n.once("moovReady",function(){(!t||t<=e)&&(t=e+15),t>n.meta.duration&&(e=n.meta.duration-(t-e),t=n.meta.duration),n.cut(e,t).then(function(a){if(a){var o=se.Util.deepCopy({duration:t-e,audioDuration:t-e,endTime:t-e},n.meta);o.duration=t-e,o.videoDuration=t-e,o.audioDuration=t-e,o.endTime=t-e,r.write(n.packMeta(o),a),i(new Blob([r.buffer],{type:'video/mp4; codecs="avc1.64001E, mp4a.40.5"'}))}})}),n.on("error",function(e){a(e)})})}},{key:"loadData",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.player.currentTime,r=this.player;r.timer&&clearTimeout(r.timer),i=Math.max(i,r.currentTime),r.timer=setTimeout(function(){r.mp4.seek(i+.1*t).then(function(t){if(t){var i=e.mse;i.updating=!0,i.appendBuffer(t),i.once("updateend",function(){i.updating=!1})}},function(){t<10&&setTimeout(function(){e.loadData(t+1)},2e3)})},50)}},{key:"switchURL",value:function(e){var t=this,i=this.player,r=new ae(e,i.config.withCredentials),n=i.mp4;r.on("moovReady",function(){var a=i.currentTime,o=n.timeRage.find(function(e){return e[0]-a>2})[0],s=i.getBufferedRange()[1];s-o>0&&"safari"!==se.Sniffer.browser&&t.mse.removeBuffer(o,s),se.util.hasClass(i.root,"xgplayer-ended")||i.emit(ue.URL_CHANGE,e),t.mp4=r,t.mse.appendBuffer(r.packMeta())}),r.on("error",function(e){t.errorHandle(i,e)})}},{key:"playNext",value:function(e){var t=this,i=this.player,r=new ae(e,i.config.withCredentials),n=i.mp4;r.on("moovReady",function(){var e=[0,0],a=i.video.buffered,o=i.video.currentTime,s=0;if(a)for(var u=0,d=a.length;u<d;u++)e[0]=a.start(u),e[1]=a.end(u),e[0]<=o&&e[1]<=o&&(s=e[1]>s?e[1]:s,i.mse.removeBuffer(e[0],e[1]));t.mp4=r,t.mse.appendBuffer(r.packMeta());var f=!0;i.on("timeupdate",function(){if(f&&n.meta.endTime-i.currentTime<2){var e=i.getBufferedRange();if(i.currentTime-e[1]<.1&&(f=!1,i.currentTime=0,a=i.video.buffered))for(var t=0,r=a.length;t<r;t++)e[0]=a.start(t),e[1]=a.end(t),e[0]>=s&&i.mse.removeBuffer(e[0],e[1])}})}),r.on("error",function(e){t.errorHandle(e)})}},{key:"replay",value:function(){var e=this,t=this.player;re.clear(),this.mp4.bufferCache.clear(),this.initMp4().then(function(){t.hasStart=!1,t.start(),t.currentTime=0,t.play(),t.once("canplay",function(){t.on("waiting",e.onWaiting),e.mp4ProgressTimer=setInterval(e.onTimeUpdate,t.config.mp4ProgressTimer||300)})},function(t){e.errorHandle(t)})}},{key:"onTimeUpdate",value:function(){var e=this,t=this.player,i=this.mse,r=this.mp4;if(i&&!i.updating&&r.canDownload){var n=r.timeRage,a=t.getBufferedRange(),o=t.currentTime+this.playerConfig.preloadTime;if(a[1]-o>0)return;n.every(function(t,i){var n=(t[0]+t[1])/2;return 0!==a[1]&&(!(n>a[1]&&!r.bufferCache.has(i))||void e.loadData(0,n))}),de(t,r)}}},{key:"onWaiting",value:function(){var e=this.player,t=this.mp4;if(t&&t.meta){var i=e.getBufferedRange(),r=t.meta.videoDuration;r-e.currentTime<.5&&r-i[1]<.5?this.mse.endOfStream():(this.loadData(0,i[1]+1),this.waiterTimer=setTimeout(function(){for(var t=e.buffered,i=void 0,r=0,n=t.length;r<n;r++)if((i=t.start(r))>=e.currentTime){e.currentTime=i;break}},1500))}}},{key:"onSeeking",value:function(){var e=this.player,t=e.buffered,i=!1,r=e.currentTime;if(re.clear(),t.length){for(var n=0,a=t.length;n<a;n++)if(r>=t.start(n)&&r<=t.end(n)){i=!0;break}i||this.loadData(0,r)}else this.loadData(0,e.currentTime)}},{key:"errorHandle",value:function(e){var t=this.player;e.url=t.src,e.errd&&"object"===K(e.errd)&&t.mp4&&(e.errd.url=t.mp4.url,e.url=t.mp4.url,t.mp4.canDownload=!1),re.clear(),this.mp4&&this.mp4.bufferCache&&this.mp4.bufferCache.clear(),clearInterval(t.mp4ProgressTimer)}}]),t}(se)});
//# sourceMappingURL=index.min.js.map
