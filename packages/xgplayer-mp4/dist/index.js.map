{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import 'core-js/modules/es6.promise.js'\nimport 'core-js/modules/es7.string.pad-start'\nimport Player from 'xgplayer'\nimport MP4 from './mp4'\nimport MSE from './media/mse'\nimport Task from './media/task'\nimport Buffer from './fmp4/buffer'\n\nlet isEnded = (player, mp4) => {\n  if (mp4.meta.endTime - player.currentTime < 2) {\n    let range = player.getBufferedRange()\n    if (player.currentTime - range[1] < 0.1) {\n      player.mse.endOfStream()\n    }\n  }\n}\n\nlet mp4player = function () {\n  let player = this; let sniffer = Player.sniffer; let util = Player.util\n  let Errors = Player.Errors; let mainURL; let backupURL\n  let preloadTime = player.config.preloadTime || 15\n  let waiterTimer\n  let url = player.config.url\n  let rule = player.config.pluginRule || function () { return true }\n  if (!url) {\n    player.emit('error', new Errors('other', player.config.vid))\n    return\n  }\n  if (util.typeOf(url) === 'String') {\n    mainURL = url\n  } else if (util.typeOf(url) === 'Array' && url.length) {\n    mainURL = url[0].src\n    if(url.length > 1) {\n      backupURL = url[1].src\n    }\n  }\n  player.config._mainURL = mainURL\n  player.config._backupURL = backupURL\n  let loadData = (i = 0, time = player.currentTime) => {\n    if (player.timer) {\n      clearTimeout(player.timer)\n    }\n    time = Math.max(time, player.currentTime)\n    player.timer = setTimeout(function () {\n      player.mp4.seek(time + i * 0.1).then(buffer => {\n        if (buffer) {\n          let mse = player.mse\n          mse.updating = true\n          mse.appendBuffer(buffer)\n          mse.once('updateend', () => {\n            mse.updating = false\n          })\n        }\n      }, () => {\n        if (i < 10) {\n          setTimeout(function () {\n            loadData(i + 1)\n          }, 2000)\n        }\n      })\n    }, 50)\n  }\n  let init = (url) => {\n    let mp4 = new MP4(url, player.config.withCredentials)\n    let mse\n    return new Promise((resolve, reject) => {\n      mp4.once('moovReady', () => {\n        mse = new MSE()\n        mse.on('sourceopen', function () {\n          mse.appendBuffer(mp4.packMeta())\n          mse.once('updateend', loadData.bind(player))\n        })\n        mse.on('error', function (e) {\n          reject(e)\n        })\n        resolve([mp4, mse])\n      })\n      mp4.on('error', (e) => {\n        reject(e)\n      })\n    })\n  }\n  if (['chrome', 'firfox', 'safari'].some(item => item === sniffer.browser) && MSE.isSupported('video/mp4; codecs=\"avc1.64001E, mp4a.40.5\"')) {\n    player._start = player.start\n    if (!rule.call(player)) {\n      return false\n    }\n\n    let errorHandle = (player, err) => {\n      err.vid = player.config.vid\n      err.url = player.src\n      if (err.errd && typeof err.errd === 'object') {\n        if (player.mp4) {\n          err.errd.url = player.mp4.url\n          err.url = player.mp4.url\n          player.mp4.canDownload = false\n        }\n      }\n      player.emit('DATA_REPORT', err)\n      Task.clear()\n      if (player.mp4 && player.mp4.bufferCache) {\n        player.mp4.bufferCache.clear()\n      }\n      if (player.currentTime) {\n        player._currentTime = player.currentTime\n      }\n      if (player._start) {\n        player.start = player._start\n        player._start = null\n      }\n      player.switchURL = null\n      player._replay = null\n\n      // player.off('timeupdate', timeupdateFunc)\n      clearInterval(player.mp4ProgressTimer)\n      player.off('seeking', seekingFunc)\n      player.off('pause', pauseFunc)\n      player.off('playing', playingFunc)\n      player.off('waiting', waitingFunc)\n      player.off('ended', endedFunc)\n      player.off('destroy', destroyFunc)\n\n      if (err.errt === 'network' && player.config._backupURL) {\n        player.src = player.config._backupURL\n      } else {\n        player.src = player.config._mainURL\n      }\n      player.once('canplay', () => {\n        if (player._currentTime) {\n          player.currentTime = player._currentTime\n        }\n        player.play()\n      })\n    }\n\n    player.start = function (url = mainURL) {\n      init(url).then((result) => {\n        let mp4 = result[0]; let mse = result[1]\n        player._start(mse.url)\n        player.logParams.pluginSrc = url\n        player.mp4 = mp4\n        player.mse = mse\n        mp4.on('error', err => {\n          errorHandle(player, err)\n        })\n      }, err => {\n        player._start(url)\n        errorHandle(player, err)\n      })\n      player.once('canplay', () => {\n        // safari decoder time offset\n        if (sniffer.browser === 'safari' && player.buffered) {\n          let start = player.buffered.start(0)\n          player.currentTime = start + 0.1\n        }\n      })\n    }\n\n    player.cut = function (start = 0, end) {\n      let segment = new Buffer()\n      let mp4 = new MP4(url, player.config.withCredentials)\n      return new Promise((resolve, reject) => {\n        mp4.once('moovReady', () => {\n          if (!end || end <= start) {\n            end = start + 15\n          }\n          if (end > mp4.meta.duration) {\n            start = mp4.meta.duration - (end - start)\n            end = mp4.meta.duration\n          }\n          mp4.cut(start, end).then(buffer => {\n            if (buffer) {\n              let meta = Player.util.deepCopy({\n                duration: end - start,\n                audioDuration: end - start,\n                endTime: end - start\n              }, mp4.meta)\n              meta.duration = end - start\n              meta.videoDuration = end - start\n              meta.audioDuration = end - start\n              meta.endTime = end - start\n              segment.write(mp4.packMeta(meta), buffer)\n              resolve(new Blob([segment.buffer], {type: 'video/mp4; codecs=\"avc1.64001E, mp4a.40.5\"'}))\n            }\n          })\n        })\n        mp4.on('error', (e) => {\n          reject(e)\n        })\n      })\n    }\n\n    player.switchURL = (url) => {\n      let mp5 = new MP4(url, player.config.withCredentials)\n      let mp4 = player.mp4\n      mp5.on('moovReady', () => {\n        let timeRange = mp4.timeRage; let curTime = player.currentTime\n        timeRange = mp4.timeRage\n        let start = timeRange.find(item => item[0] - curTime > 2)[0]\n        let end = player.getBufferedRange()[1]\n        if (end - start > 0 && sniffer.browser !== 'safari') {\n          player.mse.removeBuffer(start, end)\n        }\n        if (!Player.util.hasClass(player.root, 'xgplayer-ended')) {\n          player.emit('urlchange', JSON.parse(JSON.stringify(player.logParams)))\n        }\n        player.logParams = {\n          bc: 0,\n          bu_acu_t: 0,\n          played: [{\n            begin: player.video.currentTime,\n            end: -1\n          }],\n          pt: new Date().getTime(),\n          vt: new Date().getTime(),\n          vd: 0\n        }\n        player.mp4 = mp5\n        player.mse.appendBuffer(mp5.packMeta())\n\n        player.logParams.pt = new Date().getTime()\n        // console.log('pt: ' + player.logParams.pt)\n        player.logParams.vt = new Date().getTime()\n        // console.log('vt: ' + player.logParams.vt)\n        player.logParams.vd = player.video.duration\n        player.logParams.pluginSrc = url\n      })\n      mp5.on('error', err => {\n        errorHandle(player, err)\n      })\n    }\n\n    player.playNext = (url) => {\n      let mp5 = new MP4(url, player.config.withCredentials)\n      let mp4 = player.mp4\n      mp5.on('moovReady', () => {\n        let range = [0, 0]\n        let buffered = player.video.buffered\n        let currentTime = player.video.currentTime\n        let max = 0\n        if (buffered) {\n          for (let i = 0, len = buffered.length; i < len; i++) {\n            range[0] = buffered.start(i)\n            range[1] = buffered.end(i)\n            if (range[0] <= currentTime && range[1] <= currentTime) {\n              max = range[1] > max ? range[1] : max\n              player.mse.removeBuffer(range[0], range[1])\n            }\n          }\n        }\n        player.mp4 = mp5\n        player.mse.appendBuffer(mp5.packMeta())\n        let flag = true\n        player.on('timeupdate', function () {\n          if (flag && mp4.meta.endTime - player.currentTime < 2) {\n            let range = player.getBufferedRange()\n            if (player.currentTime - range[1] < 0.1) {\n              flag = false\n              player.currentTime = 0\n              buffered = player.video.buffered\n              if (buffered) {\n                for (let i = 0, len = buffered.length; i < len; i++) {\n                  range[0] = buffered.start(i)\n                  range[1] = buffered.end(i)\n                  if (range[0] >= max) {\n                    player.mse.removeBuffer(range[0], range[1])\n                  }\n                }\n              }\n            }\n          }\n        })\n      })\n      mp5.on('error', err => {\n        errorHandle(player, err)\n      })\n    }\n\n    let timeupdateFunc = function () {\n      let mse = player.mse; let mp4 = player.mp4\n      if (mse && !mse.updating && mp4.canDownload) {\n        let timeRage = mp4.timeRage\n        let range = player.getBufferedRange(); let cacheMaxTime = player.currentTime + preloadTime\n        if (range[1] - cacheMaxTime > 0) {\n          return\n        }\n        timeRage.every((item, idx) => {\n          let start = item[0]; let end = item[1]; let center = (start + end) / 2\n          if (range[1] === 0) {\n            return false\n          } else {\n            if (center > range[1] && !mp4.bufferCache.has(idx)) {\n              loadData(0, center)\n            } else {\n              return true\n            }\n          }\n        })\n        isEnded(player, mp4)// hack for older webkit\n      }\n    }\n\n    // player.on('timeupdate', timeupdateFunc)\n    player.mp4ProgressTimer = setInterval(timeupdateFunc, player.config.mp4ProgressTimer || 300)\n\n    let seekingFunc = function () {\n      let buffered = player.buffered; let hasBuffered = false; let curTime = player.currentTime\n      Task.clear()\n      if (buffered.length) {\n        for (let i = 0, len = buffered.length; i < len; i++) {\n          if (curTime >= buffered.start(i) && curTime <= buffered.end(i)) {\n            hasBuffered = true\n            break\n          }\n        }\n        if (!hasBuffered) {\n          loadData(0, curTime)\n        }\n      } else {\n        loadData(0, player.currentTime)\n      }\n    }\n    player.on('seeking', seekingFunc)\n\n    let pauseFunc = function () {\n      Task.clear()\n    }\n    player.on('pause', pauseFunc)\n\n    let playingFunc = function () {\n      if (waiterTimer) {\n        clearTimeout(waiterTimer)\n      }\n    }\n    player.on('playing', playingFunc)\n\n    let waitingFunc = function () {\n      let mp4 = player.mp4\n      if (!mp4 || !mp4.meta) {\n        return\n      }\n      let range = player.getBufferedRange()\n      let duration = mp4.meta.videoDuration\n      if (duration - player.currentTime < 0.5 && duration - range[1] < 0.5) {\n        player.mse.endOfStream()\n      } else {\n        loadData(0, range[1] + 1)\n        waiterTimer = setTimeout(function () {\n          let buffered = player.buffered; let start\n          for (let i = 0, len = buffered.length; i < len; i++) {\n            start = buffered.start(i)\n            if (start >= player.currentTime) {\n              player.currentTime = start\n              break\n            }\n          }\n        }, 1500)\n      }\n    }\n    player.on('waiting', waitingFunc)\n\n    let endedFunc = function () {\n      player.off('waiting', waitingFunc)\n      // player.off('timeupdate', timeupdateFunc)\n      clearInterval(player.mp4ProgressTimer)\n    }\n    player.on('ended', endedFunc)\n\n    let destroyFunc = function () {\n      Task.clear()\n      if (player.timer) {\n        clearTimeout(player.timer)\n      }\n    }\n    player.once('destroy', destroyFunc)\n\n    player._replay = function () {\n      Task.clear()\n      player.mp4.bufferCache.clear()\n      init(player.mp4.url).then((result) => {\n        let mp4 = result[0]; let mse = result[1]\n        player._start(mse.url)\n        player.mp4 = mp4\n        player.mse = mse\n        player.currentTime = 0\n        player.play()\n        player.once('canplay', () => {\n          player.on('waiting', waitingFunc)\n          // player.on('timeupdate', timeupdateFunc)\n          player.mp4ProgressTimer = setInterval(timeupdateFunc, player.config.mp4ProgressTimer || 300)\n        })\n      }, err => {\n        errorHandle(player, err)\n      })\n    }\n  }\n}\n\nPlayer.install('mp4player', mp4player)\n"],"names":["isEnded","player","mp4","meta","endTime","currentTime","range","getBufferedRange","mse","endOfStream","mp4player","sniffer","Player","util","Errors","mainURL","backupURL","preloadTime","config","waiterTimer","url","rule","pluginRule","emit","vid","typeOf","length","src","_mainURL","_backupURL","loadData","i","time","timer","clearTimeout","Math","max","setTimeout","seek","then","buffer","updating","appendBuffer","once","init","MP4","withCredentials","Promise","resolve","reject","MSE","on","packMeta","bind","e","some","item","browser","isSupported","_start","start","call","errorHandle","err","errd","canDownload","Task","clear","bufferCache","_currentTime","switchURL","_replay","clearInterval","mp4ProgressTimer","off","seekingFunc","pauseFunc","playingFunc","waitingFunc","endedFunc","destroyFunc","errt","play","result","logParams","pluginSrc","buffered","cut","end","segment","Buffer","duration","deepCopy","audioDuration","videoDuration","write","Blob","type","mp5","timeRange","timeRage","curTime","find","removeBuffer","hasClass","root","JSON","parse","stringify","bc","bu_acu_t","played","begin","video","pt","Date","getTime","vt","vd","playNext","len","flag","timeupdateFunc","cacheMaxTime","every","idx","center","has","setInterval","hasBuffered","install"],"mappings":"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"}