!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["xgplayer-hls-live"]=t():e["xgplayer-hls-live"]=t()}(window,function(){return function(e){var t={};function r(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(i,n,function(t){return e[t]}.bind(null,n));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=1)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const i=r(3);t.default=class{constructor(e=[]){this._emitter=new i.EventEmitter,this._instanceMap={},this._clsMap={},this._inited=!1,this.allowedEvents=e}getInstance(e){if(this._instanceMap[e])return this._instanceMap[e];throw new Error(`${e}实例尚未初始化`)}initInstance(e,...t){if(this._clsMap[e]){const r=new this._clsMap[e](...t);return this._instanceMap[e]=r,r.init&&r.init(),r}throw new Error(`${e}未在context中注册`)}init(e){if(!this._inited){for(let t in this._clsMap)this._clsMap.hasOwnProperty(t)&&!this._instanceMap[t]&&this.initInstance(t,e);this._inited=!0}}registry(e,t){const r=this._emitter,i=this._isMessageNameValid.bind(this),n=this;return this._clsMap[e]=class extends t{constructor(...t){super(...t),this.listeners={},this.TAG=e,this._context=n}on(e,t){return i(e),this.listeners[e]?this.listeners[e].push(t):this.listeners[e]=[t],r.on(e,t)}once(e,t){return i(e),r.once(e,t)}emit(e,...t){return i(e),console.log(`[${this.TAG}] ${e}`,this),r.emit(e,...t)}off(e,t){return i(e),r.off(e,t)}removeListeners(){const e=Object.prototype.hasOwnProperty.bind(this.listeners);for(let t in this.listeners)if(e(t)){const e=this.listeners[t]||[];for(let i=0;i<e.length;i++){const n=e[i];r.off(t,n)}}}destroy(){this.removeListeners(),delete n._instanceMap[e],super.destroy()}},(...t)=>this.initInstance(e,...t)}destroyInstances(){Object.keys(this._instanceMap).forEach(e=>{this._instanceMap[e].destroy&&this._instanceMap[e].destroy()})}destroy(){this._emitter=null,this.allowedEvents=null,this._clsMap=null,this.destroyInstances()}_isMessageNameValid(e){if(!this.allowedEvents.indexOf(e)<0)throw new Error(`unregistered message name: ${e}`)}}},function(e,t,r){e.exports=r(2)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=d(r(0)),n=r(4),s=d(r(6)),a=d(r(8)),o=d(r(9));function d(e){return e&&e.__esModule?e:{default:e}}window.Context=i.default,t.default=class{constructor(e){this.configs=Object.assign({},e),this.url="",this.baseurl="",this.sequence=0,this._playlist=null}init(){this._context.registry("M3U8_BUFFER",n.XgBuffer),this._context.registry("TS_BUFFER",n.XgBuffer),this._context.initInstance("M3U8_BUFFER"),this._context.initInstance("TS_BUFFER"),this._context.registry("M3U8_LOADER",s.default),this._context.registry("TS_LOADER",s.default),this._context.initInstance("M3U8_LOADER",{buffer:"M3U8_BUFFER",readtype:1}),this._context.initInstance("TS_LOADER",{buffer:"TS_BUFFER",readtype:0}),this._context.registry("TS_DEMUXER",o.default),this._context.initInstance("TS_DEMUXER",{inputbuffer:"TS_BUFFER"}),this.initEvents()}initEvents(){console.log(this),this.on("LOADER_COMPLETE",e=>{let t=this._context.getInstance("TS_LOADER");if("M3U8_BUFFER"===e.TAG){let r=a.default.parse(e.shift(),this.baseurl);if(this._playlist,this._playlist=r,this._playlist.frags&&this._playlist.frags.length>0){let e=this._playlist.frags.shift();t.load(e.url)}}else if("TS_BUFFER"===e.TAG){this._context.getInstance("TS_DEMUXER").demux(),this._playlist.frags&&this._playlist.frags.length}})}load(e){this.baseurl=a.default.parseURL(e),this.url=e,this._context.getInstance("M3U8_LOADER").load(e)}}},function(e,t,r){"use strict";var i,n="object"==typeof Reflect?Reflect:null,s=n&&"function"==typeof n.apply?n.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};i=n&&"function"==typeof n.ownKeys?n.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var a=Number.isNaN||function(e){return e!=e};function o(){o.init.call(this)}e.exports=o,o.EventEmitter=o,o.prototype._events=void 0,o.prototype._eventsCount=0,o.prototype._maxListeners=void 0;var d=10;function l(e){return void 0===e._maxListeners?o.defaultMaxListeners:e._maxListeners}function u(e,t,r,i){var n,s,a,o;if("function"!=typeof r)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r);if(void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),a=s[t]),void 0===a)a=s[t]=r,++e._eventsCount;else if("function"==typeof a?a=s[t]=i?[r,a]:[a,r]:i?a.unshift(r):a.push(r),(n=l(e))>0&&a.length>n&&!a.warned){a.warned=!0;var d=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");d.name="MaxListenersExceededWarning",d.emitter=e,d.type=t,d.count=a.length,o=d,console&&console.warn&&console.warn(o)}return e}function h(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,s(this.listener,this.target,e))}function f(e,t,r){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},n=h.bind(i);return n.listener=r,i.wrapFn=n,n}function c(e,t,r){var i=e._events;if(void 0===i)return[];var n=i[t];return void 0===n?[]:"function"==typeof n?r?[n.listener||n]:[n]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(n):g(n,n.length)}function p(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function g(e,t){for(var r=new Array(t),i=0;i<t;++i)r[i]=e[i];return r}Object.defineProperty(o,"defaultMaxListeners",{enumerable:!0,get:function(){return d},set:function(e){if("number"!=typeof e||e<0||a(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");d=e}}),o.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||a(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},o.prototype.getMaxListeners=function(){return l(this)},o.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var i="error"===e,n=this._events;if(void 0!==n)i=i&&void 0===n.error;else if(!i)return!1;if(i){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var o=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw o.context=a,o}var d=n[e];if(void 0===d)return!1;if("function"==typeof d)s(d,this,t);else{var l=d.length,u=g(d,l);for(r=0;r<l;++r)s(u[r],this,t)}return!0},o.prototype.addListener=function(e,t){return u(this,e,t,!1)},o.prototype.on=o.prototype.addListener,o.prototype.prependListener=function(e,t){return u(this,e,t,!0)},o.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.on(e,f(this,e,t)),this},o.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.prependListener(e,f(this,e,t)),this},o.prototype.removeListener=function(e,t){var r,i,n,s,a;if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);if(void 0===(i=this._events))return this;if(void 0===(r=i[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(n=-1,s=r.length-1;s>=0;s--)if(r[s]===t||r[s].listener===t){a=r[s].listener,n=s;break}if(n<0)return this;0===n?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,n),1===r.length&&(i[e]=r[0]),void 0!==i.removeListener&&this.emit("removeListener",e,a||t)}return this},o.prototype.off=o.prototype.removeListener,o.prototype.removeAllListeners=function(e){var t,r,i;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var n,s=Object.keys(r);for(i=0;i<s.length;++i)"removeListener"!==(n=s[i])&&this.removeAllListeners(n);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},o.prototype.listeners=function(e){return c(this,e,!0)},o.prototype.rawListeners=function(e){return c(this,e,!1)},o.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},o.prototype.listenerCount=p,o.prototype.eventNames=function(){return this._eventsCount>0?i(this._events):[]}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.VideoTrack=t.AudioTrack=t.XgBuffer=void 0;var i,n=r(5),s=(i=n)&&i.__esModule?i:{default:i};t.XgBuffer=class{constructor(e){this.length=e||0,this.historyLen=e||0,this.array=[],this.offset=0}push(e){this.array.push(e),this.length+=e.byteLength,this.historyLen+=e.byteLength}shift(e){if(this.array.length<1)return new Uint8Array(0);if(void 0===e)return this._shiftBuffer();if(this.offset+e===this.array[0].length){let t=this.array[0].slice(this.offset,this.offset+e);return this.offset=0,this.array.shift(),this.length-=e,t}if(this.offset+e<this.array[0].length){let t=this.array[0].slice(this.offset,this.offset+e);return this.offset+=e,this.length-=e,t}let t=new Uint8Array(e),r=0;for(;this.array.length>0&&e>0;){if(this.offset+e<this.array[0].length){let i=this.array[0].slice(this.offset,this.offset+e);t.set(i,r),this.offset+=e,this.length-=e,e=0;break}{let i=this.array[0].length-this.offset;t.set(this.array[0].slice(this.offset,this.array[0].length),r),this.array.shift(),this.offset=0,r+=i,this.length-=i,e-=i}}return t}clear(){this.array=[],this.length=0,this.offset=0}destroy(){this.clear(),this.historyLen=0}_shiftBuffer(){return this.length-=this.array[0].length,this.offset=0,this.array.shift()}toInt(e,t){let r=0,i=this.offset+e;for(;i<this.offset+t+e;)i<this.array[0].length?r=256*r+this.array[0][i]:this.array[1]&&(r=256*r+this.array[1][i-this.array[0].length]),i++;return r}};t.AudioTrack=class extends s.default{constructor(){super(),this.TAG="AudioTrack",this.type="audio"}};t.VideoTrack=class extends s.default{constructor(){super(),this.TAG="VideoTrack",this.type="video",this.dropped=0}reset(){this.sequenceNumber=0,this.samples=[],this.length=0,this.dropped=0}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(){this.id=-1,this.sequenceNumber=0,this.samples=[],this.length=0}reset(){this.sequenceNumber=0,this.samples=[],this.length=0}distroy(){this.reset(),this.id=-1}};t.Tracks=class{constructor(){this.audioTrack=null,this.videoTrack=null}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,n=r(0),s=(i=n)&&i.__esModule?i:{default:i},a=r(7);const o=0,d=1,l=2;window.Context=s.default,t.default=class{constructor(e){this.configs=Object.assign({},e),this.url=null,this.status=0,this.error=null,this._reader=null,this.readtype=this.configs.readtype,this.buffer=this.configs.buffer||"LOADER_BUFFER"}static get type(){return"loader"}load(e,t){let r=this;this.url=e;let i=this.getParams(t);return fetch(this.url,i).then(function(e){return r.status=e.status,r.loading=!0,r._onFetchResponse(e)})}_onFetchResponse(e){let t=this,r=this._context.getInstance(this.buffer);if(!0===e.ok)switch(this.readtype){case l:e.json().then(e=>{r?(r.push(e),t.emit(a.LOADER_EVENTS.LOADER_COMPLETE,r)):t.emit(a.LOADER_EVENTS.LOADER_COMPLETE,e)});break;case d:e.text().then(e=>{r?(r.push(e),t.emit(a.LOADER_EVENTS.LOADER_COMPLETE,r)):t.emit(a.LOADER_EVENTS.LOADER_COMPLETE,e)});break;case o:default:return this._onReader(e.body.getReader())}}_onReader(e){let t=this._context.getInstance(this.buffer);if(t||this._reader.cancel(),this._reader=e,!1===this.loading)return;let r=this;this._reader&&this._reader.read().then(function(i){return i.done?(r.loading=!1,r.status=0,void r.emit(a.LOADER_EVENTS.LOADER_COMPLETE,t)):(t.push(i.value),r.emit(a.LOADER_EVENTS.LOADER_DATALOADED,t),r._onReader(e))}).catch(function(e){console.log(e)})}getParams(e){let t=Object.assign({},e),r=new Headers,i={method:"GET",headers:r,mode:"cors",cache:"default"};if("object"==typeof this.configs.headers){let e=this.configs.headers;for(let t in e)e.hasOwnProperty(t)&&r.append(t,e[t])}return!1===t.cors&&(i.mode="same-origin"),t.withCredentials&&(i.credentials="include"),i}cancel(){this._reader&&(this._reader.cancel(),this._reader=null)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=t.LOADER_EVENTS={LOADER_DATALOADED:"LOADER_DATALOADED",LOADER_COMPLETE:"LOADER_COMPLETE",LOADER_ERROR:"LOADER_ERROR"},n=t.DEMUX_EVENTS={DEMUX_COMPLETE:"DEMUX_COMPLETE",DEMUX_ERROR:"DEMUX_ERROR",METADATA_PARSED:"METADATA_COMPLETE",VIDEO_METADATA_CHANGE:"VIDEO_METADATA_CHANGE",AUDIO_METADATA_CHANGE:"AUDIO_METADATA_CHANGE",MEDIA_INFO:"MEDIA_INFO"},s=t.REMUX_EVENTS={MEDIA_SEGMENT:"MEDIA_SEGMENT",REMUX_ERROR:"REMUX_ERROR",INIT_SEGMENT:"INIT_SEGMENT"},a=Object.assign({},i,n,s),o=t.flvAllowedEvents=[];for(var d in a)a.hasOwnProperty(d)&&o.push(a[d]);t.default=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{static parse(e,t=""){let r={duration:0};console.log(e);let i=e.split(/\r|\n/),n=i.shift();if(!n.match("#EXTM3U"))return null;for(n=i.shift();void 0!==n;){let e=n.match(/#(.*):(.*)/);if(e&&e.length>2)switch(e[1]){case"EXT-X-VERSION":r.version=parseInt(e[2]);break;case"EXT-X-MEDIA-SEQUENCE":r.sequence=parseInt(e[2]);break;case"EXT-X-TARGETDURATION":r.targetduration=parseFloat(e[2]);break;case"EXTINF":r.frags||(r.frags=[]);let n={start:r.duration,duration:1e3*parseFloat(e[2])};r.duration+=n.duration,n.url=t+i.shift(),r.frags.push(n)}n=i.shift()}return r}static parseURL(e){let t="",r=e.match(/(.*\/).*\.m3u8$/);if(r&&r.length>0)for(let e=0;e<r.length;e++)r[e].match(/.*\/$/g)&&r[e].length>t.length&&(t=r[e]);return t}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=a(r(10)),n=a(r(11)),s=r(4);function a(e){return e&&e.__esModule?e:{default:e}}const o={1:["video","MPEG-1"],2:["video","MPEG-2"],27:["video","AVC.H264"],234:["video","VC-1"],3:["audio","MPEG-1"],4:["audio","MPEG-2"],15:["audio","MPEG-2.AAC"],17:["audio","MPEG-4.AAC"],128:["audio","LPCM"],129:["audio","AC3"],6:["audio","AC3"],130:["audio","DTS"],131:["audio","Dolby TrueHD"],132:["audio","AC3-Plus"],133:["audio","DTS-HD"],134:["audio","DTS-MA"],161:["audio","AC3-Plus-SEC"],162:["audio","DTS-HD-SEC"]};class d{constructor(e){this.configs=Object.assign({},e),this.demuxing=!1,this.pat=[],this.pmt=[]}init(){this.inputbuffer=this._context.getInstance(this.configs.inputbuffer)}demux(){if(this.demuxing)return;let e=this.inputbuffer,t={pat:[],pmt:[]},r={};for(;e.length>=188;){let n=e.shift(188),s=new i.default(n.buffer),a={};d.read(s,a,t),a.pes?(r[a.header.pid]||(r[a.header.pid]=[]),r[a.header.pid].push(a.pes),a.pes.ES.buffer=[a.pes.ES.buffer]):r[a.header.pid]&&r[a.header.pid][r[a.header.pid].length-1].ES.buffer.push(a.payload.stream)}for(let e=0;e<Object.keys(r).length;e++){let t=r[Object.keys(r)[e]];for(let e=0;e<t.length;e++)t[e].ES.buffer=d.Merge(t[e].ES.buffer),"audio"===t[e].type||"video"===t[e].type&&this.pushVideoSample(t[e]);t[0].type}}pushVideoSample(e){let t,r=n.default.getNalunits(e.ES.buffer);this._context._clsMap.VIDEO_TRACK?t=this._context.getInstance("VIDEO_TRACK"):(this._context.registry("VIDEO_TRACK",s.VideoTrack),t=this._context.initInstance("VIDEO_TRACK"));let i=0;for(let e=0;e<r.length;e++){let n=r[e];n.sps?(t.meta=n.sps,t.sps=n.body):n.pps?t.pps=n.body:i+=4+n.body.byteLength}let a={pts:e.pts/90,dts:e.dts/90,data:new Uint8Array(i)},o=0;for(let e=0;e<r.length;e++){let t=r[e],i=t.body.byteLength;t.pps||t.sps||(a.data.set(new Uint8Array([i>>>24&255,i>>>16&255,i>>>8&255,255&i]),o),o+=4,a.data.set(t.body,o),o+=i)}t.samples.push(a),console.log(t)}static Merge(e){let t,r=0,n=0;for(let t=0;t<e.length;t++)r+=e[t].length-e[t].position;t=new Uint8Array(r);for(let r=0;r<e.length;r++){let i=e[r];t.set(new Uint8Array(i.buffer,i.position),n),n+=i.length-i.position}return new i.default(t.buffer)}static read(e,t,r){d.readHeader(e,t),d.readPayload(e,t,r),"MEDIA"===t.header.packet&&1===t.header.payload&&(t.pes=d.PES(t))}static readPayload(e,t,r){let i=t.header.pid;switch(i){case 0:d.PAT(e,t,r);break;case 8191:break;default:if(r.pat.some(e=>e.pid===i))d.PMT(e,t,r);else{let n=r.pmt?r.pmt.filter(e=>e.pid===i):[];n.length>0&&d.Media(e,t,o[n[0].streamType][0])}}}static readHeader(e,t){let r={};r.sync=e.readUint8();let i=e.readUint16();r.error=i>>>15,r.payload=i>>>14&1,r.priority=i>>>13&1,r.pid=8191&i,i=e.readUint8(),r.scrambling=i>>6&3,r.adaptation=i>>4&3,r.continuity=15&i,r.packet=0===r.pid?"PAT":"MEDIA",t.header=r}static PAT(e,t,r){let i={},n=e.readUint8();e.skip(n),n=e.readUint8(),i.tabelID=n,n=e.readUint16(),i.error=n>>>7,i.zero=n>>>6&1,i.sectionLength=4095&n,i.streamID=e.readUint16(),i.current=1&e.readUint8(),i.sectionNumber=e.readUint8(),i.lastSectionNumber=e.readUint8();let s=(i.sectionLength-9)/4,a=[];for(let t=0;t<s;t++){let t=e.readUint16(),r=8191&e.readUint16();a.push({program:t,pid:r,type:0===t?"network":"mapPID"})}a.length>0&&(r.pat=r.pat.concat(a)),i.list=a,i.program=e.readUint16(),i.pid=8191&e.readUint16(),t.payload=i}static PMT(e,t,r){let i={};t.header.packet="PMT";let n=e.readUint8();e.skip(n),n=e.readUint8(),i.tableID=n,n=e.readUint16(),i.sectionLength=4095&n,i.program=e.readUint16(),i.current=1&e.readUint8(),i.order=e.readUint8(),i.lastOrder=e.readUint8(),i.PCR_PID=8191&e.readUint16(),i.programLength=4095&e.readUint16();let s=(i.sectionLength-13)/5,a=[];for(let t=0;t<s;t++)a.push({streamType:e.readUint8(),pid:8191&e.readUint16(),es:4095&e.readUint16()});i.list=a,this.pmt||(this.pmt=[]),r.pmt=this.pmt.concat(a.map(e=>({pid:e.pid,es:e.es,streamType:e.streamType,program:i.program}))),t.payload=i}static Media(e,t,r){let n=t.header,s={};if(n.type=r,3===n.adaptation&&(s.adaptationLength=e.readUint8(),s.adaptationLength>0)){let t=e.readUint8();s.discontinue=t>>>7,s.access=t>>>6&1,s.priority=t>>>5&1,s.PCR=t>>>4&1,s.OPCR=t>>>3&1,s.splicePoint=t>>>2&1,s.transportPrivate=t>>>1&1,s.adaptationField=1&t;let r=e.position;if(1===s.PCR&&(s.programClockBase=e.readUint32()<<1,t=e.readUint16(),s.programClockBase|=t>>>15,s.programClockExtension=511&t),1===s.OPCR&&(s.originProgramClockBase=e.readUint32()<<1,t=e.readUint16(),s.originProgramClockBase+=t>>>15,s.originProgramClockExtension=511&t),1===s.splicePoint&&(s.spliceCountdown=e.readUint8()),1===s.transportPrivate){let t=e.readUint8(),r=[];for(let i=0;i<t;i++)r.push(e.readUint8())}if(1===s.adaptationField){let t=e.readUint8(),r=e.readUint8(),i=e.position,n=r>>>6&1,a=r>>>5&1;1===r>>>7&&(r=e.readUint16(),s.ltwValid=r>>>15,s.ltwOffset=61439&r),1===n&&(r=e.readUint24(),s.piecewiseRate=4194303&r),1===a&&(r=e.readInt8(),s.spliceType=r>>>4,s.dtsNextAU1=r>>>1&7,s.marker1=1&r,r=e.readUint16(),s.dtsNextAU2=r>>>1,s.marker2=1&r,r=e.readUint16(),s.dtsNextAU3=r),e.skip(t-1-(e.position-i))}let i=s.adaptationLength-1-(e.position-r);e.skip(i)}s.stream=new i.default(e.buffer.slice(e.position)),t.payload=s}static PES(e){let t={},r=e.payload.stream;if(1!==r.readUint24())t.ES={},t.ES.buffer=r;else{let e=r.readUint8();e>=224&&e<=239&&(t.type="video"),e>=192&&e<=223&&(t.type="audio");let i=r.readUint16();if(t.packetLength=i,"video"!==t.type&&"audio"!==t.type)throw new Error("format is not supported");{let e=r.readUint8();if(2!==e>>>6)throw new Error("error when parse pes header");e=r.readUint8(),t.ptsDTSFlag=e>>>6,t.escrFlag=e>>>5&1,t.esRateFlag=e>>>4&1,t.dsmFlag=e>>>3&1,t.additionalFlag=e>>>2&1,t.crcFlag=e>>>1&1,t.extensionFlag=1&e,t.pesHeaderLength=r.readUint8();let i=t.pesHeaderLength;if(2===t.ptsDTSFlag){let n=[];e=r.readUint8(),n.push(e>>>1&7),e=r.readUint16(),n.push(e>>>1),e=r.readUint16(),n.push(e>>>1),t.pts=n[0]<<30|n[1]<<15|n[2],i-=5,"video"===t.type&&(t.dts=t.pts)}if(3===t.ptsDTSFlag){let n=[];e=r.readUint8(),n.push(e>>>1&7),e=r.readUint16(),n.push(e>>>1),e=r.readUint16(),n.push(e>>>1),t.pts=n[0]<<30|n[1]<<15|n[2];let s=[];e=r.readUint8(),s.push(e>>>1&7),e=r.readUint16(),s.push(e>>>1),e=r.readUint16(),s.push(e>>>1),t.dts=s[0]<<30|s[1]<<15|s[2],i-=10}if(1===t.escrFlag){let n=[],s=[];e=r.readUint8(),n.push(e>>>3&7),n.push(3&e),e=r.readUint16(),n.push(e>>>13),n.push(3&e),e=r.readUint16(),n.push(e>>>13),s.push(3&e),e=r.readUint8(),s.push(e>>>1),t.escr=300*(n[0]<<30|n[1]<<28|n[2]<<15|n[3]<<13|n[4])+(s[0]<<7|s[1]),i-=6}if(1===t.esRateFlag&&(e=r.readUint24(),t.esRate=e>>>1&4194303,i-=3),1===t.dsmFlag)throw new Error("not support DSM_trick_mode");if(1===t.additionalFlag&&(e=r.readUint8(),t.additionalCopyInfo=127&e,i-=1),1===t.crcFlag&&(t.pesCRC=r.readUint16(),i-=2),1===t.extensionFlag)throw new Error("not support extension");i>0&&r.skip(i),t.ES=d.ES(r,t.type)}}return t}static ES(e,t){let r,i={};if("video"===t){if(1!==(r=e.readUint32())&&(e.back(4),1!==(r=e.readUint24())))throw new Error("h264 nal header parse failed");e.skip(2),i.buffer=e}else{if("audio"!==t)throw new Error(`ES ${t} is not supported`);{if((r=e.readUint16())>>>4!=4095)throw new Error("aac ES parse Error");const t=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];i.id=0==(r>>>3&1)?"MPEG-4":"MPEG-2",i.layer=r>>>1&3,i.absent=1&r,r=e.readUint16(),i.audioObjectType=1+(r>>>14&3),i.profile=i.audioObjectType-1,i.frequencyIndex=r>>>10&15,i.frequence=t[i.frequencyIndex],i.channel=r>>>6&7,i.frameLength=(3&r)<<11|e.readUint16()>>>5,i.audioConfig=d.getAudioConfig(i.audioObjectType,i.channel,i.frequencyIndex),e.skip(1),i.buffer=e}}return i}static getAudioConfig(e,t,r){let i,n,s=navigator.userAgent.toLowerCase();return/firefox/i.test(s)?r>=6?(e=5,i=new Array(4),n=r-3):(e=2,i=new Array(2),n=r):-1!==s.indexOf("android")?(e=2,i=new Array(2),n=r):(e=5,i=new Array(4),r>=6?n=r-3:(1===t&&(e=2,i=new Array(2)),n=r)),i[0]=e<<3,i[0]|=(14&r)>>1,i[1]=(1&r)<<7,i[1]|=t<<3,5===e&&(i[1]|=(14&n)>>1,i[2]=(1&n)<<7,i[2]|=8,i[3]=0),i}}t.default=d},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});class i{constructor(e){if(!(e instanceof ArrayBuffer))throw new Error("data is invalid");this.buffer=e,this.dataview=new DataView(e),this.dataview.position=0}get length(){return this.buffer.byteLength}set position(e){this.dataview.position=e}get position(){return this.dataview.position}back(e){this.position-=e}skip(e){let t=Math.floor(e/4),r=e%4;for(let e=0;e<t;e++)i.readByte(this.dataview,4);r>0&&i.readByte(this.dataview,r)}static readByte(e,t,r){let i;switch(t){case 1:i=r?e.getInt8(e.position):e.getUint8(e.position);break;case 2:i=r?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(r)throw"not supported for readByte 3";i=e.getUint8(e.position)<<16,i|=e.getUint8(e.position+1)<<8,i|=e.getUint8(e.position+2);break;case 4:i=r?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(r)throw"not supported for readBody 8";i=e.getUint32(e.position)<<32,i|=e.getUint32(e.position+4);break;default:i=""}return e.position+=t,i}readUint8(){return i.readByte(this.dataview,1)}readUint16(){return i.readByte(this.dataview,2)}readUint24(){return i.readByte(this.dataview,3)}readUint32(){return i.readByte(this.dataview,4)}readUint64(){return i.readByte(this.dataview,8)}readInt8(){return i.readByte(this.dataview,1,!0)}readInt16(){return i.readByte(this.dataview,2,!0)}readInt32(){return i.readByte(this.dataview,4,!0)}writeUint32(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}}t.default=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,n=r(13),s=(i=n)&&i.__esModule?i:{default:i};class a{static getNalunits(e){let t=[],r=a.getHeaderPositionAnnexB(e),i=r.pos,n=i;for(;i<e.length-4;){let s=e.buffer.slice(i,i+r.headerLength);r.pos===e.position&&e.skip(r.headerLength),n=(r=a.getHeaderPositionAnnexB(e)).pos;let o={header:s,body:new Uint8Array(e.buffer.slice(i+s.byteLength,n))};a.analyseNal(o),t.push(o),e.skip(n-e.position),i=n}return t}static toAVCC(e){}static analyseNal(e){switch(31&e.body[0]){case 1:e.ndr=!0;break;case 5:e.idr=!0;break;case 6:break;case 7:e.sps=s.default.parseSPS(e.body),console.log(e);break;case 8:e.pps=!0}}static getHeaderPositionAnnexB(e){let t=e.position,r=0;for(;3!==r&&4!==r&&t<e.length-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?r=4:1===e.dataview.getInt8(t+2)?r=3:t++:t++;return t===e.length-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)&&(r=4):(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?r=3:t=e.length)),{pos:t,headerLength:r}}}t.default=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(e){this.TAG="Golomb",this._buffer=e,this._bufferIndex=0,this._totalBytes=e.byteLength,this._totalBits=8*e.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}destroy(){this._buffer=null}_fillCurrentWord(){let e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),r=new Uint8Array(4);r.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(r.buffer).getUint32(0,!1),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}readBits(e){if(e<=this._currentWordBitsLeft){let t=this._currentWord>>>32-e;return this._currentWord<<=e,this._currentWordBitsLeft-=e,t}let t=this._currentWordBitsLeft?this._currentWord:0;this._currentWordBitsLeft;let r=e-this._currentWordBitsLeft;this._fillCurrentWord();let i=Math.min(r,this._currentWordBitsLeft),n=this._currentWord>>>32-i;return this._currentWord<<=i,this._currentWordBitsLeft-=i,t=t<<i|n}readBool(){return 1===this.readBits(1)}readByte(){return this.readBits(8)}_skipLeadingZero(){let e;for(e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}readUEG(){let e=this._skipLeadingZero();return this.readBits(e+1)-1}readSEG(){let e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,n=r(12),s=(i=n)&&i.__esModule?i:{default:i};class a{static _ebsp2rbsp(e){let t=e,r=t.byteLength,i=new Uint8Array(r),n=0;for(let e=0;e<r;e++)e>=2&&3===t[e]&&0===t[e-1]&&0===t[e-2]||(i[n]=t[e],n++);return new Uint8Array(i.buffer,0,n)}static parseSPS(e){let t=a._ebsp2rbsp(e),r=new s.default(t);r.readByte();let i=r.readByte();r.readByte();let n=r.readByte();r.readUEG();let o=a.getProfileString(i),d=a.getLevelString(n),l=1,u=420,h=[0,420,422,444],f=8;if((100===i||110===i||122===i||244===i||44===i||83===i||86===i||118===i||128===i||138===i||144===i)&&(3===(l=r.readUEG())&&r.readBits(1),l<=3&&(u=h[l]),f=r.readUEG()+8,r.readUEG(),r.readBits(1),r.readBool())){let e=3!==l?8:12;for(let t=0;t<e;t++)r.readBool()&&(t<6?a._skipScalingList(r,16):a._skipScalingList(r,64))}r.readUEG();let c=r.readUEG();if(0===c)r.readUEG();else if(1===c){r.readBits(1),r.readSEG(),r.readSEG();let e=r.readUEG();for(let t=0;t<e;t++)r.readSEG()}r.readUEG(),r.readBits(1);let p=r.readUEG(),g=r.readUEG(),y=r.readBits(1);0===y&&r.readBits(1),r.readBits(1);let _=0,E=0,v=0,b=0;r.readBool()&&(_=r.readUEG(),E=r.readUEG(),v=r.readUEG(),b=r.readUEG());let m=1,U=1,w=0,A=!0,L=0,O=0;if(r.readBool()){if(r.readBool()){let e=r.readByte(),t=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],i=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];e>0&&e<16?(m=t[e-1],U=i[e-1]):255===e&&(m=r.readByte()<<8|r.readByte(),U=r.readByte()<<8|r.readByte())}if(r.readBool()&&r.readBool(),r.readBool()&&(r.readBits(4),r.readBool()&&r.readBits(24)),r.readBool()&&(r.readUEG(),r.readUEG()),r.readBool()){let e=r.readBits(32),t=r.readBits(32);A=r.readBool(),w=(L=t)/(O=2*e)}}let M=1;1===m&&1===U||(M=m/U);let T=0,R=0;if(0===l)T=1,R=2-y;else{T=3===l?1:2,R=(1===l?2:1)*(2-y)}let B=16*(p+1),D=16*(g+1)*(2-y);B-=(_+E)*T,D-=(v+b)*R;let x=Math.ceil(B*M);return r.destroy(),r=null,{profile_string:o,level_string:d,bit_depth:f,chroma_format:u,chroma_format_string:a.getChromaFormatString(u),frame_rate:{fixed:A,fps:w,fps_den:O,fps_num:L},sar_ratio:{width:m,height:U},codec_size:{width:B,height:D},present_size:{width:x,height:D}}}static _skipScalingList(e,t){let r=8,i=8,n=0;for(let s=0;s<t;s++)0!==i&&(i=(r+(n=e.readSEG())+256)%256),r=0===i?r:i}static getProfileString(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}static getLevelString(e){return(e/10).toFixed(1)}static getChromaFormatString(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}}t.default=a}])});