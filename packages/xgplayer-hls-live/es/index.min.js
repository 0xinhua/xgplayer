function EventHandlers(){}function EventEmitter(){EventEmitter.init.call(this)}function $getMaxListeners(e){return void 0===e._maxListeners?EventEmitter.defaultMaxListeners:e._maxListeners}function emitNone(e,t,i){if(t)e.call(i);else for(var r=e.length,n=arrayClone(e,r),s=0;s<r;++s)n[s].call(i)}function emitOne(e,t,i,r){if(t)e.call(i,r);else for(var n=e.length,s=arrayClone(e,n),a=0;a<n;++a)s[a].call(i,r)}function emitTwo(e,t,i,r,n){if(t)e.call(i,r,n);else for(var s=e.length,a=arrayClone(e,s),o=0;o<s;++o)a[o].call(i,r,n)}function emitThree(e,t,i,r,n,s){if(t)e.call(i,r,n,s);else for(var a=e.length,o=arrayClone(e,a),u=0;u<a;++u)o[u].call(i,r,n,s)}function emitMany(e,t,i,r){if(t)e.apply(i,r);else for(var n=e.length,s=arrayClone(e,n),a=0;a<n;++a)s[a].apply(i,r)}function _addListener(e,t,i,r){var n,s,a;if("function"!=typeof i)throw new TypeError('"listener" argument must be a function');if(s=e._events,s?(s.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),s=e._events),a=s[t]):(s=e._events=new EventHandlers,e._eventsCount=0),a){if("function"==typeof a?a=s[t]=r?[i,a]:[a,i]:r?a.unshift(i):a.push(i),!a.warned&&(n=$getMaxListeners(e))&&n>0&&a.length>n){a.warned=!0;var o=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");o.name="MaxListenersExceededWarning",o.emitter=e,o.type=t,o.count=a.length,emitWarning(o)}}else a=s[t]=i,++e._eventsCount;return e}function emitWarning(e){"function"==typeof console.warn?console.warn(e):console.log(e)}function _onceWrap(e,t,i){function r(){e.removeListener(t,r),n||(n=!0,i.apply(e,arguments))}var n=!1;return r.listener=i,r}function listenerCount(e){var t=this._events;if(t){var i=t[e];if("function"==typeof i)return 1;if(i)return i.length}return 0}function spliceOne(e,t){for(var i=t,r=i+1,n=e.length;r<n;i+=1,r+=1)e[i]=e[r];e.pop()}function arrayClone(e,t){for(var i=new Array(t);t--;)i[t]=e[t];return i}function unwrapListeners(e){for(var t=new Array(e.length),i=0;i<t.length;++i)t[i]=e[i].listener||e[i];return t}function unwrapExports(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function createCommonjsModule(e,t){return t={exports:{}},e(t,t.exports),t.exports}import Player from"xgplayer";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),get=function e(t,i,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,i);if(void 0===n){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,i,r)}if("value"in n)return n.value;var a=n.get;if(void 0!==a)return a.call(r)},inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t};!function(e){var t=e.babelHelpers={};t.typeof=function(e){return void 0===e?"undefined":_typeof(e)},t.classCallCheck=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t.createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,i,r){return i&&e(t.prototype,i),r&&e(t,r),t}}(),t.defineEnumerableProperties=function(e,t){for(var i in t){var r=t[i];r.configurable=r.enumerable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,i,r)}return e},t.defaults=function(e,t){for(var i=Object.getOwnPropertyNames(t),r=0;r<i.length;r++){var n=i[r],s=Object.getOwnPropertyDescriptor(t,n);s&&s.configurable&&void 0===e[n]&&Object.defineProperty(e,n,s)}return e},t.defineProperty=function(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e},t.extends=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var r in i)Object.prototype.hasOwnProperty.call(i,r)&&(e[r]=i[r])}return e},t.get=function e(t,i,r){null===t&&(t=Function.prototype);var n=Object.getOwnPropertyDescriptor(t,i);if(void 0===n){var s=Object.getPrototypeOf(t);return null===s?void 0:e(s,i,r)}if("value"in n)return n.value;var a=n.get;if(void 0!==a)return a.call(r)},t.inherits=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":_typeof(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},t.instanceof=function(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?t[Symbol.hasInstance](e):e instanceof t},t.interopRequireDefault=function(e){return e&&e.__esModule?e:{default:e}},t.interopRequireWildcard=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t.default=e,t},t.newArrowCheck=function(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")},t.objectDestructuringEmpty=function(e){if(null==e)throw new TypeError("Cannot destructure undefined")},t.objectWithoutProperties=function(e,t){var i={};for(var r in e)t.indexOf(r)>=0||Object.prototype.hasOwnProperty.call(e,r)&&(i[r]=e[r]);return i},t.possibleConstructorReturn=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":_typeof(t))&&"function"!=typeof t?e:t},t.selfGlobal=void 0===e?self:e,t.set=function e(t,i,r,n){var s=Object.getOwnPropertyDescriptor(t,i);if(void 0===s){var a=Object.getPrototypeOf(t);null!==a&&e(a,i,r,n)}else if("value"in s&&s.writable)s.value=r;else{var o=s.set;void 0!==o&&o.call(n,r)}return r},t.slicedToArray=function(){function e(e,t){var i=[],r=!0,n=!1,s=void 0;try{for(var a,o=e[Symbol.iterator]();!(r=(a=o.next()).done)&&(i.push(a.value),!t||i.length!==t);r=!0);}catch(e){n=!0,s=e}finally{try{!r&&o.return&&o.return()}finally{if(n)throw s}}return i}return function(t,i){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,i);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),t.slicedToArrayLoose=function(e,t){if(Array.isArray(e))return e;if(Symbol.iterator in Object(e)){for(var i,r=[],n=e[Symbol.iterator]();!(i=n.next()).done&&(r.push(i.value),!t||r.length!==t););return r}throw new TypeError("Invalid attempt to destructure non-iterable instance")},t.taggedTemplateLiteral=function(e,t){return Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))},t.taggedTemplateLiteralLoose=function(e,t){return e.raw=t,e},t.temporalRef=function(e,t,i){if(e===i)throw new ReferenceError(t+" is not defined - temporal dead zone");return e},t.temporalUndefined={},t.toArray=function(e){return Array.isArray(e)?e:Array.from(e)},t.toConsumableArray=function(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}}("undefined"==typeof global?self:global);var LOADER_EVENTS={LADER_START:"LOADER_START",LOADER_DATALOADED:"LOADER_DATALOADED",LOADER_COMPLETE:"LOADER_COMPLETE",LOADER_ERROR:"LOADER_ERROR"},DEMUX_EVENTS={DEMUX_START:"DEMUX_START",DEMUX_COMPLETE:"DEMUX_COMPLETE",DEMUX_ERROR:"DEMUX_ERROR",METADATA_PARSED:"METADATA_PARSED",VIDEO_METADATA_CHANGE:"VIDEO_METADATA_CHANGE",AUDIO_METADATA_CHANGE:"AUDIO_METADATA_CHANGE",MEDIA_INFO:"MEDIA_INFO"},REMUX_EVENTS={REMUX_METADATA:"REMUX_METADATA",REMUX_MEDIA:"REMUX_MEDIA",MEDIA_SEGMENT:"MEDIA_SEGMENT",REMUX_ERROR:"REMUX_ERROR",INIT_SEGMENT:"INIT_SEGMENT",DETECT_CHANGE_STREAM:"DETECT_CHANGE_STREAM",DETECT_CHANGE_STREAM_DISCONTINUE:"DETECT_CHANGE_STREAM_DISCONTINUE",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT"},MSE_EVENTS={SOURCE_UPDATE_END:"SOURCE_UPDATE_END"},HLS_EVENTS={RETRY_TIME_EXCEEDED:"RETRY_TIME_EXCEEDED"},CRYTO_EVENTS={START_DECRYPT:"START_DECRYPT",DECRYPTED:"DECRYPTED"},ALLEVENTS=Object.assign({},LOADER_EVENTS,DEMUX_EVENTS,REMUX_EVENTS,MSE_EVENTS,HLS_EVENTS),FlvAllowedEvents=[],HlsAllowedEvents=[];for(var key in ALLEVENTS)ALLEVENTS.hasOwnProperty(key)&&FlvAllowedEvents.push(ALLEVENTS[key]);for(var _key in ALLEVENTS)ALLEVENTS.hasOwnProperty(_key)&&HlsAllowedEvents.push(ALLEVENTS[_key]);var EVENTS={ALLEVENTS:ALLEVENTS,HLS_EVENTS:HLS_EVENTS,REMUX_EVENTS:REMUX_EVENTS,DEMUX_EVENTS:DEMUX_EVENTS,MSE_EVENTS:MSE_EVENTS,LOADER_EVENTS:LOADER_EVENTS,FlvAllowedEvents:FlvAllowedEvents,HlsAllowedEvents:HlsAllowedEvents,CRYTO_EVENTS:CRYTO_EVENTS},isObjectFilled=function(e){for(var t in e)if(e.hasOwnProperty(t)&&null===e[t])return!1;return!0},MediaInfo=function(){function e(){babelHelpers.classCallCheck(this,e),this.mimeType=null,this.duration=null,this.hasVideo=null,this.video={codec:null,width:null,height:null,profile:null,level:null,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},chromaFormat:null,parRatio:{width:1,height:1}},this.hasAudio=null,this.audio={codec:null,sampleRate:null,sampleRateIndex:null,channelCount:null}}return babelHelpers.createClass(e,[{key:"isComplete",value:function(){return e.isBaseInfoReady(this)&&e.isVideoReady(this)&&e.isAudioReady(this)}}],[{key:"isBaseInfoReady",value:function(e){return isObjectFilled(e)}},{key:"isVideoReady",value:function(e){return!e.hasVideo||isObjectFilled(e.video)}},{key:"isAudioReady",value:function(e){return!e.hasAudio||isObjectFilled(e.video)}}]),e}(),domain;EventHandlers.prototype=Object.create(null),EventEmitter.EventEmitter=EventEmitter,EventEmitter.usingDomains=!1,EventEmitter.prototype.domain=void 0,EventEmitter.prototype._events=void 0,EventEmitter.prototype._maxListeners=void 0,EventEmitter.defaultMaxListeners=10,EventEmitter.init=function(){this.domain=null,EventEmitter.usingDomains&&domain.active&&domain.Domain,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new EventHandlers,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},EventEmitter.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},EventEmitter.prototype.getMaxListeners=function(){return $getMaxListeners(this)},EventEmitter.prototype.emit=function(e){var t,i,r,n,s,a,o,u="error"===e;if(a=this._events)u=u&&null==a.error;else if(!u)return!1;if(o=this.domain,u){if(t=arguments[1],!o){if(t instanceof Error)throw t;var l=new Error('Uncaught, unspecified "error" event. ('+t+")");throw l.context=t,l}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=o,t.domainThrown=!1,o.emit("error",t),!1}if(!(i=a[e]))return!1;var h="function"==typeof i;switch(r=arguments.length){case 1:emitNone(i,h,this);break;case 2:emitOne(i,h,this,arguments[1]);break;case 3:emitTwo(i,h,this,arguments[1],arguments[2]);break;case 4:emitThree(i,h,this,arguments[1],arguments[2],arguments[3]);break;default:for(n=new Array(r-1),s=1;s<r;s++)n[s-1]=arguments[s];emitMany(i,h,this,n)}return!0},EventEmitter.prototype.addListener=function(e,t){return _addListener(this,e,t,!1)},EventEmitter.prototype.on=EventEmitter.prototype.addListener,EventEmitter.prototype.prependListener=function(e,t){return _addListener(this,e,t,!0)},EventEmitter.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,_onceWrap(this,e,t)),this},EventEmitter.prototype.removeListener=function(e,t){var i,r,n,s,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(i=r[e]))return this;if(i===t||i.listener&&i.listener===t)0==--this._eventsCount?this._events=new EventHandlers:(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(n=-1,s=i.length;s-- >0;)if(i[s]===t||i[s].listener&&i[s].listener===t){a=i[s].listener,n=s;break}if(n<0)return this;if(1===i.length){if(i[0]=void 0,0==--this._eventsCount)return this._events=new EventHandlers,this;delete r[e]}else spliceOne(i,n);r.removeListener&&this.emit("removeListener",e,a||t)}return this},EventEmitter.prototype.removeAllListeners=function(e){var t,i;if(!(i=this._events))return this;if(!i.removeListener)return 0===arguments.length?(this._events=new EventHandlers,this._eventsCount=0):i[e]&&(0==--this._eventsCount?this._events=new EventHandlers:delete i[e]),this;if(0===arguments.length){for(var r,n=Object.keys(i),s=0;s<n.length;++s)"removeListener"!==(r=n[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new EventHandlers,this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},EventEmitter.prototype.listeners=function(e){var t,i=this._events;return i&&(t=i[e])?"function"==typeof t?[t.listener||t]:unwrapListeners(t):[]},EventEmitter.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):listenerCount.call(e,t)},EventEmitter.prototype.listenerCount=listenerCount,EventEmitter.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var DIRECT_EMIT_FLAG="__TO__",Context=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];babelHelpers.classCallCheck(this,e),this._emitter=new EventEmitter,this._emitter.off||(this._emitter.off=this._emitter.removeListener),this._instanceMap={},this._clsMap={},this._inited=!1,this.mediaInfo=new MediaInfo,this.allowedEvents=t,this._hooks={}}return babelHelpers.createClass(e,[{key:"getInstance",value:function(e){var t=this._instanceMap[e];return t||null}},{key:"initInstance",value:function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];var n=i[0],s=i[1],a=i[2],o=i[3];if(this._clsMap[e]){var u=new this._clsMap[e](n,s,a,o);return this._instanceMap[e]=u,u.init&&u.init(),u}throw new Error(e+"未在context中注册")}},{key:"init",value:function(e){if(!this._inited){for(var t in this._clsMap)this._clsMap.hasOwnProperty(t)&&!this._instanceMap[t]&&this.initInstance(t,e);this._inited=!0}}},{key:"registry",value:function(e,t){var i=this,r=this._emitter,n=this._isMessageNameValid.bind(this),s=this,a=function(t){function i(t,r,n){babelHelpers.classCallCheck(this,i);var a=babelHelpers.possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,r,n));return a.listeners={},a.onceListeners={},a.TAG=e,a._context=s,a}return babelHelpers.inherits(i,t),babelHelpers.createClass(i,[{key:"on",value:function(t,i){return n(t),this.listeners[t]?this.listeners[t].push(i):this.listeners[t]=[i],r.on(""+t+DIRECT_EMIT_FLAG+e,i),r.on(t,i)}},{key:"before",value:function(e,t){n(e),s._hooks[e]?s._hooks[e].push(t):s._hooks[e]=[t]}},{key:"once",value:function(t,i){return n(t),this.onceListeners[t]?this.onceListeners[t].push(i):this.onceListeners[t]=[i],r.once(""+t+DIRECT_EMIT_FLAG+e,i),r.once(t,i)}},{key:"emit",value:function(e){n(e);var t=s._hooks?s._hooks[e]:null;if(t)for(var i=0,a=t.length;i<a;i++)(0,t[i])();for(var o=arguments.length,u=Array(o>1?o-1:0),l=1;l<o;l++)u[l-1]=arguments[l];return r.emit.apply(r,[e].concat(u))}},{key:"emitTo",value:function(e,t){n(t);for(var i=arguments.length,s=Array(i>2?i-2:0),a=2;a<i;a++)s[a-2]=arguments[a];return r.emit.apply(r,[""+t+DIRECT_EMIT_FLAG+e].concat(s))}},{key:"off",value:function(e,t){return n(e),r.off(e,t)}},{key:"removeListeners",value:function(){var t=Object.prototype.hasOwnProperty.bind(this.listeners);for(var i in this.listeners)if(t(i))for(var n=this.listeners[i]||[],s=0;s<n.length;s++){var a=n[s];r.off(i,a),r.off(""+i+DIRECT_EMIT_FLAG+e,a)}for(var o in this.onceListeners)if(t(o))for(var u=this.onceListeners[o]||[],l=0;l<u.length;l++){var h=u[l];r.off(o,h),r.off(""+o+DIRECT_EMIT_FLAG+e,h)}}},{key:"destroy",value:function(){if(this.removeListeners(),this.listeners={},delete s._instanceMap[e],babelHelpers.get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this))return babelHelpers.get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this)}}]),i}(t);return this._clsMap[e]=a,function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return i.initInstance.apply(i,[e].concat(r))}}},{key:"destroyInstances",value:function(){var e=this;Object.keys(this._instanceMap).forEach(function(t){e._instanceMap[t].destroy&&e._instanceMap[t].destroy()})}},{key:"destroy",value:function(){this._emitter=null,this.allowedEvents=[],this._clsMap=null,this._context=null,this._hooks=null,this.destroyInstances()}},{key:"_isMessageNameValid",value:function(e){if(!this.allowedEvents.indexOf(e)<0)throw new Error("unregistered message name: "+e)}}]),e}(),MSE=function(){function e(t,i){babelHelpers.classCallCheck(this,e),i&&(this._context=i,this.emit=i._emitter.emit.bind(i._emitter)),this.configs=Object.assign({},t),this.container=this.configs.container,this.mediaSource=null,this.sourceBuffers={},this.preloadTime=this.configs.preloadTime||1,this.onSourceOpen=this.onSourceOpen.bind(this),this.onTimeUpdate=this.onTimeUpdate.bind(this),this.onUpdateEnd=this.onUpdateEnd.bind(this),this.onWaiting=this.onWaiting.bind(this)}return babelHelpers.createClass(e,[{key:"init",value:function(){this.mediaSource=new self.MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this.container.src=URL.createObjectURL(this.mediaSource),this.url=this.container.src,this.container.addEventListener("timeupdate",this.onTimeUpdate),this.container.addEventListener("waiting",this.onWaiting)}},{key:"resetContext",value:function(e){this._context=e}},{key:"onTimeUpdate",value:function(){this.emit("TIME_UPDATE",this.container)}},{key:"onWaiting",value:function(){this.emit("WAITING",this.container)}},{key:"onSourceOpen",value:function(){this.addSourceBuffers()}},{key:"onUpdateEnd",value:function(){this.emit("SOURCE_UPDATE_END"),this.doAppend()}},{key:"addSourceBuffers",value:function(){if("open"===this.mediaSource.readyState){var e=this._context.getInstance("PRE_SOURCE_BUFFER"),t=this._context.getInstance("TRACKS"),i=void 0;e=e.sources;for(var r=!1,n=0,s=Object.keys(e).length;n<s;n++){var a=Object.keys(e)[n];if("audio"===a?i=t.audioTrack:"video"===a&&(i=t.videoTrack),i){var o="audio"===a?21:40;i.meta&&i.meta.refSampleDuration&&(o=i.meta.refSampleDuration),e[a].data.length>=this.preloadTime/o&&(r=!0)}}if(r){if(Object.keys(this.sourceBuffers).length>0)return;for(var u=0,l=Object.keys(e).length;u<l;u++){var h=Object.keys(e)[u],c=e[h],d="video"===h?"video/mp4;codecs="+c.mimetype:"audio/mp4;codecs="+c.mimetype,f=this.mediaSource.addSourceBuffer(d);this.sourceBuffers[h]=f,f.addEventListener("updateend",this.onUpdateEnd),this.doAppend()}}}}},{key:"doAppend",value:function(){var e=this._context.getInstance("PRE_SOURCE_BUFFER");if(e)for(var t=0;t<Object.keys(this.sourceBuffers).length;t++){var i=Object.keys(this.sourceBuffers)[t],r=this.sourceBuffers[i],n=e.sources[i];if(n&&!n.inited)try{r.appendBuffer(n.init.buffer.buffer),n.inited=!0}catch(e){}else if(n){var s=n.data.shift();if(s)try{r.appendBuffer(s.buffer.buffer)}catch(e){n.data.unshift(s)}}}}},{key:"endOfStream",value:function(){var e=this.mediaSource,t=e.readyState,i=e.activeSourceBuffers;if("open"===t&&0===i.length)try{this.mediaSource.endOfStream()}catch(e){}}},{key:"remove",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;i<Object.keys(this.sourceBuffers).length;i++){var r=this.sourceBuffers[Object.keys(this.sourceBuffers)[i]];r.updating||r.remove(t,e)}}},{key:"removeBuffers",value:function(){for(var t=this,i=[],r=0;r<Object.keys(this.sourceBuffers).length;r++)!function(r){var n=t.sourceBuffers[Object.keys(t.sourceBuffers)[r]];n.removeEventListener("updateend",t.onUpdateEnd);var s=void 0;s=n.updating?new Promise(function(t){var i=function i(){var r=3,s=function i(){n.updating?r>0?(setTimeout(i,200),r--):t():(e.clearBuffer(n),n.addEventListener("updateend",function(){t()}))};setTimeout(s,200),n.removeEventListener("updateend",i)};n.addEventListener("updateend",i)}):new Promise(function(t){e.clearBuffer(n),n.addEventListener("updateend",function(){t()})}),i.push(s)}(r);return Promise.all(i)}},{key:"destroy",value:function(){var e=this;return this.removeBuffers().then(function(){for(var t=0;t<Object.keys(e.sourceBuffers).length;t++){var i=e.sourceBuffers[Object.keys(e.sourceBuffers)[t]];e.mediaSource.removeSourceBuffer(i),delete e.sourceBuffers[Object.keys(e.sourceBuffers)[t]]}e.container.removeEventListener("timeupdate",e.onTimeUpdate),e.container.removeEventListener("waiting",e.onWaiting),e.mediaSource.removeEventListener("sourceopen",e.onSourceOpen),e.endOfStream(),window.URL.revokeObjectURL(e.url),e.url=null,e.configs={},e.container=null,e.mediaSource=null,e.sourceBuffers={},e.preloadTime=1})}}],[{key:"clearBuffer",value:function(e){for(var t=e.buffered,i=.1,r=0,n=t.length;r<n;r++)i=t.end(r);try{e.remove(0,i)}catch(e){}}}]),e}(),Track=function(){function e(){babelHelpers.classCallCheck(this,e),this.id=-1,this.sequenceNumber=0,this.samples=[],this.droppedSamples=[],this.length=0}return babelHelpers.createClass(e,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0}},{key:"distroy",value:function(){this.reset(),this.id=-1}}]),e}(),AudioTrack=function(e){function t(){babelHelpers.classCallCheck(this,t);var e=babelHelpers.possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="AudioTrack",e.type="audio",e}return babelHelpers.inherits(t,e),t}(Track),VideoTrack=function(e){function t(){babelHelpers.classCallCheck(this,t);var e=babelHelpers.possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="VideoTrack",e.type="video",e.dropped=0,e}return babelHelpers.inherits(t,e),babelHelpers.createClass(t,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0,this.dropped=0}}]),t}(Track),Tracks=function(){function e(){babelHelpers.classCallCheck(this,e),this.audioTrack=null,this.videoTrack=null}return babelHelpers.createClass(e,[{key:"destroy",value:function(){this.audioTrack=null,this.videoTrack=null}}]),e}(),Source=function e(){babelHelpers.classCallCheck(this,e),this.mimetype="",this.init=null,this.data=[]},PreSource=function(){function e(){babelHelpers.classCallCheck(this,e),this.sources={}}return babelHelpers.createClass(e,[{key:"getSource",value:function(e){return this.sources[e]}},{key:"createSource",value:function(e){return this.sources[e]=new Source,this.sources[e]}},{key:"clear",value:function(){this.sources={}}},{key:"destroy",value:function(){this.sources={}}}]),e}(),XgBuffer=function(){function e(t){babelHelpers.classCallCheck(this,e),this.length=t||0,this.historyLen=t||0,this.array=[],this.offset=0}return babelHelpers.createClass(e,[{key:"push",value:function(e){this.array.push(e),this.length+=e.byteLength,this.historyLen+=e.byteLength}},{key:"shift",value:function(e){if(this.array.length<1)return new Uint8Array(0);if(void 0===e)return this._shiftBuffer();if(this.offset+e===this.array[0].length){var t=this.array[0].slice(this.offset,this.offset+e);return this.offset=0,this.array.shift(),this.length-=e,t}if(this.offset+e<this.array[0].length){var i=this.array[0].slice(this.offset,this.offset+e);return this.offset+=e,this.length-=e,i}for(var r=new Uint8Array(e),n=0;this.array.length>0&&e>0;){if(this.offset+e<this.array[0].length){var s=this.array[0].slice(this.offset,this.offset+e);r.set(s,n),this.offset+=e,this.length-=e,e=0;break}var a=this.array[0].length-this.offset;r.set(this.array[0].slice(this.offset,this.array[0].length),n),this.array.shift(),this.offset=0,n+=a,this.length-=a,e-=a}return r}},{key:"clear",value:function(){this.array=[],this.length=0,this.offset=0}},{key:"destroy",value:function(){this.clear(),this.historyLen=0}},{key:"_shiftBuffer",value:function(){return this.length-=this.array[0].length,this.offset=0,this.array.shift()}},{key:"toInt",value:function(e,t){for(var i=0,r=this.offset+e;r<this.offset+t+e;)r<this.array[0].length?i=256*i+this.array[0][r]:this.array[1]&&(i=256*i+this.array[1][r-this.array[0].length]),r++;return i}}]),e}(),LOADER_EVENTS$1=EVENTS.LOADER_EVENTS,READ_STREAM=0,READ_TEXT=1,READ_JSON=2,READ_BUFFER=3,FetchLoader=function(){function e(t){babelHelpers.classCallCheck(this,e),this.configs=Object.assign({},t),this.url=null,this.status=0,this.error=null,this._reader=null,this._canceled=!1,this._destroyed=!1,this.readtype=this.configs.readtype,this.buffer=this.configs.buffer||"LOADER_BUFFER",this._loaderTaskNo=0}return babelHelpers.createClass(e,[{key:"init",value:function(){this.on(LOADER_EVENTS$1.LADER_START,this.load.bind(this))}},{key:"load",value:function(e,t){var i=this;this.url=e,this._canceled=!1;var r=this.getParams(t);return this.loading=!0,fetch(this.url,r).then(function(e){if(e.ok)return i.status=e.status,Promise.resolve().then(function(){i._onFetchResponse(e)}),Promise.resolve(e);i.loading=!1,i.emit(LOADER_EVENTS$1.LOADER_ERROR,i.TAG,new Error(e.status+" ("+e.statusText+")"))}).catch(function(e){throw i.loading=!1,i.emit(LOADER_EVENTS$1.LOADER_ERROR,i.TAG,e),e})}},{key:"_onFetchResponse",value:function(e){var t=this,i=this._context.getInstance(this.buffer),r=++this._loaderTaskNo;if(!0===e.ok)switch(this.readtype){case READ_JSON:e.json().then(function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(e),t.emit(LOADER_EVENTS$1.LOADER_COMPLETE,i)):t.emit(LOADER_EVENTS$1.LOADER_COMPLETE,e))});break;case READ_TEXT:e.text().then(function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(e),t.emit(LOADER_EVENTS$1.LOADER_COMPLETE,i)):t.emit(LOADER_EVENTS$1.LOADER_COMPLETE,e))});break;case READ_BUFFER:e.arrayBuffer().then(function(e){t.loading=!1,t._canceled||t._destroyed||(i?(i.push(new Uint8Array(e)),t.emit(LOADER_EVENTS$1.LOADER_COMPLETE,i)):t.emit(LOADER_EVENTS$1.LOADER_COMPLETE,e))});break;case READ_STREAM:default:return this._onReader(e.body.getReader(),r)}}},{key:"_onReader",value:function(e,t){var i=this,r=this._context.getInstance(this.buffer);if(!r&&this._reader||this._destroyed)try{this._reader.cancel()}catch(e){}this._reader=e,!1!==this.loading&&this._reader&&this._reader.read().then(function(n){if(!i._canceled&&!i._destroyed)return n.done?(i.loading=!1,i.status=0,void Promise.resolve().then(function(){i.emit(LOADER_EVENTS$1.LOADER_COMPLETE,r)})):(r.push(n.value),Promise.resolve().then(function(){i.emit(LOADER_EVENTS$1.LOADER_DATALOADED,r)}),i._onReader(e,t));if(i._reader)try{i._reader.cancel()}catch(e){}}).catch(function(e){throw i.loading=!1,i.emit(LOADER_EVENTS$1.LOADER_ERROR,i.TAG,e),e})}},{key:"getParams",value:function(e){var t=Object.assign({},e),i=new Headers,r={method:"GET",headers:i,mode:"cors",cache:"default"};if("object"===babelHelpers.typeof(this.configs.headers)){var n=this.configs.headers;for(var s in n)n.hasOwnProperty(s)&&i.append(s,n[s])}if("object"===babelHelpers.typeof(t.headers)){var a=t.headers;for(var o in a)a.hasOwnProperty(o)&&i.append(o,a[o])}return!1===t.cors&&(r.mode="same-origin"),t.withCredentials&&(r.credentials="include"),r}},{key:"cancel",value:function(){if(this._reader){try{this._reader.cancel()}catch(e){}this._reader=null,this.loading=!1}this._canceled=!0}},{key:"destroy",value:function(){this._destroyed=!0,this.cancel()}}],[{key:"type",get:function(){return"loader"}}]),e}(),AAC=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,null,[{key:"getSilentFrame",value:function(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}]),e}(),REMUX_EVENTS$1=EVENTS.REMUX_EVENTS,Compatibility=function(){function e(){babelHelpers.classCallCheck(this,e),this.nextAudioDts=0,this.nextVideoDts=0,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.allAudioSamplesCount=0,this.allVideoSamplesCount=0,this._firstAudioSample=null,this._firstVideoSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this.videoLastSample=null,this.audioLastSample=null,this._videoLargeGap=0,this._audioLargeGap=0}return babelHelpers.createClass(e,[{key:"init",value:function(){this.before(REMUX_EVENTS$1.REMUX_MEDIA,this.doFix.bind(this))}},{key:"reset",value:function(){this.nextAudioDts=null,this.nextVideoDts=null,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.videoLastSample=null,this.audioLastSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[]}},{key:"doFix",value:function(){var t=this.getFirstSample(),i=t.isFirstAudioSamples,r=t.isFirstVideoSamples;this.recordSamplesCount(),this._firstVideoSample&&this.fixRefSampleDuration(this.videoTrack.meta,this.videoTrack.samples),this._firstAudioSample&&this.fixRefSampleDuration(this.audioTrack.meta,this.audioTrack.samples);var n=e.detactChangeStream(this.videoTrack.samples),s=n.changed,a=n.changedIdx;s&&!i?this.fixChangeStreamVideo(a):this.doFixVideo(r);var o=e.detactChangeStream(this.audioTrack.samples),u=o.changed,l=o.changedIdx;u?this.fixChangeStreamAudio(l):this.doFixAudio(i),this.removeInvalidSamples()}},{key:"doFixVideo",value:function(t,i){for(var r=this.videoTrack,n=r.samples,s=r.meta,a=0,o=n.length;a<o;a++){var u=n[a];u.originDts=u.dts}if((!s.frameRate||!1!==s.frameRate.fixed)&&n&&n.length&&this._firstVideoSample){var l=n[0];if(0!==this._videoLargeGap&&e.doFixLargeGap(n,this._videoLargeGap),l.dts!==this._firstVideoSample.dts&&(i||this.videoLastSample&&e.detectLargeGap(this.videoLastSample.dts,l))&&(this.nextVideoDts=i||this.videoLastSample.dts,this._videoLargeGap=this.nextVideoDts-l.dts,e.doFixLargeGap(n,this._videoLargeGap)),t&&this._firstAudioSample){var h=this._firstVideoSample.originDts,c=h-(this._firstAudioSample.originDts||this._firstAudioSample.dts);if(c>2*s.refSampleDuration&&c<10*s.refSampleDuration){for(var d=Math.floor(c/s.refSampleDuration),f=0;f<d;f++){var p=Object.assign({},l);p.dts=h-(f+1)*s.refSampleDuration,p.pts=p.dts+p.cts,n.unshift(p),this.filledVideoSamples.push({dts:p.dts,size:p.data.byteLength})}this._firstVideoSample=this.filledVideoSamples[0]||this._firstVideoSample}else c<-2*s.refSampleDuration&&(this._videoLargeGap=-1*c,e.doFixLargeGap(n,-1*c))}var E=n.pop();if(n.length&&(n[n.length-1].duration=E.dts-n[n.length-1].dts),this.videoLastSample){var v=this.videoLastSample;v.duration=l.dts-v.dts,n.unshift(this.videoLastSample)}this.videoLastSample=E,this.videoTrack.samples=n}}},{key:"doFixAudio",value:function(t,i){var r=this.audioTrack,n=r.samples,s=r.meta;if(n&&n.length){for(var a=0,o=n.length;a<o;a++){var u=n[a];u.originDts=u.dts}var l=n.length,h=AAC.getSilentFrame(s.codec,s.channelCount),c=this._firstAudioSample,d=n[0];if(0!==this._audioLargeGap&&e.doFixLargeGap(n,this._audioLargeGap),d.dts!==this._firstAudioSample.dts&&(i||e.detectLargeGap(this.nextAudioDts,d))&&(i&&(this.nextAudioDts=i),this._audioLargeGap=this.nextAudioDts-d.dts,e.doFixLargeGap(n,this._audioLargeGap)),this._firstVideoSample&&t){var f=this._firstVideoSample.originDts||this._firstVideoSample.dts,p=c.dts-f;if(p>s.refSampleDuration&&p<10*s.refSampleDuration){for(var E=Math.floor((c.dts-f)/s.refSampleDuration),v=0;v<E;v++){var y={data:h,datasize:h.byteLength,dts:c.dts-(v+1)*s.refSampleDuration,filtered:0};n.unshift(y),this.filledAudioSamples.push({dts:y.dts,size:y.data.byteLength})}this._firstAudioSample=this.filledAudioSamples[0]||this._firstAudioSample}else p<-1*s.refSampleDuration&&(this._audioLargeGap=-1*p,e.doFixLargeGap(n,-1*p))}var _=void 0,m=n[0].dts;if(this.nextAudioDts){_=m-this.nextAudioDts;var g=Math.abs(_);if(g>s.refSampleDuration&&1===l&&1===this.lastAudioSamplesLen&&(s.refSampleDurationFixed=void 0),_>2*s.refSampleDuration&&_<10*s.refSampleDuration)if(1===l&&1===this.lastAudioSamplesLen)s.refSampleDurationFixed=void 0!==s.refSampleDurationFixed?s.refSampleDurationFixed+_:s.refSampleDuration+_;else for(var T=Math.floor(_/s.refSampleDuration),b=0;b<T;b++){var S=m-(b+1)*s.refSampleDuration,A=Object.assign({},n[0],{dts:S>this.nextAudioDts?S:this.nextAudioDts});this.filledAudioSamples.push({dts:A.dts,size:A.data.byteLength}),this.audioTrack.samples.unshift(A)}else g<=s.refSampleDuration&&g>0?(n[0].dts=this.nextAudioDts,n[0].pts=this.nextAudioDts):_<0&&e.doFixLargeGap(n,-1*_)}var k=n[n.length-1].originDts,R=n[n.length-1].dts,D=n.length>=2?k-n[n.length-2].originDts:s.refSampleDuration;this.lastAudioSamplesLen=l,this.nextAudioDts=s.refSampleDurationFixed?R+s.refSampleDurationFixed:R+D,this.lastAudioDts=R,n[n.length-1].duration=D;for(var C=0,L=n.length;C<L;C++){var w=n[C],U=n[C+1];if(!U)break;var O=U.dts-w.dts;n[C].duration=O}this.audioTrack.samples=e.sortAudioSamples(n)}}},{key:"fixChangeStreamVideo",value:function(e){var t=this.videoTrack,i=t.samples,r=t.meta,n=0===e?this.videoLastSample?this.videoLastSample.dts:this.getStreamChangeStart(i[0]):i[e-1].dts,s=i[e].dts;if(Math.abs(n-s)<=2e3)return i[e].options?i[e].options.isContinue=!0:i[e].options={isContinue:!0},this.doFixVideo(!1);this.emit(REMUX_EVENTS$1.DETECT_CHANGE_STREAM_DISCONTINUE),this._videoLargeGap=0;var a=i.slice(0,e),o=i.slice(e),u=i[0],l=void 0;u.options&&u.options.start?l=u.options&&u.options.start?u.options.start:null:this.videoLastSample&&(l=this.videoLastSample.dts-this.dtsBase+r.refSampleDuration),this.videoTrack.samples=i.slice(0,e),this.doFixVideo(!1),this.videoTrack.samples=i.slice(e),this.doFixVideo(!1,l),this.videoTrack.samples=a.concat(o)}},{key:"fixChangeStreamAudio",value:function(e){var t=this.audioTrack,i=t.samples,r=t.meta,n=0===e?this.getStreamChangeStart(i[0]):i[e-1].dts,s=i[e].dts;if(Math.abs(n-s)<=2e3)return i[e].options?i[e].options.isContinue=!0:i[e].options={isContinue:!0},this.doFixAudio(!1);this.emit(REMUX_EVENTS$1.DETECT_CHANGE_STREAM_DISCONTINUE),this._audioLargeGap=0;var a=i.slice(0,e),o=i.slice(e),u=i[0],l=void 0;l=u.options&&u.options.start?u.options&&u.options.start?u.options.start:null:this.lastAudioDts-this.dtsBase+r.refSampleDuration,this.audioTrack.samples=a,this.doFixAudio(!1),this.audioTrack.samples=o,this.doFixAudio(!1,l),this.audioTrack.samples=a.concat(o)}},{key:"getFirstSample",value:function(){var t=this.videoTrack.samples,i=this.audioTrack.samples,r=!1,n=!1;return!this._firstVideoSample&&t.length&&(this._firstVideoSample=e.findFirstVideoSample(t),this.removeInvalidSamples(),r=!0),!this._firstAudioSample&&i.length&&(this._firstAudioSample=e.findFirstAudioSample(i),this.removeInvalidSamples(),n=!0),{isFirstVideoSamples:r,isFirstAudioSamples:n}}},{key:"fixRefSampleDuration",value:function(e,t){var i="video"===e.type,r=i?this.allVideoSamplesCount:this.allAudioSamplesCount,n=i?this._firstVideoSample.dts:this._firstAudioSample.dts,s=i?this.filledVideoSamples.length:this.filledAudioSamples.length;if(!e.refSampleDuration||e.refSampleDuration<=0||Number.isNaN(e.refSampleDuration)){if(t.length>=1){var a=t[t.length-1].dts;e.refSampleDuration=Math.floor((a-n)/(r+s-1))}}else if(e.refSampleDuration&&t.length>=5){var o=(t[t.length-1].dts-t[0].dts)/(t.length-1);o>0&&o<1e3&&(e.refSampleDuration=Math.floor(Math.abs(e.refSampleDuration-o)<=5?e.refSampleDuration:o))}}},{key:"recordSamplesCount",value:function(){var e=this.audioTrack,t=this.videoTrack;this.allAudioSamplesCount+=e.samples.length,this.allVideoSamplesCount+=t.samples.length}},{key:"removeInvalidSamples",value:function(){var e=this._firstVideoSample,t=this._firstAudioSample;t&&(this.audioTrack.samples=this.audioTrack.samples.filter(function(e,i){return e===t||e.dts>t.dts})),e&&(this.videoTrack.samples=this.videoTrack.samples.filter(function(t,i){return t===e||t.dts>e.dts}))}},{key:"getStreamChangeStart",value:function(e){return e.options&&e.options.start?e.options.start-this.dtsBase:1/0}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"audioTrack",get:function(){return this.tracks&&this.tracks.audioTrack?this.tracks.audioTrack:{samples:[],meta:{}}}},{key:"videoTrack",get:function(){return this.tracks&&this.tracks.videoTrack?this.tracks.videoTrack:{samples:[],meta:{}}}},{key:"dtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e?e._dtsBase:0}}],[{key:"sortAudioSamples",value:function(e){return 1===e.length?e:e.sort(function(e,t){return e.dts-t.dts})}},{key:"findFirstAudioSample",value:function(t){return t&&0!==t.length?e.sortAudioSamples(t)[0]:null}},{key:"findFirstVideoSample",value:function(e){if(!e.length)return null;for(var t=e.sort(function(e,t){return e.dts-t.dts}),i=0,r=t.length;i<r;i++)if(t[i].isKeyframe)return t[i]}},{key:"detectLargeGap",value:function(e,t){if(null!==e){var i=t.dts||0,r=e-i>=1e3||i-e>=1e3,n=t.options&&t.options.discontinue;return r||n}}},{key:"doFixLargeGap",value:function(e,t){for(var i=0,r=e.length;i<r;i++){var n=e[i];n.dts+=t,n.pts&&(n.pts+=t)}}},{key:"detactChangeStream",value:function(e){for(var t=!1,i=-1,r=0,n=e.length;r<n;r++)if(e[r].options&&e[r].options.meta){t=!0,i=r;break}return{changed:t,changedIdx:i}}}]),e}(),isObjectFilled$1=function(e){for(var t in e)if(e.hasOwnProperty(t)&&null===e[t])return!1;return!0},MediaInfo$1=function(){function e(){babelHelpers.classCallCheck(this,e),this.mimeType=null,this.duration=null,this.hasVideo=null,this.video={codec:null,width:null,height:null,profile:null,level:null,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},chromaFormat:null,parRatio:{width:1,height:1}},this.hasAudio=null,this.audio={codec:null,sampleRate:null,sampleRateIndex:null,channelCount:null}}return babelHelpers.createClass(e,[{key:"isComplete",value:function(){return e.isBaseInfoReady(this)&&e.isVideoReady(this)&&e.isAudioReady(this)}}],[{key:"isBaseInfoReady",value:function(e){return isObjectFilled$1(e)}},{key:"isVideoReady",value:function(e){return!e.hasVideo||isObjectFilled$1(e.video)}},{key:"isAudioReady",value:function(e){return!e.hasAudio||isObjectFilled$1(e.video)}}]),e}(),DIRECT_EMIT_FLAG$1="__TO__",Context$1=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];babelHelpers.classCallCheck(this,e),this._emitter=new EventEmitter,this._emitter.off||(this._emitter.off=this._emitter.removeListener),this._instanceMap={},this._clsMap={},this._inited=!1,this.mediaInfo=new MediaInfo$1,this.allowedEvents=t,this._hooks={}}return babelHelpers.createClass(e,[{key:"getInstance",value:function(e){var t=this._instanceMap[e];return t||null}},{key:"initInstance",value:function(e){for(var t=arguments.length,i=Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];var n=i[0],s=i[1],a=i[2],o=i[3];if(this._clsMap[e]){var u=new this._clsMap[e](n,s,a,o);return this._instanceMap[e]=u,u.init&&u.init(),u}throw new Error(e+"未在context中注册")}},{key:"init",value:function(e){if(!this._inited){for(var t in this._clsMap)this._clsMap.hasOwnProperty(t)&&!this._instanceMap[t]&&this.initInstance(t,e);this._inited=!0}}},{key:"registry",value:function(e,t){var i=this,r=this._emitter,n=this._isMessageNameValid.bind(this),s=this,a=function(t){function i(t,r,n){babelHelpers.classCallCheck(this,i);var a=babelHelpers.possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,t,r,n));return a.listeners={},a.onceListeners={},a.TAG=e,a._context=s,a}return babelHelpers.inherits(i,t),babelHelpers.createClass(i,[{key:"on",value:function(t,i){return n(t),this.listeners[t]?this.listeners[t].push(i):this.listeners[t]=[i],r.on(""+t+DIRECT_EMIT_FLAG$1+e,i),r.on(t,i)}},{key:"before",value:function(e,t){n(e),s._hooks[e]?s._hooks[e].push(t):s._hooks[e]=[t]}},{key:"once",value:function(t,i){return n(t),this.onceListeners[t]?this.onceListeners[t].push(i):this.onceListeners[t]=[i],r.once(""+t+DIRECT_EMIT_FLAG$1+e,i),r.once(t,i)}},{key:"emit",value:function(e){n(e);var t=s._hooks?s._hooks[e]:null;if(t)for(var i=0,a=t.length;i<a;i++)(0,t[i])();for(var o=arguments.length,u=Array(o>1?o-1:0),l=1;l<o;l++)u[l-1]=arguments[l];return r.emit.apply(r,[e].concat(u))}},{key:"emitTo",value:function(e,t){n(t);for(var i=arguments.length,s=Array(i>2?i-2:0),a=2;a<i;a++)s[a-2]=arguments[a];return r.emit.apply(r,[""+t+DIRECT_EMIT_FLAG$1+e].concat(s))}},{key:"off",value:function(e,t){return n(e),r.off(e,t)}},{key:"removeListeners",value:function(){var t=Object.prototype.hasOwnProperty.bind(this.listeners);for(var i in this.listeners)if(t(i))for(var n=this.listeners[i]||[],s=0;s<n.length;s++){var a=n[s];r.off(i,a),r.off(""+i+DIRECT_EMIT_FLAG$1+e,a)}for(var o in this.onceListeners)if(t(o))for(var u=this.onceListeners[o]||[],l=0;l<u.length;l++){var h=u[l];r.off(o,h),r.off(""+o+DIRECT_EMIT_FLAG$1+e,h)}}},{key:"destroy",value:function(){if(this.removeListeners(),this.listeners={},delete s._instanceMap[e],babelHelpers.get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this))return babelHelpers.get(i.prototype.__proto__||Object.getPrototypeOf(i.prototype),"destroy",this).call(this)}}]),i}(t);return this._clsMap[e]=a,function(){for(var t=arguments.length,r=Array(t),n=0;n<t;n++)r[n]=arguments[n];return i.initInstance.apply(i,[e].concat(r))}}},{key:"destroyInstances",value:function(){var e=this;Object.keys(this._instanceMap).forEach(function(t){e._instanceMap[t].destroy&&e._instanceMap[t].destroy()})}},{key:"destroy",value:function(){this._emitter=null,this.allowedEvents=[],this._clsMap=null,this._context=null,this._hooks=null,this.destroyInstances()}},{key:"_isMessageNameValid",value:function(e){if(!this.allowedEvents.indexOf(e)<0)throw new Error("unregistered message name: "+e)}}]),e}(),LOADER_EVENTS$2={LADER_START:"LOADER_START",LOADER_DATALOADED:"LOADER_DATALOADED",LOADER_COMPLETE:"LOADER_COMPLETE",LOADER_ERROR:"LOADER_ERROR"},DEMUX_EVENTS$1={DEMUX_START:"DEMUX_START",DEMUX_COMPLETE:"DEMUX_COMPLETE",DEMUX_ERROR:"DEMUX_ERROR",METADATA_PARSED:"METADATA_PARSED",VIDEO_METADATA_CHANGE:"VIDEO_METADATA_CHANGE",AUDIO_METADATA_CHANGE:"AUDIO_METADATA_CHANGE",MEDIA_INFO:"MEDIA_INFO"},REMUX_EVENTS$2={REMUX_METADATA:"REMUX_METADATA",REMUX_MEDIA:"REMUX_MEDIA",MEDIA_SEGMENT:"MEDIA_SEGMENT",REMUX_ERROR:"REMUX_ERROR",INIT_SEGMENT:"INIT_SEGMENT",DETECT_CHANGE_STREAM:"DETECT_CHANGE_STREAM",DETECT_CHANGE_STREAM_DISCONTINUE:"DETECT_CHANGE_STREAM_DISCONTINUE",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT"},MSE_EVENTS$1={SOURCE_UPDATE_END:"SOURCE_UPDATE_END"},HLS_EVENTS$1={RETRY_TIME_EXCEEDED:"RETRY_TIME_EXCEEDED"},CRYTO_EVENTS$1={START_DECRYPT:"START_DECRYPT",DECRYPTED:"DECRYPTED"},ALLEVENTS$1=Object.assign({},LOADER_EVENTS$2,DEMUX_EVENTS$1,REMUX_EVENTS$2,MSE_EVENTS$1,HLS_EVENTS$1),FlvAllowedEvents$1=[],HlsAllowedEvents$1=[];for(var key$1 in ALLEVENTS$1)ALLEVENTS$1.hasOwnProperty(key$1)&&FlvAllowedEvents$1.push(ALLEVENTS$1[key$1]);for(var _key$1 in ALLEVENTS$1)ALLEVENTS$1.hasOwnProperty(_key$1)&&HlsAllowedEvents$1.push(ALLEVENTS$1[_key$1]);var _EVENTS={ALLEVENTS:ALLEVENTS$1,HLS_EVENTS:HLS_EVENTS$1,REMUX_EVENTS:REMUX_EVENTS$2,DEMUX_EVENTS:DEMUX_EVENTS$1,MSE_EVENTS:MSE_EVENTS$1,LOADER_EVENTS:LOADER_EVENTS$2,FlvAllowedEvents:FlvAllowedEvents$1,HlsAllowedEvents:HlsAllowedEvents$1,CRYTO_EVENTS:CRYTO_EVENTS$1},le=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),sniffer={get device(){var e=sniffer.os;return e.isPc?"pc":e.isTablet?"tablet":"mobile"},get browser(){var e=navigator.userAgent.toLowerCase(),t={ie:/rv:([\d.]+)\) like gecko/,firfox:/firefox\/([\d.]+)/,chrome:/chrome\/([\d.]+)/,opera:/opera.([\d.]+)/,safari:/version\/([\d.]+).*safari/};return[].concat(Object.keys(t).filter(function(i){return t[i].test(e)}))[0]},get os(){var e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,r=/(?:Android)/.test(e),n=/(?:Firefox)/.test(e),s=/(?:iPad|PlayBook)/.test(e)||r&&!/(?:Mobile)/.test(e)||n&&/(?:Tablet)/.test(e),a=/(?:iPhone)/.test(e)&&!s;return{isTablet:s,isPhone:a,isAndroid:r,isPc:!a&&!r&&!i,isSymbian:i,isWindowsPhone:t,isFireFox:n}},get isLe(){return le}},le$1=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),UTF8=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,null,[{key:"decode",value:function(t){for(var i=[],r=t,n=0,s=t.length;n<s;)if(r[n]<128)i.push(String.fromCharCode(r[n])),++n;else{if(r[n]<192);else if(r[n]<224){if(e._checkContinuation(r,n,1)){var a=(31&r[n])<<6|63&r[n+1];if(a>=128){i.push(String.fromCharCode(65535&a)),n+=2;continue}}}else if(r[n]<240){if(e._checkContinuation(r,n,2)){var o=(15&r[n])<<12|(63&r[n+1])<<6|63&r[n+2];if(o>=2048&&55296!=(63488&o)){i.push(String.fromCharCode(65535&o)),n+=3;continue}}}else if(r[n]<248&&e._checkContinuation(r,n,3)){var u=(7&r[n])<<18|(63&r[n+1])<<12|(63&r[n+2])<<6|63&r[n+3];if(u>65536&&u<1114112){u-=65536,i.push(String.fromCharCode(u>>>10|55296)),i.push(String.fromCharCode(1023&u|56320)),n+=4;continue}}i.push(String.fromCharCode(65533)),++n}return i.join("")}},{key:"_checkContinuation",value:function(e,t,i){var r=e;if(t+i<r.length){for(;i--;)if(128!=(192&r[++t]))return!1;return!0}return!1}}]),e}(),MediaSample=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);var r=e.getDefaultInf();if(!t||"[object Object]"!==Object.prototype.toString.call(t))return r;var n=Object.assign({},r,t);Object.entries(n).forEach(function(e){var t=babelHelpers.slicedToArray(e,2),r=t[0],n=t[1];i[r]=n})}return babelHelpers.createClass(e,null,[{key:"getDefaultInf",value:function(){return{dts:null,pts:null,duration:null,position:null,isRAP:!1,originDts:null}}}]),e}(),MediaSegment=function(){function e(){babelHelpers.classCallCheck(this,e),this.startDts=-1,this.endDts=-1,this.startPts=-1,this.endPts=-1,this.originStartDts=-1,this.originEndDts=-1,this.randomAccessPoints=[],this.firstSample=null,this.lastSample=null}return babelHelpers.createClass(e,[{key:"addRAP",value:function(e){e.isRAP=!0,this.randomAccessPoints.push(e)}}]),e}(),MediaSegmentList=function(){function e(t){babelHelpers.classCallCheck(this,e),this._type=t,this._list=[],this._lastAppendLocation=-1}return babelHelpers.createClass(e,[{key:"isEmpty",value:function(){return 0===this._list.length}},{key:"clear",value:function(){this._list=[],this._lastAppendLocation=-1}},{key:"_searchNearestSegmentBefore",value:function(e){var t=this._list;if(0===t.length)return-2;var i=t.length-1,r=0,n=0,s=i,a=0;if(e<t[0].originDts)return a=-1;for(;n<=s;){if((r=n+Math.floor((s-n)/2))===i||e>t[r].lastSample.originDts&&e<t[r+1].originDts){a=r;break}t[r].originDts<e?n=r+1:s=r-1}return a}},{key:"_searchNearestSegmentAfter",value:function(e){return this._searchNearestSegmentBefore(e)+1}},{key:"append",value:function(e){var t=this._list,i=this._lastAppendLocation,r=0;-1!==i&&i<t.length&&e.originStartDts>=t[i].lastSample.originDts&&(i===t.length-1||i<t.length-1&&e.originStartDts<t[i+1].originStartDts)?r=i+1:t.length>0&&(r=this._searchNearestSegmentBefore(e.originStartDts)+1),this._lastAppendLocation=r,this._list.splice(r,0,e)}},{key:"getLastSegmentBefore",value:function(e){var t=this._searchNearestSegmentBefore(e);return t>=0?this._list[t]:null}},{key:"getLastSampleBefore",value:function(e){var t=this.getLastSegmentBefore(e);return null!==t?t.lastSample:null}},{key:"getLastRAPBefore",value:function(e){for(var t=this._searchNearestSegmentBefore(e),i=this._list[t].randomAccessPoints;0===i.length&&t>0;)t--,i=this._list[t].randomAccessPoints;return i.length>0?i[i.length-1]:null}},{key:"type",get:function(){return this._type}},{key:"length",get:function(){return this._list.length}}]),e}(),AudioTrackMeta=function(){function e(t){babelHelpers.classCallCheck(this,e);var i={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2",config:[41,401,136,0],duration:0,id:2,refSampleDuration:21,sampleRateIndex:3,timescale:1e3,type:"audio"};return t?Object.assign({},i,t):i}return babelHelpers.createClass(e,[{key:"destroy",value:function(){this.init=null}}]),e}(),VideoTrackMeta=function(){function e(t){babelHelpers.classCallCheck(this,e);var i={avcc:null,sps:new Uint8Array(0),pps:new Uint8Array(0),chromaFormat:420,codec:"avc1.640020",codecHeight:720,codecWidth:1280,duration:0,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},id:1,level:"3.2",presentHeight:720,presentWidth:1280,profile:"High",refSampleDuration:40,parRatio:{height:1,width:1},timescale:1e3,type:"video"};return t?Object.assign({},i,t):i}return babelHelpers.createClass(e,[{key:"destroy",value:function(){this.init=null,this.sps=null,this.pps=null}}]),e}(),AudioTrackSample=function(){function e(t){babelHelpers.classCallCheck(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return babelHelpers.createClass(e,null,[{key:"getDefault",value:function(){return{dts:null,pts:null,data:new Uint8Array}}}]),e}(),VideoTrackSample=function(){function e(t){babelHelpers.classCallCheck(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return babelHelpers.createClass(e,null,[{key:"getDefault",value:function(){return{dts:null,pts:null,isKeyframe:!1,originDts:null,data:new Uint8Array}}}]),e}(),MSE$1=function(){function e(t,i){babelHelpers.classCallCheck(this,e),i&&(this._context=i,this.emit=i._emitter.emit.bind(i._emitter)),this.configs=Object.assign({},t),this.container=this.configs.container,this.mediaSource=null,this.sourceBuffers={},this.preloadTime=this.configs.preloadTime||1,this.onSourceOpen=this.onSourceOpen.bind(this),this.onTimeUpdate=this.onTimeUpdate.bind(this),this.onUpdateEnd=this.onUpdateEnd.bind(this),this.onWaiting=this.onWaiting.bind(this)}return babelHelpers.createClass(e,[{key:"init",value:function(){this.mediaSource=new self.MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this.container.src=URL.createObjectURL(this.mediaSource),this.url=this.container.src,this.container.addEventListener("timeupdate",this.onTimeUpdate),this.container.addEventListener("waiting",this.onWaiting)}},{key:"resetContext",value:function(e){this._context=e}},{key:"onTimeUpdate",value:function(){this.emit("TIME_UPDATE",this.container)}},{key:"onWaiting",value:function(){this.emit("WAITING",this.container)}},{key:"onSourceOpen",value:function(){this.addSourceBuffers()}},{key:"onUpdateEnd",value:function(){this.emit("SOURCE_UPDATE_END"),this.doAppend()}},{key:"addSourceBuffers",value:function(){if("open"===this.mediaSource.readyState){var e=this._context.getInstance("PRE_SOURCE_BUFFER"),t=this._context.getInstance("TRACKS"),i=void 0;e=e.sources;for(var r=!1,n=0,s=Object.keys(e).length;n<s;n++){var a=Object.keys(e)[n];if("audio"===a?i=t.audioTrack:"video"===a&&(i=t.videoTrack),i){var o="audio"===a?21:40;i.meta&&i.meta.refSampleDuration&&(o=i.meta.refSampleDuration),e[a].data.length>=this.preloadTime/o&&(r=!0)}}if(r){if(Object.keys(this.sourceBuffers).length>0)return;for(var u=0,l=Object.keys(e).length;u<l;u++){var h=Object.keys(e)[u],c=e[h],d="video"===h?"video/mp4;codecs="+c.mimetype:"audio/mp4;codecs="+c.mimetype,f=this.mediaSource.addSourceBuffer(d);this.sourceBuffers[h]=f,f.addEventListener("updateend",this.onUpdateEnd),this.doAppend()}}}}},{key:"doAppend",value:function(){var e=this._context.getInstance("PRE_SOURCE_BUFFER");if(e)for(var t=0;t<Object.keys(this.sourceBuffers).length;t++){var i=Object.keys(this.sourceBuffers)[t],r=this.sourceBuffers[i],n=e.sources[i];if(n&&!n.inited)try{r.appendBuffer(n.init.buffer.buffer),n.inited=!0}catch(e){}else if(n){var s=n.data.shift();if(s)try{r.appendBuffer(s.buffer.buffer)}catch(e){n.data.unshift(s)}}}}},{key:"endOfStream",value:function(){var e=this.mediaSource,t=e.readyState,i=e.activeSourceBuffers;if("open"===t&&0===i.length)try{this.mediaSource.endOfStream()}catch(e){}}},{key:"remove",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0;i<Object.keys(this.sourceBuffers).length;i++){var r=this.sourceBuffers[Object.keys(this.sourceBuffers)[i]];r.updating||r.remove(t,e)}}},{key:"removeBuffers",value:function(){for(var t=this,i=[],r=0;r<Object.keys(this.sourceBuffers).length;r++)!function(r){var n=t.sourceBuffers[Object.keys(t.sourceBuffers)[r]];n.removeEventListener("updateend",t.onUpdateEnd);var s=void 0;s=n.updating?new Promise(function(t){var i=function i(){var r=3,s=function i(){n.updating?r>0?(setTimeout(i,200),r--):t():(e.clearBuffer(n),n.addEventListener("updateend",function(){t()}))};setTimeout(s,200),n.removeEventListener("updateend",i)};n.addEventListener("updateend",i)}):new Promise(function(t){e.clearBuffer(n),n.addEventListener("updateend",function(){t()})}),i.push(s)}(r);return Promise.all(i)}},{key:"destroy",value:function(){var e=this;return this.removeBuffers().then(function(){for(var t=0;t<Object.keys(e.sourceBuffers).length;t++){var i=e.sourceBuffers[Object.keys(e.sourceBuffers)[t]];e.mediaSource.removeSourceBuffer(i),delete e.sourceBuffers[Object.keys(e.sourceBuffers)[t]]}e.container.removeEventListener("timeupdate",e.onTimeUpdate),e.container.removeEventListener("waiting",e.onWaiting),e.mediaSource.removeEventListener("sourceopen",e.onSourceOpen),e.endOfStream(),window.URL.revokeObjectURL(e.url),e.url=null,e.configs={},e.container=null,e.mediaSource=null,e.sourceBuffers={},e.preloadTime=1})}}],[{key:"clearBuffer",value:function(e){for(var t=e.buffered,i=.1,r=0,n=t.length;r<n;r++)i=t.end(r);try{e.remove(0,i)}catch(e){}}}]),e}(),Stream=function(){function e(t){if(babelHelpers.classCallCheck(this,e),!(t instanceof ArrayBuffer))throw new Error("data is invalid");this.buffer=t,this.dataview=new DataView(t),this.dataview.position=0}return babelHelpers.createClass(e,[{key:"back",value:function(e){this.position-=e}},{key:"skip",value:function(t){for(var i=Math.floor(t/4),r=t%4,n=0;n<i;n++)e.readByte(this.dataview,4);r>0&&e.readByte(this.dataview,r)}},{key:"readUint8",value:function(){return e.readByte(this.dataview,1)}},{key:"readUint16",value:function(){return e.readByte(this.dataview,2)}},{key:"readUint24",value:function(){return e.readByte(this.dataview,3)}},{key:"readUint32",value:function(){return e.readByte(this.dataview,4)}},{key:"readUint64",value:function(){return e.readByte(this.dataview,8)}},{key:"readInt8",value:function(){return e.readByte(this.dataview,1,!0)}},{key:"readInt16",value:function(){return e.readByte(this.dataview,2,!0)}},{key:"readInt32",value:function(){return e.readByte(this.dataview,4,!0)}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}},{key:"length",get:function(){return this.buffer.byteLength}},{key:"position",set:function(e){this.dataview.position=e},get:function(){return this.dataview.position}}],[{key:"readByte",value:function(e,t,i){var r=void 0;switch(t){case 1:r=i?e.getInt8(e.position):e.getUint8(e.position);break;case 2:r=i?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(i)throw new Error("not supported for readByte 3");r=e.getUint8(e.position)<<16,r|=e.getUint8(e.position+1)<<8,r|=e.getUint8(e.position+2);break;case 4:r=i?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(i)throw new Error("not supported for readBody 8");r=e.getUint32(e.position)<<32,r|=e.getUint32(e.position+4);break;default:r=""}return e.position+=t,r}}]),e}(),concat=createCommonjsModule(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){for(var t=0,i=arguments.length,r=Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];var s=!0,a=!1,o=void 0;try{for(var u,l=r[Symbol.iterator]();!(s=(u=l.next()).done);s=!0)t+=u.value.length}catch(e){a=!0,o=e}finally{try{!s&&l.return&&l.return()}finally{if(a)throw o}}var h=new e(t),c=0,d=!0,f=!1,p=void 0;try{for(var E,v=r[Symbol.iterator]();!(d=(E=v.next()).done);d=!0){var y=E.value;h.set(y,c),c+=y.length}}catch(e){f=!0,p=e}finally{try{!d&&v.return&&v.return()}finally{if(f)throw p}}return h}});unwrapExports(concat);var lib=createCommonjsModule(function(e){var t=function(e){return e&&e.__esModule?e:{default:e}}(concat);e.exports=t.default}),Concat=unwrapExports(lib),Buffer=function(){function e(t){babelHelpers.classCallCheck(this,e),this.buffer=t||new Uint8Array(0)}return babelHelpers.createClass(e,[{key:"write",value:function(){for(var e=this,t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];i.forEach(function(t){e.buffer=Concat(Uint8Array,e.buffer,t)})}}],[{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,255&e])}},{key:"readAsInt",value:function(e){function t(e){return e.toString(16).padStart(2,"0")}var i="";return e.forEach(function(e){i+=t(e)}),parseInt(i,16)}}]),e}(),CRYTO_EVENTS$2=_EVENTS.CRYTO_EVENTS,Crypto=function(){function e(t){babelHelpers.classCallCheck(this,e),this.inputBuffer=t.inputbuffer,this.outputBuffer=t.outputbuffer,this.key=t.key,this.iv=t.iv,this.method=t.method,this.crypto=window.crypto||window.msCrypto}return babelHelpers.createClass(e,[{key:"init",value:function(){this.on(CRYTO_EVENTS$2.START_DECRYPT,this.decript.bind(this))}},{key:"decript",value:function(){var e=this;this.aeskey?this.decriptData():this.crypto.subtle.importKey("raw",this.key.buffer,{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(t){e.aeskey=t,e.decriptData()})}},{key:"decriptData",value:function(){var e=this,t=this._context.getInstance(this.inputBuffer),i=this._context.getInstance(this.outputBuffer),r=t.shift();r&&this.crypto.subtle.decrypt({name:"AES-CBC",iv:this.iv.buffer},this.aeskey,r).then(function(t){i.push(new Uint8Array(t)),e.emit(CRYTO_EVENTS$2.DECRYPTED),e.decriptData(r)})}}]),e}(),EVENTS$1=_EVENTS,sniffer$1=sniffer,MediaSegmentList$1=MediaSegmentList,Buffer$1=Buffer,Fmp4=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,null,[{key:"size",value:function(e){return Buffer$1.writeUint32(e)}},{key:"initBox",value:function(t,i){for(var r=new Buffer$1,n=arguments.length,s=Array(n>2?n-2:0),a=2;a<n;a++)s[a-2]=arguments[a];return r.write.apply(r,[e.size(t),e.type(i)].concat(s)),r.buffer}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,255&t])}},{key:"ftyp",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]))}},{key:"moov",value:function(t){var i=t.type,r=t.meta,n=8,s=e.mvhd(r.duration,r.timescale),a=void 0;a="video"===i?e.videoTrak(r):e.audioTrak(r);var o=e.mvex(r.duration,r.timescale||1e3,r.id);return[s,a,o].forEach(function(e){n+=e.byteLength}),e.initBox(n,"moov",s,a,o)}},{key:"mvhd",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,r=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.initBox(8+r.length,"mvhd",new Uint8Array(r))}},{key:"videoTrak",value:function(t){var i=8,r=e.tkhd({id:1,duration:t.duration,timescale:t.timescale||1e3,width:t.presentWidth,height:t.presentHeight,type:"video"}),n=e.mdia({type:"video",timescale:t.timescale||1e3,duration:t.duration,avcc:t.avcc,parRatio:t.parRatio,width:t.presentWidth,height:t.presentHeight});return[r,n].forEach(function(e){i+=e.byteLength}),e.initBox(i,"trak",r,n)}},{key:"audioTrak",value:function(t){var i=8,r=e.tkhd({id:2,duration:t.duration,timescale:t.timescale||1e3,width:0,height:0,type:"audio"}),n=e.mdia({type:"audio",timescale:t.timescale||1e3,duration:t.duration,channelCount:t.channelCount,samplerate:t.sampleRate,config:t.config});return[r,n].forEach(function(e){i+=e.byteLength}),e.initBox(i,"trak",r,n)}},{key:"tkhd",value:function(t){var i=t.id,r=t.duration,n=t.width,s=t.height,a=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,0,0,0,0,r>>>24&255,r>>>16&255,r>>>8&255,255&r,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,n>>>8&255,255&n,0,0,s>>>8&255,255&s,0,0]);return e.initBox(8+a.byteLength,"tkhd",a)}},{key:"edts",value:function(t){var i=new Buffer$1,r=t.duration,n=t.mediaTime;return i.write(e.size(36),e.type("edts")),i.write(e.size(28),e.type("elst")),i.write(new Uint8Array([0,0,0,1,r>>24&255,r>>16&255,r>>8&255,255&r,n>>24&255,n>>16&255,n>>8&255,255&n,0,0,0,1])),i.buffer}},{key:"mdia",value:function(t){var i=8,r=e.mdhd(t.timescale,t.duration),n=e.hdlr(t.type),s=e.minf(t);return[r,n,s].forEach(function(e){i+=e.byteLength}),e.initBox(i,"mdia",r,n,s)}},{key:"mdhd",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,i=arguments[1],r=new Uint8Array([0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,i>>>24&255,i>>>16&255,i>>>8&255,255&i,85,196,0,0]);return e.initBox(12+r.byteLength,"mdhd",e.extension(0,0),r)}},{key:"hdlr",value:function(t){var i=[0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0];return"audio"===t&&(i.splice.apply(i,[8,4].concat([115,111,117,110])),i.splice.apply(i,[24,13].concat([83,111,117,110,100,72,97,110,100,108,101,114,0]))),e.initBox(8+i.length,"hdlr",new Uint8Array(i))}},{key:"minf",value:function(t){var i=8,r="video"===t.type?e.vmhd():e.smhd(),n=e.dinf(),s=e.stbl(t);return[r,n,s].forEach(function(e){i+=e.byteLength}),e.initBox(i,"minf",r,n,s)}},{key:"vmhd",value:function(){return e.initBox(20,"vmhd",new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))}},{key:"smhd",value:function(){return e.initBox(16,"smhd",new Uint8Array([0,0,0,0,0,0,0,0]))}},{key:"dinf",value:function(){var t=new Buffer$1,i=[0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1];return t.write(e.size(36),e.type("dinf"),e.size(28),e.type("dref"),new Uint8Array(i)),t.buffer}},{key:"stbl",value:function(t){var i=8,r=e.stsd(t),n=e.stts(),s=e.stsc(),a=e.stsz(),o=e.stco();return[r,n,s,a,o].forEach(function(e){i+=e.byteLength}),e.initBox(i,"stbl",r,n,s,a,o)}},{key:"stsd",value:function(t){var i=void 0;return i="audio"===t.type?e.mp4a(t):e.avc1(t),e.initBox(16+i.byteLength,"stsd",e.extension(0,0),new Uint8Array([0,0,0,1]),i)}},{key:"mp4a",value:function(t){var i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,t.samplerate>>8&255,255&t.samplerate,0,0]),r=e.esds(t.config);return e.initBox(8+i.byteLength+r.byteLength,"mp4a",i,r)}},{key:"esds",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[43,146,8,0],i=t.length,r=new Buffer$1,n=new Uint8Array([0,0,0,0,3,23+i,0,1,0,4,15+i,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([i]).concat(t).concat([6,1,2]));return r.write(e.size(8+n.byteLength),e.type("esds"),n),r.buffer}},{key:"avc1",value:function(t){var i=new Buffer$1,r=t.width,n=t.height,s=t.parRatio.height,a=t.parRatio.width,o=t.avcc,u=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,r>>8&255,255&r,n>>8&255,255&n,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l=new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]),h=new Uint8Array([s>>24,s>>16&255,s>>8&255,255&s,a>>24,a>>16&255,a>>8&255,255&a]);return i.write(e.size(40+u.byteLength+o.byteLength+l.byteLength),e.type("avc1"),u,e.size(8+o.byteLength),e.type("avcC"),o,e.size(20),e.type("btrt"),l,e.size(16),e.type("pasp"),h),i.buffer}},{key:"stts",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stts",t)}},{key:"stsc",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stsc",t)}},{key:"stco",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stco",t)}},{key:"stsz",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);return e.initBox(20,"stsz",t)}},{key:"mvex",value:function(t){var i=arguments[2],r=new Buffer$1,n=Buffer$1.writeUint32(t);return r.write(e.size(56),e.type("mvex"),e.size(16),e.type("mehd"),e.extension(0,0),n,e.trex(i)),r.buffer}},{key:"trex",value:function(t){var i=new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return e.initBox(8+i.byteLength,"trex",i)}},{key:"moof",value:function(t){var i=8,r=e.mfhd(),n=e.traf(t);return[r,n].forEach(function(e){i+=e.byteLength}),e.initBox(i,"moof",r,n)}},{key:"mfhd",value:function(){var t=Buffer$1.writeUint32(e.sequence);return e.sequence+=1,e.initBox(16,"mfhd",e.extension(0,0),t)}},{key:"traf",value:function(t){var i=8,r=e.tfhd(t.id),n=e.tfdt(t.time),s=e.sdtp(t),a=e.trun(t,s.byteLength);return[r,n,a,s].forEach(function(e){i+=e.byteLength}),e.initBox(i,"traf",r,n,a,s)}},{key:"tfhd",value:function(t){var i=Buffer$1.writeUint32(t);return e.initBox(16,"tfhd",e.extension(0,0),i)}},{key:"tfdt",value:function(t){return e.initBox(16,"tfdt",e.extension(0,0),Buffer$1.writeUint32(t))}},{key:"trun",value:function(t,i){var r=new Buffer$1,n=Buffer$1.writeUint32(t.samples.length),s=Buffer$1.writeUint32(92+16*t.samples.length+i);return r.write(e.size(20+16*t.samples.length),e.type("trun"),new Uint8Array([0,0,15,1]),n,s),t.samples.forEach(function(e){var t=e.flags;r.write(new Uint8Array([e.duration>>>24&255,e.duration>>>16&255,e.duration>>>8&255,255&e.duration,e.size>>>24&255,e.size>>>16&255,e.size>>>8&255,255&e.size,t.isLeading<<2|t.dependsOn,t.isDependedOn<<6|t.hasRedundancy<<4|t.isNonSync,0,0,e.cts>>>24&255,e.cts>>>16&255,e.cts>>>8&255,255&e.cts]))}),r.buffer}},{key:"sdtp",value:function(t){var i=new Buffer$1;return i.write(e.size(12+t.samples.length),e.type("sdtp"),e.extension(0,0)),t.samples.forEach(function(e){var t=e.flags,r=t.isLeading<<6|t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;i.write(new Uint8Array([r]))}),i.buffer}},{key:"mdat",value:function(t){var i=new Buffer$1,r=8;t.samples.forEach(function(e){r+=e.size}),i.write(e.size(r),e.type("mdat"));var n=new Uint8Array(r),s=0;return n.set(i.buffer,s),s+=8,t.samples.forEach(function(e){e.buffer.forEach(function(e){n.set(e,s),s+=e.byteLength})}),n}}]),e}();Fmp4.type=function(e){return new Uint8Array([e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)])},Fmp4.sequence=1;var REMUX_EVENTS$3=EVENTS$1.REMUX_EVENTS,Mp4Remuxer=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;babelHelpers.classCallCheck(this,e),this._dtsBase=1e3*t,this._isDtsBaseInited=!1,this._videoSegmentList=new MediaSegmentList$1("video"),this._audioSegmentList=new MediaSegmentList$1("audio");var i=sniffer$1.browser;this._fillSilenceFrame="ie"===i,this.isFirstVideo=!0,this.isFirstAudio=!0,this.videoAllDuration=0,this.audioAllDuration=0}return babelHelpers.createClass(e,[{key:"init",value:function(){this.on(REMUX_EVENTS$3.REMUX_MEDIA,this.remux.bind(this)),this.on(REMUX_EVENTS$3.REMUX_METADATA,this.onMetaDataReady.bind(this)),this.on(REMUX_EVENTS$3.DETECT_CHANGE_STREAM,this.resetDtsBase.bind(this))}},{key:"remux",value:function(){var e=this._context.getInstance("TRACKS"),t=e.audioTrack,i=e.videoTrack;!this._isDtsBaseInited&&this.calcDtsBase(t,i),this._remuxVideo(i),this._remuxAudio(t)}},{key:"resetDtsBase",value:function(){this._dtsBase=0,this._dtsBaseInited=!1}},{key:"seek",value:function(){this._videoSegmentList.clear(),this._audioSegmentList.clear()}},{key:"onMetaDataReady",value:function(e){var t=void 0;t="audio"===e?this._context.getInstance("TRACKS").audioTrack:this._context.getInstance("TRACKS").videoTrack;var i=this._context.getInstance("PRE_SOURCE_BUFFER"),r=i.getSource(e);r||(r=i.createSource(e)),r.mimetype=t.meta.codec,r.init=this.remuxInitSegment(e,t.meta),this.emit(REMUX_EVENTS$3.INIT_SEGMENT,e)}},{key:"remuxInitSegment",value:function(e,t){var i=new Buffer$1,r=Fmp4.ftyp(),n=Fmp4.moov({type:e,meta:t});return i.write(r,n),i}},{key:"calcDtsBase",value:function(e,t){if(!e&&t.samples.length)return t.samples[0].dts;if(e.samples.length||t.samples.length){var i=1/0,r=1/0;e.samples&&e.samples.length&&(i=e.samples[0].dts),t.samples&&t.samples.length&&(r=t.samples[0].dts),this._dtsBase=Math.min(i,r)-this._dtsBase,this._isDtsBaseInited=!0}}},{key:"_remuxVideo",value:function(e){var t=e||{};if(e.samples&&e.samples.length){for(var i=t.samples,r=-1,n=null,s=[],a={samples:[]},o=1e4;i.length&&o-- >0;){var u=i.shift(),l=u.isKeyframe,h=u.options;if(!this.isFirstVideo&&h&&h.meta){n=this.remuxInitSegment("video",h.meta),h.meta=null,i.unshift(u),h.isContinue||this.resetDtsBase();break}var c=u.dts-this._dtsBase;-1===r&&(r=c);var d=void 0,f=void 0;void 0!==u.pts&&(d=(f=u.pts-this._dtsBase)-c),void 0!==u.cts&&(f=u.cts+c,d=u.cts);var p={buffer:[],size:0},E=0;E=u.duration?u.duration:i.length>=1?i[0].dts-this._dtsBase-c:s.length>=1?s[s.length-1].duration:this.videoMeta.refSampleDuration,this.videoAllDuration+=E,E>=0&&(a.samples.push(p),p.buffer.push(u.data),p.size+=u.data.byteLength,s.push({dts:c,cts:d,pts:f,data:u.data,size:u.data.byteLength,isKeyframe:l,duration:E,flags:{isLeading:0,dependsOn:l?2:1,isDependedOn:l?1:0,hasRedundancy:0,isNonSync:l?0:1},originDts:c,type:"video"})),l&&this.emit(REMUX_EVENTS$3.RANDOM_ACCESS_POINT,f)}var v=new Buffer$1;if(s.length){var y=Fmp4.moof({id:t.meta.id,time:r,samples:s}),_=Fmp4.mdat(a);v.write(y,_),this.writeToSource("video",v)}if(n&&(this.writeToSource("video",n),i.length))return t.samples=i,this._remuxVideo(t);this.isFirstVideo=!1,this.emit(REMUX_EVENTS$3.MEDIA_SEGMENT,"video"),t.samples=[],t.length=0}}},{key:"_remuxAudio",value:function(e){var t=(e||{}).samples,i=-1,r=[],n=null,s={samples:[]};if(t&&t.length){for(var a=1e4,o=!1;t.length&&a-- >0;){var u=t.shift(),l=u.data,h=u.options;if(!this.isFirstAudio&&h&&h.meta){n=this.remuxInitSegment("audio",h.meta),h.meta=null,t.unshift(u),h.isContinue||this.resetDtsBase();break}var c=u.dts-this._dtsBase,d=c;o||(i=c,o=!0);var f=0;f=u.duration?u.duration:this.audioMeta.refSampleDurationFixed?this.audioMeta.refSampleDurationFixed:t.length>=1?t[0].dts-this._dtsBase-c:r.length>=1?r[r.length-1].duration:this.audioMeta.refSampleDuration,this.audioAllDuration+=f;var p={dts:c,pts:c,cts:0,size:l.byteLength,duration:u.duration?u.duration:f,flags:{isLeading:0,dependsOn:2,isDependedOn:1,hasRedundancy:0,isNonSync:0},isKeyframe:!0,originDts:d,type:"audio"},E={buffer:[],size:0};f>=0&&(E.buffer.push(l),E.size+=l.byteLength,s.samples.push(E),r.push(p))}var v=new Buffer$1;if(r.length){var y=Fmp4.moof({id:e.meta.id,time:i,samples:r}),_=Fmp4.mdat(s);v.write(y,_),this.writeToSource("audio",v)}if(n&&(this.writeToSource("audio",n),t.length))return e.samples=t,this._remuxAudio(e);this.isFirstAudio=!1,this.emit(REMUX_EVENTS$3.MEDIA_SEGMENT,"audio",v),e.samples=[],e.length=0}}},{key:"writeToSource",value:function(e,t){var i=this._context.getInstance("PRE_SOURCE_BUFFER"),r=i.getSource(e);r||(r=i.createSource(e)),r.data.push(t)}},{key:"initSilentAudio",value:function(t,i){var r=e.getSilentFrame(this._audioMeta.channelCount);return{dts:t,pts:t,cts:0,duration:i,unit:r,size:r.byteLength,originDts:t,type:"video"}}},{key:"destroy",value:function(){this._player=null}},{key:"videoMeta",get:function(){return this._context.getInstance("TRACKS").videoTrack.meta}},{key:"audioMeta",get:function(){return this._context.getInstance("TRACKS").audioTrack.meta}}],[{key:"getSilentFrame",value:function(e){return 1===e?new Uint8Array([0,200,0,128,35,128]):2===e?new Uint8Array([33,0,73,144,2,25,0,35,128]):3===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]):4===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]):5===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]):6===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]):null}}]),e}(),CRYTO_EVENTS$3=EVENTS.CRYTO_EVENTS,Crypto$1=function(){function e(t){babelHelpers.classCallCheck(this,e),this.inputBuffer=t.inputbuffer,this.outputBuffer=t.outputbuffer,this.key=t.key,this.iv=t.iv,this.method=t.method,this.crypto=window.crypto||window.msCrypto}return babelHelpers.createClass(e,[{key:"init",value:function(){this.on(CRYTO_EVENTS$3.START_DECRYPT,this.decript.bind(this))}},{key:"decript",value:function(){var e=this;this.aeskey?this.decriptData():this.crypto.subtle.importKey("raw",this.key.buffer,{name:"AES-CBC"},!1,["encrypt","decrypt"]).then(function(t){e.aeskey=t,e.decriptData()})}},{key:"decriptData",value:function(){var e=this,t=this._context.getInstance(this.inputBuffer),i=this._context.getInstance(this.outputBuffer),r=t.shift();r&&this.crypto.subtle.decrypt({name:"AES-CBC",iv:this.iv.buffer},this.aeskey,r).then(function(t){i.push(new Uint8Array(t)),e.emit(CRYTO_EVENTS$3.DECRYPTED),e.decriptData(r)})}}]),e}(),M3U8Parser=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,null,[{key:"parse",value:function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r={duration:0};if(t&&t.split){var n=t.split(/\r|\n/),s=(n=n.filter(function(e){return e})).shift();if(!s.match("#EXTM3U"))throw new Error('Invalid m3u8 file: not "#EXTM3U"');s=n.shift();for(var a=!1;s;){var o=s.match(/#(.[A-Z|-]*):(.*)/),u=s.match(/#(.[A-Z|-]*)/);if(u&&o&&o.length>2)switch(o[1]){case"EXT-X-VERSION":r.version=parseInt(o[2]);break;case"EXT-X-MEDIA-SEQUENCE":r.sequence=parseInt(o[2]);break;case"EXT-X-TARGETDURATION":r.targetduration=parseFloat(o[2]);break;case"EXTINF":e.parseFrag(o,n,r,i,a),a=!1;break;case"EXT-X-KEY":e.parseDecrypt(o[2],r)}if(u&&u.length>1)switch(u[1]){case"EXT-X-DISCONTINUITY":a=!0}s=n.shift()}return r}}},{key:"parseFrag",value:function(e,t,i,r,n){i.frags||(i.frags=[]);var s={start:i.duration,duration:1e3*parseFloat(e[2])};i.duration+=s.duration;var a=t.shift();(a.match(/#(.*):(.*)/)||a.match(/^#/))&&(a=t.shift()),a.length>0&&"/"===a.charAt(0)&&r.match(/.*\/\/.*\.\w+/g)&&(r=r.match(/.*\/\/.*\.\w+/g)[0]),a.match(/.*:\/\/.*/)?s.url=a:s.url=r+a,s.discontinue=n,i.frags.push(s)}},{key:"parseURL",value:function(e){var t="",i=e.match(/(.*\/).*\.m3u8/);if(i&&i.length>0)for(var r=0;r<i.length;r++)i[r].match(/.*\/$/g)&&i[r].length>t.length&&(t=i[r]);return t}},{key:"parseDecrypt",value:function(e,t){t.encrypt={};var i=e.split(",");for(var r in i){var n=i[r];if(n.match(/METHOD=(.*)/)&&(t.encrypt.method=n.match(/METHOD=(.*)/)[1]),n.match(/URI="(.*)"/)&&(t.encrypt.uri=n.match(/URI="(.*)"/)[1]),n.match(/IV=0x(.*)/)){var s=n.match(/IV=0x(.*)/)[1],a=Math.ceil(s.length/2);t.encrypt.ivb=new Uint8Array(a);for(var o=a-1;o>=0;o--){var u=parseInt(s.substr(2*o,2),16);t.encrypt.ivb[o]=u}t.encrypt.iv=s}}}}]),e}(),Stream$1=function(){function e(t){if(babelHelpers.classCallCheck(this,e),!(t instanceof ArrayBuffer))throw new Error("data is invalid");this.buffer=t,this.dataview=new DataView(t),this.dataview.position=0}return babelHelpers.createClass(e,[{key:"back",value:function(e){this.position-=e}},{key:"skip",value:function(t){for(var i=Math.floor(t/4),r=t%4,n=0;n<i;n++)e.readByte(this.dataview,4);r>0&&e.readByte(this.dataview,r)}},{key:"readUint8",value:function(){return e.readByte(this.dataview,1)}},{key:"readUint16",value:function(){return e.readByte(this.dataview,2)}},{key:"readUint24",value:function(){return e.readByte(this.dataview,3)}},{key:"readUint32",value:function(){return e.readByte(this.dataview,4)}},{key:"readUint64",value:function(){return e.readByte(this.dataview,8)}},{key:"readInt8",value:function(){return e.readByte(this.dataview,1,!0)}},{key:"readInt16",value:function(){return e.readByte(this.dataview,2,!0)}},{key:"readInt32",value:function(){return e.readByte(this.dataview,4,!0)}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}},{key:"length",get:function(){return this.buffer.byteLength}},{key:"position",set:function(e){this.dataview.position=e},get:function(){return this.dataview.position}}],[{key:"readByte",value:function(e,t,i){var r=void 0;switch(t){case 1:r=i?e.getInt8(e.position):e.getUint8(e.position);break;case 2:r=i?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(i)throw new Error("not supported for readByte 3");r=e.getUint8(e.position)<<16,r|=e.getUint8(e.position+1)<<8,r|=e.getUint8(e.position+2);break;case 4:r=i?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(i)throw new Error("not supported for readBody 8");r=e.getUint32(e.position)<<32,r|=e.getUint32(e.position+4);break;default:r=""}return e.position+=t,r}}]),e}(),Golomb=function(){function e(t){babelHelpers.classCallCheck(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}return babelHelpers.createClass(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),i=new Uint8Array(4);i.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(i.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),i=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),t=e-t,t>0&&this._currentWordBitsLeft?i<<t|this.readBits(t):i}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e=void 0;for(e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}}]),e}(),SPSParser=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,i=t.byteLength,r=new Uint8Array(i),n=0,s=0;s<i;s++)s>=2&&3===t[s]&&0===t[s-1]&&0===t[s-2]||(r[n]=t[s],n++);return new Uint8Array(r.buffer,0,n)}},{key:"parseSPS",value:function(t){var i=e._ebsp2rbsp(t),r=new Golomb(i);r.readByte();var n=r.readByte();r.readByte();var s=r.readByte();r.readUEG();var a=e.getProfileString(n),o=e.getLevelString(s),u=1,l=420,h=[0,420,422,444],c=8;if((100===n||110===n||122===n||244===n||44===n||83===n||86===n||118===n||128===n||138===n||144===n)&&(3===(u=r.readUEG())&&r.readBits(1),u<=3&&(l=h[u]),c=r.readUEG()+8,r.readUEG(),r.readBits(1),r.readBool()))for(var d=3!==u?8:12,f=0;f<d;f++)r.readBool()&&(f<6?e._skipScalingList(r,16):e._skipScalingList(r,64));r.readUEG();var p=r.readUEG();if(0===p)r.readUEG();else if(1===p){r.readBits(1),r.readSEG(),r.readSEG();for(var E=r.readUEG(),v=0;v<E;v++)r.readSEG()}r.readUEG(),r.readBits(1);var y=r.readUEG(),_=r.readUEG(),m=r.readBits(1);0===m&&r.readBits(1),r.readBits(1);var g=0,T=0,b=0,S=0;r.readBool()&&(g=r.readUEG(),T=r.readUEG(),b=r.readUEG(),S=r.readUEG());var A=1,k=1,R=0,D=!0,C=0,L=0;if(r.readBool()){if(r.readBool()){var w=r.readByte(),U=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],O=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];w>0&&w<16?(A=U[w-1],k=O[w-1]):255===w&&(A=r.readByte()<<8|r.readByte(),k=r.readByte()<<8|r.readByte())}if(r.readBool()&&r.readBool(),r.readBool()&&(r.readBits(4),r.readBool()&&r.readBits(24)),r.readBool()&&(r.readUEG(),r.readUEG()),r.readBool()){var M=r.readBits(32),N=r.readBits(32);D=r.readBool(),R=(C=N)/(L=2*M)}}var B=1;1===A&&1===k||(B=A/k);var x=0,I=0;0===u?(x=1,I=2-m):(x=3===u?1:2,I=(1===u?2:1)*(2-m));var V=16*(y+1),P=16*(_+1)*(2-m);V-=(g+T)*x,P-=(b+S)*I;var H=Math.ceil(V*B);return r.destroy(),r=null,{profile_string:a,level_string:o,bit_depth:c,chroma_format:l,chroma_format_string:e.getChromaFormatString(l),frame_rate:{fixed:D,fps:R,fps_den:L,fps_num:C},par_ratio:{width:A,height:k},codec_size:{width:V,height:P},present_size:{width:H,height:P}}}},{key:"_skipScalingList",value:function(e,t){for(var i=8,r=8,n=0;n<t;n++)0!==r&&(r=(i+e.readSEG()+256)%256),i=0===r?i:r}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};e&&e.codec_size&&(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t.parRatio={width:e.par_ratio.width,height:e.par_ratio.height},t.frameRate=e.frame_rate;var i=t.frameRate.fps_den,r=t.frameRate.fps_num;return t.refSampleDuration=Math.floor(t.timescale*(i/r)),t}}]),e}(),Nalunit=function(){function e(){babelHelpers.classCallCheck(this,e)}return babelHelpers.createClass(e,null,[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var i=t.dataview,r=t.position;return 1===i.getInt32(r)||0===i.getInt16(r)&&1===i.getInt8(r+2)?e.getAnnexbNals(t):e.getAvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var i=[],r=e.getHeaderPositionAnnexB(t),n=r.pos,s=n;n<t.length-4;){var a=t.buffer.slice(n,n+r.headerLength);r.pos===t.position&&t.skip(r.headerLength),s=(r=e.getHeaderPositionAnnexB(t)).pos;var o={header:a,body:new Uint8Array(t.buffer.slice(n+a.byteLength,s))};e.analyseNal(o),o.type<=9&&0!==o.type&&i.push(o),t.skip(s-t.position),n=s}return i}},{key:"getAvccNals",value:function(t){for(var i=[];t.position<t.length-4;){var r=t.dataview.getInt32();if(!(t.length-t.position>=r))break;var n=t.buffer.slice(t.position,t.position+4);t.skip(4);var s=t.buffer.slice(t.position,t.position+r);t.skip(r);var a={header:n,body:s};e.analyseNal(a),a.type<=9&&0!==a.type&&i.push(a)}return i}},{key:"analyseNal",value:function(e){var t=31&e.body[0];switch(e.type=t,t){case 1:e.ndr=!0;break;case 5:e.idr=!0;break;case 6:break;case 7:e.sps=SPSParser.parseSPS(e.body);break;case 8:e.pps=!0}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,i=0;3!==i&&4!==i&&t<e.length-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?i=4:1===e.dataview.getInt8(t+2)?i=3:t++:t++;return t===e.length-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)&&(i=4):(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?i=3:t=e.length)),{pos:t,headerLength:i}}},{key:"getAvcc",value:function(e,t){var i=new Uint8Array(e.byteLength+t.byteLength+11);i[0]=1,i[1]=e[1],i[2]=e[2],i[3]=e[3],i[4]=255,i[5]=225;var r=6;return i.set(new Uint8Array([e.byteLength>>>8&255,255&e.byteLength]),r),r+=2,i.set(e,r),r+=e.byteLength,i[r]=1,r++,i.set(new Uint8Array([t.byteLength>>>8&255,255&t.byteLength]),r),r+=2,i.set(t,r),i}}]),e}(),NalUnit=Nalunit,AudioTrackMeta$1=function(){function e(t){babelHelpers.classCallCheck(this,e);var i={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2",config:[41,401,136,0],duration:0,id:2,refSampleDuration:21,sampleRateIndex:3,timescale:1e3,type:"audio"};return t?Object.assign({},i,t):i}return babelHelpers.createClass(e,[{key:"destroy",value:function(){this.init=null}}]),e}(),VideoTrackMeta$1=function(){function e(t){babelHelpers.classCallCheck(this,e);var i={avcc:null,sps:new Uint8Array(0),pps:new Uint8Array(0),chromaFormat:420,codec:"avc1.640020",codecHeight:720,codecWidth:1280,duration:0,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},id:1,level:"3.2",presentHeight:720,presentWidth:1280,profile:"High",refSampleDuration:40,parRatio:{height:1,width:1},timescale:1e3,type:"video"};return t?Object.assign({},i,t):i}return babelHelpers.createClass(e,[{key:"destroy",value:function(){this.init=null,this.sps=null,this.pps=null}}]),e}(),AudioTrackSample$1=function(){function e(t){babelHelpers.classCallCheck(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return babelHelpers.createClass(e,null,[{key:"getDefault",value:function(){return{dts:null,pts:null,data:new Uint8Array}}}]),e}(),VideoTrackSample$1=function(){function e(t){babelHelpers.classCallCheck(this,e);var i=e.getDefault();return t?Object.assign({},i,t):i}return babelHelpers.createClass(e,null,[{key:"getDefault",value:function(){return{dts:null,pts:null,isKeyframe:!1,originDts:null,data:new Uint8Array}}}]),e}(),DEMUX_EVENTS$2=EVENTS.DEMUX_EVENTS,StreamType={1:["video","MPEG-1"],2:["video","MPEG-2"],27:["video","AVC.H264"],234:["video","VC-1"],3:["audio","MPEG-1"],4:["audio","MPEG-2"],15:["audio","MPEG-2.AAC"],17:["audio","MPEG-4.AAC"],128:["audio","LPCM"],129:["audio","AC3"],6:["audio","AC3"],130:["audio","DTS"],131:["audio","Dolby TrueHD"],132:["audio","AC3-Plus"],133:["audio","DTS-HD"],134:["audio","DTS-MA"],161:["audio","AC3-Plus-SEC"],162:["audio","DTS-HD-SEC"]},TsDemuxer=function(){function e(t){babelHelpers.classCallCheck(this,e),this.configs=Object.assign({},t),this.demuxing=!1,this.pat=[],this.pmt=[],this._hasVideoMeta=!1,this._hasAudioMeta=!1}return babelHelpers.createClass(e,[{key:"init",value:function(){this.on(DEMUX_EVENTS$2.DEMUX_START,this.demux.bind(this))}},{key:"demux",value:function(t){if(!this.demuxing){for(var i=this.inputBuffer,r={pat:[],pmt:[]},n={};i.length>=188;){for(i.length>=1&&71!==i.array[0][i.offset]&&this.emit(DEMUX_EVENTS$2.DEMUX_ERROR,this.TAG,new Error("Untrust sync code: "+i.array[0][i.offset]+", try to recover;"),!1);i.length>=1&&71!==i.array[0][i.offset];)i.shift(1);if(!(i.length<188)){var s=i.shift(188),a=new Stream$1(s.buffer),o={};e.read(a,o,r),o.pes?(n[o.header.pid]||(n[o.header.pid]=[]),n[o.header.pid].push(o.pes),o.pes.ES.buffer=[o.pes.ES.buffer]):n[o.header.pid]&&n[o.header.pid][n[o.header.pid].length-1].ES.buffer.push(o.payload.stream)}}for(var u=t,l=t,h=0;h<Object.keys(n).length;h++)for(var c=n[Object.keys(n)[h]],d=0;d<c.length;d++)c[d].id=Object.keys(n)[h],c[d].ES.buffer=e.Merge(c[d].ES.buffer),"audio"===c[d].type?(this.pushAudioSample(c[d],u),u={}):"video"===c[d].type&&(this.pushVideoSample(c[d],l),l={});this._hasAudioMeta&&this.emit(DEMUX_EVENTS$2.DEMUX_COMPLETE,"audio"),this._hasVideoMeta&&this.emit(DEMUX_EVENTS$2.DEMUX_COMPLETE,"video")}}},{key:"pushAudioSample",value:function(t,i){var r=void 0;this._tracks.audioTrack?r=this._tracks.audioTrack:(this._tracks.audioTrack=new AudioTrack,r=this._tracks.audioTrack);var n=new AudioTrackMeta$1({audioSampleRate:t.ES.frequence,sampleRate:t.ES.frequence,channelCount:t.ES.channel,codec:"mp4a.40."+t.ES.audioObjectType,config:t.ES.audioConfig,id:2,sampleRateIndex:t.ES.frequencyIndex});n.refSampleDuration=Math.floor(1024/n.audioSampleRate*n.timescale);var s=e.compaireMeta(r.meta,n,!0);this._hasAudioMeta&&s||(r.meta=n,this._hasAudioMeta=!0,this.emit(DEMUX_EVENTS$2.METADATA_PARSED,"audio"));var a=new Uint8Array(t.ES.buffer.buffer.slice(t.ES.buffer.position,t.ES.buffer.length)),o=parseInt(t.pts/90),u=parseInt(t.pts/90),l=new AudioTrackSample$1({dts:o,pts:u,data:a,options:i});r.samples.push(l)}},{key:"pushVideoSample",value:function(t,i){var r=NalUnit.getNalunits(t.ES.buffer),n=void 0,s=new VideoTrackMeta$1;this._tracks.videoTrack?n=this._tracks.videoTrack:(this._tracks.videoTrack=new VideoTrack,n=this._tracks.videoTrack);for(var a=0,o=!1,u=!1,l=0;l<r.length;l++){var h=r[l];if(h.sps){o=h,n.sps=h.body,s.chromaFormat=o.sps.chroma_format,s.codec="avc1.";for(var c=1;c<4;c++){var d=o.body[c].toString(16);d.length<2&&(d="0"+d),s.codec+=d}s.codecHeight=o.sps.codec_size.height,s.codecWidth=o.sps.codec_size.width,s.frameRate=o.sps.frame_rate,s.id=1,s.level=o.sps.level_string,s.presentHeight=o.sps.present_size.height,s.presentWidth=o.sps.present_size.width,s.profile=o.sps.profile_string,s.refSampleDuration=Math.floor(s.timescale*(o.sps.frame_rate.fps_den/o.sps.frame_rate.fps_num)),s.sarRatio=o.sps.sar_ratio?o.sps.sar_ratio:o.sps.par_ratio}else h.pps?(n.pps=h.body,u=h):h.type<9&&(a+=4+h.body.byteLength)}if(o&&u){s.avcc=NalUnit.getAvcc(o.body,u.body);var f=e.compaireMeta(n.meta,s,!0);this._hasVideoMeta&&f||(i?i.meta=Object.assign({},s):i={meta:Object.assign({},s)},n.meta=s,this._hasVideoMeta=!0,this.emit(DEMUX_EVENTS$2.METADATA_PARSED,"video"))}for(var p=new Uint8Array(a),E=0,v=!1,y=0;y<r.length;y++){var _=r[y];if(!(_.type&&_.type>=9)){var m=_.body.byteLength;_.idr&&(v=!0),_.pps||_.sps||(p.set(new Uint8Array([m>>>24&255,m>>>16&255,m>>>8&255,255&m]),E),E+=4,p.set(_.body,E),E+=m)}}var g=new VideoTrackSample$1({dts:parseInt(t.dts/90),pts:parseInt(t.pts/90),cts:(t.pts-t.dts)/90,originDts:t.dts,isKeyframe:v,data:p,options:i});n.samples.push(g)}},{key:"destory",value:function(){this.off(DEMUX_EVENTS$2.DEMUX_START,this.demux),this.configs={},this.demuxing=!1,this.pat=[],this.pmt=[],this._hasVideoMeta=!1,this._hasAudioMeta=!1}},{key:"inputBuffer",get:function(){return this._context.getInstance(this.configs.inputbuffer)}},{key:"_tracks",get:function(){return this._context.getInstance("TRACKS")}}],[{key:"compaireArray",value:function(e,t,i){var r=0,n=0;if("Uint8Array"===i?(r=e.byteLength,n=t.byteLength):"Array"===i&&(r=e.length,n=t.length),r!==n)return!1;for(var s=0;s<r;s++)if(e[s]!==t[s])return!1;return!0}},{key:"compaireMeta",value:function(t,i,r){if(!t||!i)return!1;for(var n=0,s=Object.keys(t).length;n<s;n++){var a=t[Object.keys(t)[n]],o=i[Object.keys(t)[n]];if("object"!==(void 0===a?"undefined":babelHelpers.typeof(a))){if(r&&"duration"!==Object.keys(t)[n]&&"refSampleDuration"!==Object.keys(t)[n]&&"refSampleDurationFixed"!==Object.keys(t)[n]&&a!==o)return!1}else if(void 0!==a.byteLength){if(void 0===o.byteLength)return!1;if(!e.compaireArray(a,o,"Uint8Array"))return!1}else if(void 0!==a.length){if(void 0===o.length)return!1;if(!e.compaireArray(a,o,"Array"))return!1}else if(!e.compaireMeta(a,o))return!1}return!0}},{key:"Merge",value:function(e){for(var t=void 0,i=0,r=0,n=0;n<e.length;n++)i+=e[n].length-e[n].position;t=new Uint8Array(i);for(var s=0;s<e.length;s++){var a=e[s];t.set(new Uint8Array(a.buffer,a.position),r),r+=a.length-a.position}return new Stream$1(t.buffer)}},{key:"read",value:function(t,i,r){e.readHeader(t,i),e.readPayload(t,i,r),"MEDIA"!==i.header.packet||1!==i.header.payload||i.unknownPIDs||(i.pes=e.PES(i))}},{key:"readPayload",value:function(t,i,r){var n=i.header.pid;switch(n){case 0:e.PAT(t,i,r);break;case 1:e.CAT(t,i,r);break;case 2:e.TSDT(t,i,r);break;case 8191:break;default:if(r.pat.some(function(e){return e.pid===n}))e.PMT(t,i,r);else{var s=r.pmt?r.pmt.filter(function(e){return e.pid===n}):[];s.length>0?e.Media(t,i,StreamType[s[0].streamType][0]):i.unknownPIDs=!0}}}},{key:"readHeader",value:function(e,t){var i={};i.sync=e.readUint8();var r=e.readUint16();i.error=r>>>15,i.payload=r>>>14&1,i.priority=r>>>13&1,i.pid=8191&r,r=e.readUint8(),i.scrambling=r>>6&3,i.adaptation=r>>4&3,i.continuity=15&r,i.packet=0===i.pid?"PAT":"MEDIA",t.header=i}},{key:"PAT",value:function(e,t,i){var r={},n=e.readUint8();e.skip(n),n=e.readUint8(),r.tabelID=n,n=e.readUint16(),r.error=n>>>7,r.zero=n>>>6&1,r.sectionLength=4095&n,r.streamID=e.readUint16(),r.current=1&e.readUint8(),r.sectionNumber=e.readUint8(),r.lastSectionNumber=e.readUint8();for(var s=(r.sectionLength-9)/4,a=[],o=0;o<s;o++){var u=e.readUint16(),l=8191&e.readUint16();a.push({program:u,pid:l,type:0===u?"network":"mapPID"})}a.length>0&&(i.pat=i.pat.concat(a)),r.list=a,r.program=e.readUint16(),r.pid=8191&e.readUint16(),t.payload=r}},{key:"PMT",value:function(e,t,i){var r={};t.header.packet="PMT";var n=e.readUint8();e.skip(n),n=e.readUint8(),r.tableID=n,n=e.readUint16(),r.sectionLength=4095&n,r.program=e.readUint16(),r.current=1&e.readUint8(),r.order=e.readUint8(),r.lastOrder=e.readUint8(),r.PCR_PID=8191&e.readUint16(),r.programLength=4095&e.readUint16();for(var s=(r.sectionLength-13)/5,a=[],o=0;o<s;o++)a.push({streamType:e.readUint8(),pid:8191&e.readUint16(),es:4095&e.readUint16()});r.list=a,this.pmt||(this.pmt=[]),i.pmt=this.pmt.concat(a.map(function(e){return{pid:e.pid,es:e.es,streamType:e.streamType,program:r.program}})),t.payload=r}},{key:"Media",value:function(e,t,i){var r=t.header,n={};if(r.type=i,3===r.adaptation&&(n.adaptationLength=e.readUint8(),n.adaptationLength>0)){var s=e.readUint8();n.discontinue=s>>>7,n.access=s>>>6&1,n.priority=s>>>5&1,n.PCR=s>>>4&1,n.OPCR=s>>>3&1,n.splicePoint=s>>>2&1,n.transportPrivate=s>>>1&1,n.adaptationField=1&s;var a=e.position;if(1===n.PCR&&(n.programClockBase=e.readUint32()<<1,s=e.readUint16(),n.programClockBase|=s>>>15,n.programClockExtension=511&s),1===n.OPCR&&(n.originProgramClockBase=e.readUint32()<<1,s=e.readUint16(),n.originProgramClockBase+=s>>>15,n.originProgramClockExtension=511&s),1===n.splicePoint&&(n.spliceCountdown=e.readUint8()),1===n.transportPrivate)for(var o=e.readUint8(),u=[],l=0;l<o;l++)u.push(e.readUint8());if(1===n.adaptationField){var h=e.readUint8(),c=e.readUint8(),d=e.position,f=c>>>6&1,p=c>>>5&1;1===c>>>7&&(c=e.readUint16(),n.ltwValid=c>>>15,n.ltwOffset=61439&c),1===f&&(c=e.readUint24(),n.piecewiseRate=4194303&c),1===p&&(c=e.readInt8(),n.spliceType=c>>>4,n.dtsNextAU1=c>>>1&7,n.marker1=1&c,c=e.readUint16(),n.dtsNextAU2=c>>>1,n.marker2=1&c,c=e.readUint16(),n.dtsNextAU3=c),e.skip(h-1-(e.position-d))}var E=n.adaptationLength-1-(e.position-a);e.skip(E)}n.stream=new Stream$1(e.buffer.slice(e.position)),t.payload=n}},{key:"PES",value:function(t){var i={},r=t.payload.stream;if(1!==r.readUint24())i.ES={},i.ES.buffer=r;else{var n=r.readUint8();n>=224&&n<=239&&(i.type="video"),n>=192&&n<=223&&(i.type="audio");var s=r.readUint16();if(i.packetLength=s,"video"!==i.type&&"audio"!==i.type)throw new Error("format is not supported");var a=r.readUint8();if(2!==a>>>6)throw new Error("error when parse pes header");a=r.readUint8(),i.ptsDTSFlag=a>>>6,i.escrFlag=a>>>5&1,i.esRateFlag=a>>>4&1,i.dsmFlag=a>>>3&1,i.additionalFlag=a>>>2&1,i.crcFlag=a>>>1&1,i.extensionFlag=1&a,i.pesHeaderLength=r.readUint8();var o=i.pesHeaderLength;if(2===i.ptsDTSFlag){var u=[];a=r.readUint8(),u.push(a>>>1&7),a=r.readUint16(),u.push(a>>>1),a=r.readUint16(),u.push(a>>>1),i.pts=u[0]<<30|u[1]<<15|u[2],o-=5,"video"===i.type&&(i.dts=i.pts)}if(3===i.ptsDTSFlag){var l=[];a=r.readUint8(),l.push(a>>>1&7),a=r.readUint16(),l.push(a>>>1),a=r.readUint16(),l.push(a>>>1),i.pts=l[0]<<30|l[1]<<15|l[2];var h=[];a=r.readUint8(),h.push(a>>>1&7),a=r.readUint16(),h.push(a>>>1),a=r.readUint16(),h.push(a>>>1),i.dts=h[0]<<30|h[1]<<15|h[2],o-=10}if(1===i.escrFlag){var c=[],d=[];a=r.readUint8(),c.push(a>>>3&7),c.push(3&a),a=r.readUint16(),c.push(a>>>13),c.push(3&a),a=r.readUint16(),c.push(a>>>13),d.push(3&a),a=r.readUint8(),d.push(a>>>1),i.escr=300*(c[0]<<30|c[1]<<28|c[2]<<15|c[3]<<13|c[4])+(d[0]<<7|d[1]),o-=6}if(1===i.esRateFlag&&(a=r.readUint24(),i.esRate=a>>>1&4194303,o-=3),1===i.dsmFlag)throw new Error("not support DSM_trick_mode");if(1===i.additionalFlag&&(a=r.readUint8(),i.additionalCopyInfo=127&a,o-=1),1===i.crcFlag&&(i.pesCRC=r.readUint16(),o-=2),1===i.extensionFlag)throw new Error("not support extension");o>0&&r.skip(o),i.ES=e.ES(r,i.type)}return i}},{key:"ES",value:function(t,i){var r=void 0,n={};if("video"===i){if(1!==(r=t.readUint32())&&(t.back(4),1!==(r=t.readUint24())))throw new Error("h264 nal header parse failed");t.skip(2),n.buffer=t}else{if("audio"!==i)throw new Error("ES "+i+" is not supported");if((r=t.readUint16())>>>4!=4095)throw new Error("aac ES parse Error");var s=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];n.id=0==(r>>>3&1)?"MPEG-4":"MPEG-2",n.layer=r>>>1&3,n.absent=1&r,r=t.readUint16(),n.audioObjectType=1+(r>>>14&3),n.profile=n.audioObjectType-1,n.frequencyIndex=r>>>10&15,n.frequence=s[n.frequencyIndex],n.channel=r>>>6&7,n.frameLength=(3&r)<<11|t.readUint16()>>>5,e.getAudioConfig(n),t.skip(1),n.buffer=t}return n}},{key:"TSDT",value:function(e,t,i){t.payload={}}},{key:"CAT",value:function(e,t,i){var r={};r.tableID=e.readUint8();var n=e.readUint16();r.sectionIndicator=n>>>7,r.sectionLength=4095&n,e.skip(2),n=e.readUint8(),r.version=n>>>3,r.currentNextIndicator=1&n,r.sectionNumber=e.readUint8(),r.lastSectionNumber=e.readUint8();this.sectionLength;r.crc32=e.readUint32(),t.payload=r}},{key:"getAudioConfig",value:function(e){var t=navigator.userAgent.toLowerCase(),i=void 0,r=void 0;/firefox/i.test(t)?e.frequencyIndex>=6?(e.audioObjectType=5,i=new Array(4),r=e.frequencyIndex-3):(e.audioObjectType=2,i=new Array(2),r=e.frequencyIndex):-1!==t.indexOf("android")?(e.audioObjectType=2,i=new Array(2),r=e.frequencyIndex):(e.audioObjectType=5,i=new Array(4),e.frequencyIndex>=6?r=e.frequencyIndex-3:(1===e.channel&&(e.audioObjectType=2,i=new Array(2)),r=e.frequencyIndex)),i[0]=e.audioObjectType<<3,i[0]|=(14&e.frequencyIndex)>>1,i[1]=(1&e.frequencyIndex)<<7,i[1]|=e.channel<<3,5===e.audioObjectType&&(i[1]|=(14&r)>>1,i[2]=(1&r)<<7,i[2]|=8,i[3]=0),e.audioConfig=i}}]),e}(),Playlist=function(){function e(t){babelHelpers.classCallCheck(this,e),this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0,this.fragLength=0,this._lastget=void 0,this._audoclear=t.autoclear||!1}return babelHelpers.createClass(e,[{key:"push",value:function(e,t,i){this._ts[e]||(this._ts[e]={duration:t,downloaded:!1,downloading:!1,start:this.duration,discontinue:!!i},this._list[this.duration]=e,this.duration+=t,this.fragLength+=1)}},{key:"deleteFrag",value:function(e){this._ts[e]&&(this._ts[e].start>this._lastget.time&&(this._lastget={duration:this._ts[e].duration,time:this._ts[e].start,downloaded:!1,downloading:!1,url:e}),delete this._list[this._ts[e].start],delete this._ts[e],this.fragLength-=1)}},{key:"pushM3U8",value:function(e,t){if(!e)throw new Error("No m3u8 data received.");if(this.version=e.version,this.targetduration=e.targetduration,e.encrypt&&!this.encrypt&&(this.encrypt=e.encrypt),!(e.sequence>this.sequence))throw new Error("Old m3u8 file received, "+e.sequence);this.sequence=e.sequence;for(var i=[],r=0;r<e.frags.length;r++){var n=e.frags[r];this._ts[n.url]||(i.push(n.url),this.push(n.url,n.duration,n.discontinue))}if(i.length<1)throw new Error("Can not read ts file list.");if(t)for(var s=this.getTsList(),a=0;a<s.length;a++)i.indexOf(s[a])<0&&this.deleteFrag(s[a])}},{key:"getTsList",value:function(){return Object.keys(this._ts)}},{key:"downloaded",value:function(e,t){var i=this._ts[e];i&&(i.downloaded=t)}},{key:"downloading",value:function(e,t){var i=this._ts[e];i&&(i.downloading=t)}},{key:"getTsByName",value:function(e){return this._ts[e]}},{key:"getTs",value:function(e){var t=Object.keys(this._list),i=void 0;if(void 0===e&&(e=this._lastget?this._lastget.time+this._lastget.duration:0),!(t.length<1||e>=this.duration)){t.sort(function(e,t){return parseFloat(e)-parseFloat(t)});for(var r=0;r<t.length&&e>=parseInt(t[r]);r++){var n=this._list[t[r]];i={url:n,downloaded:this._ts[n].downloaded,downloading:this._ts[n].downloading,time:parseInt(t[r]),duration:parseInt(this._ts[n].duration)},this.autoclear&&(delete this._ts[this._lastget.url],delete this._list[this._lastget.time]),this._lastget=i}return i}}},{key:"clear",value:function(){this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0}},{key:"clearDownloaded",value:function(){for(var e=0,t=Object.keys(this._ts).length;e<t;e++){var i=this._ts[Object.keys(this._ts)[e]];i.downloaded=!1,i.downloading=!1}}},{key:"destroy",value:function(){this._baseURL="",this._list={},this._ts={},this.version=0,this.sequence=-1,this.targetduration=0,this.duration=0,this.fragLength=0,this._lastget=void 0,this._audoclear=!1}},{key:"list",get:function(){return this._list}},{key:"baseURL",set:function(e){this.baseURL!==e&&(this.clear(),this._baseURL=e)},get:function(){return this._baseURL}}]),e}(),LOADER_EVENTS$3=EVENTS.LOADER_EVENTS,REMUX_EVENTS$4=EVENTS.REMUX_EVENTS,DEMUX_EVENTS$3=EVENTS.DEMUX_EVENTS,HLS_EVENTS$2=EVENTS.HLS_EVENTS,CRYTO_EVENTS$4=EVENTS.CRYTO_EVENTS,HLS_ERROR="HLS_ERROR",HlsLiveController=function(){function e(t){classCallCheck(this,e),this.configs=Object.assign({},t),this.url="",this.baseurl="",this.sequence=0,this._playlist=null,this.retrytimes=this.configs.retrytimes||3,this.preloadTime=this.configs.preloadTime,this.container=this.configs.container,this._m3u8lasttime=0,this._timmer=setInterval(this._checkStatus.bind(this),50),this._lastCheck=0,this._player=this.configs.player,this.m3u8Text=null}return createClass(e,[{key:"init",value:function(){this._context.registry("M3U8_BUFFER",XgBuffer),this._context.registry("TS_BUFFER",XgBuffer),this._context.registry("TRACKS",Track),this._playlist=this._context.registry("PLAYLIST",Playlist)({autoclear:!0}),this._context.registry("PRE_SOURCE_BUFFER",PreSource),this._context.registry("COMPATIBILITY",Compatibility),this._m3u8loader=this._context.registry("M3U8_LOADER",FetchLoader)({buffer:"M3U8_BUFFER",readtype:1}),this._tsloader=this._context.registry("TS_LOADER",FetchLoader)({buffer:"TS_BUFFER",readtype:3}),this._context.registry("TS_DEMUXER",TsDemuxer)({inputbuffer:"TS_BUFFER"}),this._context.registry("MP4_REMUXER",Mp4Remuxer),this.mse=this._context.registry("MSE",MSE)({container:this.container}),this.initEvents()}},{key:"initEvents",value:function(){this.on(LOADER_EVENTS$3.LOADER_COMPLETE,this._onLoadComplete.bind(this)),this.on(REMUX_EVENTS$4.INIT_SEGMENT,this.mse.addSourceBuffers.bind(this.mse)),this.on(REMUX_EVENTS$4.MEDIA_SEGMENT,this.mse.doAppend.bind(this.mse)),this.on(DEMUX_EVENTS$3.METADATA_PARSED,this._onMetadataParsed.bind(this)),this.on(DEMUX_EVENTS$3.DEMUX_COMPLETE,this._onDemuxComplete.bind(this)),this.on(LOADER_EVENTS$3.LOADER_ERROR,this._onLoadError.bind(this)),this.on(DEMUX_EVENTS$3.DEMUX_ERROR,this._onDemuxError.bind(this)),this.on(REMUX_EVENTS$4.REMUX_ERROR,this._onRemuxError.bind(this))}},{key:"_onError",value:function(e,t,i,r){var n={errorType:e,errorDetails:"["+t+"]: "+i.message,errorFatal:r};this._player.emit(HLS_ERROR,n)}},{key:"_onDemuxComplete",value:function(){this.emit(REMUX_EVENTS$4.REMUX_MEDIA)}},{key:"_onMetadataParsed",value:function(e){this.emit(REMUX_EVENTS$4.REMUX_METADATA,e)}},{key:"_onLoadError",value:function(e,t){!this._tsloader.loading&&!this._m3u8loader.loading&&this.retrytimes>1?(this.retrytimes--,this._onError(LOADER_EVENTS$3.LOADER_ERROR,e,t,!1)):this.retrytimes<=1&&(this._onError(LOADER_EVENTS$3.LOADER_ERROR,e,t,!0),this.emit(HLS_EVENTS$2.RETRY_TIME_EXCEEDED),this.mse.endOfStream())}},{key:"_onDemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._onError(LOADER_EVENTS$3.LOADER_ERROR,e,t,i)}},{key:"_onRemuxError",value:function(e,t,i){void 0===i&&(i=!0),this._onError(REMUX_EVENTS$4.REMUX_ERROR,e,t,i)}},{key:"_onLoadComplete",value:function(e){if("M3U8_BUFFER"===e.TAG){var t=void 0;try{this.m3u8Text=e.shift(),t=M3U8Parser.parse(this.m3u8Text,this.baseurl)}catch(e){this._onError("M3U8_PARSER_ERROR","M3U8_PARSER",e,!1)}if(!t)return void(this.retrytimes>0?(this.retrytimes--,this._preload()):(this.emit(HLS_EVENTS$2.RETRY_TIME_EXCEEDED),this.mse.endOfStream()));try{this._playlist.pushM3U8(t,!0)}catch(e){this._onError("M3U8_PARSER_ERROR","PLAYLIST",e,!1)}this._playlist.encrypt&&this._playlist.encrypt.uri&&!this._playlist.encrypt.key?(this._context.registry("DECRYPT_BUFFER",XgBuffer)(),this._context.registry("KEY_BUFFER",XgBuffer)(),this._tsloader.buffer="DECRYPT_BUFFER",this._keyLoader=this._context.registry("KEY_LOADER",FetchLoader)({buffer:"KEY_BUFFER",readtype:3}),this.emitTo("KEY_LOADER",LOADER_EVENTS$3.LADER_START,this._playlist.encrypt.uri)):this._m3u8Loaded(t)}else"TS_BUFFER"===e.TAG?(this.retrytimes=this.configs.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0),this.emit(DEMUX_EVENTS$3.DEMUX_START)):"DECRYPT_BUFFER"===e.TAG?(this.retrytimes=this.configs.retrytimes||3,this._playlist.downloaded(this._tsloader.url,!0),this.emitTo("CRYPTO",CRYTO_EVENTS$4.START_DECRYPT)):"KEY_BUFFER"===e.TAG&&(this.retrytimes=this.configs.retrytimes||3,this._playlist.encrypt.key=e.shift(),this._crypto=this._context.registry("CRYPTO",Crypto$1)({key:this._playlist.encrypt.key,iv:this._playlist.encrypt.ivb,method:this._playlist.encrypt.method,inputbuffer:"DECRYPT_BUFFER",outputbuffer:"TS_BUFFER"}),this._crypto.on(CRYTO_EVENTS$4.DECRYPTED,this._onDcripted.bind(this)))}},{key:"_onDcripted",value:function(){this.emit(DEMUX_EVENTS$3.DEMUX_START)}},{key:"_m3u8Loaded",value:function(e){this.preloadTime||(this.preloadTime=this._playlist.targetduration?this._playlist.targetduration:5),this._playlist.fragLength>0&&this._playlist.sequence<e.sequence?this.retrytimes=this.configs.retrytimes||3:this.retrytimes>0?(this.retrytimes--,this._preload()):(this.emit(HLS_EVENTS$2.RETRY_TIME_EXCEEDED),this.mse.endOfStream())}},{key:"_checkStatus",value:function(){if(!(this.retrytimes<1&&(new Date).getTime()-this._lastCheck<1e4))if(this._lastCheck=(new Date).getTime(),this.container.buffered.length<1)this._preload();else{var e=this.container.currentTime,t=this.container.buffered.start(this.container.buffered.length-1);this.container.readyState<=2&&(e<t?(this.container.currentTime=t,e=t):this._preload());var i=this.container.buffered.end(this.container.buffered.length-1);e<i-2*this.preloadTime&&(this.container.currentTime=i-2*this.preloadTime),i>2*this.preloadTime&&this.mse.remove(i-2*this.preloadTime),e>i-this.preloadTime&&this._preload()}}},{key:"_preload",value:function(){if(!this._tsloader.loading&&!this._m3u8loader.loading){var e=this._playlist.getTs();if(!e||e.downloaded||e.downloading){var t=this.preloadTime?this.preloadTime:0,i=(new Date).getTime();(!e||e.downloaded)&&(i-this._m3u8lasttime)/1e3>t&&(this._m3u8lasttime=i,this.emitTo("M3U8_LOADER",LOADER_EVENTS$3.LADER_START,this.url))}else this._playlist.downloading(e.url,!0),this.emitTo("TS_LOADER",LOADER_EVENTS$3.LADER_START,e.url)}}},{key:"load",value:function(e){this.baseurl=M3U8Parser.parseURL(e),this.url=e,this._preload()}},{key:"destroy",value:function(){clearInterval(this._timmer),this.off(LOADER_EVENTS$3.LOADER_COMPLETE,this._onLoadComplete),this.off(REMUX_EVENTS$4.INIT_SEGMENT,this.mse.addSourceBuffers),this.off(REMUX_EVENTS$4.MEDIA_SEGMENT,this.mse.doAppend),this.off(DEMUX_EVENTS$3.METADATA_PARSED,this._onMetadataParsed),this.off(DEMUX_EVENTS$3.DEMUX_COMPLETE,this._onDemuxComplete),this.mse=null,this.m3u8Text=null}}]),e}(),HlsAllowedEvents$2=EVENTS.HlsAllowedEvents,REMUX_EVENTS$5=EVENTS.REMUX_EVENTS,HlsLivePlayer=function(e){function t(e){classCallCheck(this,t);var i=possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.hlsOps={},i.util=Player.util,i.util.deepCopy(i.hlsOps,e),i._context=new Context(HlsAllowedEvents$2),i._hasStarted=!1,i}return inherits(t,e),createClass(t,[{key:"_initEvents",value:function(){var e=this;this.__core__.once(REMUX_EVENTS$5.INIT_SEGMENT,function(){var i=e._context.getInstance("MSE");if(!e._hasStarted){var r=e.util.createDom("xg-live","正在直播",{},"xgplayer-live");e.util.addClass(e.root,"xgplayer-is-live"),e.controls.appendChild(r)}e._hasStarted=!0,get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"start",e).call(e,i.url)}),this.once("canplay",function(){e.video.play()})}},{key:"_initSrcChangeHandler",value:function(){var e=this;Object.defineProperty(this,"src",{get:function(){return e.currentSrc},set:function(t){e.config.url=t,e.paused?e.start(t):(e.pause(),e.once("pause",function(){e.start(t)}),e.once("canplay",function(){e.play()})),e.once("canplay",function(){e.currentTime=0})},configurable:!0})}},{key:"start",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.config.url;e&&(this.__core__=this._context.registry("HLS_LIVE_CONTROLLER",HlsLiveController)({player:this,container:this.video}),this._context.init(),this.url=e,this.__core__.load(e),this._initEvents(),this._initSrcChangeHandler())}},{key:"play",value:function(){this._hasStarted&&(this._context.destroy(),this._context=new Context(HlsAllowedEvents$2),this.__core__=this._context.registry("HLS_LIVE_CONTROLLER",HlsLiveController)({container:this.video}),this._context.init(),this._initEvents(),this.__core__.load(this.url)),get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"play",this).call(this)}},{key:"destroy",value:function(){this._context.destroy(),get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}}]),t}(Player);export default HlsLivePlayer;
//# sourceMappingURL=index.min.js.map
