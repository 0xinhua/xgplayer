{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import 'core-js/modules/es6.promise.js'\nimport 'core-js/modules/es7.string.pad-start'\nimport Player from 'xgplayer'\nimport MP4 from './mp4'\nimport MSE from './media/mse'\nimport Task from './media/task'\nimport Buffer from './fmp4/buffer'\nimport FMP4 from './fmp4/mp4'\n\nlet isEnded = (player, mp4) => {\n  if (mp4.meta.endTime - player.currentTime < 2) {\n    let range = player.getBufferedRange()\n    if (player.currentTime - range[1] < 0.1) {\n      player.mse.endOfStream()\n    }\n  }\n}\n\nlet errorHandle = (player, err) => {\n  err.vid = player.config.vid\n  err.url = player.src\n  if (err.errd && typeof err.errd === 'object') {\n    if (player.mp4) {\n      err.errd.url = player.mp4.url\n      err.url = player.mp4.url\n      player.mp4.canDownload = false\n    }\n  }\n  player.emit('DATA_REPORT', err)\n  if (err.errt === 'network' && player.config._backupURL) {\n    player.src = player.config._backupURL\n  } else {\n    player.src = player.config._mainURL\n  }\n  player.switchURL = null\n  player._replay = null\n}\n\nlet m4aplayer = function () {\n  let player = this; let sniffer = Player.sniffer; let util = Player.util\n  let Errors = Player.Errors; let mainURL; let backupURL\n  let preloadTime = player.config.preloadTime || 15\n  let waiterTimer\n  Player.m4a = true\n  player.hasEnded = false\n  let list = util.typeOf(player.config.url) === 'Array' ? player.config.url : [{\n    src: player.config.url,\n    name: player.config.name,\n    vid: player.config.vid,\n    poster: player.config.poster\n  }]\n  let url = list[0].src\n  let name = list[0].name\n  let vid = list[0].vid\n  let poster = list[0].poster\n  let rule = player.config.pluginRule || function () { return true }\n  if (!url) {\n    player.emit('error', new Errors('other', player.config.vid))\n    return\n  }\n  if (util.typeOf(url) === 'String') {\n    mainURL = url\n  } else if (util.typeOf(url) === 'Array' && url.length) {\n    mainURL = url[0].src\n    backupURL = url[1].src\n  }\n  player.config._mainURL = mainURL\n  player.config._backupURL = backupURL\n  let loadData = (i = 0, time = player.currentTime, order = null, nextOrder = null) => {\n    if (player.timer) {\n      clearTimeout(player.timer)\n    }\n    time = Math.max(time, player.currentTime)\n    player.timer = setTimeout(function () {\n      player.mp4.seek(time, order, nextOrder).then(buffer => {\n        if (buffer) {\n          let mse = player.mse\n          mse.updating = true\n          mse.appendBuffer(buffer)\n          mse.once('updateend', () => {\n            mse.updating = false\n          })\n        }\n      }, () => {\n        if (i < 10) {\n          setTimeout(function () {\n            loadData(i + 1)\n          }, 2000)\n        }\n      })\n    }, 50)\n  }\n  let init = (url, replaying = false) => {\n    let mp4 = new MP4(url)\n    mp4.reqTimeLength = player.config.reqTimeLength || 5\n    let mse\n    return new Promise((resolve, reject) => {\n      mp4.once('mdatReady', () => {\n        mse = new MSE()\n        if (replaying) {\n          mse.replaying = true\n        }\n        mse.on('sourceopen', function () {\n          mse.appendBuffer(mp4.packMeta(mp4.meta))\n          mse.once('updateend', loadData.bind(player))\n        })\n        mse.on('error', function (e) {\n          reject(e)\n        })\n        resolve([mp4, mse])\n      })\n      mp4.on('error', (e) => {\n        reject(e)\n      })\n    })\n  }\n  if (['chrome', 'firfox', 'safari'].some(item => item === sniffer.browser) && MSE.isSupported('audio/mp4; codecs=\"mp4a.40.5\"')) {\n    let _start = player.start\n    if (!rule.call(player)) {\n      return false\n    }\n    player.cut = function (start = 0, end) {\n      let segment = new Buffer()\n      return new Promise((resolve, reject) => {\n        let mp4 = new MP4(url)\n        mp4.once('mdatReady', () => {\n          if (!end || end <= start) {\n            end = start + 15\n          }\n          if (end > mp4.meta.audioDuration) {\n            start = mp4.meta.audioDuration - (end - start)\n            end = mp4.meta.audioDuration\n          }\n          mp4.reqTimeLength = end - start\n          mp4.cut = true\n          mp4.seek(start).then(buffer => {\n            if (buffer) {\n              let meta = Player.util.deepCopy({\n                duration: mp4.reqTimeLength,\n                audioDuration: mp4.reqTimeLength,\n                endTime: mp4.reqTimeLength\n              }, mp4.meta)\n              meta.duration = mp4.reqTimeLength\n              meta.audioDuration = mp4.reqTimeLength\n              meta.endTime = mp4.reqTimeLength\n              segment.write(mp4.packMeta(meta), buffer)\n              resolve(new Blob([segment.buffer], {type: 'audio/mp4; codecs=\"mp4a.40.5\"'}))\n            }\n          })\n        })\n        mp4.on('error', (e) => {\n          reject(e)\n        })\n      })\n    }\n    if (player.config.segPlay) {\n      let sp = player.config.segPlay\n      player.cut(sp.start, sp.end).then(blob => {\n        if (blob) {\n          player.config.url = URL.createObjectURL(blob)\n          player.start(player.config.url)\n        }\n      }, () => {\n        console.log('error')\n      })\n      return\n    }\n    Object.defineProperty(player, 'src', {\n      get () {\n        return player.currentSrc\n      },\n      set (url) {\n        player.config.url = url\n        if (!player.paused) {\n          player.pause()\n          player.once('pause', () => {\n            player.start(url)\n          })\n          player.once('canplay', () => {\n            player.play()\n          })\n        } else {\n          player.start(url)\n        }\n        player.once('canplay', () => {\n          player.currentTime = 0\n        })\n      },\n      configurable: true\n    })\n    player.start = function (url = mainURL) {\n      init(url).then((result) => {\n        let mp4 = result[0]; let mse = result[1]\n        _start.call(player, mse.url)\n        player.mp4 = mp4\n        player.mse = mse\n        mp4.on('error', err => {\n          errorHandle(player, err)\n        })\n      }, err => {\n        _start.call(player, url)\n        errorHandle(player, err)\n      })\n      player.once('canplay', () => {\n        // safari decoder time offset\n        if (sniffer.browser === 'safari' && player.buffered) {\n          let start = player.buffered.start(0)\n          player.currentTime = start + 0.1\n        }\n      })\n    }\n\n    player.switchURL = (url) => {\n      let mp5 = new MP4(url)\n      let mp4 = player.mp4\n      mp5.on('mdatReady', () => {\n        let timeRange = mp4.timeRage; let curTime = player.currentTime\n        timeRange = mp4.timeRage\n        let start = timeRange.find(item => item[0] - curTime > 2)[0]\n        let end = player.getBufferedRange()[1]\n        if (end - start > 0 && sniffer.browser !== 'safari') {\n          player.mse.removeBuffer(start, end)\n        }\n        player.mp4 = mp5\n        player.mse.appendBuffer(mp5.packMeta(mp5.meta))\n      })\n      mp5.on('error', err => {\n        errorHandle(player, err)\n      })\n    }\n    player.on('timeupdate', function () {\n      let mse = player.mse; let mp4 = player.mp4\n      if (mse && !mse.updating && mp4.canDownload) {\n        let timeRage = mp4.timeRage\n        let range = player.getBufferedRange(); let cacheMaxTime = player.currentTime + preloadTime\n        if (range[1] - cacheMaxTime > 0) {\n          return\n        }\n        timeRage.every((item, idx) => {\n          if (range[1] === 0) {\n            loadData(5)\n            return false\n          } else {\n            if (item[0].time >= range[1] && !mp4.bufferCache.has(idx)) {\n              loadData(0, item[0].time, item[0].order, item[1].order)\n            } else {\n              return true\n            }\n          }\n        })\n        isEnded(player, mp4)// hack for older webkit\n      }\n    })\n\n    player.on('seeking', function () {\n      let buffered = player.buffered; let hasBuffered = false; let curTime = player.currentTime\n      Task.clear()\n      let timeRage = player.mp4.timeRage\n      if (buffered.length) {\n        for (let i = 0, len = buffered.length; i < len; i++) {\n          if (curTime >= buffered.start(i) && curTime <= buffered.end(i)) {\n            hasBuffered = true\n            break\n          }\n        }\n        if (!hasBuffered) {\n          timeRage.every((item, idx) => {\n            if (item[0].time <= curTime && item[1].time > curTime) {\n              loadData(0, item[0].time, item[0].order, item[1].order)\n              return false\n            } else {\n              return true\n            }\n          })\n        }\n      } else {\n        timeRage.every((item, idx) => {\n          if (item[0].time <= curTime && item[1].time > curTime) {\n            loadData(0, item[0].time, item[0].order, item[1].order)\n            return false\n          } else {\n            return true\n          }\n        })\n      }\n    })\n\n    player.on('pause', function () {\n      Task.clear()\n    })\n\n    player.on('playing', function () {\n      if (waiterTimer) {\n        clearTimeout(waiterTimer)\n      }\n    })\n\n    player.on('waiting', function () {\n      let buffered = player.buffered; let hasBuffered = false; let curTime = player.currentTime\n      Task.clear()\n      let timeRage = player.mp4.timeRage\n      if (buffered.length) {\n        for (let i = 0, len = buffered.length; i < len; i++) {\n          if (curTime >= buffered.start(i) && curTime <= buffered.end(i)) {\n            hasBuffered = true\n            break\n          }\n        }\n        if (!hasBuffered) {\n          timeRage.every((item, idx) => {\n            if (item[0].time <= curTime && item[1].time > curTime) {\n              loadData(0, item[0].time, item[0].order, item[1].order)\n              return false\n            } else {\n              return true\n            }\n          })\n        }\n      } else {\n        timeRage.every((item, idx) => {\n          if (item[0].time <= curTime && item[1].time > curTime) {\n            loadData(0, item[0].time, item[0].order, item[1].order)\n            return false\n          } else {\n            return true\n          }\n        })\n      }\n    })\n\n    player.once('destroy', () => {\n      Task.clear()\n      if (player.timer) {\n        clearTimeout(player.timer)\n      }\n    })\n\n    // let playBtn = util.findDom(player.root, '.xgplayer-play');\n    // ['click', 'touchstart'].forEach(item => {\n    //   playBtn.addEventListener(item, function (e) {\n    //     e.preventDefault()\n    //     e.stopPropagation()\n    //     if (player.hasEnded) {\n    //       player.hasEnded = false\n    //       Task.clear()\n    //       player.mp4.bufferCache.clear()\n    //       // player.currentTime = 0\n    //       init(player.mp4.url, true).then((result) => {\n    //         let mp4 = result[0]; let mse = result[1]\n    //         player.src = mse.url\n    //         player.mp4 = mp4\n    //         player.mse = mse\n    //         player.mse.replaying = true\n    //         player.currentTime = 0\n    //         player.video.play().then(() => {\n    //\n    //           // player.pause()\n    //           // player.currentTime = 0\n    //         })\n    //       }, err => {\n    //         errorHandle(player, err)\n    //       })\n    //     }\n    //   })\n    // })\n\n    player.on('change', (nextItem) => {\n      player.newMusic(nextItem.src)\n      name = `${nextItem.name}`\n      vid = `${nextItem.vid}`\n      poster = `${nextItem.poster}`\n    })\n\n    player.newMusic = (url) => {\n      Task.clear()\n      player.mp4.bufferCache.clear()\n      init(url, true).then((result) => {\n        let mp4 = result[0]; let mse = result[1]\n        player.src = mse.url\n        player.mp4 = mp4\n        player.mse = mse\n        player.mse.replaying = true\n        player.currentTime = 0\n        setTimeout(() => {\n          player.video.play()\n        }, 60)\n      }, err => {\n        errorHandle(player, err)\n      })\n    }\n\n    player.on('ended', () => {\n      player.hasEnded = true\n      if (player.config.offline) {\n        let mdatCache = new Buffer()\n        mdatCache.write(FMP4.size(player.mp4.mdatBox.size), FMP4.type('mdat'))\n        player.mp4.mdatCache.sort((a, b) => {\n          return a.start - b.start\n        })\n        let end = player.mp4.mdatCache[0].start - 1\n        player.mp4.mdatCache.forEach((item, index) => {\n          if (item.start === end + 1) {\n            mdatCache.write(item.buffer)\n            end = item.end\n          }\n        })\n        if (end !== player.mp4.mdatCache[player.mp4.mdatCache.length - 1].end) {\n          return\n        }\n        let m4aCache = new Buffer()\n        if (player.mp4.freeBuffer) {\n          m4aCache.write(new Uint8Array(player.mp4.ftypBuffer), new Uint8Array(player.mp4.moovBuffer), new Uint8Array(player.mp4.freeBuffer), mdatCache.buffer)\n        } else {\n          m4aCache.write(new Uint8Array(player.mp4.ftypBuffer), new Uint8Array(player.mp4.moovBuffer), mdatCache.buffer)\n        }\n        let offlineVid = vid || name\n        player.database.openDB(() => {\n          player.database.addData(player.database.myDB.ojstore.name, [{vid: offlineVid, blob: new Blob([m4aCache.buffer], {type: 'audio/mp4; codecs=\"mp4a.40.5\"'})}])\n          setTimeout(() => {\n            player.database.closeDB()\n          }, 5000)\n        })\n      }\n    })\n  }\n}\n\nPlayer.install('m4aplayer', m4aplayer)\n"],"names":["isEnded","player","mp4","meta","endTime","currentTime","range","getBufferedRange","mse","endOfStream","errorHandle","err","vid","config","url","src","errd","canDownload","emit","errt","_backupURL","_mainURL","switchURL","_replay","m4aplayer","sniffer","Player","util","Errors","mainURL","backupURL","preloadTime","m4a","hasEnded","list","typeOf","name","poster","rule","pluginRule","length","loadData","i","time","order","nextOrder","timer","clearTimeout","Math","max","setTimeout","seek","then","buffer","updating","appendBuffer","once","init","replaying","MP4","reqTimeLength","Promise","resolve","reject","MSE","on","packMeta","bind","e","some","item","browser","isSupported","_start","start","call","cut","end","segment","Buffer","audioDuration","deepCopy","duration","write","Blob","type","segPlay","sp","blob","URL","createObjectURL","console","log","Object","defineProperty","get","currentSrc","set","paused","pause","play","configurable","result","buffered","mp5","timeRange","timeRage","curTime","find","removeBuffer","cacheMaxTime","every","idx","bufferCache","has","hasBuffered","Task","clear","len","nextItem","newMusic","video","offline","mdatCache","FMP4","size","mdatBox","sort","a","b","forEach","index","m4aCache","freeBuffer","Uint8Array","ftypBuffer","moovBuffer","offlineVid","database","openDB","addData","myDB","ojstore","closeDB","install"],"mappings":"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"}