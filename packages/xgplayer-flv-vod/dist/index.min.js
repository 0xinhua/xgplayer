!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("xgplayer")):"function"==typeof define&&define.amd?define(["xgplayer"],t):(e=e||self,e.FlvVodPlayer=t(e.Player))}(this,function(e){"use strict";function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(){}function i(){i.init.call(this)}function r(e){return void 0===e._maxListeners?i.defaultMaxListeners:e._maxListeners}function a(e,t,n){if(t)e.call(n);else for(var i=e.length,r=v(e,i),a=0;a<i;++a)r[a].call(n)}function s(e,t,n,i){if(t)e.call(n,i);else for(var r=e.length,a=v(e,r),s=0;s<r;++s)a[s].call(n,i)}function o(e,t,n,i,r){if(t)e.call(n,i,r);else for(var a=e.length,s=v(e,a),o=0;o<a;++o)s[o].call(n,i,r)}function u(e,t,n,i,r,a){if(t)e.call(n,i,r,a);else for(var s=e.length,o=v(e,s),u=0;u<s;++u)o[u].call(n,i,r,a)}function l(e,t,n,i){if(t)e.apply(n,i);else for(var r=e.length,a=v(e,r),s=0;s<r;++s)a[s].apply(n,i)}function f(e,t,i,a){var s,o,u;if("function"!=typeof i)throw new TypeError('"listener" argument must be a function');if(o=e._events,o?(o.newListener&&(e.emit("newListener",t,i.listener?i.listener:i),o=e._events),u=o[t]):(o=e._events=new n,e._eventsCount=0),u){if("function"==typeof u?u=o[t]=a?[i,u]:[u,i]:a?u.unshift(i):u.push(i),!u.warned&&(s=r(e))&&s>0&&u.length>s){u.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+u.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=u.length,c(l)}}else u=o[t]=i,++e._eventsCount;return e}function c(e){"function"==typeof console.warn?console.warn(e):console.log(e)}function h(e,t,n){function i(){e.removeListener(t,i),r||(r=!0,n.apply(e,arguments))}var r=!1;return i.listener=n,i}function d(e){var t=this._events;if(t){var n=t[e];if("function"==typeof n)return 1;if(n)return n.length}return 0}function p(e,t){for(var n=t,i=n+1,r=e.length;i<r;n+=1,i+=1)e[n]=e[i];e.pop()}function v(e,t){for(var n=new Array(t);t--;)n[t]=e[t];return n}function y(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}function m(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Ae(t))&&"function"!=typeof t?e:t}function g(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Ae(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function b(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function k(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function E(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function w(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function S(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function A(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function T(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function R(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function L(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function D(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function B(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function O(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function x(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":lt(t))&&"function"!=typeof t?e:t}function U(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":lt(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function C(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function I(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function M(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function P(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function N(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function F(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function V(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function j(e,t){return t={exports:{}},e(t,t.exports),t.exports}function G(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function z(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function H(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function X(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function W(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function K(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Y(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function q(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Z(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":Qt(t))&&"function"!=typeof t?e:t}function J(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":Qt(t)));e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function Q(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function $(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ee(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function te(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ne(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ie(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function re(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ae(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function se(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function oe(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}e=e&&e.hasOwnProperty("default")?e.default:e;var ue={VISIBILITY_CHANGE:"VISIBILITY_CHANGE"},le={SEEK:"SEEK"},fe={LADER_START:"LOADER_START",LOADER_DATALOADED:"LOADER_DATALOADED",LOADER_COMPLETE:"LOADER_COMPLETE",LOADER_ERROR:"LOADER_ERROR"},ce={DEMUX_START:"DEMUX_START",DEMUX_COMPLETE:"DEMUX_COMPLETE",DEMUX_ERROR:"DEMUX_ERROR",METADATA_PARSED:"METADATA_PARSED",SEI_PARSED:"SEI_PARSED",VIDEO_METADATA_CHANGE:"VIDEO_METADATA_CHANGE",AUDIO_METADATA_CHANGE:"AUDIO_METADATA_CHANGE",MEDIA_INFO:"MEDIA_INFO"},he={REMUX_METADATA:"REMUX_METADATA",REMUX_MEDIA:"REMUX_MEDIA",MEDIA_SEGMENT:"MEDIA_SEGMENT",REMUX_ERROR:"REMUX_ERROR",INIT_SEGMENT:"INIT_SEGMENT",DETECT_CHANGE_STREAM:"DETECT_CHANGE_STREAM",DETECT_CHANGE_STREAM_DISCONTINUE:"DETECT_CHANGE_STREAM_DISCONTINUE",RANDOM_ACCESS_POINT:"RANDOM_ACCESS_POINT"},de={SOURCE_UPDATE_END:"SOURCE_UPDATE_END"},pe={RETRY_TIME_EXCEEDED:"RETRY_TIME_EXCEEDED"},ve={START_DECRYPT:"START_DECRYPT",DECRYPTED:"DECRYPTED"},ye=Object.assign({},fe,ce,he,de,pe,le,ue),me=[],ge=[];for(var _e in ye)ye.hasOwnProperty(_e)&&me.push(ye[_e]);for(var be in ye)ye.hasOwnProperty(be)&&ge.push(ye[be]);var ke={ALLEVENTS:ye,HLS_EVENTS:pe,REMUX_EVENTS:he,DEMUX_EVENTS:ce,MSE_EVENTS:de,LOADER_EVENTS:fe,FlvAllowedEvents:me,HlsAllowedEvents:ge,CRYTO_EVENTS:ve,PLAYER_EVENTS:le,BROWSER_EVENTS:ue},Ee=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),we=function(e){for(var t in e)if(e.hasOwnProperty(t)&&null===e[t])return!1;return!0},Se=function(){function e(){t(this,e),this.mimeType=null,this.duration=null,this.hasVideo=null,this.video={codec:null,width:null,height:null,profile:null,level:null,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},chromaFormat:null,parRatio:{width:1,height:1}},this.hasAudio=null,this.audio={codec:null,sampleRate:null,sampleRateIndex:null,channelCount:null}}return Ee(e,[{key:"isComplete",value:function(){return e.isBaseInfoReady(this)&&e.isVideoReady(this)&&e.isAudioReady(this)}}],[{key:"isBaseInfoReady",value:function(e){return we(e)}},{key:"isVideoReady",value:function(e){return!e.hasVideo||we(e.video)}},{key:"isAudioReady",value:function(e){return!e.hasAudio||we(e.video)}}]),e}();n.prototype=Object.create(null),i.EventEmitter=i,i.usingDomains=!1,i.prototype.domain=void 0,i.prototype._events=void 0,i.prototype._maxListeners=void 0,i.defaultMaxListeners=10,i.init=function(){this.domain=null,i.usingDomains&&(void 0).active&&(void 0).Domain,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new n,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},i.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},i.prototype.getMaxListeners=function(){return r(this)},i.prototype.emit=function(e){var t,n,i,r,f,c,h,d="error"===e;if(c=this._events)d=d&&null==c.error;else if(!d)return!1;if(h=this.domain,d){if(t=arguments[1],!h){if(t instanceof Error)throw t;var p=new Error('Uncaught, unspecified "error" event. ('+t+")");throw p.context=t,p}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=h,t.domainThrown=!1,h.emit("error",t),!1}if(!(n=c[e]))return!1;var v="function"==typeof n;switch(i=arguments.length){case 1:a(n,v,this);break;case 2:s(n,v,this,arguments[1]);break;case 3:o(n,v,this,arguments[1],arguments[2]);break;case 4:u(n,v,this,arguments[1],arguments[2],arguments[3]);break;default:for(r=new Array(i-1),f=1;f<i;f++)r[f-1]=arguments[f];l(n,v,this,r)}return!0},i.prototype.addListener=function(e,t){return f(this,e,t,!1)},i.prototype.on=i.prototype.addListener,i.prototype.prependListener=function(e,t){return f(this,e,t,!0)},i.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,h(this,e,t)),this},i.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,h(this,e,t)),this},i.prototype.removeListener=function(e,t){var i,r,a,s,o;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(r=this._events))return this;if(!(i=r[e]))return this;if(i===t||i.listener&&i.listener===t)0==--this._eventsCount?this._events=new n:(delete r[e],r.removeListener&&this.emit("removeListener",e,i.listener||t));else if("function"!=typeof i){for(a=-1,s=i.length;s-- >0;)if(i[s]===t||i[s].listener&&i[s].listener===t){o=i[s].listener,a=s;break}if(a<0)return this;if(1===i.length){if(i[0]=void 0,0==--this._eventsCount)return this._events=new n,this;delete r[e]}else p(i,a);r.removeListener&&this.emit("removeListener",e,o||t)}return this},i.prototype.removeAllListeners=function(e){var t,i;if(!(i=this._events))return this;if(!i.removeListener)return 0===arguments.length?(this._events=new n,this._eventsCount=0):i[e]&&(0==--this._eventsCount?this._events=new n:delete i[e]),this;if(0===arguments.length){for(var r,a=Object.keys(i),s=0;s<a.length;++s)"removeListener"!==(r=a[s])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=new n,this._eventsCount=0,this}if("function"==typeof(t=i[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},i.prototype.listeners=function(e){var t,n=this._events;return n&&(t=n[e])?"function"==typeof t?[t.listener||t]:y(t):[]},i.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):d.call(e,t)},i.prototype.listenerCount=d,i.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var Ae="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Te=function e(t,n,i){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,n);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,n,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)},Re=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Le=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];_(this,e),this._emitter=new i,this._emitter.off||(this._emitter.off=this._emitter.removeListener),this.mediaInfo=new Se,this._instanceMap={},this._clsMap={},this._inited=!1,this.allowedEvents=t,this._hooks={}}return Re(e,[{key:"getInstance",value:function(e){var t=this._instanceMap[e];return t||null}},{key:"initInstance",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var r=n[0],a=n[1],s=n[2],o=n[3];if(this._clsMap[e]){var u=new this._clsMap[e](r,a,s,o);return this._instanceMap[e]=u,u.init&&u.init(),u}throw new Error(e+"未在context中注册")}},{key:"init",value:function(e){if(!this._inited){for(var t in this._clsMap)this._clsMap.hasOwnProperty(t)&&!this._instanceMap[t]&&this.initInstance(t,e);this._inited=!0}}},{key:"registry",value:function(e,t){var n=this,i=this._emitter,r=this._isMessageNameValid.bind(this),a=this,s=function(t){function n(t,i,r){_(this,n);var s=m(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,i,r));return s.listeners={},s.onceListeners={},s.TAG=e,s._context=a,s}return g(n,t),Re(n,[{key:"on",value:function(t,n){return r(t),this.listeners[t]?this.listeners[t].push(n):this.listeners[t]=[n],i.on(t+"__TO__"+e,n),i.on(t,n)}},{key:"before",value:function(e,t){r(e),a._hooks[e]?a._hooks[e].push(t):a._hooks[e]=[t]}},{key:"once",value:function(t,n){return r(t),this.onceListeners[t]?this.onceListeners[t].push(n):this.onceListeners[t]=[n],i.once(t+"__TO__"+e,n),i.once(t,n)}},{key:"emit",value:function(e){r(e);var t=a._hooks?a._hooks[e]:null;if(t)for(var n=0,s=t.length;n<s;n++)(0,t[n])();for(var o=arguments.length,u=Array(o>1?o-1:0),l=1;l<o;l++)u[l-1]=arguments[l];return i.emit.apply(i,[e].concat(u))}},{key:"emitTo",value:function(e,t){r(t);for(var n=arguments.length,a=Array(n>2?n-2:0),s=2;s<n;s++)a[s-2]=arguments[s];return i.emit.apply(i,[t+"__TO__"+e].concat(a))}},{key:"off",value:function(e,t){return r(e),i.off(e,t)}},{key:"removeListeners",value:function(){var t=Object.prototype.hasOwnProperty.bind(this.listeners);for(var n in this.listeners)if(t(n))for(var r=this.listeners[n]||[],a=0;a<r.length;a++){var s=r[a];i.off(n,s),i.off(n+"__TO__"+e,s)}for(var o in this.onceListeners)if(t(o))for(var u=this.onceListeners[o]||[],l=0;l<u.length;l++){var f=u[l];i.off(o,f),i.off(o+"__TO__"+e,f)}}},{key:"destroy",value:function(){if(this.removeListeners(),this.listeners={},delete a._instanceMap[e],Te(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this))return Te(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this)}}]),n}(t);return this._clsMap[e]=s,function(){for(var t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];return n.initInstance.apply(n,[e].concat(i))}}},{key:"seek",value:function(e){this._emitter.emit(ke.PLAYER_EVENTS.SEEK,e)}},{key:"destroyInstances",value:function(){var e=this;Object.keys(this._instanceMap).forEach(function(t){e._instanceMap[t].destroy&&e._instanceMap[t].destroy()})}},{key:"destroy",value:function(){this._emitter=null,this.allowedEvents=[],this._clsMap=null,this._context=null,this._hooks=null,this.destroyInstances()}},{key:"_isMessageNameValid",value:function(e){if(!this.allowedEvents.indexOf(e)<0)throw new Error("unregistered message name: "+e)}}]),e}(),De="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Be="function"==typeof Symbol&&"symbol"===De(Symbol.iterator)?function(e){return void 0===e?"undefined":De(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":void 0===e?"undefined":De(e)},Oe=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),xe=ke.LOADER_EVENTS,Ue=function(){function e(t){b(this,e),this.configs=Object.assign({},t),this.url=null,this.status=0,this.error=null,this._reader=null,this._canceled=!1,this._destroyed=!1,this.readtype=this.configs.readtype,this.buffer=this.configs.buffer||"LOADER_BUFFER",this._loaderTaskNo=0}return Oe(e,[{key:"init",value:function(){this.on(xe.LADER_START,this.load.bind(this))}},{key:"load",value:function(e,t){var n=this;this.url=e,this._canceled=!1;var i=this.getParams(t);return this.loading=!0,fetch(this.url,i).then(function(e){if(e.ok)return n.status=e.status,Promise.resolve().then(function(){n._onFetchResponse(e)}),Promise.resolve(e);n.loading=!1,n.emit(xe.LOADER_ERROR,n.TAG,new Error(e.status+" ("+e.statusText+")"))}).catch(function(e){throw n.loading=!1,n.emit(xe.LOADER_ERROR,n.TAG,e),e})}},{key:"_onFetchResponse",value:function(e){var t=this,n=this._context.getInstance(this.buffer),i=++this._loaderTaskNo;if(!0===e.ok)switch(this.readtype){case 2:e.json().then(function(e){t.loading=!1,t._canceled||t._destroyed||(n?(n.push(e),t.emit(xe.LOADER_COMPLETE,n)):t.emit(xe.LOADER_COMPLETE,e))});break;case 1:e.text().then(function(e){t.loading=!1,t._canceled||t._destroyed||(n?(n.push(e),t.emit(xe.LOADER_COMPLETE,n)):t.emit(xe.LOADER_COMPLETE,e))});break;case 3:e.arrayBuffer().then(function(e){t.loading=!1,t._canceled||t._destroyed||(n?(n.push(new Uint8Array(e)),t.emit(xe.LOADER_COMPLETE,n)):t.emit(xe.LOADER_COMPLETE,e))});break;case 0:default:return this._onReader(e.body.getReader(),i)}}},{key:"_onReader",value:function(e,t){var n=this,i=this._context.getInstance(this.buffer);if(!i&&this._reader||this._destroyed)try{this._reader.cancel()}catch(e){}this._reader=e,!1!==this.loading&&this._reader&&this._reader.read().then(function(r){if(!n._canceled&&!n._destroyed)return r.done?(n.loading=!1,n.status=0,void Promise.resolve().then(function(){n.emit(xe.LOADER_COMPLETE,i)})):(i.push(r.value),Promise.resolve().then(function(){n.emit(xe.LOADER_DATALOADED,i)}),n._onReader(e,t));if(n._reader)try{n._reader.cancel()}catch(e){}}).catch(function(e){throw n.loading=!1,n.emit(xe.LOADER_ERROR,n.TAG,e),e})}},{key:"getParams",value:function(e){var t=Object.assign({},e),n=new Headers,i={method:"GET",headers:n,mode:"cors",cache:"default"};if("object"===Be(this.configs.headers)){var r=this.configs.headers;for(var a in r)r.hasOwnProperty(a)&&n.append(a,r[a])}if("object"===Be(t.headers)){var s=t.headers;for(var o in s)s.hasOwnProperty(o)&&n.append(o,s[o])}return!1===t.cors&&(i.mode="same-origin"),t.withCredentials&&(i.credentials="include"),i}},{key:"cancel",value:function(){if(this._reader){try{this._reader.cancel()}catch(e){}this._reader=null,this.loading=!1}this._canceled=!0}},{key:"destroy",value:function(){this._destroyed=!0,this.cancel()}}],[{key:"type",get:function(){return"loader"}}]),e}(),Ce=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Ie=function(){function e(t){k(this,e);var n={sampleRate:48e3,channelCount:2,codec:"mp4a.40.2",config:[41,401,136,0],duration:0,id:2,refSampleDuration:21,sampleRateIndex:3,timescale:1e3,type:"audio"};return t?Object.assign({},n,t):n}return Ce(e,[{key:"destroy",value:function(){this.init=null}}]),e}(),Me=function(){function e(t){k(this,e);var n={avcc:null,sps:new Uint8Array(0),pps:new Uint8Array(0),chromaFormat:420,codec:"avc1.640020",codecHeight:720,codecWidth:1280,duration:0,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},id:1,level:"3.2",presentHeight:720,presentWidth:1280,profile:"High",refSampleDuration:40,parRatio:{height:1,width:1},timescale:1e3,type:"video"};return t?Object.assign({},n,t):n}return Ce(e,[{key:"destroy",value:function(){this.init=null,this.sps=null,this.pps=null}}]),e}(),Pe=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Ne=function(){function e(t){E(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}return Pe(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),n=new Uint8Array(4);n.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(n.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),n=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),t=e-t,t>0&&this._currentWordBitsLeft?n<<t|this.readBits(t):n}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e=void 0;for(e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}}]),e}(),Fe=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Ve=function(){function e(){w(this,e)}return Fe(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,n=t.byteLength,i=new Uint8Array(n),r=0,a=0;a<n;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(i[r]=t[a],r++);return new Uint8Array(i.buffer,0,r)}},{key:"parseSPS",value:function(t){var n=e._ebsp2rbsp(t),i=new Ne(n);i.readByte();var r=i.readByte();i.readByte();var a=i.readByte();i.readUEG();var s=e.getProfileString(r),o=e.getLevelString(a),u=1,l=420,f=[0,420,422,444],c=8;if((100===r||110===r||122===r||244===r||44===r||83===r||86===r||118===r||128===r||138===r||144===r)&&(3===(u=i.readUEG())&&i.readBits(1),u<=3&&(l=f[u]),c=i.readUEG()+8,i.readUEG(),i.readBits(1),i.readBool()))for(var h=3!==u?8:12,d=0;d<h;d++)i.readBool()&&(d<6?e._skipScalingList(i,16):e._skipScalingList(i,64));i.readUEG();var p=i.readUEG();if(0===p)i.readUEG();else if(1===p){i.readBits(1),i.readSEG(),i.readSEG();for(var v=i.readUEG(),y=0;y<v;y++)i.readSEG()}i.readUEG(),i.readBits(1);var m=i.readUEG(),g=i.readUEG(),_=i.readBits(1);0===_&&i.readBits(1),i.readBits(1);var b=0,k=0,E=0,w=0;i.readBool()&&(b=i.readUEG(),k=i.readUEG(),E=i.readUEG(),w=i.readUEG());var S=1,A=1,T=0,R=!0,L=0,D=0;if(i.readBool()){if(i.readBool()){var B=i.readByte(),O=[1,12,10,16,40,24,20,32,80,18,15,64,160,4,3,2],x=[1,11,11,11,33,11,11,11,33,11,11,33,99,3,2,1];B>0&&B<16?(S=O[B-1],A=x[B-1]):255===B&&(S=i.readByte()<<8|i.readByte(),A=i.readByte()<<8|i.readByte())}if(i.readBool()&&i.readBool(),i.readBool()&&(i.readBits(4),i.readBool()&&i.readBits(24)),i.readBool()&&(i.readUEG(),i.readUEG()),i.readBool()){var U=i.readBits(32),C=i.readBits(32);R=i.readBool(),T=(L=C)/(D=2*U)}}var I=1;1===S&&1===A||(I=S/A);var M=0,P=0;0===u?(M=1,P=2-_):(M=3===u?1:2,P=(1===u?2:1)*(2-_));var N=16*(m+1),F=16*(g+1)*(2-_);N-=(b+k)*M,F-=(E+w)*P;var V=Math.ceil(N*I);return i.destroy(),i=null,{profile_string:s,level_string:o,bit_depth:c,chroma_format:l,chroma_format_string:e.getChromaFormatString(l),frame_rate:{fixed:R,fps:T,fps_den:D,fps_num:L},par_ratio:{width:S,height:A},codec_size:{width:N,height:F},present_size:{width:V,height:F}}}},{key:"_skipScalingList",value:function(e,t){for(var n=8,i=8,r=0;r<t;r++)0!==i&&(i=(n+e.readSEG()+256)%256),n=0===i?n:i}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};e&&e.codec_size&&(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t.parRatio={width:e.par_ratio.width,height:e.par_ratio.height},t.frameRate=e.frame_rate;var n=t.frameRate.fps_den,i=t.frameRate.fps_num;return t.refSampleDuration=Math.floor(t.timescale*(n/i)),t}}]),e}(),je=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Ge=function(){function e(){S(this,e)}return je(e,null,[{key:"EBSP2RBSP",value:function(e){return e.filter(function(t,n){return n<2||!(0===e[n-2]&&0===e[n-1]&&3===t)})}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}]),e}(),ze=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),He=function(e){for(var t="",n=0;n<e.byteLength;n++)t+=String.fromCharCode(e[n]);return t},Xe=function(){function e(){A(this,e)}return ze(e,null,[{key:"_resolveNalu",value:function(e){return e.length>=1?Ge.EBSP2SODB(Ge.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(t){var n=e._resolveNalu(t),i=e.switchPayloadType(n),r=i.payloadType,a=i.offset,s=n.slice(a);switch(r){case 5:return e.user_data_unregistered(s);default:return{code:r,content:s}}}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),n=0,i=0;255===t.getUint8(i);)i++,n+=255;return n+=t.getUint8(i++),{payloadType:n,offset:i}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),n=0,i=0;255===t.getUint8(i);)i++,n+=255;return n+=t.getUint8(i++),{payloadLength:n,offset:i}}},{key:"user_data_unregistered",value:function(t){var n=e.getPayloadLength(t),i=n.payloadLength,r=n.offset;if(i<16)return{uuid:"",content:null};var a=t.slice(r);return{code:5,uuid:He(a.slice(0,16)),content:He(a.slice(16,i))}}}]),e}(),We=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Ke=function(){function e(){T(this,e)}return We(e,null,[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var n=t.dataview,i=t.position;return 1===n.getInt32(i)||0===n.getInt16(i)&&1===n.getInt8(i+2)?e.getAnnexbNals(t):e.getAvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var n=[],i=e.getHeaderPositionAnnexB(t),r=i.pos,a=r;r<t.length-4;){var s=t.buffer.slice(r,r+i.headerLength);i.pos===t.position&&t.skip(i.headerLength),a=(i=e.getHeaderPositionAnnexB(t)).pos;var o={header:s,body:new Uint8Array(t.buffer.slice(r+s.byteLength,a))};e.analyseNal(o),o.type<=9&&0!==o.type&&n.push(o),t.skip(a-t.position),r=a}return n}},{key:"getAvccNals",value:function(t){for(var n=[];t.position<t.length-4;){var i=t.dataview.getInt32(t.dataview.position);if(!(t.length-t.position>=i))break;var r=t.buffer.slice(t.position,t.position+4);t.skip(4);var a=new Uint8Array(t.buffer.slice(t.position,t.position+i));t.skip(i);var s={header:r,body:a};e.analyseNal(s),s.type<=9&&0!==s.type&&n.push(s)}return n}},{key:"analyseNal",value:function(e){var t=31&e.body[0];switch(e.type=t,t){case 1:e.ndr=!0;break;case 5:e.idr=!0;break;case 6:e.sei=Xe.parse(e.body);break;case 7:e.sps=Ve.parseSPS(e.body);break;case 8:e.pps=!0}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,n=0,i=e.length;3!==n&&4!==n&&t<i-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?n=4:1===e.dataview.getInt8(t+2)?n=3:t++:t++;return t===i-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)&&(n=4):(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?n=3:t=i)),{pos:t,headerLength:n}}},{key:"getAvcc",value:function(e,t){var n=new Uint8Array(e.byteLength+t.byteLength+11);n[0]=1,n[1]=e[1],n[2]=e[2],n[3]=e[3],n[4]=255,n[5]=225;var i=6;return n.set(new Uint8Array([e.byteLength>>>8&255,255&e.byteLength]),i),i+=2,n.set(e,i),i+=e.byteLength,n[i]=1,i++,n.set(new Uint8Array([t.byteLength>>>8&255,255&t.byteLength]),i),i+=2,n.set(t,i),n}}]),e}(),Ye=Ve,qe=Ke,Ze=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Je=function(){function e(t){R(this,e),this.TAG="Golomb",this._buffer=t,this._bufferIndex=0,this._totalBytes=t.byteLength,this._totalBits=8*t.byteLength,this._currentWord=0,this._currentWordBitsLeft=0}return Ze(e,[{key:"destroy",value:function(){this._buffer=null}},{key:"_fillCurrentWord",value:function(){var e=this._totalBytes-this._bufferIndex,t=Math.min(4,e),n=new Uint8Array(4);n.set(this._buffer.subarray(this._bufferIndex,this._bufferIndex+t)),this._currentWord=new DataView(n.buffer).getUint32(0),this._bufferIndex+=t,this._currentWordBitsLeft=8*t}},{key:"readBits",value:function(e){var t=Math.min(this._currentWordBitsLeft,e),n=this._currentWord>>>32-t;if(e>32)throw new Error("Cannot read more than 32 bits at a time");return this._currentWordBitsLeft-=t,this._currentWordBitsLeft>0?this._currentWord<<=t:this._totalBytes-this._bufferIndex>0&&this._fillCurrentWord(),t=e-t,t>0&&this._currentWordBitsLeft?n<<t|this.readBits(t):n}},{key:"readBool",value:function(){return 1===this.readBits(1)}},{key:"readByte",value:function(){return this.readBits(8)}},{key:"_skipLeadingZero",value:function(){var e=void 0;for(e=0;e<this._currentWordBitsLeft;e++)if(0!=(this._currentWord&2147483648>>>e))return this._currentWord<<=e,this._currentWordBitsLeft-=e,e;return this._fillCurrentWord(),e+this._skipLeadingZero()}},{key:"readUEG",value:function(){var e=this._skipLeadingZero();return this.readBits(e+1)-1}},{key:"readSEG",value:function(){var e=this.readUEG();return 1&e?e+1>>>1:-1*(e>>>1)}}]),e}(),Qe=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),$e=function(){function e(){L(this,e)}return Qe(e,null,[{key:"_ebsp2rbsp",value:function(e){for(var t=e,n=t.byteLength,i=new Uint8Array(n),r=0,a=0;a<n;a++)a>=2&&3===t[a]&&0===t[a-1]&&0===t[a-2]||(i[r]=t[a],r++);return new Uint8Array(i.buffer,0,r)}},{key:"parseSPS",value:function(t){var n=e._ebsp2rbsp(t),i=new Je(n),r=0,a=0,s=0,o=0,u=0,l=0,f=0,c=0,h=0,d=0,p=0,v=0,y=0,m=0,g={};return i.readByte(),i.readByte(),i.readBits(4),r=i.readBits(3),i.readBits(1),g=e._readProfileTierLevel(i,r),i.readUEG(),3===(s=i.readUEG())&&(a=i.readBits(1)),o=i.readUEG(),u=i.readUEG(),1===(d=i.readBits(1))&&(l=i.readUEG(),f=i.readUEG(),c=i.readUEG(),h=i.readUEG()),p=i.readUEG(),v=i.readUEG(),1===d&&(o-=(y=1!==s&&2!==s||0!==a?1:2)*f+y*l,u-=(m=1===s&&0===a?2:1)*h+m*c),i.destroy(),i=null,{width:o,height:u,general_profile_space:g.general_profile_space,general_tier_flag:g.general_tier_flag,general_profile_idc:g.general_profile_idc,general_level_idc:g.general_level_idc,chromaFormatIdc:s,bitDepthLumaMinus8:p,bitDepthChromaMinus8:v}}},{key:"_readProfileTierLevel",value:function(e,t){var n=0,i=0,r=0,a=0;n=e.readBits(2)||0,i=e.readBits(1)||0,r=e.readBits(5)||0,e.readBits(16),e.readBits(16),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(16),e.readBits(16),e.readBits(12),a=e.readBits(8)||0;for(var s=[],o=[],u=0;u<t;u++)s[u]=e.readBits(1),o[u]=e.readBits(1);t>0&&e.readBits(2*(8-t));for(var l=0;l<t;l++)0!==s[l]&&(e.readBits(2),e.readBits(1),e.readBits(5),e.readBits(16),e.readBits(16),e.readBits(4),e.readBits(16),e.readBits(16),e.readBits(12)),0!==o[l]&&e.readBits(8);return{general_profile_space:n,general_tier_flag:i,general_profile_idc:r,general_level_idc:a}}},{key:"_skipScalingList",value:function(e,t){for(var n=8,i=8,r=0;r<t;r++)0!==i&&(i=(n+e.readSEG()+256)%256),n=0===i?n:i}},{key:"getProfileString",value:function(e){switch(e){case 66:return"Baseline";case 77:return"Main";case 88:return"Extended";case 100:return"High";case 110:return"High10";case 122:return"High422";case 244:return"High444";default:return"Unknown"}}},{key:"getLevelString",value:function(e){return(e/10).toFixed(1)}},{key:"getChromaFormatString",value:function(e){switch(e){case 420:return"4:2:0";case 422:return"4:2:2";case 444:return"4:4:4";default:return"Unknown"}}},{key:"toVideoMeta",value:function(e){var t={};return e&&e.codec_size&&(t.codecWidth=e.codec_size.width,t.codecHeight=e.codec_size.height,t.presentWidth=e.present_size.width,t.presentHeight=e.present_size.height),t.profile=e.profile_string,t.level=e.level_string,t.bitDepth=e.bit_depth,t.chromaFormat=e.chroma_format,t}}]),e}(),et=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),tt=function(){function e(){D(this,e)}return et(e,null,[{key:"EBSP2RBSP",value:function(e){return e.filter(function(t,n){return n<2||!(0===e[n-2]&&0===e[n-1]&&3===t)})}},{key:"EBSP2SODB",value:function(e){var t=e[e.byteLength-1];return t&&128===t?e.slice(0,e.byteLength-1):e}}]),e}(),nt=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),it=function(e){for(var t="",n=0;n<e.byteLength;n++)t+=String.fromCharCode(e[n]);return t},rt=function(){function e(){B(this,e)}return nt(e,null,[{key:"_resolveNalu",value:function(e){return e.length>=1?tt.EBSP2SODB(tt.EBSP2RBSP(e.slice(1))):null}},{key:"parse",value:function(t){var n=e._resolveNalu(t),i=e.switchPayloadType(n),r=i.payloadType,a=i.offset,s=n.slice(a);switch(r){case 5:return e.user_data_unregistered(s);default:return{code:r,content:s}}}},{key:"switchPayloadType",value:function(e){for(var t=new DataView(e.buffer),n=0,i=0;255===t.getUint8(i);)i++,n+=255;return n+=t.getUint8(i++),{payloadType:n,offset:i}}},{key:"getPayloadLength",value:function(e){for(var t=new DataView(e.buffer),n=0,i=0;255===t.getUint8(i);)i++,n+=255;return n+=t.getUint8(i++),{payloadLength:n,offset:i}}},{key:"user_data_unregistered",value:function(t){var n=e.getPayloadLength(t),i=n.payloadLength,r=n.offset;if(i<16)return{uuid:"",content:null};var a=t.slice(r);return{code:5,uuid:it(a.slice(0,16)),content:it(a.slice(16,i))}}}]),e}(),at=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),st=function(){function e(){O(this,e)}return at(e,null,[{key:"getNalunits",value:function(t){if(t.length-t.position<4)return[];var n=t.dataview,i=t.position;return 1===n.getInt32(i)||0===n.getInt16(i)&&1===n.getInt8(i+2)?e.getAnnexbNals(t):e.getHvccNals(t)}},{key:"getAnnexbNals",value:function(t){for(var n=[],i=e.getHeaderPositionAnnexB(t),r=i.pos,a=r;r<t.length-4;){var s=t.buffer.slice(r,r+i.headerLength);i.pos===t.position&&t.skip(i.headerLength),a=(i=e.getHeaderPositionAnnexB(t)).pos;var o={header:s,body:new Uint8Array(t.buffer.slice(r+s.byteLength,a))};e.analyseNal(o),o.type<=40&&n.push(o),t.skip(a-t.position),r=a}return n}},{key:"getHvccNals",value:function(t){for(var n=[];t.position<t.length-4;){var i=new Uint8Array(t.buffer.slice(0,4)),r=i[0]<<24+i[1]<<16+i[2]<<8+i[3];if(!(t.length-t.position>=r))break;var a=t.buffer.slice(t.position,t.position+4);t.skip(4);var s=t.buffer.slice(t.position,t.position+r);t.skip(r);var o={header:a,body:s};e.analyseNal(o),o.type<=40&&n.push(o)}return n}},{key:"analyseNal",value:function(e){var t=e.body[0]>>>1&63;switch(e.type=t,t){case 0:e.slice_trail_n=!0;break;case 1:e.slice_trail_r=!0,e.key=!0;break;case 2:e.slice_tsa_n=!0;break;case 3:e.slice_tsa_r=!0,e.key=!0;break;case 4:e.slice_stsa_n=!0;break;case 5:e.slice_stsa_r=!0,e.key=!0;break;case 6:e.slice_radl_n=!0;break;case 7:e.slice_radl_r=!0,e.key=!0;break;case 8:e.slice_rasl_n=!0;break;case 9:e.slice_rasl_r=!0,e.key=!0;break;case 16:e.slice_bla_w_lp=!0;break;case 17:e.slice_bla_w_radl=!0;break;case 18:e.slice_bla_n_lp=!0;break;case 19:e.slice_idl_w_radl=!0,e.key=!0;break;case 20:e.slice_idr_n_lp=!0,e.key=!0;break;case 21:e.slice_cra_nut=!0,e.key=!0;break;case 32:e.vps=!0;break;case 33:e.sps=$e.parseSPS(e.body);break;case 34:e.pps=!0;break;case 35:break;case 36:e.aud=!0;break;case 37:e.eob=!0;break;case 38:e.fd=!0;break;case 39:case 40:e.sei=rt.parse(e.body.slice(1))}}},{key:"getHeaderPositionAnnexB",value:function(e){for(var t=e.position,n=0,i=e.length;3!==n&&4!==n&&t<i-4;)0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)?n=4:1===e.dataview.getInt8(t+2)?n=3:t++:t++;return t===i-4&&(0===e.dataview.getInt16(t)?1===e.dataview.getInt16(t+2)&&(n=4):(t++,0===e.dataview.getInt16(t)&&1===e.dataview.getInt8(t)?n=3:t=i)),{pos:t,headerLength:n}}}]),e}(),ot=$e,ut=st,lt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ft=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),ct=function(){function e(){C(this,e),this.id=-1,this.sequenceNumber=0,this.samples=[],this.droppedSamples=[],this.length=0}return ft(e,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0}},{key:"distroy",value:function(){this.reset(),this.id=-1}}]),e}(),ht=function(e){function t(){C(this,t);var e=x(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="AudioTrack",e.type="audio",e}return U(t,e),t}(ct),dt=function(e){function t(){C(this,t);var e=x(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.TAG="VideoTrack",e.type="video",e.dropped=0,e}return U(t,e),ft(t,[{key:"reset",value:function(){this.sequenceNumber=0,this.samples=[],this.length=0,this.dropped=0}}]),t}(ct),pt=(function(){function e(){C(this,e),this.audioTrack=null,this.videoTrack=null}ft(e,[{key:"destroy",value:function(){this.audioTrack=null,this.videoTrack=null}}])}(),function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}()),vt=ke.BROWSER_EVENTS,yt=void 0,mt=void 0;void 0!==document.hidden?(yt="hidden",mt="visibilitychange"):void 0!==document.msHidden?(yt="msHidden",mt="msvisibilitychange"):void 0!==document.webkitHidden&&(yt="webkitHidden",mt="webkitvisibilitychange");!function(){function e(){I(this,e),this.callbacks={onShow:[],onHidden:[]},this.handleVisibilityChange=this.handleVisibilityChange.bind(this),this.init()}pt(e,[{key:"init",value:function(){document.addEventListener(mt,this.handleVisibilityChange,!1)}},{key:"handleVisibilityChange",value:function(){this.emit(vt.VISIBILITY_CHANGE,document[yt])}},{key:"destroy",value:function(){document.removeEventListener(mt,this.handleVisibilityChange)}}])}();var gt=function(){var e=new ArrayBuffer(2);return new DataView(e).setInt16(0,256,!0),256===new Int16Array(e)[0]}(),_t={get device(){var e=_t.os;return e.isPc?"pc":e.isTablet?"tablet":"mobile"},get browser(){var e=navigator.userAgent.toLowerCase(),t={ie:/rv:([\d.]+)\) like gecko/,firfox:/firefox\/([\d.]+)/,chrome:/chrome\/([\d.]+)/,opera:/opera.([\d.]+)/,safari:/version\/([\d.]+).*safari/};return[].concat(Object.keys(t).filter(function(n){return t[n].test(e)}))[0]},get os(){var e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),n=/(?:SymbianOS)/.test(e)||t,i=/(?:Android)/.test(e),r=/(?:Firefox)/.test(e),a=/(?:iPad|PlayBook)/.test(e)||i&&!/(?:Mobile)/.test(e)||r&&/(?:Tablet)/.test(e),s=/(?:iPhone)/.test(e)&&!a;return{isTablet:a,isPhone:s,isAndroid:i,isPc:!s&&!i&&!n,isSymbian:n,isWindowsPhone:t,isFireFox:r}},get isLe(){return gt}},bt=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),kt=function(){function e(){M(this,e)}return bt(e,null,[{key:"decode",value:function(t){for(var n=[],i=t,r=0,a=t.length;r<a;)if(i[r]<128)n.push(String.fromCharCode(i[r])),++r;else{if(i[r]<192);else if(i[r]<224){if(e._checkContinuation(i,r,1)){var s=(31&i[r])<<6|63&i[r+1];if(s>=128){n.push(String.fromCharCode(65535&s)),r+=2;continue}}}else if(i[r]<240){if(e._checkContinuation(i,r,2)){var o=(15&i[r])<<12|(63&i[r+1])<<6|63&i[r+2];if(o>=2048&&55296!=(63488&o)){n.push(String.fromCharCode(65535&o)),r+=3;continue}}}else if(i[r]<248&&e._checkContinuation(i,r,3)){var u=(7&i[r])<<18|(63&i[r+1])<<12|(63&i[r+2])<<6|63&i[r+3];if(u>65536&&u<1114112){u-=65536,n.push(String.fromCharCode(u>>>10|55296)),n.push(String.fromCharCode(1023&u|56320)),r+=4;continue}}n.push(String.fromCharCode(65533)),++r}return n.join("")}},{key:"_checkContinuation",value:function(e,t,n){var i=e;if(t+n<i.length){for(;n--;)if(128!=(192&i[++t]))return!1;return!0}return!1}}]),e}(),Et=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),wt=_t.isLe,St={NUMBER:0,BOOLEAN:1,STRING:2,OBJECT:3,MIX_ARRAY:8,OBJECT_END:9,STRICT_ARRAY:10,DATE:11,LONE_STRING:12},At=function(){function e(){P(this,e),this.offset=0,this.readOffset=this.offset}return Et(e,[{key:"resolve",value:function(e,t){if(t<3)throw new Error("not enough data for metainfo");var n={},i=this.parseValue(e),r=this.parseValue(e,t-i.bodySize);return n[i.data]=r.data,this.resetStatus(),n}},{key:"resetStatus",value:function(){this.offset=0,this.readOffset=this.offset}},{key:"parseString",value:function(e){var t=new DataView(e,this.readOffset).getUint16(0,!wt),n="";n=t>0?kt.decode(new Uint8Array(e,this.readOffset+2,t)):"";var i=t+2;return this.readOffset+=i,{data:n,bodySize:t+2}}},{key:"parseDate",value:function(e,t){var n=new DataView(e,this.readOffset,t),i=n.getFloat64(0,!wt);return i+=60*n.getInt16(8,!wt)*1e3,this.readOffset+=10,{data:new Date(i),bodySize:10}}},{key:"parseObject",value:function(e,t){var n=this.parseString(e,t),i=this.parseValue(e,t-n.bodySize);return{data:{name:n.data,value:i.data},bodySize:n.bodySize+i.bodySize,isObjEnd:i.isObjEnd}}},{key:"parseLongString",value:function(e){var t=new DataView(e,this.readOffset).getUint32(0,!wt),n="";return n=t>0?kt.decode(new Uint8Array(e,this.readOffset+2,t)):"",this.readOffset+=t+4,{data:n,bodySize:t+4}}},{key:"parseValue",value:function(e,t){var n=new ArrayBuffer;n=e instanceof ArrayBuffer?e:e.buffer;var i=St.NUMBER,r=St.BOOLEAN,a=St.STRING,s=St.OBJECT,o=St.MIX_ARRAY,u=St.OBJECT_END,l=St.STRICT_ARRAY,f=St.DATE,c=St.LONE_STRING,h=new DataView(n,this.readOffset,t),d=!1,p=h.getUint8(0),v=1;this.readOffset+=1;var y=null;switch(p){case i:y=h.getFloat64(1,!wt),this.readOffset+=8,v+=8;break;case r:y=!!h.getUint8(1),this.readOffset+=1,v+=1;break;case a:var m=this.parseString(n);y=m.data,v+=m.bodySize;break;case s:y={};var g=0;for(16777215&h.getUint32(t-4,!wt)&&(g=3);v<t-4;){var _=this.parseObject(n,t-v-g);if(_.isObjectEnd)break;y[_.data.name]=_.data.value,v+=_.bodySize}v<=t-3&&9===(16777215&h.getUint32(v-1,!wt))&&(this.readOffset+=3,v+=3);break;case o:y={},v+=4,this.readOffset+=4;var b=0;for(9==(16777215&h.getUint32(t-4,!wt))&&(b=3);v<t-8;){var k=this.parseObject(n,t-v-b);if(k.isObjectEnd)break;y[k.data.name]=k.data.value,v+=k.bodySize}v<=t-3&&9===(16777215&h.getUint32(v-1,!wt))&&(v+=3,this.readOffset+=3);break;case u:y=null,d=!0;break;case l:y=[];var E=h.getUint32(1,!wt);v+=4,this.readOffset+=4;for(var w=0;w<E;w++){var S=this.parseValue(n,t-v);y.push(S.data),v+=S.bodySize}break;case f:var A=this.parseDate(n,t-1);y=A.data,v+=A.bodySize;break;case c:var T=this.parseLongString(n,t-1);y=T.data,v+=T.bodySize;break;default:v=t}return{data:y,bodySize:v,isObjEnd:d}}}]),e}(),Tt=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Rt=function(){function e(t){if(N(this,e),!(t instanceof ArrayBuffer))throw new Error("data is invalid");this.buffer=t,this.dataview=new DataView(t),this.dataview.position=0}return Tt(e,[{key:"back",value:function(e){this.position-=e}},{key:"skip",value:function(t){for(var n=Math.floor(t/4),i=t%4,r=0;r<n;r++)e.readByte(this.dataview,4);i>0&&e.readByte(this.dataview,i)}},{key:"readUint8",value:function(){return e.readByte(this.dataview,1)}},{key:"readUint16",value:function(){return e.readByte(this.dataview,2)}},{key:"readUint24",value:function(){return e.readByte(this.dataview,3)}},{key:"readUint32",value:function(){return e.readByte(this.dataview,4)}},{key:"readUint64",value:function(){return e.readByte(this.dataview,8)}},{key:"readInt8",value:function(){return e.readByte(this.dataview,1,!0)}},{key:"readInt16",value:function(){return e.readByte(this.dataview,2,!0)}},{key:"readInt32",value:function(){return e.readByte(this.dataview,4,!0)}},{key:"writeUint32",value:function(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}},{key:"length",get:function(){return this.buffer.byteLength}},{key:"position",set:function(e){this.dataview.position=e},get:function(){return this.dataview.position}}],[{key:"readByte",value:function(e,t,n){var i=void 0;switch(t){case 1:i=n?e.getInt8(e.position):e.getUint8(e.position);break;case 2:i=n?e.getInt16(e.position):e.getUint16(e.position);break;case 3:if(n)throw new Error("not supported for readByte 3");i=e.getUint8(e.position)<<16,i|=e.getUint8(e.position+1)<<8,i|=e.getUint8(e.position+2);break;case 4:i=n?e.getInt32(e.position):e.getUint32(e.position);break;case 8:if(n)throw new Error("not supported for readBody 8");i=e.getUint32(e.position)<<32,i|=e.getUint32(e.position+4);break;default:i=""}return e.position+=t,i}}]),e}(),Lt=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Dt=ke.DEMUX_EVENTS,Bt=function(){function e(){F(this,e),this._firstFragmentLoaded=!1,this._trackNum=0,this._hasScript=!1,this._videoMetaChange=!1,this._audioMetaChange=!1}return Lt(e,[{key:"init",value:function(){this.on(Dt.DEMUX_START,this.doParseFlv.bind(this))}},{key:"doParseFlv",value:function(){if(this._firstFragmentLoaded){if(this.loaderBuffer.length<11)return;var e=void 0,t=1e4;do{e=this._parseFlvTag()}while(e&&t-- >0);this.emit(Dt.DEMUX_COMPLETE)}else{if(this.loaderBuffer.length<13)return;var n=this.loaderBuffer.shift(13);this.parseFlvHeader(n),this.doParseFlv()}}},{key:"parseFlvHeader",value:function(t){e.isFlvFile(t)?(this._firstFragmentLoaded=!0,this.initVideoTrack(),this.initAudioTrack()):(this.emit(Dt.DEMUX_ERROR,new Error("invalid flv file")),this.doParseFlv()),this.doParseFlv()}},{key:"initVideoTrack",value:function(){this._trackNum++;var e=new dt;e.meta=new Me,e.id=e.meta.id=this._trackNum,this.tracks.videoTrack=e}},{key:"initAudioTrack",value:function(){this._trackNum++;var e=new ht;e.meta=new Ie,e.id=e.meta.id=this._trackNum,this.tracks.audioTrack=e}},{key:"_parseFlvTag",value:function(){if(this.loaderBuffer.length<11)return null;var e=this._parseFlvTagHeader();return e&&this._processChunk(e),e}},{key:"_parseFlvTagHeader",value:function(){var e=0,t={},n=this.loaderBuffer.toInt(e,1);if(e+=1,t.filtered=(32&n)>>>5,t.tagType=31&n,t.datasize=this.loaderBuffer.toInt(e,3),e+=3,8!==t.tagType&&9!==t.tagType&&11!==t.tagType&&18!==t.tagType||0!==this.loaderBuffer.toInt(8,3))return this.loaderBuffer&&this.loaderBuffer.length>0&&this.loaderBuffer.shift(1),this.emit(Dt.DEMUX_ERROR,this.TAG,new Error("tagType "+t.tagType),!1),null;if(this.loaderBuffer.length<t.datasize+15)return null;this.loaderBuffer.shift(4);var i=this.loaderBuffer.toInt(0,3);this.loaderBuffer.shift(3);var r=this.loaderBuffer.shift(1)[0];return r>0&&(i+=16777216*r),t.dts=i,this.loaderBuffer.shift(3),t}},{key:"_processChunk",value:function(e){switch(e.tagType){case 18:this._parseScriptData(e);break;case 8:this._parseAACData(e);break;case 9:this._parseHevcData(e);break;case 11:this.loaderBuffer.shift(3);break;default:this.loaderBuffer.shift(1)}}},{key:"_parseScriptData",value:function(e){var t=this.tracks.audioTrack,n=this.tracks.videoTrack,i=this.loaderBuffer.shift(e.datasize),r=(new At).resolve(i,i.length),a=this._context.onMetaData=r?r.onMetaData:void 0;if(this._context.mediaInfo.duration=a.duration,this._context.mediaInfo.hasVideo=a.hasVideo,this._context.mediaInfo.hsaAudio=a.hasAudio,this._datasizeValidator(e.datasize)&&(this.emit(Dt.MEDIA_INFO),this._hasScript=!0),t&&!t.hasSpecificConfig){var s=t.meta;switch(a.audiosamplerate&&(s.sampleRate=a.audiosamplerate),a.audiochannels&&(s.channelCount=a.audiochannels),a.audiosamplerate){case 44100:s.sampleRateIndex=4;break;case 22050:s.sampleRateIndex=7;break;case 11025:s.sampleRateIndex=10}}if(n&&!n.hasSpecificConfig){var o=n.meta;if("number"==typeof a.framerate){var u=Math.floor(1e3*a.framerate);if(u>0){var l=u/1e3;o.frameRate||(o.frameRate={}),o.frameRate.fixed=!0,o.frameRate.fps=l,o.frameRate.fps_num=u,o.frameRate.fps_den=1e3}}}}},{key:"_aacSequenceHeaderParser",value:function(e){var t={};t.hasSpecificConfig=!0,t.objectType=e[1]>>>3,t.sampleRateIndex=(7&e[1])<<1|e[2]>>>7,t.audiosamplerate=this._switchAudioSampleRate(t.sampleRateIndex),t.channelCount=(120&e[2])>>>3,t.frameLength=(4&e[2])>>>2,t.dependsOnCoreCoder=(2&e[2])>>>1,t.extensionFlagIndex=1&e[2];var n=window.navigator.userAgent.toLowerCase(),i=void 0,r=void 0,a=t.sampleRateIndex;return-1!==n.indexOf("firefox")?t.sampleRateIndex>=6?(t.objectType=5,r=new Array(4),i=a-3):(t.objectType=2,r=new Array(2),i=a):-1!==n.indexOf("android")||-1!==n.indexOf("safari")?(t.objectType=2,r=new Array(2),i=a):(t.objectType=5,i=t.sampleRateIndex,r=new Array(4),t.sampleRateIndex>=6?i=t.sampleRateIndex-3:1===t.channelCount&&(t.objectType=2,r=new Array(2),i=t.sampleRateIndex)),t.codec="mp4a.40."+t.objectType,r[0]=t.objectType<<3,r[0]|=(15&t.sampleRateIndex)>>>1,r[1]=(15&t.sampleRateIndex)<<7,r[1]|=(15&t.channelCount)<<3,5===t.objectType&&(r[1]|=(15&i)>>>1,r[2]=(1&i)<<7,r[2]|=8,r[3]=0),t.config=r,t}},{key:"_parseAACData",value:function(e){var t=this.tracks.audioTrack;if(t){var n=t.meta;n||(t.meta=new Ie,n=t.meta);var i=this.loaderBuffer.shift(1)[0];e.data=this.loaderBuffer.shift(e.datasize-1);var r=(240&i)>>>4;t.format=r,10!==r&&this.emit(Dt.DEMUX_ERROR,new Error("invalid audio format: "+r)),10!==r||this._hasAudioSequence||(n.sampleRate=this._switchAudioSamplingFrequency(i),n.sampleRateIndex=(12&i)>>>2,n.frameLenth=(2&i)>>>1,n.channelCount=1&i,n.refSampleDuration=Math.floor(1024/n.audioSampleRate*n.timescale));var a=n.audioSampleRate,s=n.sampleRateIndex,o=n.refSampleDuration;delete e.tagType;var u=this._datasizeValidator(e.datasize);if(0===e.data[0]){var l=this._aacSequenceHeaderParser(e.data);a=l.audiosamplerate||n.audioSampleRate,s=l.sampleRateIndex||n.sampleRateIndex,o=Math.floor(1024/a*n.timescale),n.channelCount=l.channelCount,n.sampleRate=a,n.sampleRateIndex=s,n.refSampleDuration=o,n.duration=this._context.mediaInfo.duration*n.timescale,n.config=l.config,n.objectType=l.objectType;var f=this._context.mediaInfo.audio;f.codec=l.codec,f.channelCount=l.channelCount,f.sampleRate=a,f.sampleRateIndex=l.audioSampleRateIndex,this._hasAudioSequence?this.emit(Dt.AUDIO_METADATA_CHANGE):this.emit(Dt.METADATA_PARSED,"audio"),this._hasAudioSequence=!0,this._audioMetaChange=!0}else this._audioMetaChange&&(e.options={meta:t.meta},this._audioMetaChange=!1),e.data=e.data.slice(1,e.data.length),t.samples.push(e);u||this.emit(Dt.DEMUX_ERROR,this.TAG,new Error("TAG length error at "+e.datasize),!1)}}},{key:"_parseHevcData",value:function(e){var t=this.loaderBuffer.shift(1)[0];e.frameType=(240&t)>>>4,e.isKeyframe=1===e.frameType;var n=15&t;if(this.tracks.videoTrack.codecID=n,e.avcPacketType=this.loaderBuffer.shift(1)[0],e.cts=this.loaderBuffer.toInt(0,3),this.loaderBuffer.shift(3),7===n||12===n){var i=this.loaderBuffer.shift(e.datasize-5);if(0===i[4]&&0===i[5]&&0===i[6]&&1===i[7]){for(var r=0,a=0;a<4;a++)r=256*r+i[a];r-=4,(i=i.slice(4,i.length))[3]=r%256,r=(r-i[3])/256,i[2]=r%256,r=(r-i[2])/256,i[1]=r%256,i[0]=(r-i[1])/256}if(e.data=i,0===e.avcPacketType)12===n?this._hevcSequenceHeaderParser(e.data):this._avcSequenceHeaderParser(e.data),this._datasizeValidator(e.datasize)&&(this._hasVideoSequence?this.emit(Dt.VIDEO_METADATA_CHANGE):this.emit(Dt.METADATA_PARSED,"video"),this._hasVideoSequence=!0),this._videoMetaChange=!0;else{if(!this._datasizeValidator(e.datasize))return void this.emit(Dt.DEMUX_ERROR,this.TAG,new Error("invalid video tag datasize: "+e.datasize),!1);for(var s=12===n?ut.getHvccNals(new Rt(e.data.buffer)):qe.getAvccNals(new Rt(e.data.buffer)),o=0;o<s.length;o++){var u=s[o];12===n?ut.analyseNal(u):qe.analyseNal(u),u.sei&&this.emit(Dt.SEI_PARSED,Object.assign(u.sei,{dts:e.dts}))}this.tracks.videoTrack.meta.streamType=12===n?36:27,this._videoMetaChange&&(e.options={meta:Object.assign({},this.tracks.videoTrack.meta)},this._videoMetaChange=!1),this.tracks.videoTrack.samples.push(e)}}else this.emit(Dt.DEMUX_ERROR,this.TAG,new Error("video codeid is "+n),!1),e.data=this.loaderBuffer.shift(e.datasize-1),this._datasizeValidator(e.datasize)||this.emit(Dt.DEMUX_ERROR,this.TAG,new Error("invalid video tag datasize: "+e.datasize),!1),this.tracks.videoTrack.samples.push(e),this.emit(Dt.DEMUX_COMPLETE);delete e.tagType}},{key:"_avcSequenceHeaderParser",value:function(e){var t=this.tracks.videoTrack;if(t){var n=0;t.meta||(t.meta=new Me);var i=t.meta;i.configurationVersion=e[0],i.avcProfileIndication=e[1],i.profileCompatibility=e[2],i.avcLevelIndication=e[3]/10,i.nalUnitLength=1+(3&e[4]);var r=31&e[5];n=6;for(var a={},s=0;s<r;s++){var o=255*e[n]+e[n+1];n+=2;for(var u=new Uint8Array(o),l=0;l<o;l++)u[l]=e[n+l];for(var f="avc1.",c=1;c<4;c++){var h=u[c].toString(16);h.length<2&&(h="0"+h),f+=h}i.codec=f,n+=o,this.tracks.videoTrack.meta.sps=u,a=Ye.parseSPS(u)}var d=e[n];n++;for(var p=0;p<d;p++){var v=255*e[n]+e[n+1];n+=2;for(var y=new Uint8Array(v),m=0;m<v;m++)y[m]=e[n+m];n+=v,this.tracks.videoTrack.meta.pps=y}Object.assign(i,Ye.toVideoMeta(a));var g=this._context.mediaInfo.video;g.codec=i.codec,g.profile=i.profile,g.level=i.level,g.chromaFormat=i.chromaFormat,g.frameRate=i.frameRate,g.parRatio=i.parRatio,g.width=g.width===i.presentWidth?g.width:i.presentWidth,g.height=g.height===i.presentHeight?g.width:i.presentHeight,i.duration=this._context.mediaInfo.duration*i.timescale,i.avcc=new Uint8Array(e.length),i.avcc.set(e),i.streamType=27,t.meta=i}}},{key:"_hevcSequenceHeaderParser",value:function(e){var t=this.tracks.videoTrack;if(t){var n=0;t.meta||(t.meta=new Me);var i=t.meta;i.configurationVersion=e[0],i.hevcProfileSpace=(192&e[1])>>>6,i.hevcTierFlag=(32&e[1])>>>5,i.hevcProfileIdc=31&e[1],i.hevcProfileCompatibilityFlags=[e[2],e[3],e[4],e[5]],i.hevcConstraintIndicatorFlags=[e[6],e[7],e[8],e[9],e[10],e[11]],i.hevcLevelIdc=e[12],i.minSpatialSegmentationIdc=e[13]&15+e[14]<<4,i.parallelismType=3&e[15],i.chromaFormat=3&e[16],i.bitDepthLumaMinus8=7&e[17],i.bitDepthChromaMinus8=7&e[18],i.avgFrameRate=256*e[19]+e[20],i.constantFrameRate=(192&e[21])>>>6,i.numTemporalLayers=(56&e[21])>>>3,i.temporalIdNested=(4&e[21])>>>2,i.lengthSizeMinusOne=3&e[21];var r=e[22];n=23;for(var a={},s=0,o=0,u=0,l=!1,f=!1,c=!1,h=void 0,d=void 0,p=void 0,v=0;v<r;v++){s=63&e[n],o=256*e[n+1]+e[n+2],n+=3;for(var y=0;y<o;y++){switch(u=256*e[n]+e[n+1],s){case 32:l||(l=!0,h=e.slice(n+2,n+2+u),this.tracks.videoTrack.meta.vps=ot._ebsp2rbsp(h));break;case 33:f||(f=!0,d=e.slice(n+2,n+2+u),this.tracks.videoTrack.meta.sps=ot._ebsp2rbsp(d),i.codec="hev1.1.6.L93.B0",a=ot.parseSPS(d));break;case 34:c||(c=!0,p=e.slice(n+2,n+2+u),this.tracks.videoTrack.meta.pps=ot._ebsp2rbsp(p))}n+=2+u}}Object.assign(i,ot.toVideoMeta(a));var m=this._context.mediaInfo.video;m.codec=i.codec,m.profile=i.profile,m.level=i.level,m.chromaFormat=i.chromaFormat,m.frameRate=i.frameRate,m.parRatio=i.parRatio,m.width=m.width===i.presentWidth?m.width:i.presentWidth,m.height=m.height===i.presentHeight?m.width:i.presentHeight,i.duration=this._context.mediaInfo.duration*i.timescale,i.streamType=36,t.meta=i}}},{key:"_switchAudioSampleRate",value:function(e){return[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350][e]}},{key:"_switchAudioSamplingFrequency",value:function(e){return[5500,11025,22050,44100,48e3][(12&e)>>>2]}},{key:"_switchAudioChannel",value:function(e){return[1,2][1&e]}},{key:"_datasizeValidator",value:function(e){var t=this.loaderBuffer.toInt(0,4);return this.loaderBuffer.shift(4),t===e+11}},{key:"loaderBuffer",get:function(){var e=this._context.getInstance("LOADER_BUFFER");if(e)return e;this.emit(Dt.DEMUX_ERROR,new Error("找不到 loaderBuffer 实例"))}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"logger",get:function(){return this._context.getInstance("LOGGER")}}],[{key:"isFlvFile",value:function(e){return!(70!==e[0]||76!==e[1]||86!==e[2]||1!==e[3])}},{key:"getPlayType",value:function(e){var t={hasVideo:!1,hasAudio:!1};return!0&e&&(t.hasVideo=!0),!0&e&&(t.hasAudio=!0),t}}]),e}(),Ot=j(function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){for(var t=0,n=arguments.length,i=Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];var a=!0,s=!1,o=void 0;try{for(var u,l=i[Symbol.iterator]();!(a=(u=l.next()).done);a=!0)t+=u.value.length}catch(e){s=!0,o=e}finally{try{!a&&l.return&&l.return()}finally{if(s)throw o}}var f=new e(t),c=0,h=!0,d=!1,p=void 0;try{for(var v,y=i[Symbol.iterator]();!(h=(v=y.next()).done);h=!0){var m=v.value;f.set(m,c),c+=m.length}}catch(e){d=!0,p=e}finally{try{!h&&y.return&&y.return()}finally{if(d)throw p}}return f}});V(Ot);var xt=V(j(function(e){var t=function(e){return e&&e.__esModule?e:{default:e}}(Ot);e.exports=t.default})),Ut=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Ct=function(){function e(t){G(this,e),this.buffer=t||new Uint8Array(0)}return Ut(e,[{key:"write",value:function(){for(var e=this,t=arguments.length,n=Array(t),i=0;i<t;i++)n[i]=arguments[i];n.forEach(function(t){e.buffer=xt(Uint8Array,e.buffer,t)})}}],[{key:"writeUint32",value:function(e){return new Uint8Array([e>>24,e>>16&255,e>>8&255,255&e])}},{key:"readAsInt",value:function(e){function t(e){return e.toString(16).padStart(2,"0")}var n="";return e.forEach(function(e){n+=t(e)}),parseInt(n,16)}}]),e}(),It=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Mt=function(){function e(){z(this,e)}return It(e,null,[{key:"size",value:function(e){return Ct.writeUint32(e)}},{key:"initBox",value:function(t,n){for(var i=new Ct,r=arguments.length,a=Array(r>2?r-2:0),s=2;s<r;s++)a[s-2]=arguments[s];return i.write.apply(i,[e.size(t),e.type(n)].concat(a)),i.buffer}},{key:"extension",value:function(e,t){return new Uint8Array([e,t>>16&255,t>>8&255,255&t])}},{key:"ftyp",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,97,118,99,49]))}},{key:"ftypHEVC",value:function(){return e.initBox(24,"ftyp",new Uint8Array([105,115,111,109,0,0,0,1,105,115,111,109,100,97,115,104]))}},{key:"moov",value:function(t){var n=t.type,i=t.meta,r=8,a=e.mvhd(i.duration,i.timescale),s=void 0;s="video"===n?e.videoTrak(i):e.audioTrak(i);var o=e.mvex(i.duration,i.timescale||1e3,i.id);return[a,s,o].forEach(function(e){r+=e.byteLength}),e.initBox(r,"moov",a,s,o)}},{key:"mvhd",value:function(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,i=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,n>>>24&255,n>>>16&255,n>>>8&255,255&n,t>>>24&255,t>>>16&255,t>>>8&255,255&t,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return e.initBox(8+i.length,"mvhd",new Uint8Array(i))}},{key:"videoTrak",value:function(t){var n=8,i=e.tkhd({id:1,duration:t.duration,timescale:t.timescale||1e3,width:t.presentWidth,height:t.presentHeight,type:"video"}),r=e.mdia({type:"video",timescale:t.timescale||1e3,duration:t.duration,avcc:t.avcc,parRatio:t.parRatio,width:t.presentWidth,height:t.presentHeight,streamType:t.streamType});return[i,r].forEach(function(e){n+=e.byteLength}),e.initBox(n,"trak",i,r)}},{key:"audioTrak",value:function(t){var n=8,i=e.tkhd({id:2,duration:t.duration,timescale:t.timescale||1e3,width:0,height:0,type:"audio"}),r=e.mdia({type:"audio",timescale:t.timescale||1e3,duration:t.duration,channelCount:t.channelCount,samplerate:t.sampleRate,config:t.config});return[i,r].forEach(function(e){n+=e.byteLength}),e.initBox(n,"trak",i,r)}},{key:"tkhd",value:function(t){var n=t.id,i=t.duration,r=t.width,a=t.height,s=new Uint8Array([0,0,0,7,0,0,0,0,0,0,0,0,n>>>24&255,n>>>16&255,n>>>8&255,255&n,0,0,0,0,i>>>24&255,i>>>16&255,i>>>8&255,255&i,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,r>>>8&255,255&r,0,0,a>>>8&255,255&a,0,0]);return e.initBox(8+s.byteLength,"tkhd",s)}},{key:"edts",value:function(t){var n=new Ct,i=t.duration,r=t.mediaTime;return n.write(e.size(36),e.type("edts")),n.write(e.size(28),e.type("elst")),n.write(new Uint8Array([0,0,0,1,i>>24&255,i>>16&255,i>>8&255,255&i,r>>24&255,r>>16&255,r>>8&255,255&r,0,0,0,1])),n.buffer}},{key:"mdia",value:function(t){var n=8,i=e.mdhd(t.timescale,t.duration),r=e.hdlr(t.type),a=e.minf(t);return[i,r,a].forEach(function(e){n+=e.byteLength}),e.initBox(n,"mdia",i,r,a)}},{key:"mdhd",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,n=arguments[1],i=new Uint8Array([0,0,0,0,0,0,0,0,t>>>24&255,t>>>16&255,t>>>8&255,255&t,n>>>24&255,n>>>16&255,n>>>8&255,255&n,85,196,0,0]);return e.initBox(12+i.byteLength,"mdhd",e.extension(0,0),i)}},{key:"hdlr",value:function(t){var n=[0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0];return"audio"===t&&(n.splice.apply(n,[8,4].concat([115,111,117,110])),n.splice.apply(n,[24,13].concat([83,111,117,110,100,72,97,110,100,108,101,114,0]))),e.initBox(8+n.length,"hdlr",new Uint8Array(n))}},{key:"minf",value:function(t){var n=8,i="video"===t.type?e.vmhd():e.smhd(),r=e.dinf(),a=e.stbl(t);return[i,r,a].forEach(function(e){n+=e.byteLength}),e.initBox(n,"minf",i,r,a)}},{key:"vmhd",value:function(){return e.initBox(20,"vmhd",new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]))}},{key:"smhd",value:function(){return e.initBox(16,"smhd",new Uint8Array([0,0,0,0,0,0,0,0]))}},{key:"dinf",value:function(){var t=new Ct,n=[0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1];return t.write(e.size(36),e.type("dinf"),e.size(28),e.type("dref"),new Uint8Array(n)),t.buffer}},{key:"stbl",value:function(t){var n=8,i=e.stsd(t),r=e.stts(),a=e.stsc(),s=e.stsz(),o=e.stco();return[i,r,a,s,o].forEach(function(e){n+=e.byteLength}),e.initBox(n,"stbl",i,r,a,s,o)}},{key:"stsd",value:function(t){var n=void 0;return n="audio"===t.type?e.mp4a(t):36===t.streamType?e.hvc1(t):e.avc1(t),e.initBox(16+n.byteLength,"stsd",e.extension(0,0),new Uint8Array([0,0,0,1]),n)}},{key:"mp4a",value:function(t){var n=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,t.channelCount,0,16,0,0,0,0,t.samplerate>>8&255,255&t.samplerate,0,0]),i=e.esds(t.config);return e.initBox(8+n.byteLength+i.byteLength,"mp4a",n,i)}},{key:"esds",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[43,146,8,0],n=t.length,i=new Ct,r=new Uint8Array([0,0,0,0,3,23+n,0,1,0,4,15+n,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([n]).concat(t).concat([6,1,2]));return i.write(e.size(8+r.byteLength),e.type("esds"),r),i.buffer}},{key:"avc1",value:function(t){var n=new Ct,i=t.width,r=t.height,a=t.parRatio.height,s=t.parRatio.width,o=t.avcc,u=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,i>>8&255,255&i,r>>8&255,255&r,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),l=new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192]),f=new Uint8Array([a>>24,a>>16&255,a>>8&255,255&a,s>>24,s>>16&255,s>>8&255,255&s]);return n.write(e.size(40+u.byteLength+o.byteLength+l.byteLength),e.type("avc1"),u,e.size(8+o.byteLength),e.type("avcC"),o,e.size(20),e.type("btrt"),l,e.size(16),e.type("pasp"),f),n.buffer}},{key:"hvc1",value:function(t){var n=new Ct,i=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,t.width>>8&255,255&t.width,t.height>>8&255,255&t.height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,255,255,0,0,0,122,104,118,99,67,1,1,96,0,0,0,144,0,0,0,0,0,93,240,0,252,253,248,248,0,0,15,3,160,0,1,0,24,64,1,12,1,255,255,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,153,152,9,161,0,1,0,45,66,1,1,1,96,0,0,3,0,144,0,0,3,0,0,3,0,93,160,2,128,128,45,22,89,153,164,147,43,154,128,128,128,130,0,0,3,0,2,0,0,3,0,50,16,162,0,1,0,7,68,1,193,114,180,98,64]);return n.write(e.size(8+i.byteLength+10),e.type("hvc1"),i,e.size(10),e.type("fiel"),new Uint8Array([1,0])),n.buffer}},{key:"stts",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stts",t)}},{key:"stsc",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stsc",t)}},{key:"stco",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0]);return e.initBox(16,"stco",t)}},{key:"stsz",value:function(){var t=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]);return e.initBox(20,"stsz",t)}},{key:"mvex",value:function(t){var n=arguments[2],i=new Ct,r=Ct.writeUint32(t);return i.write(e.size(56),e.type("mvex"),e.size(16),e.type("mehd"),e.extension(0,0),r,e.trex(n)),i.buffer}},{key:"trex",value:function(t){var n=new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,255&t,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]);return e.initBox(8+n.byteLength,"trex",n)}},{key:"moof",value:function(t){var n=8,i=e.mfhd(),r=e.traf(t);return[i,r].forEach(function(e){n+=e.byteLength}),e.initBox(n,"moof",i,r)}},{key:"mfhd",value:function(){var t=Ct.writeUint32(e.sequence);return e.sequence+=1,e.initBox(16,"mfhd",e.extension(0,0),t)}},{key:"traf",value:function(t){var n=8,i=e.tfhd(t.id),r=e.tfdt(t.time),a=e.sdtp(t),s=e.trun(t,a.byteLength);return[i,r,s,a].forEach(function(e){n+=e.byteLength}),e.initBox(n,"traf",i,r,s,a)}},{key:"tfhd",value:function(t){var n=Ct.writeUint32(t);return e.initBox(16,"tfhd",e.extension(0,0),n)}},{key:"tfdt",value:function(t){return e.initBox(16,"tfdt",e.extension(0,0),Ct.writeUint32(t))}},{key:"trun",value:function(t,n){var i=new Ct,r=Ct.writeUint32(t.samples.length),a=Ct.writeUint32(92+16*t.samples.length+n);return i.write(e.size(20+16*t.samples.length),e.type("trun"),new Uint8Array([0,0,15,1]),r,a),t.samples.forEach(function(e){var t=e.flags;i.write(new Uint8Array([e.duration>>>24&255,e.duration>>>16&255,e.duration>>>8&255,255&e.duration,e.size>>>24&255,e.size>>>16&255,e.size>>>8&255,255&e.size,t.isLeading<<2|t.dependsOn,t.isDependedOn<<6|t.hasRedundancy<<4|t.isNonSync,0,0,e.cts>>>24&255,e.cts>>>16&255,e.cts>>>8&255,255&e.cts]))}),i.buffer}},{key:"sdtp",value:function(t){var n=new Ct;return n.write(e.size(12+t.samples.length),e.type("sdtp"),e.extension(0,0)),t.samples.forEach(function(e){var t=e.flags,i=t.isLeading<<6|t.dependsOn<<4|t.isDependedOn<<2|t.hasRedundancy;n.write(new Uint8Array([i]))}),n.buffer}},{key:"mdat",value:function(t){var n=new Ct,i=8;t.samples.forEach(function(e){i+=e.size}),n.write(e.size(i),e.type("mdat"));var r=new Uint8Array(i),a=0;return r.set(n.buffer,a),a+=8,t.samples.forEach(function(e){e.buffer.forEach(function(e){r.set(e,a),a+=e.byteLength})}),r}}]),e}();Mt.type=function(e){return new Uint8Array([e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)])},Mt.sequence=1;var Pt=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Nt=ke.REMUX_EVENTS,Ft=ke.PLAYER_EVENTS,Vt=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;H(this,e),this._dtsBase=1e3*t,this._audioDtsBase=null,this._videoDtsBase=null,this._isDtsBaseInited=!1;var n=_t.browser;this._fillSilenceFrame="ie"===n,this.isFirstVideo=!0,this.isFirstAudio=!0,this.videoAllDuration=0,this.audioAllDuration=0,this.audioRemuxed=0,this.videoRemuxed=0}return Pt(e,[{key:"init",value:function(){this.on(Nt.REMUX_MEDIA,this.remux.bind(this)),this.on(Nt.REMUX_METADATA,this.onMetaDataReady.bind(this)),this.on(Nt.DETECT_CHANGE_STREAM,this.resetDtsBase.bind(this)),this.on(Ft.SEEK,this.seek.bind(this))}},{key:"destroy",value:function(){this._dtsBase=-1,this._isDtsBaseInited=!1}},{key:"remux",value:function(){var e=this._context.getInstance("TRACKS"),t=e.audioTrack,n=e.videoTrack;!this._isDtsBaseInited&&this.calcDtsBase(t,n),this._remuxVideo(n),this._remuxAudio(t)}},{key:"resetDtsBase",value:function(){this._dtsBase=0}},{key:"seek",value:function(e){this._isDtsBaseInited?(this._isDtsBaseInited=!1,this._dtsBase=1e3*e):this._dtsBase=1e3*e,this._audioDtsBase=this._videoDtsBase=null}},{key:"onMetaDataReady",value:function(e){var t=void 0;t="audio"===e?this._context.getInstance("TRACKS").audioTrack:this._context.getInstance("TRACKS").videoTrack;var n=this._context.getInstance("PRE_SOURCE_BUFFER"),i=n.getSource(e);i||(i=n.createSource(e)),i.mimetype=t.meta.codec,i.init=this.remuxInitSegment(e,t.meta),this.emit(Nt.INIT_SEGMENT,e)}},{key:"remuxInitSegment",value:function(e,t){var n=new Ct,i=36===t.streamType?Mt.ftypHEVC():Mt.ftyp(),r=Mt.moov({type:e,meta:t});return n.write(i,r),n}},{key:"calcDtsBase",value:function(e,t){if(!e&&t.samples.length)return t.samples[0].dts;if(e.samples.length||t.samples.length){var n=1/0,i=1/0,r=null;if(e.samples&&e.samples.length){var a=e.samples[0];n=a.dts,a.options&&a.options.start&&(r=a.options.start)}if(t.samples&&t.samples.length){var s=t.samples[0];i=s.dts,s.options&&s.options.start&&(r=s.options.start)}this._dtsBase=Math.min(n,i)-(r||this._dtsBase),this._videoDtsBase=this._dtsBase,this._audioDtsBase=this._dtsBase,this._isDtsBaseInited=!0}}},{key:"_remuxVideo",value:function(e){var t=e||{};if(e.samples&&e.samples.length){for(var n=t.samples,i=-1,r=null,a=[],s={samples:[]},o=1e4;n.length&&o-- >0;){var u=n.shift(),l=u.isKeyframe,f=u.options;if(!this.isFirstVideo&&f&&f.meta){r=this.remuxInitSegment("video",f.meta),f.meta=null,n.unshift(u),f.isContinue||(this._videoDtsBase=0);break}var c=u.dts-this.videoDtsBase;-1===i&&(i=c);var h=void 0,d=void 0;void 0!==u.pts&&(h=(d=u.pts-this._dtsBase)-c),void 0!==u.cts&&(d=u.cts+c,h=u.cts);var p={buffer:[],size:0},v=0;v=u.duration?u.duration:n.length>=1?n[0].dts-this.videoDtsBase-c:a.length>=1?a[a.length-1].duration:this.videoMeta.refSampleDuration,this.videoAllDuration+=v,v>=0&&(s.samples.push(p),p.buffer.push(u.data),p.size+=u.data.byteLength,a.push({dts:c,cts:h,pts:d,data:u.data,size:u.data.byteLength,isKeyframe:l,duration:v,flags:{isLeading:0,dependsOn:l?2:1,isDependedOn:l?1:0,hasRedundancy:0,isNonSync:l?0:1},originDts:c,type:"video"})),l&&this.emit(Nt.RANDOM_ACCESS_POINT,d)}var y=new Ct;if(a.length){var m=Mt.moof({id:t.meta.id,time:i,samples:a}),g=Mt.mdat(s);y.write(m,g),this.writeToSource("video",y)}if(r&&(this.writeToSource("video",r),n.length))return t.samples=n,this._remuxVideo(t);this.isFirstVideo=!1,this.emit(Nt.MEDIA_SEGMENT,"video"),t.samples=[],t.length=0}}},{key:"_remuxAudio",value:function(e){var t=(e||{}).samples,n=-1,i=[],r=null,a={samples:[]};if(t&&t.length){for(var s=1e4,o=!1;t.length&&s-- >0;){var u=t.shift(),l=u.data,f=u.options;if(!this.isFirstAudio&&f&&f.meta){r=this.remuxInitSegment("audio",f.meta),f.meta=null,t.unshift(u),f.isContinue||(this._audioDtsBase=0);break}var c=u.dts-this.audioDtsBase,h=u.originDts;o||(n=c,o=!0);var d=0;d=u.duration?u.duration:this.audioMeta.refSampleDurationFixed?this.audioMeta.refSampleDurationFixed:t.length>=1?t[0].dts-this.audioDtsBase-c:i.length>=1?i[i.length-1].duration:this.audioMeta.refSampleDuration,this.audioAllDuration+=d;var p={dts:c,pts:c,cts:0,size:l.byteLength,duration:u.duration?u.duration:d,flags:{isLeading:0,dependsOn:1,isDependedOn:0,hasRedundancy:0,isNonSync:0},isKeyframe:!0,originDts:h,type:"audio"},v={buffer:[],size:0};d>=0&&(v.buffer.push(l),v.size+=l.byteLength,a.samples.push(v),i.push(p))}var y=new Ct;if(i.length){var m=Mt.moof({id:e.meta.id,time:n,samples:i}),g=Mt.mdat(a);y.write(m,g),this.writeToSource("audio",y)}if(r&&(this.writeToSource("audio",r),t.length))return e.samples=t,this._remuxAudio(e);this.isFirstAudio=!1,this.emit(Nt.MEDIA_SEGMENT,"audio",y),e.samples=[],e.length=0}}},{key:"writeToSource",value:function(e,t){var n=this._context.getInstance("PRE_SOURCE_BUFFER"),i=n.getSource(e);i||(i=n.createSource(e)),i.data.push(t)}},{key:"initSilentAudio",value:function(t,n){var i=e.getSilentFrame(this._audioMeta.channelCount);return{dts:t,pts:t,cts:0,duration:n,unit:i,size:i.byteLength,originDts:t,type:"video"}}},{key:"destroy",value:function(){this._player=null}},{key:"videoMeta",get:function(){return this._context.getInstance("TRACKS").videoTrack.meta}},{key:"audioMeta",get:function(){return this._context.getInstance("TRACKS").audioTrack.meta}},{key:"videoDtsBase",get:function(){return null!==this._videoDtsBase?this._videoDtsBase:this._dtsBase}},{key:"audioDtsBase",get:function(){return null!==this._audioDtsBase?this._audioDtsBase:this._dtsBase}}],[{key:"getSilentFrame",value:function(e){return 1===e?new Uint8Array([0,200,0,128,35,128]):2===e?new Uint8Array([33,0,73,144,2,25,0,35,128]):3===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]):4===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]):5===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]):6===e?new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]):null}}]),e}(),jt=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Gt=function e(){X(this,e),this.mimetype="",this.init=null,this.data=[]},zt=function(){function e(){X(this,e),this.sources={}}return jt(e,[{key:"getSource",value:function(e){return this.sources[e]}},{key:"createSource",value:function(e){return this.sources[e]=new Gt,this.sources[e]}},{key:"clear",value:function(){this.sources={}}},{key:"destroy",value:function(){this.sources={}}}]),e}(),Ht=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Xt=function(){function e(t){W(this,e),this.length=t||0,this.historyLen=t||0,this.array=[],this.offset=0}return Ht(e,[{key:"push",value:function(e){this.array.push(e),this.length+=e.byteLength,this.historyLen+=e.byteLength}},{key:"shift",value:function(e){if(this.array.length<1)return new Uint8Array(0);if(void 0===e)return this._shiftBuffer();if(this.offset+e===this.array[0].length){var t=this.array[0].slice(this.offset,this.offset+e);return this.offset=0,this.array.shift(),this.length-=e,t}if(this.offset+e<this.array[0].length){var n=this.array[0].slice(this.offset,this.offset+e);return this.offset+=e,this.length-=e,n}for(var i=new Uint8Array(e),r=0;this.array.length>0&&e>0;){if(this.offset+e<this.array[0].length){var a=this.array[0].slice(this.offset,this.offset+e);i.set(a,r),this.offset+=e,this.length-=e,e=0;break}var s=this.array[0].length-this.offset;i.set(this.array[0].slice(this.offset,this.array[0].length),r),this.array.shift(),this.offset=0,r+=s,this.length-=s,e-=s}return i}},{key:"clear",value:function(){this.array=[],this.length=0,this.offset=0}},{key:"destroy",value:function(){this.clear(),this.historyLen=0}},{key:"_shiftBuffer",value:function(){return this.length-=this.array[0].length,this.offset=0,this.array.shift()}},{key:"toInt",value:function(e,t){for(var n=0,i=this.offset+e;i<this.offset+t+e;)i<this.array[0].length?n=256*n+this.array[0][i]:this.array[1]&&(n=256*n+this.array[1][i-this.array[0].length]),i++;return n}}]),e}(),Wt=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Kt=(function(){function e(){K(this,e)}Wt(e,null,[{key:"isHeader",value:function(t,n){return!!(n+1<t.length&&e.isHeaderPattern(t,n))}},{key:"getFrameDuration",value:function(e){return 9216e4/e}},{key:"isHeaderPattern",value:function(e,t){return 255===e[t]&&240==(246&e[t+1])}},{key:"getHeaderLength",value:function(e,t){return 1&e[t+1]?7:9}},{key:"getFullFrameLength",value:function(e,t){return(3&e[t+3])<<11|e[t+4]<<3|(224&e[t+5])>>>5}},{key:"parseFrameHeader",value:function(t,n,i,r,a){var s=void 0,o=void 0,u=void 0,l=t.length;if(s=e.getHeaderLength(t,n),o=e.getFullFrameLength(t,n),(o-=s)>0&&n+s+o<=l)return u=i+r*a,{headerLength:s,frameLength:o,stamp:u}}},{key:"appendFrame",value:function(t,n,i,r,a){var s=e.getFrameDuration(t.meta.sampleRate),o=e.parseFrameHeader(n,i,r,a,s);if(o){var u=o.stamp,l=o.headerLength,f=o.frameLength;return{sample:{unit:n.subarray(i+l,i+l+f),pts:u,dts:u},length:f+l}}}}])}(),function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}()),Yt=function(){function e(){Y(this,e)}return Kt(e,null,[{key:"getSilentFrame",value:function(e,t){if("mp4a.40.2"===e){if(1===t)return new Uint8Array([0,200,0,128,35,128]);if(2===t)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(5===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(6===t)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===t)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(3===t)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}return null}}]),e}(),qt=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),Zt=function(e){for(var t in e)if(e.hasOwnProperty(t)&&null===e[t])return!1;return!0},Jt=function(){function e(){q(this,e),this.mimeType=null,this.duration=null,this.hasVideo=null,this.video={codec:null,width:null,height:null,profile:null,level:null,frameRate:{fixed:!0,fps:25,fps_num:25e3,fps_den:1e3},chromaFormat:null,parRatio:{width:1,height:1}},this.hasAudio=null,this.audio={codec:null,sampleRate:null,sampleRateIndex:null,channelCount:null}}return qt(e,[{key:"isComplete",value:function(){return e.isBaseInfoReady(this)&&e.isVideoReady(this)&&e.isAudioReady(this)}}],[{key:"isBaseInfoReady",value:function(e){return Zt(e)}},{key:"isVideoReady",value:function(e){return!e.hasVideo||Zt(e.video)}},{key:"isAudioReady",value:function(e){return!e.hasAudio||Zt(e.video)}}]),e}(),Qt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$t=function e(t,n,i){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,n);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,n,i)}if("value"in r)return r.value;var s=r.get;if(void 0!==s)return s.call(i)},en=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),tn=(function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[];Q(this,e),this._emitter=new i,this._emitter.off||(this._emitter.off=this._emitter.removeListener),this._instanceMap={},this._clsMap={},this._inited=!1,this.mediaInfo=new Jt,this.allowedEvents=t,this._hooks={}}en(e,[{key:"getInstance",value:function(e){var t=this._instanceMap[e];return t||null}},{key:"initInstance",value:function(e){for(var t=arguments.length,n=Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];var r=n[0],a=n[1],s=n[2],o=n[3];if(this._clsMap[e]){var u=new this._clsMap[e](r,a,s,o);return this._instanceMap[e]=u,u.init&&u.init(),u}throw new Error(e+"未在context中注册")}},{key:"init",value:function(e){if(!this._inited){for(var t in this._clsMap)this._clsMap.hasOwnProperty(t)&&!this._instanceMap[t]&&this.initInstance(t,e);this._inited=!0}}},{key:"registry",value:function(e,t){var n=this,i=this._emitter,r=this._isMessageNameValid.bind(this),a=this,s=function(t){function n(t,i,r){Q(this,n);var s=Z(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,t,i,r));return s.listeners={},s.onceListeners={},s.TAG=e,s._context=a,s}return J(n,t),en(n,[{key:"on",value:function(t,n){return r(t),this.listeners[t]?this.listeners[t].push(n):this.listeners[t]=[n],i.on(t+"__TO__"+e,n),i.on(t,n)}},{key:"before",value:function(e,t){r(e),a._hooks[e]?a._hooks[e].push(t):a._hooks[e]=[t]}},{key:"once",value:function(t,n){return r(t),this.onceListeners[t]?this.onceListeners[t].push(n):this.onceListeners[t]=[n],i.once(t+"__TO__"+e,n),i.once(t,n)}},{key:"emit",value:function(e){r(e);var t=a._hooks?a._hooks[e]:null;if(t)for(var n=0,s=t.length;n<s;n++)(0,t[n])();for(var o=arguments.length,u=Array(o>1?o-1:0),l=1;l<o;l++)u[l-1]=arguments[l];return i.emit.apply(i,[e].concat(u))}},{key:"emitTo",value:function(e,t){r(t);for(var n=arguments.length,a=Array(n>2?n-2:0),s=2;s<n;s++)a[s-2]=arguments[s];return i.emit.apply(i,[t+"__TO__"+e].concat(a))}},{key:"off",value:function(e,t){return r(e),i.off(e,t)}},{key:"removeListeners",value:function(){var t=Object.prototype.hasOwnProperty.bind(this.listeners);for(var n in this.listeners)if(t(n))for(var r=this.listeners[n]||[],a=0;a<r.length;a++){var s=r[a];i.off(n,s),i.off(n+"__TO__"+e,s)}for(var o in this.onceListeners)if(t(o))for(var u=this.onceListeners[o]||[],l=0;l<u.length;l++){var f=u[l];i.off(o,f),i.off(o+"__TO__"+e,f)}}},{key:"destroy",value:function(){if(this.removeListeners(),this.listeners={},delete a._instanceMap[e],$t(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this))return $t(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"destroy",this).call(this)}}]),n}(t);return this._clsMap[e]=s,function(){for(var t=arguments.length,i=Array(t),r=0;r<t;r++)i[r]=arguments[r];return n.initInstance.apply(n,[e].concat(i))}}},{key:"seek",value:function(e){this._emitter.emit(ke.PLAYER_EVENTS.SEEK,e)}},{key:"destroyInstances",value:function(){var e=this;Object.keys(this._instanceMap).forEach(function(t){e._instanceMap[t].destroy&&e._instanceMap[t].destroy()})}},{key:"destroy",value:function(){this._emitter=null,this.allowedEvents=[],this._clsMap=null,this._context=null,this._hooks=null,this.destroyInstances()}},{key:"_isMessageNameValid",value:function(e){if(!this.allowedEvents.indexOf(e)<0)throw new Error("unregistered message name: "+e)}}])}(),function(){function e(e,t){var n=[],i=!0,r=!1,a=void 0;try{for(var s,o=e[Symbol.iterator]();!(i=(s=o.next()).done)&&(n.push(s.value),!t||n.length!==t);i=!0);}catch(e){r=!0,a=e}finally{try{!i&&o.return&&o.return()}finally{if(r)throw a}}return n}return function(t,n){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,n);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}()),nn=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),rn=(function(){function e(t){var n=this;$(this,e);var i=e.getDefaultInf();if(!t||"[object Object]"!==Object.prototype.toString.call(t))return i;var r=Object.assign({},i,t);Object.entries(r).forEach(function(e){var t=tn(e,2),i=t[0],r=t[1];n[i]=r})}nn(e,null,[{key:"getDefaultInf",value:function(){return{dts:null,pts:null,duration:null,position:null,isRAP:!1,originDts:null}}}])}(),function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}()),an=(function(){function e(){ee(this,e),this.startDts=-1,this.endDts=-1,this.startPts=-1,this.endPts=-1,this.originStartDts=-1,this.originEndDts=-1,this.randomAccessPoints=[],this.firstSample=null,this.lastSample=null}rn(e,[{key:"addRAP",value:function(e){e.isRAP=!0,this.randomAccessPoints.push(e)}}])}(),function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}()),sn=(function(){function e(t){te(this,e),this._type=t,this._list=[],this._lastAppendLocation=-1}an(e,[{key:"isEmpty",value:function(){return 0===this._list.length}},{key:"clear",value:function(){this._list=[],this._lastAppendLocation=-1}},{key:"_searchNearestSegmentBefore",value:function(e){var t=this._list;if(0===t.length)return-2;var n=t.length-1,i=0,r=0,a=n,s=0;if(e<t[0].originDts)return s=-1;for(;r<=a;){if((i=r+Math.floor((a-r)/2))===n||e>t[i].lastSample.originDts&&e<t[i+1].originDts){s=i;break}t[i].originDts<e?r=i+1:a=i-1}return s}},{key:"_searchNearestSegmentAfter",value:function(e){return this._searchNearestSegmentBefore(e)+1}},{key:"append",value:function(e){var t=this._list,n=this._lastAppendLocation,i=0;-1!==n&&n<t.length&&e.originStartDts>=t[n].lastSample.originDts&&(n===t.length-1||n<t.length-1&&e.originStartDts<t[n+1].originStartDts)?i=n+1:t.length>0&&(i=this._searchNearestSegmentBefore(e.originStartDts)+1),this._lastAppendLocation=i,this._list.splice(i,0,e)}},{key:"getLastSegmentBefore",value:function(e){var t=this._searchNearestSegmentBefore(e);return t>=0?this._list[t]:null}},{key:"getLastSampleBefore",value:function(e){var t=this.getLastSegmentBefore(e);return null!==t?t.lastSample:null}},{key:"getLastRAPBefore",value:function(e){for(var t=this._searchNearestSegmentBefore(e),n=this._list[t].randomAccessPoints;0===n.length&&t>0;)t--,n=this._list[t].randomAccessPoints;return n.length>0?n[n.length-1]:null}},{key:"type",get:function(){return this._type}},{key:"length",get:function(){return this._list.length}}])}(),{fixedFloat:function(e,t){return Number.parseFloat(Number(e).toFixed(t))}}),on=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),un="safari"===_t.browser,ln=ke.REMUX_EVENTS,fn=function(){function e(){ne(this,e),this.nextAudioDts=0,this.nextVideoDts=0,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this.allAudioSamplesCount=0,this.allVideoSamplesCount=0,this._firstAudioSample=null,this._firstVideoSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this.videoLastSample=null,this.audioLastSample=null,this._videoLargeGap=0,this._audioLargeGap=0,this.audioUnsyncTime=0}return on(e,[{key:"init",value:function(){this.before(ln.REMUX_MEDIA,this.doFix.bind(this))}},{key:"reset",value:function(){this.nextAudioDts=null,this.nextVideoDts=null,this.lastAudioSamplesLen=0,this.lastVideoSamplesLen=0,this.lastVideoDts=void 0,this.lastAudioDts=void 0,this._audioLargeGap=0,this._videoLargeGap=0,this.videoLastSample=null,this.audioLastSample=null,this.filledAudioSamples=[],this.filledVideoSamples=[],this.audioUnsyncTime=0}},{key:"doFix",value:function(){var t=this.getFirstSample(),n=t.isFirstAudioSamples,i=t.isFirstVideoSamples;this.recordSamplesCount(),this._firstVideoSample&&this.fixVideoRefSampleDuration(this.videoTrack.meta,this.videoTrack.samples),this._firstAudioSample&&n&&this.fixAudioRefSampleDuration(this.audioTrack.meta);var r=e.detectChangeStream(this.videoTrack.samples,i),a=r.changed,s=r.changedIdxes;if(a){for(var o=!1,u=0;u<s.length;u++)this.fixChangeStreamVideo(s[u],i)&&(o=!0);o||this.doFixVideo(i)}else this.doFixVideo(i);var l=e.detectChangeStream(this.audioTrack.samples,n),f=l.changed,c=l.changedIdxes;if(f){for(var h=!1,d=0;d<c.length;d++)this.fixChangeStreamAudio(c[d],n)&&(h=!0);if(h)return;this.doFixAudio(n)}else this.doFixAudio(n);this.removeInvalidSamples()}},{key:"doFixVideo",value:function(t,n){for(var i=this.videoTrack,r=i.samples,a=i.meta,s=0,o=r.length;s<o;s++){var u=r[s];u.originDts=u.dts,u.originPts=u.pts}if(r&&r.length&&this._firstVideoSample){var l=r[0];if(!t&&null===this.videoLastSample&&l.options&&l.options.start&&n&&(n=l.options.start),!t&&!n&&this.videoLastSample&&e.detectLargeGap(this.videoLastSample?this.videoLastSample.dts:0,l.dts+this._videoLargeGap)&&(this._videoLargeGap=this.videoLastSample.dts+a.refSampleDuration-l.dts),0!==this._videoLargeGap&&e.doFixLargeGap(r,this._videoLargeGap),!t&&n&&(this._videoLargeGap=n-l.dts,e.doFixLargeGap(r,this._videoLargeGap)),t&&this._firstAudioSample){var f=this._firstVideoSample.originDts,c=f-(this._firstAudioSample.originDts||this._firstAudioSample.dts);if(c>2*a.refSampleDuration&&c<10*a.refSampleDuration){for(var h=Math.floor(c/a.refSampleDuration),d=0;d<h;d++){var p=Object.assign({},l);p.dts=f-(d+1)*a.refSampleDuration,p.pts=p.dts+p.cts,r.unshift(p),this.filledVideoSamples.push({dts:p.dts,size:p.data.byteLength})}this._firstVideoSample=this.filledVideoSamples[0]||this._firstVideoSample}else Math.abs(c)>2*a.refSampleDuration&&!this._videoLargeGap&&(this._videoLargeGap=-1*c,e.doFixLargeGap(r,-1*c))}var v=r.pop();if(r.length&&(r[r.length-1].duration=v.dts-r[r.length-1].dts),this.videoLastSample){var y=this.videoLastSample;y.duration=l.dts-y.dts,r.unshift(this.videoLastSample)}r.forEach(function(e,t){if(0!==t&&t!==r.length-1){var n=r[t-1],i=r[t+1];e.dts-n.dts<5&&(e.dts=(n.dts+i.dts)/2,e.pts=(n.pts+i.pts)/2)}}),this.videoLastSample=v,this.videoTrack.samples=r}}},{key:"doFixAudio",value:function(t,n){var i=this,r=this.audioTrack,a=r.samples,s=r.meta;if(a&&a.length){for(var o=0,u=a.length;o<u;o++){var l=a[o];l.originDts=l.dts}var f=a.length,c=Yt.getSilentFrame(s.codec,s.channelCount),h=Math.floor(s.refSampleDuration),d=this._firstAudioSample,p=a[0];if(!t&&null===this.nextAudioDts&&p.options.start&&n&&(n=p.options.start),!t&&!n&&this.nextAudioDts&&e.detectLargeGap(this.nextAudioDts||0,p.dts+this._audioLargeGap)&&(this._audioLargeGap=this.nextAudioDts+s.refSampleDuration-p.dts),0!==this._audioLargeGap?e.doFixLargeGap(a,this._audioLargeGap):t||!n&&!e.detectLargeGap(this.nextAudioDts,p.dts)||(n&&(this.nextAudioDts=n),this._audioLargeGap=this.nextAudioDts-p.dts,e.doFixLargeGap(a,this._audioLargeGap)),this._firstVideoSample&&t){var v=this._firstVideoSample.originDts||this._firstVideoSample.dts,y=d.dts-v;if(y===this._videoLargeGap);else if(y>s.refSampleDuration&&y<10*s.refSampleDuration){for(var m=Math.floor((d.dts-v)/s.refSampleDuration),g=0;g<m;g++){var _={data:c,datasize:c.byteLength,dts:d.dts-(g+1)*s.refSampleDuration,filtered:0};a.unshift(_),this.filledAudioSamples.push({dts:_.dts,size:_.data.byteLength})}this._firstAudioSample=this.filledAudioSamples[0]||this._firstAudioSample}else y<-1*s.refSampleDuration&&(this._audioLargeGap=-1*y,e.doFixLargeGap(a,-1*y))}var b=void 0,k=a[0].dts;if(this.nextAudioDts){b=k-this.nextAudioDts;var E=Math.abs(b);if(b>=h&&b<10*h)for(var w=Math.ceil(b/h),S=0;S<w;S++){var A=k-(S+1)*h,T={dts:A>this.nextAudioDts?A:this.nextAudioDts,pts:A>this.nextAudioDts?A:this.nextAudioDts,datasize:c.byteLength,filtered:0,data:c};this.filledAudioSamples.push({dts:T.dts,size:T.data.byteLength}),this.audioTrack.samples.unshift(T),p=T}else E<s.refSampleDuration&&E>0?(p.dts=this.nextAudioDts,p.pts=this.nextAudioDts):b<0&&E<h&&e.doFixLargeGap(a,-1*b)}var R=s.refSampleDuration-h;a.forEach(function(e,t){if(0!==t){var n=a[t-1];e.dts=e.pts=n.dts+n.duration}e.duration=h,i.audioUnsyncTime=sn.fixedFloat(i.audioUnsyncTime+R,2),i.audioUnsyncTime>=1&&(e.duration+=1,i.audioUnsyncTime-=1)});var L=a[a.length-1],D=L.dts,B=L.duration;this.lastAudioSamplesLen=f,this.nextAudioDts=D+(B||h),this.audioTrack.samples=e.sortAudioSamples(a)}}},{key:"fixChangeStreamVideo",value:function(e){var t=this.videoTrack.samples,n=0===e?this.videoLastSample?this.videoLastSample.dts:this.getStreamChangeStart(t[0]):t[e-1].dts,i=t[e].dts;if(Math.abs(n-i)<=100)return t[e].options?t[e].options.isContinue=!0:t[e].options={isContinue:!0},!1;this.emit(ln.DETECT_CHANGE_STREAM_DISCONTINUE);var r=t.slice(0,e),a=t.slice(e),s=t[e],o=void 0;return this._videoLargeGap=0,this.videoLastSample=null,o=s.options&&s.options.start?s.options.start:n-this.videoDtsBase,this.videoTrack.samples=t.slice(0,e),this.doFixVideo(!1),this.videoTrack.samples=t.slice(e),this.doFixVideo(!1,o),this.videoTrack.samples=r.concat(a),!0}},{key:"fixChangeStreamAudio",value:function(e){var t=this.audioTrack,n=t.samples,i=(t.meta,0===e?this.lastAudioDts:n[e-1].dts),r=n[e].dts;if(Math.abs(i-r)<=1e3)return n[e].options?n[e].options.isContinue=!0:n[e].options={isContinue:!0},!1;this.emit(ln.DETECT_CHANGE_STREAM_DISCONTINUE),this._audioLargeGap=0,this.nextAudioDts=null;var a=n.slice(0,e),s=n.slice(e),o=n[e],u=void 0;return o.options&&o.options.start?u=o.options.start:(u=i-this.audioDtsBase,o.options.isContinue=!0),this.audioTrack.samples=a,this.doFixAudio(!1),this.audioTrack.samples=s,this.doFixAudio(!1,u),this.audioTrack.samples=a.concat(s),!0}},{key:"getFirstSample",value:function(){var t=this.videoTrack.samples,n=this.audioTrack.samples,i=!1,r=!1;return!this._firstVideoSample&&t.length&&(this._firstVideoSample=e.findFirstVideoSample(t),this.removeInvalidSamples(),i=!0),!this._firstAudioSample&&n.length&&(this._firstAudioSample=e.findFirstAudioSample(n),this.removeInvalidSamples(),r=!0),{isFirstVideoSamples:i,isFirstAudioSamples:r}}},{key:"fixVideoRefSampleDuration",value:function(t,n){var i=this.allVideoSamplesCount,r=this._firstVideoSample.dts,a=this.filledVideoSamples.length;if(e.isRefSampleDurationValid(t.refSampleDuration)){if(t.refSampleDuration&&n.length>=5){var s=(n[n.length-1].dts-n[0].dts)/(n.length-1);if(s>0&&s<1e3){var o=Math.floor(Math.abs(t.refSampleDuration-s)<=5?t.refSampleDuration:s);e.isRefSampleDurationValid(o)&&(t.refSampleDuration=o)}}}else if(n.length>=1){var u=n[n.length-1].dts,l=Math.floor((u-r)/(i+a-1));e.isRefSampleDurationValid(l)&&(t.refSampleDuration=l)}e.isRefSampleDurationValid(t.refSampleDuration)||(t.refSampleDuration=66)}},{key:"fixAudioRefSampleDuration",value:function(e){e.refSampleDuration=sn.fixedFloat(1024*e.timescale/e.sampleRate,un?0:2)}},{key:"recordSamplesCount",value:function(){var e=this.audioTrack,t=this.videoTrack;this.allAudioSamplesCount+=e.samples.length,this.allVideoSamplesCount+=t.samples.length}},{key:"removeInvalidSamples",value:function(){var e=this.audioTrack.samples[0],t=this.videoTrack.samples[0];e&&(this.audioTrack.samples=this.audioTrack.samples.filter(function(t,n){return t===e||t.dts>e.dts})),t&&(this.videoTrack.samples=this.videoTrack.samples.filter(function(e,n){return e===t||e.dts>t.dts}))}},{key:"getStreamChangeStart",value:function(e){return e.options&&e.options.start?e.options.start-this.dtsBase:1/0}},{key:"tracks",get:function(){return this._context.getInstance("TRACKS")}},{key:"audioTrack",get:function(){return this.tracks&&this.tracks.audioTrack?this.tracks.audioTrack:{samples:[],meta:{}}}},{key:"videoTrack",get:function(){return this.tracks&&this.tracks.videoTrack?this.tracks.videoTrack:{samples:[],meta:{}}}},{key:"dtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e?e._dtsBase:0}},{key:"audioDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._audioDtsBase?e._audioDtsBase:this.dtsBase}},{key:"videoDtsBase",get:function(){var e=this._context.getInstance("MP4_REMUXER");return e&&null!==e._videoDtsBase?e._videoDtsBase:this.dtsBase}}],[{key:"sortAudioSamples",value:function(e){return 1===e.length?e:e.sort(function(e,t){return e.dts-t.dts})}},{key:"isRefSampleDurationValid",value:function(e){return e&&e>0&&!Number.isNaN(e)}},{key:"findFirstAudioSample",value:function(t){return t&&0!==t.length?e.sortAudioSamples(t)[0]:null}},{key:"findFirstVideoSample",value:function(e){if(!e.length)return null;for(var t=e.sort(function(e,t){return e.dts-t.dts}),n=0,i=t.length;n<i;n++)if(t[n].isKeyframe)return t[n]}},{key:"detectLargeGap",value:function(e,t){if(null!==e)return e-t>=1e3||t-e>=1e3}},{key:"doFixLargeGap",value:function(e,t){for(var n=0,i=e.length;n<i;n++){var r=e[n];r.dts+=t,r.pts&&(r.pts+=t)}}},{key:"detectChangeStream",value:function(e,t){for(var n=!1,i=[],r=0,a=e.length;r<a;r++){var s=e[r];!s.options||!s.options.meta||t&&0===r||(n=!0,i.push(r))}return{changed:n,changedIdxes:i}}}]),e}(),cn=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),hn=function(){function e(t,n){ie(this,e),n&&(this._context=n,this.emit=n._emitter.emit.bind(n._emitter)),this.configs=Object.assign({},t),this.container=this.configs.container,this.mediaSource=null,this.sourceBuffers={},this.preloadTime=this.configs.preloadTime||1,this.onSourceOpen=this.onSourceOpen.bind(this),this.onUpdateEnd=this.onUpdateEnd.bind(this)}return cn(e,[{key:"init",value:function(){this.mediaSource=new self.MediaSource,this.mediaSource.addEventListener("sourceopen",this.onSourceOpen),this._url=null}},{key:"resetContext",value:function(t){this._context=t,this.emit=t._emitter.emit.bind(t._emitter);for(var n=0;n<Object.keys(this.sourceBuffers).length;n++){var i=this.sourceBuffers[Object.keys(this.sourceBuffers)[n]];i.updating||e.clearBuffer(i)}}},{key:"onSourceOpen",value:function(){this.addSourceBuffers()}},{key:"onUpdateEnd",value:function(){this.emit("SOURCE_UPDATE_END"),this.doAppend()}},{key:"addSourceBuffers",value:function(){if("open"===this.mediaSource.readyState){var e=this._context.getInstance("PRE_SOURCE_BUFFER"),t=this._context.getInstance("TRACKS"),n=void 0;e=e.sources;for(var i=!1,r=0,a=Object.keys(e).length;r<a;r++){var s=Object.keys(e)[r];"audio"===s?n=t.audioTrack:"video"===s&&(n=t.videoTrack),n&&(i=!0)}if(i){if(Object.keys(this.sourceBuffers).length>1)return;for(var o=0,u=Object.keys(e).length;o<u;o++){var l=Object.keys(e)[o];if(!this.sourceBuffers[l]){var f=e[l],c="video"===l?"video/mp4;codecs="+f.mimetype:"audio/mp4;codecs="+f.mimetype,h=this.mediaSource.addSourceBuffer(c);this.sourceBuffers[l]=h,h.addEventListener("updateend",this.onUpdateEnd),this.doAppend()}}}}}},{key:"doAppend",value:function(){var e=this._context.getInstance("PRE_SOURCE_BUFFER");if(e)for(var t=0;t<Object.keys(this.sourceBuffers).length;t++){var n=Object.keys(this.sourceBuffers)[t],i=this.sourceBuffers[n],r=e.sources[n];if(r&&!r.inited)try{i.appendBuffer(r.init.buffer.buffer),r.inited=!0}catch(e){}else if(r){var a=r.data.shift();if(a)try{i.appendBuffer(a.buffer.buffer)}catch(e){r.data.unshift(a)}}}}},{key:"endOfStream",value:function(){if("open"===this.mediaSource.readyState)try{this.mediaSource.endOfStream()}catch(e){}}},{key:"remove",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=0;n<Object.keys(this.sourceBuffers).length;n++){var i=this.sourceBuffers[Object.keys(this.sourceBuffers)[n]];i.updating||i.remove(t,e)}}},{key:"cleanBuffers",value:function(){for(var t=this,n=[],i=0;i<Object.keys(this.sourceBuffers).length;i++)!function(i){var r=t.sourceBuffers[Object.keys(t.sourceBuffers)[i]],a=void 0;a=r.updating?new Promise(function(t){var n=function n(){var i=3,a=function n(){r.updating?i>0?(setTimeout(n,200),i--):t():(e.clearBuffer(r),r.addEventListener("updateend",function(){t()}))};setTimeout(a,200),r.removeEventListener("updateend",n)};r.addEventListener("updateend",n)}):new Promise(function(t){e.clearBuffer(r),r.addEventListener("updateend",function(){t()})}),n.push(a)}(i);return Promise.all(n)}},{key:"removeBuffers",value:function(){for(var t=this,n=[],i=0;i<Object.keys(this.sourceBuffers).length;i++)!function(i){var r=t.sourceBuffers[Object.keys(t.sourceBuffers)[i]];r.removeEventListener("updateend",t.onUpdateEnd);var a=void 0;a=r.updating?new Promise(function(t){var n=function n(){var i=3,a=function n(){r.updating?i>0?(setTimeout(n,200),i--):t():(e.clearBuffer(r),r.addEventListener("updateend",function(){t()}))};setTimeout(a,200),r.removeEventListener("updateend",n)};r.addEventListener("updateend",n)}):new Promise(function(t){e.clearBuffer(r),r.addEventListener("updateend",function(){t()})}),n.push(a)}(i);return Promise.all(n)}},{key:"destroy",value:function(){var e=this;return this.removeBuffers().then(function(){for(var t=0;t<Object.keys(e.sourceBuffers).length;t++){var n=e.sourceBuffers[Object.keys(e.sourceBuffers)[t]];e.mediaSource.removeSourceBuffer(n),delete e.sourceBuffers[Object.keys(e.sourceBuffers)[t]]}e.mediaSource.removeEventListener("sourceopen",e.onSourceOpen),e.endOfStream(),window.URL.revokeObjectURL(e.url),e.url=null,e.configs={},e.container=null,e.mediaSource=null,e.sourceBuffers={},e.preloadTime=1})}},{key:"url",set:function(e){this._url=e},get:function(){return this._url||(this._url=window.URL.createObjectURL(this.mediaSource)),this._url}}],[{key:"clearBuffer",value:function(e){for(var t=e.buffered,n=.1,i=0,r=t.length;i<r;i++)n=t.end(i);try{e.remove(0,n)}catch(e){}}}]),e}(),dn=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),pn=ke.REMUX_EVENTS,vn=ke.DEMUX_EVENTS,yn=ke.LOADER_EVENTS,mn="FLVController",gn=function(){function e(){re(this,e)}return dn(e,[{key:"warn",value:function(){}}]),e}(),_n=function(){function t(e,n){re(this,t),this.TAG=mn,this._player=e,this.mse=n,this.state={initSegmentArrived:!1,range:{start:0,end:""},rangeSupport:!0}}return dn(t,[{key:"init",value:function(){this._context.registry("FETCH_LOADER",Ue),this._context.registry("LOADER_BUFFER",Xt),this._context.registry("FLV_DEMUXER",Bt),this._context.registry("TRACKS",ct),this._context.registry("MP4_REMUXER",Vt)(this._player.currentTime),this._context.registry("PRE_SOURCE_BUFFER",zt),this._context.registry("COMPATIBILITY",fn),this._context.registry("LOGGER",gn),this.mse||(this.mse=new hn({container:this._player.video},this._context),this.mse.init()),this.initListeners()}},{key:"initListeners",value:function(){this.on(yn.LOADER_DATALOADED,this._handleLoaderDataLoaded.bind(this)),this.on(yn.LOADER_ERROR,this._handleNetworkError.bind(this)),this.on(vn.MEDIA_INFO,this._handleMediaInfo.bind(this)),this.on(vn.METADATA_PARSED,this._handleMetadataParsed.bind(this)),this.on(vn.DEMUX_COMPLETE,this._handleDemuxComplete.bind(this)),this.on(vn.DEMUX_ERROR,this._handleDemuxError.bind(this)),this.on(vn.SEI_PARSED,this._handleSEIParsed.bind(this)),this.on(pn.INIT_SEGMENT,this._handleAppendInitSegment.bind(this)),this.on(pn.MEDIA_SEGMENT,this._handleMediaSegment.bind(this))}},{key:"_handleMediaInfo",value:function(){var e=this;this._context.onMetaData||this.emit(vn.DEMUX_ERROR,new Error("failed to get mediainfo"));var t=this._context.getInstance("LOADER_BUFFER"),n=this._context.getInstance("FETCH_LOADER");this.isSeekable&&(n.cancel(),this.state.range={start:0,end:t.historyLen-1},setTimeout(function(){e.loadNext(0)}))}},{key:"_handleLoaderDataLoaded",value:function(){this.emitTo("FLV_DEMUXER",vn.DEMUX_START)}},{key:"_handleMetadataParsed",value:function(e){this.emit(pn.REMUX_METADATA,e)}},{key:"_handleSEIParsed",value:function(e){this._player.emit("SEI_PARSED",e)}},{key:"_handleDemuxComplete",value:function(){this.emit(pn.REMUX_MEDIA)}},{key:"_handleAppendInitSegment",value:function(){this.state.initSegmentArrived=!0,this.mse.addSourceBuffers()}},{key:"_handleMediaSegment",value:function(){this.mse.addSourceBuffers(),this.mse.doAppend()}},{key:"_handleNetworkError",value:function(t,n){this._player.emit("error",new e.Errors("network",this._player.config.url)),this._onError(yn.LOADER_ERROR,t,n,!0)}},{key:"_handleDemuxError",value:function(t,n,i){void 0===i&&(i=!1),this._player.emit("error",new e.Errors("parse",this._player.config.url)),this._onError(yn.LOADER_ERROR,t,n,i)}},{key:"_onError",value:function(e,t,n,i){var r={errorType:e,errorDetails:"["+t+"]: "+(n?n.message:""),errorFatal:i||!1};this._player.emit("FLV_ERROR",r)}},{key:"seek",value:function(e){if(!this._context.onMetaData)return void this.loadMeta();if(this.isSeekable){this._context.getInstance("LOADER_BUFFER").clear();var t=this._player.config.preloadTime,n=void 0===t?15:t,i=this.getSeekRange(e,n);this.state.range=i,this.compat&&this.compat.reset(),this.loadData()}}},{key:"loadNext",value:function(e){this._context.onMetaData&&(this.loader.loading||this.getNextRange(e)&&this.loadData())}},{key:"loadData",value:function(){var e=this.state.range,t=e.start,n=e.end;this.emit(yn.LADER_START,this._player.config.url,{headers:{method:"get",Range:"bytes="+t+"-"+n}})}},{key:"loadMeta",value:function(){var e=this;this.loader.load(this._player.config.url,{headers:{Range:"bytes=0-"}}).catch(function(){e.state.rangeSupport=!1,e.loadFallback()})}},{key:"loadFallback",value:function(){var t=this;this.loader.load(this._player.config.url).catch(function(){t._player.emit("error",new e.Errors("network",t._player.config.url))})}},{key:"getSeekRange",value:function(e,n){var i=this._context.onMetaData.keyframes,r=this._context.mediaInfo.duration,a=e,s=e+n,o=t.findFilePosition(a,i);return s>=r||a>=r?{start:o,end:""}:{start:o,end:t.findFilePosition(s,i)}}},{key:"getNextRange",value:function(e){if(""!==this.state.range.end){var t=this.getSeekRange(e,this.config.preloadTime||15).end;if(!(t<=this.state.range.end&&""!==t))return this.state.range={start:this.state.range.end+1,end:t},!0}}},{key:"destroy",value:function(){this._player=null,this.mse=null,this.state={initSegmentArrived:!1,range:{start:0,end:""},rangeSupport:!0}}},{key:"isSeekable",get:function(){return!(!this.state.rangeSupport||!this._context)&&(null!==this._context.onMetaData.keyframes&&void 0!==this._context.onMetaData.keyframes)}},{key:"config",get:function(){return this._player.config}},{key:"loader",get:function(){return this._context.getInstance("FETCH_LOADER")}},{key:"compat",get:function(){return this._context.getInstance("COMPATIBILITY")}},{key:"loadBuffer",get:function(){return this._context.getInstance("LOADER_BUFFER")}}],[{key:"findFilePosition",value:function(e,t){for(var n=0,i=t.times.length;n<i;n++){var r=t.times[n],a=n+1<i?t.times[n+1]:Number.MAX_SAFE_INTEGER;if(r<=e&&e<=a)return t.filepositions[n]}return""}}]),t}(),bn=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}(),kn=e.BasePlugin,En=e.Events,wn=ke.FlvAllowedEvents,Sn=function(e,t){if(!e.config.isLive&&e.duration-e.currentTime<2){var n=e.getBufferedRange();e.currentTime-n[1]<.1&&(e.emit("ended"),t.mse.endOfStream())}};return function(e){function t(){return ae(this,t),se(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return oe(t,e),bn(t,[{key:"beforePlayerInit",value:function(){var e=this;this.context=new Le(wn),this.initEvents();var t=this.initFlv();this.context.init(),this.remuxer._dtsBase=0,t.loadMeta(),this.player.swithURL=this.swithURL;try{kn.defineGetterOrSetter(this.player,{__url:{get:function(){return e.flv.mse.url}}})}catch(e){}}},{key:"initFlv",value:function(){var e=this.player,t=this.context.registry("FLV_CONTROLLER",_n)(e);return this.flv=t,this.mse=t.mse,t}},{key:"initFlvBackupEvents",value:function(e,t){var n=this;e.once(ke.REMUX_EVENTS.INIT_SEGMENT,function(){var i=3;e.on(ke.REMUX_EVENTS.MEDIA_SEGMENT,function(){0===(i-=1)&&(n.flv=e,n.mse.resetContext(t),n.context.destroy(),n.context=t)})}),e.once(ke.LOADER_EVENTS.LOADER_ERROR,function(){t.destroy()})}},{key:"initEvents",value:function(){this.on(En.TIME_UPDATE,this.handleTimeUpdate.bind(this)),this.on(En.SEEKING,this.handleSeek.bind(this)),this.on(En.URL_CHANGE,this.swithURL.bind(this)),this.once(En.DESTROY,this._destroy.bind(this))}},{key:"handleTimeUpdate",value:function(){this.loadData(),Sn(this.player,this.flv)}},{key:"handleSeek",value:function(){var e=this.player.currentTime,t=this.player.getBufferedRange();(e>t[1]||e<t[0])&&this.flv.seek(e)}},{key:"_destroy",value:function(){this.context.destroy(),this.context=null}},{key:"loadData",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.player.currentTime,t=this.player,n=t.getBufferedRange();n[1]-e<(t.config.preloadTime||15)-5&&this.flv.loadNext(n[1]+1)}},{key:"swithURL",value:function(e){var t=this.player;t.config.url=e,t.hasStart=!1,t.paused?t.start():(t.pause(),t.once("pause",function(){t.start()}),t.once("canplay",function(){t.play()})),t.once("canplay",function(){t.currentTime=0})}},{key:"remuxer",get:function(){return this.context.getInstance("MP4_REMUXER")}}],[{key:"isSupported",value:function(){return window.MediaSource&&window.MediaSource.isTypeSupported('video/mp4; codecs="avc1.42E01E,mp4a.40.2"')}},{key:"pluginName",get:function(){return"flvVod"}}]),t}(kn)});
//# sourceMappingURL=index.min.js.map
