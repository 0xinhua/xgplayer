{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import Player from 'xgplayer'\nimport { Context, EVENTS } from 'xgplayer-utils';\nimport FLV from './flv-vod'\n\nconst flvAllowedEvents = EVENTS.FlvAllowedEvents;\n\nconst isEnded = (player, flv) => {\n  if (!player.config.isLive) {\n    if (player.duration - player.currentTime < 2) {\n      const range = player.getBufferedRange()\n      if (player.currentTime - range[1] < 0.1) {\n        player.emit('ended')\n        flv.mse.endOfStream()\n      }\n    }\n  }\n}\n\nclass FlvPlayer extends Player {\n  constructor (config) {\n    super(config)\n    this.context = new Context(flvAllowedEvents)\n    this.initEvents()\n    // const preloadTime = player.config.preloadTime || 15\n  }\n\n  start () {\n    const flv = this.context.registry('FLV_CONTROLLER', FLV)(this)\n    this.flv = flv\n    this.context.init()\n    super.start(flv.mse.url)\n  }\n\n  initEvents () {\n    this.on('timeupdate', this.handleTimeUpdate.bind(this))\n\n    this.on('seeking', this.handleSeek.bind(this))\n\n    this.once('destroy', this._destroy.bind(this))\n  }\n\n  handleTimeUpdate () {\n    this.loadData()\n    isEnded(this, this.flv)\n  }\n\n  handleSeek () {\n    const time = this.currentTime\n    const range = this.getBufferedRange()\n    if (time > range[1] || time < range[0]) {\n      this.flv.seek(this.currentTime)\n    }\n  }\n\n  _destroy () {\n    this.context.destroy()\n    this.context = null\n    this.flv = null\n  }\n\n  loadData (time = this.currentTime) {\n    const range = this.getBufferedRange()\n    if (range[1] - time < (this.config.preloadTime || 15) - 5) {\n      this.flv.loadNext(range[1] + 1)\n    }\n  }\n\n  get src () {\n    return this.currentSrc\n  }\n\n  set src (url) {\n    this.player.config.url = url\n    if (!this.paused) {\n      this.pause()\n      this.once('pause', () => {\n        this.start(url)\n      })\n      this.once('canplay', () => {\n        this.play()\n      })\n    } else {\n      this.start(url)\n    }\n    this.once('canplay', () => {\n      this.currentTime = 0\n    })\n  }\n}\n\nmodule.exports = FlvPlayer\n"],"names":["flvAllowedEvents","EVENTS","FlvAllowedEvents","isEnded","player","flv","config","isLive","duration","currentTime","range","getBufferedRange","emit","mse","endOfStream","FlvPlayer","Player","constructor","context","Context","initEvents","start","registry","FLV","init","url","on","handleTimeUpdate","bind","handleSeek","once","_destroy","loadData","time","seek","destroy","preloadTime","loadNext","src","currentSrc","paused","pause","play","module","exports"],"mappings":"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"}