<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name=viewport
    content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui">
  <meta name="referrer" content="no-referrer">
  <title>播放器</title>
  <style type="text/css">
    .hide {
      display: none;
      visibility: hidden;
      opacity: 0;
    }

    .scale {
      transform: scale(0.25, 0.25);
      transform-origin: top left;
      position: absolute;
      top: 80px
    }

    .info {
      height: 100px;
      overflow: hidden;
      width: 300px;
    }

    .line {
      display: inline-block;
    }

    .url {
      width: 100%;
      max-width: 500px;
    }

    #dis {
      width: 1280px;
      height: 720px;
      border: 1px solid red
    }
  </style>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xgplayer@3.0.0-alpha.86/dist/xgplayer.min.css">

</head>

<body>
  <div>
    <button id="debug">打开调试信息</button>
  </div>
  <button id="urlbutton">视频播放地址</button>
  <input type="input" id="url" class="url" value="">
  </div>
  <!-- <video id="video" autoplay muted controlls class="hide"></video> -->
  <div id="mse"></div>
  <div>
    <div>
      <label for="delay">视频原始帧率:</label>
      <div id="fps" class="line"></div>
    </div>
    <div>
      <label for="delay">每秒视频截图数量:</label>
      <div id="totle" class="line"></div>
    </div>
    <div>
      <label for="delay">分辨率:</label>
      <div id="resolution" class="line"></div>
    </div>
    <div>
      <label for="delay">截图平均耗时:</label>
      <div id="ptime" class="line"></div>
    </div>
    <div>
      <label for="delay">剩余图片缓存长度</label>
      <div id="buffer" class="line"></div>
    </div>
    <div>
      <label for="delay">currentTime add bufferEnd</label>
      <div id="currentTime" class="line"></div>
    </div>
    <!-- <div>
      <label for="delay">buffer info</label>
      <div id="bufferInfo" class="line"></div>
    </div>
    <div>
      <label for="delay">dts</label>
      <div id="dtsInfo" class="line"></div>
    </div> -->

  </div>
  <img src="" alt="" id="img">
  <canvas id="canvas">
  </canvas>
  <div id="video"></div>

  <!-- <script src="./player.js"></script>
    <script src="./mobile-video.js"></script>
    <script src="./flv-live.js"></script>
    <script src="./vconsole.min.js"></script> -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/xgplayer@3.0.0-alpha.64-1/dist/index.min.js" charset="utf-8"></script> -->
  <!-- <scrip src="https://cdn.jsdelivr.net/npm/xgplayer-hls-live@3.0.0-alpha.81/dist/index.min.js" charset="utf-8"></scrip> -->
  <script src="http://10.1.15.145/packages/xgplayer/dist/index.js?t=2ccc2"></script>
  <script src="http://10.1.15.145/packages/xgplayer-mobilevideo/dist/index.js?t=ff"></script>
  <script src="http://10.1.15.145/packages/xgplayer-mobilevideo/node_modules/vconsole/dist/vconsole.min.js"></script>
  <script src="http://10.1.15.145/packages/xgplayer-flv-live/dist/index.js?t=cccddd"></script>
  <script type="text/javascript">
    var vConsole
    // vConsole = new VConsole();
    //打开log打印
    // document.cookie = 'xgd=2'
    let fpsDiv = document.querySelector('#fps')
    let totleDiv = document.querySelector('#totle')
    let timeDiv = document.querySelector('#ctime')
    let ptimeDiv = document.querySelector('#ptime')
    let bufferDiv = document.querySelector('#buffer')
    let resDiv = document.querySelector('#resolution')
    let inputUrl = document.querySelector('#url')
    let buttonUrl = document.querySelector('#urlbutton')
    let debugButton = document.querySelector('#debug')
    let currentTimeDiv = document.querySelector('#currentTime')
    let bufferInfoDiv = document.querySelector('#bufferInfo')
    let dtsInfoDiv = document.querySelector('#dtsInfo')

    let options = {
      debug: true,
      id: 'mse',
      url: 'https://pull-flv-l6.ixigua.com/game/stream-108561722603995566.flv',
      // plugins: [FlvLivePlayer.FlvLiveMsePlayer],
      // plugins: [FlvLivePlayer.FlvLiveVideoPlayer],
      plugins: [FlvLivePlayer.FlvLiveMobilePlayer],
      autoplay: true,
      isLive: true,
      playsinline: true,
      width: '100%',
      height: 270,
      preloadTime: 4,
      // innerDegrade: 2,
      mediaType: 'mobile-video',
      flvLiveMobile: {
        decodeMode: 7
      },
      // videoAttrbutes: {
      //   maxVideoHeight: 540,
      // }
    }
    let json = parseParamsToObj(window.location.href) || {}
    let url = json.url
    let myStorage = window.localStorage
    inputUrl.value = url
    if (url) {
      options.url = url
      myStorage.setItem('url', url)
    } else if (myStorage.getItem('url')) {
      options.url = myStorage.getItem('url')
    }
    let player = new Player(options);
    let start = false
    let spTime
    player.onReady = function () {
      // player.muted = true
    }
    player.on('SEI_PARSED', (sei) => {
      // console.error('SEI_PARSED', sei)
    })
    let audioLastDts = 0
    let a_baseDts = 0
    let aEndTime = 0
    let aCurrentTime = 0
    player.on('timeupdate', () => {
      let cuTime = player.currentTime
      if (!player.buffered.length) {
        return
      }
      let buTime = player.buffered.end(0)
      if (player.video.timeline) {
        let audioRender = player.video.timeline.audioRender
        let aTimeRange = audioRender._timeRange
        a_baseDts = aTimeRange._baseDts
        let videoRender = player.video.timeline.videoRender
        let decodeController = videoRender._videoDecodeController
        if (!decodeController) {
          return
        }
        let blobList = decodeController._blobURLList
        let length = blobList.length
        let infoDts = ''
        aEndTime = parseInt(a_baseDts + buTime * 1000)
        aCurrentTime = parseInt(a_baseDts + cuTime * 1000)
        let vendTime = decodeController.currentFramentDts + 4000
        currentTimeDiv.innerHTML = a_baseDts + ',' + aCurrentTime + ',' + aEndTime + ',bufferLength：' + (aEndTime - aCurrentTime)
      }

    })

    let stime = 0
    player.on('pause', (num) => {
      let time = player.currentTime
      console.log(time * 1000 - spTime * 1000, Date.now() - stime)
    })
    let isAdd = false
    player.on('playing', () => {
      spTime = player.currentTime
      stime = Date.now()
      console.error('-------------play play play', player.currentTime)
      try {
        if (isAdd) {
          return
        }
        let videoRender = player.video.timeline.videoRender
        let vControl = videoRender._videoDecodeController
        if (!vControl) {
          return
        }
        vControl.on('fps', (metafps, num, totalTime, duration, time, info) => {
          totleDiv.innerHTML = parseInt(num / (duration / 1000))
          fpsDiv.innerHTML = metafps
          resDiv.innerHTML = `原始高${info.relHeight}，显示高${info.height}`
          let pTime = parseInt(totalTime / num)
          ptimeDiv.innerHTML = `${num}张图片，总共耗时${totalTime}毫秒，平均耗时${pTime}毫秒`
        })
        vControl.on('renderDelay', (delay, num) => {
          bufferDiv.innerHTML = num
        })
        isAdd = true
      } catch (e) {
        console.error(e)
      }

    })
    player.on('ended', () => {
      console.log('end')
    })
    buttonUrl.onclick = function () {
      if (inputUrl.value != player.src) {
        player.src = inputUrl.value
      }
    }

    debugButton.onclick = function () {
      if (vConsole) {
        vConsole.destroy()
        vConsole = null
      } else {
        vConsole = new VConsole();
      }
    }

    function parseParamsToObj(url) {
      const params = /.+\?(.+)$/.exec(url); // 匹配?后字符串
      let paramsStr
      if (params) {
        paramsStr = params[1]
      } else {
        return
      }
      const paramsArr = paramsStr.split('&'); // 将字符串以&分割成数组
      let paramsObj = {};
      paramsArr.forEach(param => {
        // 处理已指定value的参数
        if (/=/.test(param)) {
          let [key, val] = param.split('=');
          val = decodeURIComponent(val);
          val = /^\d+$/.test(val) ? parseFloat(val) : val;
          // 对象有key,添加值
          if (paramsObj.hasOwnProperty(key)) {
            paramsObj[key] = [].concat(paramsObj[key], val);
          } else {
            paramsObj[key] = val;
          }
        } else {
          // 处理未指定value的参数
          paramsObj[param] = true;
        }
      })
      return paramsObj;
    }
  </script>
</body>

</html>