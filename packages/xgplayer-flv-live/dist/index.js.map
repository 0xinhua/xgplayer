{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["import Player from 'xgplayer'\nimport { Context, EVENTS } from 'xgplayer-utils';\nimport FLV from './flv-live'\nconst flvAllowedEvents = EVENTS.FlvAllowedEvents;\n\nclass FlvPlayer extends Player {\n  constructor (config) {\n    super(config)\n    this.context = new Context(flvAllowedEvents)\n    this.initEvents()\n    this.loaderCompleteTimer = null\n    // const preloadTime = player.config.preloadTime || 15\n  }\n\n  start () {\n    this.initFlv()\n    this.context.init()\n    super.start(this.flv.mse.url)\n  }\n\n  initFlvEvents (flv) {\n    const player = this;\n    flv.once(EVENTS.REMUX_EVENTS.INIT_SEGMENT, () => {\n      Player.util.addClass(player.root, 'xgplayer-is-live')\n      if (!Player.util.findDom(this.root, 'xg-live')) {\n        const live = Player.util.createDom('xg-live', '正在直播', {}, 'xgplayer-live')\n        player.controls.appendChild(live)\n      }\n    })\n\n    flv.once(EVENTS.LOADER_EVENTS.LOADER_COMPLETE, () => {\n      // 直播完成，待播放器播完缓存后发送关闭事件\n      if (!player.paused) {\n        this.loaderCompleteTimer = setInterval(() => {\n          const end = player.getBufferedRange()[1]\n          if (Math.abs(player.currentTime - end) < 0.5) {\n            player.emit('ended')\n            window.clearInterval(this.loaderCompleteTimer)\n          }\n        }, 200)\n      } else {\n        player.emit('ended')\n      }\n    })\n  }\n\n  initEvents () {\n    this.on('timeupdate', () => {\n      this.loadData()\n    })\n\n    this.on('seeking', () => {\n      const time = this.currentTime\n      const range = this.getBufferedRange()\n      if (time > range[1] || time < range[0]) {\n        this.flv.seek(this.currentTime)\n      }\n    })\n\n  }\n\n  initFlv () {\n    const flv = this.context.registry('FLV_CONTROLLER', FLV)(this)\n    this.initFlvEvents(flv)\n    this.flv = flv\n  }\n\n  play () {\n    if (this._hasStart) {\n      return this._destroy().then(() => {\n        this.context = new Context(flvAllowedEvents)\n        const flv = this.context.registry('FLV_CONTROLLER', FLV)(this)\n        this.initFlvEvents(flv)\n        this.flv = flv\n        this.context.init()\n        super.start(flv.mse.url)\n        return super.play()\n      })\n\n    } else {\n      return super.play()\n    }\n  }\n\n  pause () {\n    super.pause()\n    if (this.flv) {\n      this.flv.pause()\n    }\n  }\n\n  loadData (time = this.currentTime) {\n    if (this.flv) {\n      this.flv.seek(time)\n    }\n  }\n\n  destroy () {\n    this._destroy().then(() => {\n      super.destroy();\n    })\n  }\n\n  _destroy () {\n    return this.flv.mse.destroy().then(() => {\n      this.context.destroy()\n      this.flv = null\n      this.context = null\n      if (this.loaderCompleteTimer) {\n        window.clearInterval(this.loaderCompleteTimer)\n      }\n    })\n  }\n\n  get src () {\n    return this.currentSrc\n  }\n\n  set src (url) {\n    this.player.config.url = url\n    if (!this.paused) {\n      this.pause()\n      this.once('pause', () => {\n        this.start(url)\n      })\n      this.once('canplay', () => {\n        this.play()\n      })\n    } else {\n      this.start(url)\n    }\n    this.once('canplay', () => {\n      this.currentTime = 0\n    })\n  }\n}\n\nmodule.exports = FlvPlayer\n"],"names":["flvAllowedEvents","EVENTS","FlvAllowedEvents","FlvPlayer","Player","constructor","config","context","Context","initEvents","loaderCompleteTimer","start","initFlv","init","flv","mse","url","initFlvEvents","player","once","REMUX_EVENTS","INIT_SEGMENT","util","addClass","root","findDom","live","createDom","controls","appendChild","LOADER_EVENTS","LOADER_COMPLETE","paused","setInterval","end","getBufferedRange","Math","abs","currentTime","emit","window","clearInterval","on","loadData","time","range","seek","registry","FLV","play","_hasStart","_destroy","then","pause","destroy","src","currentSrc","module","exports"],"mappings":"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"}